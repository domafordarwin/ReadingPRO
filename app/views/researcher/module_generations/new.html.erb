<% content_for :title, "모듈 자동 생성 - 새로 만들기" %>

<div class="rp-page-container">
  <div style="margin-bottom:24px;">
    <%= link_to "← 목록으로", researcher_module_generations_path,
        style: "color:#667eea; text-decoration:none; font-size: var(--rp-font-size-sm);" %>
  </div>

  <h1 style="font-size: var(--rp-font-size-2xl); font-weight: var(--rp-font-weight-bold); color:#1e293b; margin-bottom:8px;">진단 모듈 자동 생성</h1>
  <p style="color:#64748b; margin-bottom:32px;">
    기존 모듈의 구조(평가 영역, 난이도, 루브릭)를 템플릿으로 사용하여 새 지문에 맞는 문항을 AI가 자동 생성합니다.
  </p>

  <%# Step 1: 템플릿 선택 %>
  <div style="background:#fff; border-radius:12px; border:1px solid #e2e8f0; padding:24px; margin-bottom:24px;">
    <h2 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color:#1e293b; margin-bottom:16px; display:flex; align-items:center; gap:8px;">
      <span style="width:28px; height:28px; border-radius:50%; background:#667eea; color:#fff; display:flex; align-items:center; justify-content:center; font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-bold);">1</span>
      템플릿 모듈 선택
    </h2>

    <div id="template-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px;">
      <% @templates.each do |tmpl| %>
        <label style="cursor:pointer;">
          <input type="radio" name="template_stimulus_id" value="<%= tmpl.id %>"
                 class="template-radio" style="display:none;"
                 data-mcq="<%= tmpl.mcq_count %>" data-constructed="<%= tmpl.constructed_count %>"
                 data-title="<%= tmpl.title %>">
          <div class="template-card" style="border:2px solid #e2e8f0; border-radius:10px; padding:14px; transition:all 0.2s;">
            <div style="font-weight: var(--rp-font-weight-semibold); color:#1e293b; font-size: var(--rp-font-size-sm); margin-bottom:4px;">
              <%= tmpl.title || tmpl.code %>
            </div>
            <div style="font-size: var(--rp-font-size-sm); color:#64748b;">
              <span style="background:#eff6ff; color:#3b82f6; padding:2px 6px; border-radius:4px;">MCQ <%= tmpl.mcq_count %></span>
              <span style="background:#faf5ff; color:#8b5cf6; padding:2px 6px; border-radius:4px;">서술형 <%= tmpl.constructed_count %></span>
              <% if tmpl.grade_level.present? %>
                <span style="background:#f0fdf4; color:#16a34a; padding:2px 6px; border-radius:4px;"><%= tmpl.grade_level_short %></span>
              <% end %>
            </div>
          </div>
        </label>
      <% end %>
    </div>
  </div>

  <%# Step 2: 지문 입력 방식 %>
  <div style="background:#fff; border-radius:12px; border:1px solid #e2e8f0; padding:24px; margin-bottom:24px;">
    <h2 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color:#1e293b; margin-bottom:16px; display:flex; align-items:center; gap:8px;">
      <span style="width:28px; height:28px; border-radius:50%; background:#667eea; color:#fff; display:flex; align-items:center; justify-content:center; font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-bold);">2</span>
      지문 입력
    </h2>

    <%# 모드 선택 탭 %>
    <div style="display:flex; gap:8px; margin-bottom:20px;">
      <button type="button" id="mode-text-btn" onclick="switchMode('text')"
              style="padding:8px 20px; border-radius:8px; border:2px solid #667eea; background:#667eea; color:#fff; font-weight: var(--rp-font-weight-semibold); cursor:pointer; transition:all 0.2s;">
        직접 입력
      </button>
      <button type="button" id="mode-ai-btn" onclick="switchMode('ai')"
              style="padding:8px 20px; border-radius:8px; border:2px solid #e2e8f0; background:#fff; color:#475569; font-weight: var(--rp-font-weight-medium); cursor:pointer; transition:all 0.2s;">
        AI 자동 생성
      </button>
      <button type="button" id="mode-batch-btn" onclick="switchMode('batch')"
              style="padding:8px 20px; border-radius:8px; border:2px solid #e2e8f0; background:#fff; color:#475569; font-weight: var(--rp-font-weight-medium); cursor:pointer; transition:all 0.2s;">
        일괄 생성
      </button>
    </div>

    <%# 직접 입력 모드 %>
    <div id="mode-text" class="mode-panel">
      <%= form_with url: researcher_module_generations_path, method: :post, data: { turbo: false } do |f| %>
        <input type="hidden" name="generation_mode" value="text">
        <input type="hidden" name="template_stimulus_id" id="text-template-id">

        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight: var(--rp-font-weight-medium); color:#374151; margin-bottom:6px;">지문 제목</label>
          <input type="text" name="passage_title" required
                 style="width:100%; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size: var(--rp-font-size-sm);"
                 placeholder="예: 인공지능과 일상생활">
        </div>
        <div style="margin-bottom:20px;">
          <label style="display:block; font-weight: var(--rp-font-weight-medium); color:#374151; margin-bottom:6px;">지문 본문</label>
          <textarea name="passage_text" rows="10" required
                    style="width:100%; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size: var(--rp-font-size-sm); resize:vertical;"
                    placeholder="읽기 지문을 입력하세요... (최소 100자 이상 권장)"></textarea>
        </div>
        <button type="submit"
                style="padding:12px 28px; background:#667eea; color:#fff; border:none; border-radius:8px; font-weight: var(--rp-font-weight-semibold); font-size: var(--rp-font-size-sm); cursor:pointer; transition:background 0.2s;">
          모듈 생성 시작
        </button>
      <% end %>
    </div>

    <%# AI 생성 모드 %>
    <div id="mode-ai" class="mode-panel" style="display:none;">
      <%= form_with url: researcher_module_generations_path, method: :post, data: { turbo: false } do |f| %>
        <input type="hidden" name="generation_mode" value="ai">
        <input type="hidden" name="template_stimulus_id" id="ai-template-id">

        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight: var(--rp-font-weight-medium); color:#374151; margin-bottom:6px;">주제 / 키워드</label>
          <input type="text" name="passage_topic" required
                 style="width:100%; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size: var(--rp-font-size-sm);"
                 placeholder="예: 기후변화와 재생에너지, 생태계 보전">
        </div>
        <div style="padding:12px 16px; background:#fffbeb; border-radius:8px; border:1px solid #fde68a; margin-bottom:20px;">
          <p style="font-size: var(--rp-font-size-sm); color:#92400e;">
            AI가 주제에 맞는 읽기 지문을 자동으로 작성한 후, 템플릿 구조에 따라 문항을 생성합니다.
          </p>
        </div>
        <button type="submit"
                style="padding:12px 28px; background:#667eea; color:#fff; border:none; border-radius:8px; font-weight: var(--rp-font-weight-semibold); font-size: var(--rp-font-size-sm); cursor:pointer;">
          AI 모듈 생성 시작
        </button>
      <% end %>
    </div>

    <%# 일괄 생성 모드 %>
    <div id="mode-batch" class="mode-panel" style="display:none;">
      <%= form_with url: batch_create_researcher_module_generations_path, method: :post, data: { turbo: false } do |f| %>
        <input type="hidden" name="generation_mode" value="text">
        <input type="hidden" name="template_stimulus_id" id="batch-template-id">

        <div id="batch-passages">
          <div class="batch-passage-entry" style="background:#f8fafc; border-radius:8px; padding:16px; margin-bottom:12px; border:1px solid #e2e8f0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <span style="font-weight: var(--rp-font-weight-semibold); color:#374151;">지문 1</span>
            </div>
            <input type="text" name="passages[][title]" placeholder="지문 제목"
                   style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; margin-bottom:8px; font-size: var(--rp-font-size-sm);">
            <textarea name="passages[][text]" rows="5" placeholder="지문 본문"
                      style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size: var(--rp-font-size-sm); resize:vertical;"></textarea>
          </div>
        </div>

        <button type="button" onclick="addBatchPassage()"
                style="padding:8px 16px; background:#f1f5f9; color:#475569; border:1px dashed #cbd5e1; border-radius:8px; cursor:pointer; font-size: var(--rp-font-size-sm); margin-bottom:20px; width:100%;">
          + 지문 추가
        </button>

        <button type="submit"
                style="padding:12px 28px; background:#667eea; color:#fff; border:none; border-radius:8px; font-weight: var(--rp-font-weight-semibold); font-size: var(--rp-font-size-sm); cursor:pointer;">
          일괄 생성 시작
        </button>
      <% end %>
    </div>
  </div>
</div>

<style>
  .template-card:hover { border-color: #667eea; }
  .template-radio:checked + .template-card {
    border-color: #667eea;
    background: #f0f4ff;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
</style>

<script>
  function switchMode(mode) {
    document.querySelectorAll('.mode-panel').forEach(p => p.style.display = 'none');
    document.getElementById('mode-' + mode).style.display = 'block';

    ['text', 'ai', 'batch'].forEach(m => {
      const btn = document.getElementById('mode-' + m + '-btn');
      if (m === mode) {
        btn.style.background = '#667eea';
        btn.style.color = '#fff';
        btn.style.borderColor = '#667eea';
      } else {
        btn.style.background = '#fff';
        btn.style.color = '#475569';
        btn.style.borderColor = '#e2e8f0';
      }
    });
  }

  // 템플릿 선택 시 hidden field 동기화
  document.querySelectorAll('.template-radio').forEach(radio => {
    radio.addEventListener('change', function() {
      document.getElementById('text-template-id').value = this.value;
      document.getElementById('ai-template-id').value = this.value;
      document.getElementById('batch-template-id').value = this.value;
    });
  });

  let batchCount = 1;
  function addBatchPassage() {
    batchCount++;
    const container = document.getElementById('batch-passages');
    const entry = document.createElement('div');
    entry.className = 'batch-passage-entry';
    entry.style = 'background:#f8fafc; border-radius:8px; padding:16px; margin-bottom:12px; border:1px solid #e2e8f0;';
    entry.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <span style="font-weight: var(--rp-font-weight-semibold); color:#374151;">지문 ${batchCount}</span>
        <button type="button" onclick="this.closest('.batch-passage-entry').remove()"
                style="color:#ef4444; background:none; border:none; cursor:pointer; font-size: var(--rp-font-size-sm);">삭제</button>
      </div>
      <input type="text" name="passages[][title]" placeholder="지문 제목"
             style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; margin-bottom:8px; font-size: var(--rp-font-size-sm);">
      <textarea name="passages[][text]" rows="5" placeholder="지문 본문"
                style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size: var(--rp-font-size-sm); resize:vertical;"></textarea>
    `;
    container.appendChild(entry);
  }
</script>
