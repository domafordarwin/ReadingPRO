<%# 모듈 생성 카드 파셜 %>
<% gen = generation %>
<div style="background:#fff; border-radius:12px; border:1px solid #e2e8f0; padding:20px; transition:box-shadow 0.2s; hover:box-shadow:0 4px 12px rgba(0,0,0,0.08);">
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
    <div style="flex:1; min-width:0;">
      <%# 상단: 상태 배지 + 모드 %>
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <span style="display:inline-block; padding:3px 10px; border-radius:12px; font-size:0.75rem; font-weight:600; background:<%= gen.status_color %>20; color:<%= gen.status_color %>;">
          <%= gen.status_label %>
        </span>
        <span style="font-size:0.75rem; color:#94a3b8;">
          <%= gen.generation_mode == "ai" ? "AI 지문 생성" : "직접 입력" %>
        </span>
        <% if gen.batch? %>
          <span style="font-size:0.75rem; color:#94a3b8; background:#f1f5f9; padding:2px 8px; border-radius:8px;">
            배치 #<%= gen.batch_index %>
          </span>
        <% end %>
      </div>

      <%# 제목 %>
      <%= link_to researcher_module_generation_path(gen),
          style: "font-size:1.05rem; font-weight:600; color:#1e293b; text-decoration:none;" do %>
        <%= gen.passage_title.presence || gen.passage_topic.presence || "모듈 생성 ##{gen.id}" %>
      <% end %>

      <%# 템플릿 정보 %>
      <p style="font-size:0.85rem; color:#64748b; margin-top:6px;">
        템플릿: <strong><%= gen.template_stimulus.title || gen.template_stimulus.code %></strong>
        (MCQ <%= gen.template_snapshot.dig("total_mcq") || "?" %>개 +
        서술형 <%= gen.template_snapshot.dig("total_constructed") || "?" %>개)
      </p>
    </div>

    <%# 우측: 타당도 점수 %>
    <div style="text-align:center; min-width:80px;">
      <% if gen.validation_score.present? %>
        <% score = gen.validation_score.to_f %>
        <% score_color = score >= 80 ? "#22c55e" : score >= 70 ? "#f59e0b" : "#ef4444" %>
        <div style="width:56px; height:56px; border-radius:50%; border:3px solid <%= score_color %>; display:flex; align-items:center; justify-content:center; margin:0 auto;">
          <span style="font-size:1rem; font-weight:700; color:<%= score_color %>;"><%= score.round(0) %></span>
        </div>
        <span style="font-size:0.7rem; color:#94a3b8; display:block; margin-top:4px;">타당도</span>
      <% elsif gen.generating? || gen.validating? || gen.pending? %>
        <div style="width:56px; height:56px; border-radius:50%; border:3px solid #e2e8f0; display:flex; align-items:center; justify-content:center; margin:0 auto; animation:pulse 2s infinite;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
        </div>
        <span style="font-size:0.7rem; color:#94a3b8; display:block; margin-top:4px;">진행중</span>
      <% end %>
    </div>
  </div>

  <%# 하단: 생성일 + 액션 %>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:12px; border-top:1px solid #f1f5f9;">
    <span style="font-size:0.8rem; color:#94a3b8;">
      <%= gen.created_at.strftime("%Y-%m-%d %H:%M") %>
    </span>
    <div style="display:flex; gap:8px;">
      <% if gen.review? %>
        <%= link_to "리뷰하기", researcher_module_generation_path(gen),
            style: "padding:5px 12px; background:#8b5cf6; color:#fff; border-radius:6px; font-size:0.8rem; text-decoration:none; font-weight:500;" %>
      <% elsif gen.approved? && gen.generated_stimulus_id %>
        <%= link_to "모듈 보기", researcher_passage_path(gen.generated_stimulus_id),
            style: "padding:5px 12px; background:#22c55e; color:#fff; border-radius:6px; font-size:0.8rem; text-decoration:none; font-weight:500;" %>
      <% else %>
        <%= link_to "상세", researcher_module_generation_path(gen),
            style: "padding:5px 12px; background:#f1f5f9; color:#475569; border-radius:6px; font-size:0.8rem; text-decoration:none;" %>
      <% end %>
    </div>
  </div>
</div>
