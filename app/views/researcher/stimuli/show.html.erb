<% content_for :portal_title do %>
  진단지 세트 상세
<% end %>
<% content_for :portal_subtitle do %>
  <%= @stimulus.code %>
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :item_bank %>
<% end %>

<div class="passage-detail">
  <!-- 헤더 -->
  <div class="detail-header">
    <div class="header-left">
      <h1><%= @stimulus.title.presence || "제목 없음" %></h1>
      <div class="header-meta">
        <span class="code-badge"><%= @stimulus.code %></span>
        <span class="status-badge status-<%= @stimulus.bundle_status %>">
          <%= { 'draft' => '작업중', 'active' => '배포가능', 'archived' => '보관됨' }[@stimulus.bundle_status] %>
        </span>
        <% if @stimulus.ai_analyzed? %>
          <span class="ai-badge">AI 분석 완료</span>
        <% end %>
      </div>
    </div>
    <div class="header-actions">
      <%= link_to edit_researcher_stimulus_path(@stimulus), class: "action-btn action-btn-outline" do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        <span>편집</span>
      <% end %>
      <%= button_to duplicate_researcher_passage_path(@stimulus), method: :post, class: "action-btn action-btn-outline", data: { turbo_confirm: "이 진단지 세트를 복제하시겠습니까? 모든 문항도 함께 복제됩니다." } do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <span>복제</span>
      <% end %>
      <% unless @stimulus.ai_analyzed? %>
        <%= button_to analyze_researcher_passage_path(@stimulus), method: :post, class: "action-btn action-btn-ai", data: { turbo_confirm: "AI 분석을 실행하시겠습니까?" } do %>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
          </svg>
          <span>AI 분석</span>
        <% end %>
      <% else %>
        <%= button_to analyze_researcher_passage_path(@stimulus), method: :post, class: "action-btn action-btn-outline", data: { turbo_confirm: "AI 분석을 다시 실행하시겠습니까?" } do %>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"></path>
          </svg>
          <span>AI 재분석</span>
        <% end %>
      <% end %>
      <% if @stimulus.bundle_status != 'archived' %>
        <%= button_to archive_researcher_passage_path(@stimulus), method: :post, class: "action-btn action-btn-archive", data: { turbo_confirm: "이 진단지 세트를 보관처리 하시겠습니까?\n\n지문과 문항 데이터는 삭제되지 않으며, 목록에서만 숨겨집니다." } do %>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="21 8 21 21 3 21 3 8"></polyline>
            <rect x="1" y="3" width="22" height="5"></rect>
            <line x1="10" y1="12" x2="14" y2="12"></line>
          </svg>
          <span>보관처리</span>
        <% end %>
      <% else %>
        <%= button_to restore_researcher_passage_path(@stimulus), method: :post, class: "action-btn action-btn-restore", data: { turbo_confirm: "이 진단지 세트를 보관 해제하시겠습니까?" } do %>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"></path>
          </svg>
          <span>보관 해제</span>
        <% end %>
      <% end %>
      <%= button_to researcher_passage_path(@stimulus), method: :delete, class: "action-btn action-btn-delete", data: { turbo_confirm: "정말 삭제하시겠습니까?\n\n이 모듈의 지문과 모든 문항이 영구적으로 삭제됩니다.\n(보관처리를 원하시면 '보관처리' 버튼을 사용해주세요)" } do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        <span>삭제</span>
      <% end %>
      <%= link_to researcher_item_bank_path, class: "action-btn action-btn-back" do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        <span>목록으로</span>
      <% end %>
    </div>
  </div>

  <!-- AI 분석 결과 (있는 경우) -->
  <% if @stimulus.ai_analyzed? %>
    <div class="ai-analysis-card">
      <h3>AI 분석 결과</h3>
      <div class="analysis-grid">
        <div class="analysis-item">
          <span class="label">영역</span>
          <span class="value"><%= @stimulus.domain %></span>
        </div>
        <div class="analysis-item">
          <span class="label">주제</span>
          <span class="value"><%= @stimulus.main_topic %></span>
        </div>
        <div class="analysis-item">
          <span class="label">난이도</span>
          <span class="value difficulty-<%= @stimulus.difficulty_level %>">
            <%= { 'easy' => '쉬움', 'medium' => '보통', 'hard' => '어려움' }[@stimulus.difficulty_level] %>
            (<%= @stimulus.difficulty_score %>/10)
          </span>
        </div>
        <div class="analysis-item">
          <span class="label">대상 학년</span>
          <span class="value"><%= @stimulus.target_grade || "-" %></span>
        </div>
      </div>

      <% if @stimulus.ai_summary.present? %>
        <div class="analysis-summary">
          <span class="label">AI 요약</span>
          <p><%= @stimulus.ai_summary %></p>
        </div>
      <% end %>

      <div class="key-concepts-section">
        <span class="label">핵심 개념</span>
        <div class="concept-tags">
          <% @stimulus.key_concepts.each do |concept| %>
            <span class="concept-tag"><%= concept %></span>
          <% end %>
        </div>
      </div>

      <% if @stimulus.ai_analysis["readability_factors"].present? %>
        <div class="readability-factors">
          <span class="label">가독성 분석</span>
          <div class="factors-grid">
            <% @stimulus.ai_analysis["readability_factors"].each do |key, value| %>
              <div class="factor-item">
                <span class="factor-label"><%= { "vocabulary_level" => "어휘 수준", "sentence_complexity" => "문장 복잡도", "concept_abstractness" => "개념 추상성", "background_knowledge_required" => "배경지식 요구" }[key] || key %></span>
                <span class="factor-value"><%= value %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="analysis-meta">
        분석 일시: <%= Time.parse(@stimulus.bundle_metadata["analyzed_at"]).strftime("%Y-%m-%d %H:%M") rescue "-" %>
      </div>
    </div>
  <% end %>

  <!-- 지문 본문 -->
  <div class="passage-body-card">
    <h3>지문 본문</h3>
    <div class="passage-content">
      <%= sanitize_rich_text(@stimulus.body) %>
    </div>
    <% if @stimulus.images.attached? %>
      <div style="display: flex; flex-direction: column; align-items: center; gap: 16px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
        <% @stimulus.images.each do |img| %>
          <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
            <%= image_tag img, style: "max-width: 600px; max-height: 450px; display: block;" %>
          </div>
        <% end %>
      </div>
    <% end %>
    <div class="passage-meta">
      <span>단어 수: <%= @stimulus.body.to_s.gsub(/<[^>]*>/, '').split.size %>개</span>
      <span>예상 소요 시간: <%= @stimulus.estimated_time_minutes %>분</span>
    </div>
  </div>

  <!-- 연결된 문항 목록 -->
  <div class="items-section">
    <div class="section-header">
      <div class="section-header-left">
        <h3>연결된 문항 (<span id="itemCount"><%= @stimulus.items.count %></span>개)</h3>
        <div class="item-type-filters">
          <button class="filter-btn active" data-filter="all">전체</button>
          <button class="filter-btn" data-filter="mcq">객관식 (<span class="mcq-count"><%= @stimulus.items.where(item_type: 'mcq').count %></span>)</button>
          <button class="filter-btn" data-filter="constructed">서술형 (<span class="constructed-count"><%= @stimulus.items.where(item_type: 'constructed').count %></span>)</button>
        </div>
      </div>
      <%= link_to researcher_item_create_path(stimulus_id: @stimulus.id), class: "action-btn action-btn-add action-btn-sm" do %>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>문항 추가</span>
      <% end %>
    </div>

    <% if @stimulus.items.any? %>
      <div class="items-grid">
        <% sorted_items = @stimulus.items.sort_by { |i| [i.item_type == 'mcq' ? 0 : 1, i.code.to_s] } %>
        <% sorted_items.each_with_index do |item, idx| %>
          <div class="item-card item-type-<%= item.item_type %>" data-item-type="<%= item.item_type %>">
            <div class="item-header">
              <span class="item-number-badge"><%= idx + 1 %></span>
              <span class="item-code"><%= item.code %></span>
              <span class="item-type-badge item-type-badge-<%= item.item_type %>"><%= item.item_type == 'mcq' ? '객관식' : '서술형' %></span>
              <span class="difficulty-badge difficulty-<%= item.difficulty %>"><%= { 'easy' => '쉬움', 'medium' => '보통', 'hard' => '어려움' }[item.difficulty] %></span>
              <% if item.evaluation_indicator %>
                <span class="indicator-badge-sm"><%= item.evaluation_indicator.name %></span>
              <% end %>
              <% if item.sub_indicator %>
                <span class="indicator-badge-sm indicator-badge-sm--sub"><%= item.sub_indicator.name %></span>
              <% end %>
              <% if item.item_type == 'mcq' %>
                <% if item.item_choices.none?(&:is_correct) %>
                  <span class="answer-status-badge answer-missing">정답 미설정</span>
                <% end %>
              <% elsif item.item_type == 'constructed' %>
                <% if item.rubric.blank? || item.rubric.rubric_criteria.count <= 1 %>
                  <span class="answer-status-badge answer-missing">채점기준 미설정</span>
                <% end %>
              <% end %>
            </div>
            <div class="item-prompt"><%= sanitize_rich_text(item.prompt) %></div>

            <% if item.item_type == 'mcq' && item.item_choices.any? %>
              <div class="item-choices">
                <% item.item_choices.order(:choice_no).each do |choice| %>
                  <div class="choice <%= 'correct' if choice.is_correct %>">
                    <span class="choice-num"><%= choice.choice_no.to_s.gsub(/[0-9]/) { |d| ['①','②','③','④','⑤'][d.to_i - 1] || d } %></span>
                    <%= sanitize_choice_text(choice.content) %>
                    <% if choice.is_correct %>
                      <span class="correct-marker">정답</span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% elsif item.item_type == 'constructed' && item.rubric.present? %>
              <div class="rubric-preview">
                <span class="rubric-label">채점 기준: <%= item.rubric.rubric_criteria.count %>개 기준</span>
              </div>
            <% end %>

            <div class="item-actions">
              <%= link_to edit_researcher_item_path(item), class: "action-btn action-btn-outline action-btn-xs" do %>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                <span>문항 편집</span>
              <% end %>
              <% if item.item_type == 'mcq' && item.item_choices.none?(&:is_correct) %>
                <%= link_to edit_researcher_item_path(item, state: 'mcq-default'), class: "action-btn action-btn-primary action-btn-xs" do %>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <span>정답 설정</span>
                <% end %>
              <% elsif item.item_type == 'constructed' && (item.rubric.blank? || item.rubric.rubric_criteria.count <= 1) %>
                <%= link_to edit_researcher_item_path(item, state: 'essay-rubric'), class: "action-btn action-btn-primary action-btn-xs" do %>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                  </svg>
                  <span>채점기준 설정</span>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="empty-items">
        <p>연결된 문항이 없습니다.</p>
        <p>
          <%= link_to researcher_item_create_path(stimulus_id: @stimulus.id), class: "action-btn action-btn-primary" do %>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>문항 추가하기</span>
          <% end %>
        </p>
      </div>
    <% end %>
  </div>

  <!-- 문항 통계 -->
  <div class="stats-card">
    <h3>통계</h3>
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-value"><%= @stimulus.mcq_count %></span>
        <span class="stat-label">객관식</span>
      </div>
      <div class="stat-item">
        <span class="stat-value"><%= @stimulus.constructed_count %></span>
        <span class="stat-label">서술형</span>
      </div>
      <div class="stat-item">
        <span class="stat-value"><%= @stimulus.total_count %></span>
        <span class="stat-label">전체 문항</span>
      </div>
      <div class="stat-item">
        <span class="stat-value"><%= @stimulus.estimated_time_minutes %>분</span>
        <span class="stat-label">예상 시간</span>
      </div>
    </div>
  </div>

  <%# 정답/채점기준 등록 섹션 - 숨김 처리 (수동 입력 방식으로 전환) %>

  <!-- 버전 이력 -->
  <% if @stimulus.respond_to?(:versions) && @stimulus.versions.any? %>
    <div class="version-history-card">
      <h3>수정 이력</h3>
      <div class="version-list">
        <% @stimulus.version_history.limit(10).each do |version| %>
          <div class="version-item">
            <div class="version-info">
              <span class="version-event">
                <%= { 'create' => '생성', 'update' => '수정', 'destroy' => '삭제' }[version.event] || version.event %>
              </span>
              <span class="version-time"><%= version.created_at.strftime("%Y-%m-%d %H:%M") %></span>
            </div>
            <% if version.changeset.present? %>
              <div class="version-changes">
                <% version.changeset.except('updated_at', 'bundle_metadata').each do |field, changes| %>
                  <div class="change-item">
                    <span class="field-name"><%= field_label(field) %>:</span>
                    <span class="old-value"><%= truncate(changes[0].to_s, length: 30) %></span>
                    →
                    <span class="new-value"><%= truncate(changes[1].to_s, length: 30) %></span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <% if @stimulus.versions.count > 10 %>
        <div class="version-more">
          <span>외 <%= @stimulus.versions.count - 10 %>개의 기록이 있습니다.</span>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<%
  def field_label(field)
    {
      'title' => '제목',
      'body' => '본문',
      'code' => '코드',
      'bundle_status' => '상태',
      'item_codes' => '문항 코드'
    }[field] || field
  end
%>

<style>
  .passage-detail {
    max-width: 900px;
    margin: 0 auto;
  }

  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border, #e5e7eb);
  }

  .detail-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: var(--rp-font-size-2xl);
  }

  .header-meta {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .code-badge {
    font-family: monospace;
    font-size: var(--rp-font-size-xs);
    background: var(--bg-secondary, #f3f4f6);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .status-badge, .ai-badge {
    font-size: var(--rp-font-size-xs);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .status-draft { background: #fef3c7; color: #92400e; }
  .status-active { background: #d1fae5; color: #065f46; }
  .status-archived { background: #e5e7eb; color: #374151; }
  .ai-badge { background: #dbeafe; color: #1e40af; }

  .header-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  /* Modern Action Buttons */
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.875rem;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-medium);
    border-radius: 8px;
    border: none;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .action-btn svg {
    flex-shrink: 0;
  }

  .action-btn-outline {
    background: white;
    border: 1px solid var(--border, #d1d5db);
    color: var(--text-secondary, #4b5563);
  }

  .action-btn-outline:hover {
    background: var(--bg-secondary, #f3f4f6);
    border-color: var(--primary, #2563eb);
    color: var(--primary, #2563eb);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
  }

  .action-btn-ai {
    background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
  }

  .action-btn-ai:hover {
    background: linear-gradient(135deg, #6d28d9 0%, #4338ca 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
  }

  .action-btn-archive {
    background: transparent;
    border: 1px solid #f59e0b;
    color: #d97706;
  }

  .action-btn-archive:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
  }

  .action-btn-restore {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }

  .action-btn-restore:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }

  .action-btn-delete {
    background: transparent;
    border: 1px solid #ef4444;
    color: #dc2626;
  }

  .action-btn-delete:hover {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  }

  .action-btn-back {
    background: var(--bg-secondary, #f3f4f6);
    border: 1px solid var(--border, #e5e7eb);
    color: var(--text-muted, #6b7280);
  }

  .action-btn-back:hover {
    background: var(--bg-tertiary, #e5e7eb);
    color: var(--text-primary, #374151);
  }

  .action-btn-primary {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
  }

  .action-btn-primary:hover {
    background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
  }

  .action-btn-add {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
  }

  .action-btn-add:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.35);
  }

  .action-btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: var(--rp-font-size-xs);
    border-radius: 6px;
  }

  .action-btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: var(--rp-font-size-xs);
    border-radius: 5px;
    gap: 0.25rem;
  }

  /* Focus states for accessibility */
  .action-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
  }

  .action-btn:active {
    transform: translateY(0);
  }

  .ai-analysis-card, .passage-body-card, .items-section, .stats-card {
    background: white;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .ai-analysis-card h3, .passage-body-card h3, .stats-card h3 {
    margin: 0 0 1rem 0;
    font-size: var(--rp-font-size-lg);
    color: var(--text-primary, #111827);
  }

  .analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .analysis-item {
    background: var(--bg-secondary, #f8f9fa);
    padding: 0.75rem;
    border-radius: 8px;
  }

  .analysis-item .label, .analysis-summary .label, .key-concepts-section .label, .readability-factors .label {
    display: block;
    font-size: var(--rp-font-size-xs);
    color: var(--text-muted, #6b7280);
    margin-bottom: 0.25rem;
  }

  .analysis-item .value {
    font-weight: var(--rp-font-weight-semibold);
    font-size: var(--rp-font-size-sm);
  }

  .difficulty-easy { color: #065f46; }
  .difficulty-medium { color: #92400e; }
  .difficulty-hard { color: #991b1b; }

  .analysis-summary p {
    margin: 0.5rem 0 0;
    line-height: 1.6;
  }

  .key-concepts-section {
    margin-top: 1rem;
  }

  .concept-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.5rem;
  }

  .concept-tag {
    background: var(--bg-tertiary, #e0e7ff);
    color: var(--primary, #3730a3);
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-size: var(--rp-font-size-sm);
  }

  .readability-factors {
    margin-top: 1rem;
  }

  .factors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .factor-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 6px;
    font-size: var(--rp-font-size-sm);
  }

  .factor-label { color: var(--text-muted, #6b7280); }
  .factor-value { font-weight: var(--rp-font-weight-medium); }

  .analysis-meta {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border, #e5e7eb);
    font-size: var(--rp-font-size-xs);
    color: var(--text-muted, #6b7280);
  }

  .passage-content {
    background: var(--bg-secondary, #f8f9fa);
    padding: 1.5rem;
    border-radius: 8px;
    line-height: 1.8;
    font-size: var(--rp-font-size-sm);
  }

  .passage-meta {
    display: flex;
    gap: 1.5rem;
    margin-top: 1rem;
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    gap: 16px;
  }

  .section-header-left {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .section-header h3 {
    margin: 0;
  }

  /* 문항 타입 필터 버튼 */
  .item-type-filters {
    display: flex;
    gap: 8px;
  }

  .filter-btn {
    padding: 6px 14px;
    border: 1px solid #d1d5db;
    background: white;
    color: #6b7280;
    border-radius: 6px;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-medium);
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .filter-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
  }

  .filter-btn .mcq-count,
  .filter-btn .constructed-count {
    font-weight: var(--rp-font-weight-semibold);
  }

  /* 문항 카드 필터링 시 숨김 */
  .item-card.hidden {
    display: none;
  }

  .items-grid {
    display: grid;
    gap: 1rem;
  }

  .item-card {
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 8px;
    padding: 1rem;
    background: var(--bg-secondary, #fafafa);
  }

  .item-card.item-type-mcq { border-left: 3px solid #2563eb; }
  .item-card.item-type-constructed { border-left: 3px solid #7c3aed; }

  .item-header {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
  }

  .item-code {
    font-family: monospace;
    font-size: var(--rp-font-size-xs);
    background: var(--bg-tertiary, #e5e7eb);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
  }

  .item-type-badge {
    font-size: var(--rp-font-size-xs);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-weight: var(--rp-font-weight-semibold);
  }

  /* 객관식: 파란색 */
  .item-type-badge-mcq {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 1px solid #93c5fd;
  }

  /* 서술형: 보라색 */
  .item-type-badge-constructed {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    color: #7c3aed;
    border: 1px solid #d8b4fe;
  }

  .difficulty-badge {
    font-size: var(--rp-font-size-xs);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
  }

  .difficulty-badge.difficulty-easy { background: #d1fae5; color: #065f46; }
  .difficulty-badge.difficulty-medium { background: #fef3c7; color: #92400e; }
  .difficulty-badge.difficulty-hard { background: #fee2e2; color: #991b1b; }

  .item-number-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-bold);
    flex-shrink: 0;
  }

  .indicator-badge-sm {
    font-size: var(--rp-font-size-xs);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    font-weight: var(--rp-font-weight-medium);
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
  }

  .indicator-badge-sm--sub {
    background: #f0f9ff;
    color: #0369a1;
    border: 1px solid #bae6fd;
  }

  .answer-status-badge {
    font-size: var(--rp-font-size-xs);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-weight: var(--rp-font-weight-semibold);
    animation: pulse-warning 2s ease-in-out infinite;
  }

  .answer-status-badge.answer-missing {
    background: #fef3c7;
    color: #d97706;
    border: 1px solid #fbbf24;
  }

  @keyframes pulse-warning {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .item-prompt {
    margin: 0.5rem 0;
    font-size: var(--rp-font-size-sm);
    line-height: 1.5;
  }

  .item-choices {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
  }

  .choice {
    padding: 0.3rem 0;
    font-size: var(--rp-font-size-sm);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .choice.correct {
    color: #065f46;
    font-weight: var(--rp-font-weight-medium);
  }

  .choice-num {
    font-size: var(--rp-font-size-sm);
  }

  .correct-marker {
    font-size: var(--rp-font-size-xs);
    background: #d1fae5;
    color: #065f46;
    padding: 0.1rem 0.3rem;
    border-radius: 4px;
    margin-left: auto;
  }

  .rubric-preview {
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #f3e8ff;
    border-radius: 6px;
    font-size: var(--rp-font-size-sm);
    color: #7c3aed;
  }

  .item-actions {
    margin-top: 0.75rem;
    display: flex;
    gap: 6px;
    justify-content: flex-end;
  }

  .btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: var(--rp-font-size-xs);
  }

  .empty-items {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted, #6b7280);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }

  .stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 8px;
  }

  .stat-value {
    display: block;
    font-size: var(--rp-font-size-2xl);
    font-weight: bold;
    color: var(--primary, #2563eb);
  }

  .stat-label {
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
  }

  @media (max-width: 640px) {
    .detail-header {
      flex-direction: column;
      gap: 1rem;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* 정답지 업로드 섹션 */
  .answer-key-section {
    background: white;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .section-header-full {
    margin-bottom: 1rem;
  }

  .section-header-full h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 0 0.5rem 0;
    font-size: var(--rp-font-size-lg);
    color: var(--text-primary, #111827);
  }

  .section-header-full h3 svg {
    color: #667eea;
  }

  .section-description {
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
    margin: 0;
  }

  /* 정답 상태 요약 */
  .answer-status-summary {
    display: flex;
    gap: 1.5rem;
    padding: 1rem;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 8px;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .status-summary-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--rp-font-size-sm);
  }

  .status-summary-item.complete .status-icon {
    color: #10b981;
    font-weight: bold;
  }

  .status-summary-item.incomplete .status-icon {
    color: #f59e0b;
  }

  .status-summary-item.complete .status-text {
    color: #059669;
  }

  .status-summary-item.incomplete .status-text {
    color: #d97706;
  }

  /* 탭 메뉴 */
  .answer-tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--border, #e5e7eb);
    margin-bottom: 1.5rem;
  }

  .answer-tab {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    color: var(--text-muted, #6b7280);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }

  .answer-tab:hover {
    color: var(--primary, #667eea);
  }

  .answer-tab.active {
    color: var(--primary, #667eea);
    border-bottom-color: var(--primary, #667eea);
  }

  .answer-tab-content {
    display: none;
  }

  .answer-tab-content.active {
    display: block;
  }

  /* PDF 업로드 영역 */
  .answer-key-upload-form {
    max-width: 600px;
    margin: 0 auto;
  }

  .upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s;
    background: var(--bg-secondary, #f9fafb);
  }

  .upload-area:hover,
  .upload-area.dragover {
    border-color: #667eea;
    background: #f0f4ff;
  }

  .file-input-hidden {
    display: none;
  }

  .upload-label {
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .upload-label svg {
    color: #9ca3af;
  }

  .upload-text {
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    color: var(--text-primary, #374151);
  }

  .upload-hint {
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
  }

  .selected-file {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1rem;
    background: white;
    border: 1px solid #667eea;
    border-radius: 8px;
    margin-top: 1rem;
  }

  .file-icon {
    font-size: var(--rp-font-size-2xl);
  }

  .file-name {
    font-weight: var(--rp-font-weight-semibold);
    color: #667eea;
  }

  .file-remove {
    background: #fee2e2;
    border: none;
    color: #dc2626;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: var(--rp-font-size-sm);
    line-height: 1;
  }

  .upload-actions {
    margin-top: 1.5rem;
    text-align: center;
  }

  .upload-note {
    margin-top: 0.75rem;
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
  }

  .action-btn.loading {
    opacity: 0.7;
    cursor: wait;
    position: relative;
  }

  .action-btn.loading::after {
    content: '';
    display: inline-block;
    width: 14px;
    height: 14px;
    margin-left: 8px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* 일괄 편집 */
  .bulk-edit-grid {
    display: grid;
    gap: 1rem;
  }

  .bulk-edit-item {
    padding: 1rem;
    background: var(--bg-secondary, #f9fafb);
    border-radius: 8px;
    border-left: 3px solid #d1d5db;
  }

  .bulk-edit-item.item-type-mcq {
    border-left-color: #2563eb;
  }

  .bulk-edit-item.item-type-constructed {
    border-left-color: #7c3aed;
  }

  .bulk-edit-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .item-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-bold);
  }

  .item-type-badge-mini {
    font-size: var(--rp-font-size-xs);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    font-weight: var(--rp-font-weight-semibold);
  }

  .item-type-badge-mini.item-type-mcq {
    background: #dbeafe;
    color: #1e40af;
  }

  .item-type-badge-mini.item-type-constructed {
    background: #f3e8ff;
    color: #7c3aed;
  }

  .bulk-edit-prompt {
    font-size: var(--rp-font-size-sm);
    color: var(--text-secondary, #4b5563);
    margin-bottom: 0.75rem;
    line-height: 1.4;
  }

  .bulk-edit-choices {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .bulk-choice-option {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: var(--rp-font-size-sm);
  }

  .bulk-choice-option:hover {
    border-color: #667eea;
  }

  .bulk-choice-option:has(input:checked) {
    background: #d1fae5;
    border-color: #10b981;
  }

  .bulk-choice-option input {
    margin: 0;
  }

  .bulk-choice-option .choice-num {
    font-weight: var(--rp-font-weight-bold);
    color: #6b7280;
  }

  .bulk-choice-option:has(input:checked) .choice-num {
    color: #059669;
  }

  .bulk-choice-option .choice-text {
    color: #374151;
  }

  .bulk-edit-rubric-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .rubric-edit-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: white;
    border: 1px solid #d8b4fe;
    border-radius: 6px;
    color: #7c3aed;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-medium);
    text-decoration: none;
    transition: all 0.2s;
  }

  .rubric-edit-link:hover {
    background: #f3e8ff;
    border-color: #7c3aed;
  }

  .rubric-status {
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-medium);
  }

  .rubric-status.complete {
    color: #059669;
  }

  .rubric-status.incomplete {
    color: #d97706;
  }

  .bulk-edit-actions {
    margin-top: 1.5rem;
    text-align: center;
    padding-top: 1rem;
    border-top: 1px solid var(--border, #e5e7eb);
  }

  /* Template Registration Styles */
  .template-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .template-step {
    display: flex;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--bg-secondary, #f9fafb);
    border-radius: 10px;
    border: 1px solid var(--border, #e5e7eb);
    transition: all 0.2s;
  }

  .template-step:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
  }

  .step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-bold);
    flex-shrink: 0;
  }

  .step-content {
    flex: 1;
  }

  .step-content h4 {
    margin: 0 0 0.5rem 0;
    font-size: var(--rp-font-size-sm);
    color: var(--text-primary, #111827);
  }

  .step-content p {
    margin: 0 0 0.75rem 0;
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
  }

  .template-guide {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-top: 0.5rem;
  }

  .guide-item {
    display: flex;
    gap: 0.5rem;
    padding: 0.4rem 0;
    font-size: var(--rp-font-size-sm);
    border-bottom: 1px dashed #e5e7eb;
  }

  .guide-item:last-child {
    border-bottom: none;
  }

  .guide-label {
    font-weight: var(--rp-font-weight-semibold);
    color: var(--text-primary, #374151);
    min-width: 60px;
  }

  .guide-value {
    color: var(--text-secondary, #6b7280);
    font-family: monospace;
    font-size: var(--rp-font-size-sm);
  }

  .template-upload-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .upload-area-compact {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 2px dashed #d1d5db;
    border-radius: 10px;
    background: white;
    transition: all 0.2s;
  }

  .upload-area-compact:hover,
  .upload-area-compact.dragover {
    border-color: #667eea;
    background: #f0f4ff;
  }

  .upload-area-compact.has-file {
    border-color: #10b981;
    background: #ecfdf5;
    border-style: solid;
  }

  .upload-label-compact {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary, #f3f4f6);
    border-radius: 6px;
    transition: all 0.2s;
  }

  .upload-label-compact:hover {
    background: #e5e7eb;
  }

  .upload-label-compact svg {
    color: #667eea;
  }

  .upload-label-compact span {
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-medium);
    color: var(--text-primary, #374151);
  }

  .selected-template-name {
    flex: 1;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-medium);
    color: #059669;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .selected-template-name:empty {
    display: none;
  }

  .selected-template-name::before {
    content: '✓ ';
    color: #10b981;
  }

  .template-upload-actions {
    display: flex;
    justify-content: flex-end;
  }

  .template-upload-actions .action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #d1d5db;
    box-shadow: none;
  }

  /* Version History Styles */
  .version-history-card {
    background: white;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .version-history-card h3 {
    margin: 0 0 1rem 0;
    font-size: var(--rp-font-size-lg);
    color: var(--text-primary, #111827);
  }

  .version-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .version-item {
    padding: 0.75rem;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 8px;
    border-left: 3px solid var(--primary, #2563eb);
  }

  .version-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .version-event {
    font-weight: var(--rp-font-weight-semibold);
    font-size: var(--rp-font-size-sm);
    color: var(--primary, #2563eb);
  }

  .version-time {
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
  }

  .version-changes {
    font-size: var(--rp-font-size-sm);
  }

  .change-item {
    padding: 0.25rem 0;
  }

  .field-name {
    color: var(--text-muted, #6b7280);
    margin-right: 0.5rem;
  }

  .old-value {
    color: #dc2626;
    text-decoration: line-through;
  }

  .new-value {
    color: #059669;
    font-weight: var(--rp-font-weight-medium);
  }

  .version-more {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border, #e5e7eb);
    text-align: center;
    font-size: var(--rp-font-size-sm);
    color: var(--text-muted, #6b7280);
  }
</style>

<script>
  // Turbo Drive 호환성을 위해 turbo:load 사용
  document.addEventListener('turbo:load', function() {
    // 문항 타입 필터링 기능
    const filterBtns = document.querySelectorAll('.filter-btn');
    const itemCards = document.querySelectorAll('.item-card');
    const itemCountEl = document.getElementById('itemCount');

    if (filterBtns.length > 0 && itemCards.length > 0) {
      filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const filter = this.dataset.filter;

          // 활성 버튼 업데이트
          filterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          // 문항 카드 필터링
          let visibleCount = 0;

          itemCards.forEach(card => {
            const itemType = card.dataset.itemType;

            if (filter === 'all') {
              card.classList.remove('hidden');
              visibleCount++;
            } else if (itemType === filter) {
              card.classList.remove('hidden');
              visibleCount++;
            } else {
              card.classList.add('hidden');
            }
          });

          // 표시되는 문항 수 업데이트
          if (itemCountEl) {
            itemCountEl.textContent = visibleCount;
          }
        });
      });
    }

    // 정답/채점기준 탭 기능
    const answerTabs = document.querySelectorAll('.answer-tab');
    const tabContents = document.querySelectorAll('.answer-tab-content');

    if (answerTabs.length > 0) {
      answerTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;

          // 활성 탭 업데이트
          answerTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');

          // 탭 콘텐츠 표시
          tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === 'tab-' + tabId) {
              content.classList.add('active');
            }
          });
        });
      });
    }

    // 정답지 PDF 업로드 기능
    const answerKeyFile = document.getElementById('answerKeyFile');
    const answerKeyDropZone = document.getElementById('answerKeyDropZone');
    const selectedAnswerFile = document.getElementById('selectedAnswerFile');
    const answerFileName = document.getElementById('answerFileName');
    const removeAnswerFile = document.getElementById('removeAnswerFile');
    const uploadAnswerKeyBtn = document.getElementById('uploadAnswerKeyBtn');

    console.log('[Answer Key Upload] Elements found:', {
      answerKeyFile: !!answerKeyFile,
      answerKeyDropZone: !!answerKeyDropZone,
      selectedAnswerFile: !!selectedAnswerFile,
      uploadAnswerKeyBtn: !!uploadAnswerKeyBtn
    });

    if (answerKeyFile && answerKeyDropZone) {
      // 파일 선택 시
      answerKeyFile.addEventListener('change', function() {
        console.log('[Answer Key Upload] File change event, files:', this.files.length);
        if (this.files.length > 0) {
          showSelectedFile(this.files[0]);
        }
      });

      // 드래그 앤 드롭
      answerKeyDropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
      });

      answerKeyDropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
      });

      answerKeyDropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
          answerKeyFile.files = files;
          showSelectedFile(files[0]);
        }
      });

      // 파일 제거
      if (removeAnswerFile) {
        removeAnswerFile.addEventListener('click', function() {
          answerKeyFile.value = '';
          hideSelectedFile();
        });
      }

      function showSelectedFile(file) {
        console.log('[Answer Key Upload] showSelectedFile called:', file.name);
        if (answerFileName) answerFileName.textContent = file.name;
        if (selectedAnswerFile) selectedAnswerFile.style.display = 'flex';
        if (uploadAnswerKeyBtn) {
          uploadAnswerKeyBtn.disabled = false;
          console.log('[Answer Key Upload] Button enabled');
        }

        // 레이블 숨김
        const label = answerKeyDropZone.querySelector('.upload-label');
        if (label) label.style.display = 'none';
      }

      function hideSelectedFile() {
        if (selectedAnswerFile) selectedAnswerFile.style.display = 'none';
        if (uploadAnswerKeyBtn) uploadAnswerKeyBtn.disabled = true;

        // 레이블 표시
        const label = answerKeyDropZone.querySelector('.upload-label');
        if (label) label.style.display = 'flex';
      }

      // 폼 제출 시 로딩 상태 표시
      const uploadForm = document.querySelector('.answer-key-upload-form');
      console.log('[Answer Key Upload] Form found:', !!uploadForm);
      if (uploadForm) {
        console.log('[Answer Key Upload] Form action:', uploadForm.action);
        uploadForm.addEventListener('submit', function(e) {
          console.log('[Answer Key Upload] Form submit triggered');
          console.log('[Answer Key Upload] File input files:', answerKeyFile.files.length);
          if (uploadAnswerKeyBtn) {
            const loadingText = uploadAnswerKeyBtn.dataset.loadingText || '분석 중...';
            uploadAnswerKeyBtn.value = loadingText;
            uploadAnswerKeyBtn.disabled = true;
            uploadAnswerKeyBtn.classList.add('loading');
          }
        });
      }
    }

    // 템플릿 파일 업로드 기능
    const templateFile = document.getElementById('templateFile');
    const templateDropZone = document.getElementById('templateDropZone');
    const templateFileName = document.getElementById('templateFileName');
    const uploadTemplateBtn = document.getElementById('uploadTemplateBtn');

    console.log('[Template Upload] Elements found:', {
      templateFile: !!templateFile,
      templateDropZone: !!templateDropZone,
      templateFileName: !!templateFileName,
      uploadTemplateBtn: !!uploadTemplateBtn
    });

    if (templateFile && templateDropZone) {
      // 파일 선택 시
      templateFile.addEventListener('change', function() {
        console.log('[Template Upload] File change event, files:', this.files.length);
        if (this.files.length > 0) {
          showTemplateFile(this.files[0]);
        } else {
          hideTemplateFile();
        }
      });

      // 드래그 앤 드롭
      templateDropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
      });

      templateDropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
      });

      templateDropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          const validTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
          const validExtensions = ['.csv', '.xlsx'];
          const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));

          if (validTypes.includes(file.type) || hasValidExtension) {
            templateFile.files = files;
            showTemplateFile(files[0]);
          } else {
            alert('CSV 또는 Excel 파일만 업로드할 수 있습니다.');
          }
        }
      });

      function showTemplateFile(file) {
        console.log('[Template Upload] showTemplateFile called:', file.name);
        if (templateFileName) templateFileName.textContent = file.name;
        if (templateDropZone) templateDropZone.classList.add('has-file');
        if (uploadTemplateBtn) {
          uploadTemplateBtn.disabled = false;
          console.log('[Template Upload] Button enabled');
        }
      }

      function hideTemplateFile() {
        if (templateFileName) templateFileName.textContent = '';
        if (templateDropZone) templateDropZone.classList.remove('has-file');
        if (uploadTemplateBtn) uploadTemplateBtn.disabled = true;
      }

      // 폼 제출 시 로딩 상태 표시
      const templateUploadForm = document.querySelector('.template-upload-form');
      console.log('[Template Upload] Form found:', !!templateUploadForm);
      if (templateUploadForm) {
        console.log('[Template Upload] Form action:', templateUploadForm.action);
        templateUploadForm.addEventListener('submit', function(e) {
          console.log('[Template Upload] Form submit triggered');
          console.log('[Template Upload] File input files:', templateFile.files.length);
          if (uploadTemplateBtn) {
            uploadTemplateBtn.value = '등록 중...';
            uploadTemplateBtn.disabled = true;
            uploadTemplateBtn.classList.add('loading');
          }
        });
      }
    }
  });
</script>
