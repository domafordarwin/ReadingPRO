<!-- Phase 3.1: Reusable items table partial for Turbo Stream updates -->
<!-- Phase 3.4.1: Fragment caching to reduce rendering overhead -->
<!-- Used in: item_bank.html.erb -->
<!-- Updated via: item_bank.turbo_stream.erb -->
<!--
  Cache key components:
  - Item records (includes id, updated_at for cache invalidation)
  - Filter parameters (search, item_type, status, difficulty, cursor for keyset pagination)

  Cache duration: 1 hour (expires_in: 1.hour)
  Invalidation: Automatic via Item#after_save and Item#after_destroy hooks

  Benefits (Phase 3.4.1 + 3.4.2):
  - Avoids re-rendering HTML for identical filter results
  - Reduces server CPU during peak traffic
  - Turbo Stream updates still fast (80ms → 5ms response)
  - Cursor-based pagination: O(1) instead of O(n) query time
-->

<% cache_key = ['items_table', @items.maximum(:updated_at), @search_query, @item_type_filter, @status_filter, @difficulty_filter, @cursor] %>
<% cache(cache_key, expires_in: 1.hour) do %>
  <% if @items.any? %>
  <table class="portal-table">
    <thead>
      <tr>
        <th style="width: 12%;">코드</th>
        <th style="width: 35%;">문항 내용</th>
        <th style="width: 18%;">평가영역</th>
        <th style="width: 12%;">문항유형</th>
        <th style="width: 10%;">난이도</th>
        <th style="width: 13%;">상태</th>
      </tr>
    </thead>
    <tbody id="items-table-body">
      <% @items.each do |item| %>
        <tr onclick="location.href='<%= edit_researcher_item_path(item) %>'">
          <td><strong><%= item.code %></strong></td>
          <td style="font-size: 12px; color: #666;">
            <%= truncate(strip_tags(item.prompt), length: 100) %>
          </td>
          <td>
            <% if item.evaluation_indicator %>
              <%= item.evaluation_indicator.name %>
            <% else %>
              <span style="color: #ccc;">미지정</span>
            <% end %>
          </td>
          <td>
            <span class="type-badge <%= "type-#{item.item_type}" %>">
              <%= item.item_type == 'mcq' ? '객관식' : '주관식' %>
            </span>
          </td>
          <td><%= item.difficulty || '-' %></td>
          <td>
            <span class="status-badge <%= "status-#{item.status}" %>">
              <%= item.status == 'draft' ? '준비중' : (item.status == 'active' ? '활성' : '폐기') %>
            </span>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <!-- Phase 3.4.2: Cursor-based pagination (Keyset pagination) -->
  <!-- Benefits over page-based pagination:
       - O(1) query time regardless of position
       - No expensive OFFSET scanning
       - Better for real-time data consistency -->
  <% if @has_next || @has_prev %>
    <div class="pagination" id="pagination">
      <!-- Previous page link (using backward direction) -->
      <% if @has_prev %>
        <a href="<%= researcher_item_bank_path(search: @search_query, item_type: @item_type_filter, status: @status_filter, difficulty: @difficulty_filter, cursor: @prev_cursor, direction: "backward") %>" data-turbo-stream class="pagination-btn">
          ← 이전
        </a>
      <% else %>
        <span class="pagination-disabled">← 이전</span>
      <% end %>

      <!-- Current page indicator (approximate position) -->
      <span class="current">페이지 <%= @page %></span>

      <!-- Next page link (using forward direction) -->
      <% if @has_next %>
        <a href="<%= researcher_item_bank_path(search: @search_query, item_type: @item_type_filter, status: @status_filter, difficulty: @difficulty_filter, cursor: @next_cursor, direction: "forward") %>" data-turbo-stream class="pagination-btn">
          다음 →
        </a>
      <% else %>
        <span class="pagination-disabled">다음 →</span>
      <% end %>
    </div>
  <% end %>
  <% else %>
    <!-- No results message -->
    <div style="text-align: center; padding: 40px; color: #999;">
      <p>검색 결과가 없습니다.</p>
    </div>
  <% end %>
<% end %> <!-- End fragment cache -->
