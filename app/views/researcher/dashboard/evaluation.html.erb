<% content_for :portal_title do %>
  í‰ê°€ ì˜ì—­
<% end %>
<% content_for :portal_subtitle do %>
  í‰ê°€ ì˜ì—­ë³„ ë¬¸í•­ êµ¬ì„±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :evaluation %>
<% end %>

<style>
  .evaluation-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 32px;
  }

  .evaluation-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 24px;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .evaluation-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
  }

  .evaluation-card__icon {
    width: 56px;
    height: 56px;
    background: #f0f0f0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    font-size: var(--rp-font-size-2xl);
  }

  .evaluation-card__title {
    font-size: var(--rp-font-size-md);
    font-weight: var(--rp-font-weight-semibold);
    color: #333;
    margin-bottom: 12px;
  }

  .evaluation-card__meta {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    font-size: var(--rp-font-size-sm);
    color: #666;
  }

  .evaluation-card__meta-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .evaluation-card__meta-label {
    color: #999;
    font-size: var(--rp-font-size-xs);
    text-transform: uppercase;
    font-weight: var(--rp-font-weight-semibold);
    letter-spacing: 0.5px;
  }

  .evaluation-card__meta-value {
    color: #333;
    font-weight: var(--rp-font-weight-semibold);
    font-size: var(--rp-font-size-lg);
  }

  .evaluation-card__progress {
    margin-bottom: 16px;
  }

  .evaluation-card__progress-label {
    font-size: var(--rp-font-size-xs);
    color: #666;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
  }

  .evaluation-card__progress-bar {
    height: 6px;
    background: #f0f0f0;
    border-radius: 3px;
    overflow: hidden;
  }

  .evaluation-card__progress-fill {
    height: 100%;
    background: linear-gradient(to right, #667eea, #764ba2);
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  .evaluation-card__footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
  }

  .evaluation-card__status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-semibold);
  }

  .evaluation-card__status--active {
    background: #d4edda;
    color: #155724;
  }

  .evaluation-card__status--review {
    background: #fff3cd;
    color: #856404;
  }

  .evaluation-card__action {
    color: #667eea;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-semibold);
    cursor: pointer;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .evaluation-card__action:hover {
    color: #764ba2;
  }

  .evaluation-summary {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 32px;
  }

  .evaluation-summary__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f0f0f0;
  }

  .evaluation-summary__title {
    font-size: var(--rp-font-size-md);
    font-weight: var(--rp-font-weight-semibold);
    color: #333;
  }

  .evaluation-summary__total {
    font-size: var(--rp-font-size-2xl);
    font-weight: var(--rp-font-weight-bold);
    color: #667eea;
  }

  .evaluation-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }

  .evaluation-stat {
    text-align: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
  }

  .evaluation-stat__label {
    font-size: var(--rp-font-size-xs);
    color: #666;
    margin-bottom: 8px;
    font-weight: var(--rp-font-weight-semibold);
  }

  .evaluation-stat__value {
    font-size: var(--rp-font-size-2xl);
    font-weight: var(--rp-font-weight-bold);
    color: #333;
  }

  @media (max-width: 1200px) {
    .evaluation-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .evaluation-stats {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .evaluation-grid {
      grid-template-columns: 1fr;
    }

    .evaluation-stats {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- í‰ê°€ ì˜ì—­ í†µê³„ -->
<div class="evaluation-summary">
  <div class="evaluation-summary__header">
    <h2 class="evaluation-summary__title">í‰ê°€ ì˜ì—­ í˜„í™©</h2>
    <div class="evaluation-summary__total">
      <%= @total_indicators %><span style="font-size: var(--rp-font-size-sm); color: #666; margin-left: 4px;">ê°œ</span>
    </div>
  </div>

  <div class="evaluation-stats">
    <div class="evaluation-stat">
      <div class="evaluation-stat__label">í™œì„± ì˜ì—­</div>
      <div class="evaluation-stat__value"><%= @active_indicators %></div>
    </div>
    <div class="evaluation-stat">
      <div class="evaluation-stat__label">ê²€í† ì¤‘ ì˜ì—­</div>
      <div class="evaluation-stat__value"><%= @review_indicators %></div>
    </div>
    <div class="evaluation-stat">
      <div class="evaluation-stat__label">í‰ê·  ë¬¸í•­ ìˆ˜</div>
      <div class="evaluation-stat__value"><%= @average_items %></div>
    </div>
    <div class="evaluation-stat">
      <div class="evaluation-stat__label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
      <div class="evaluation-stat__value" style="font-size: var(--rp-font-size-sm);"><%= @last_updated.strftime("%m/%d") %></div>
    </div>
  </div>
</div>

<!-- í‰ê°€ ì˜ì—­ ì¹´ë“œ -->
<div class="evaluation-grid">
  <% @indicators.each do |indicator| %>
    <%
      total_items = indicator.items.count
      mcq_items = indicator.items.where(item_type: 'mcq').count
      constructed_items = indicator.items.where(item_type: 'constructed').count
      active_items = indicator.items.where(status: 'active').count
      completion_percent = total_items > 0 ? (active_items.to_f / total_items * 100).round : 0
      is_active = active_items > 0
      is_review = total_items > 0 && active_items == 0
    %>
    <div class="evaluation-card">
      <div class="evaluation-card__icon">ğŸ“š</div>
      <h3 class="evaluation-card__title"><%= indicator.name %></h3>

      <div class="evaluation-card__meta">
        <div class="evaluation-card__meta-item">
          <span class="evaluation-card__meta-label">ë¬¸í•­ ìˆ˜</span>
          <span class="evaluation-card__meta-value"><%= total_items %></span>
        </div>
        <div class="evaluation-card__meta-item">
          <span class="evaluation-card__meta-label">MCQ</span>
          <span class="evaluation-card__meta-value"><%= mcq_items %></span>
        </div>
        <div class="evaluation-card__meta-item">
          <span class="evaluation-card__meta-label">ì£¼ê´€ì‹</span>
          <span class="evaluation-card__meta-value"><%= constructed_items %></span>
        </div>
      </div>

      <div class="evaluation-card__progress">
        <div class="evaluation-card__progress-label">
          <span>ì™„ì„±ë„</span>
          <span><%= completion_percent %>%</span>
        </div>
        <div class="evaluation-card__progress-bar">
          <div class="evaluation-card__progress-fill" style="width: <%= completion_percent %>%;"></div>
        </div>
      </div>

      <div class="evaluation-card__footer">
        <% if is_active %>
          <span class="evaluation-card__status evaluation-card__status--active">í™œì„±</span>
        <% elsif is_review %>
          <span class="evaluation-card__status evaluation-card__status--review">ê²€í† ì¤‘</span>
        <% else %>
          <span class="evaluation-card__status">ì¤€ë¹„ì¤‘</span>
        <% end %>
        <%= link_to "ê´€ë¦¬ â†’", researcher_item_bank_path(search: indicator.code), class: "evaluation-card__action" %>
      </div>
    </div>
  <% end %>
</div>

<!-- ì„¸ë¶€ ì˜ì—­ êµ¬ì„± -->
<div class="portal-card">
  <div class="portal-card__header">
    <h3 class="portal-card__title">ì„¸ë¶€ í‰ê°€ ì§€í‘œ</h3>
  </div>
  <div class="portal-card__body">
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
      <% @indicators.each_with_index do |indicator, index| %>
        <% next if indicator.sub_indicators.empty? %>
        <% grid_column = (indicator.sub_indicators.count > 5 || index == @indicators.count - 1) ? "grid-column: 1 / -1;" : "" %>
        <div style="<%= grid_column %>">
          <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #333; margin-bottom: 12px;">
            ğŸ“š <%= indicator.name %>
          </h4>
          <ul style="list-style: none; padding: 0; margin: 0; display: <%= indicator.sub_indicators.count > 3 ? 'grid' : 'flex' %>; <%= indicator.sub_indicators.count > 3 ? 'grid-template-columns: repeat(3, 1fr);' : 'flex-direction: column;' %> gap: 8px;">
            <% indicator.sub_indicators.each do |sub_indicator| %>
              <% sub_item_count = sub_indicator.items.count %>
              <li style="font-size: var(--rp-font-size-sm); color: #666; padding: 8px 12px; background: #f8f9fa; border-radius: 4px;">
                âœ“ <%= sub_indicator.name %>
                <span style="<%= indicator.sub_indicators.count > 3 ? 'display: block; margin-top: 4px;' : 'float: right;' %> font-weight: var(--rp-font-weight-semibold); color: #667eea;"><%= sub_item_count %>ë¬¸í•­</span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if @indicators.all? { |ind| ind.sub_indicators.empty? } %>
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
          <p>ë“±ë¡ëœ ì„¸ë¶€ í‰ê°€ ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>
