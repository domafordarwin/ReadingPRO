<% content_for :portal_title do %>
  문항 관리
<% end %>
<% content_for :portal_subtitle do %>
  새로운 문항을 등록하세요.
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :items %>
<% end %>

<style>
  .item-create-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e0e0e0;
  }

  .page-header h1 {
    font-size: var(--rp-font-size-2xl);
    font-weight: var(--rp-font-weight-bold);
    color: #333;
    margin: 0;
  }

  .form-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
  }

  .form-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f0f0f0;
  }

  .card-header-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: var(--rp-font-weight-bold);
    font-size: var(--rp-font-size-md);
  }

  .card-header-title {
    font-size: var(--rp-font-size-lg);
    font-weight: var(--rp-font-weight-bold);
    color: #333;
    margin: 0;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }

  .form-grid.two-col {
    grid-template-columns: repeat(2, 1fr);
  }

  .form-grid.full {
    grid-template-columns: 1fr;
  }

  .form-field {
    display: flex;
    flex-direction: column;
  }

  .form-field label {
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    color: #333;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .required-badge {
    background: #e74c3c;
    color: white;
    font-size: var(--rp-font-size-xs);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: var(--rp-font-weight-bold);
  }

  .form-field input[type="text"],
  .form-field select,
  .form-field textarea {
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: var(--rp-font-size-sm);
    font-family: inherit;
    transition: all 0.2s;
  }

  .form-field input:focus,
  .form-field select:focus,
  .form-field textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  }

  .form-field textarea {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }

  .form-field .help-text {
    font-size: var(--rp-font-size-xs);
    color: #999;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .help-icon {
    width: 14px;
    height: 14px;
    display: inline-block;
  }

  .action-bar {
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 24px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
  }

  .btn {
    padding: 14px 28px;
    border: none;
    border-radius: 8px;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: white;
    color: #666;
    border: 2px solid #e0e0e0;
  }

  .btn-secondary:hover {
    background: #f8f9fa;
    border-color: #667eea;
    color: #667eea;
  }

  .btn-icon {
    width: 16px;
    height: 16px;
  }

  .info-box {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .info-box p {
    margin: 0;
    font-size: var(--rp-font-size-sm);
    color: #1976d2;
    line-height: 1.6;
  }

  @media (max-width: 1024px) {
    .form-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .form-grid,
    .form-grid.two-col {
      grid-template-columns: 1fr;
    }

    .action-bar {
      flex-direction: column;
      gap: 16px;
    }

    .action-buttons {
      width: 100%;
      flex-direction: column;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* Rich text editor */
  .rp-editor-toolbar {
    display: flex;
    gap: 4px;
    padding: 6px 8px;
    background: #f8fafc;
    border: 1px solid #e0e0e0;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
  }

  .rp-fmt-btn {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 2px 8px;
    cursor: pointer;
    font-size: var(--rp-font-size-sm);
    line-height: 1.4;
    color: #334155;
    min-width: 28px;
    text-align: center;
  }
  .rp-fmt-btn:hover { background: #e2e8f0; }

  .rp-contenteditable {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 0 0 6px 6px;
    font-size: var(--rp-font-size-sm);
    line-height: 1.8;
    outline: none;
    overflow-y: auto;
  }

  .rp-contenteditable:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .rp-contenteditable:empty::before {
    content: attr(data-placeholder);
    color: #9ca3af;
    pointer-events: none;
  }

  .rp-contenteditable u { text-decoration: underline; }
  .rp-contenteditable b, .rp-contenteditable strong { font-weight: var(--rp-font-weight-bold); }
  .rp-contenteditable i, .rp-contenteditable em { font-style: italic; }
  .rp-contenteditable s { text-decoration: line-through; }
</style>

<div class="item-create-container">
  <div class="page-header">
    <h1>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
      </svg>
      새 문항 등록
    </h1>
  </div>

  <div class="info-box">
    <p>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
      문항을 등록한 후 정답 및 선택지를 설정할 수 있습니다. 필수 항목을 모두 입력한 후 등록 버튼을 클릭하세요.
    </p>
  </div>

  <form action="<%= researcher_items_path %>" method="post" data-turbo="false">
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

    <!-- 기본 정보 카드 -->
    <div class="form-card">
      <div class="card-header">
        <div class="card-header-icon">1</div>
        <h2 class="card-header-title">기본 정보</h2>
      </div>

      <div class="form-grid">
        <div class="form-field">
          <label>
            문항 코드
            <span class="required-badge">필수</span>
          </label>
          <input type="text" name="item[code]" placeholder="예: RP-E-001" required>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            고유한 문항 식별 코드
          </span>
        </div>

        <div class="form-field">
          <label>
            문항 유형
            <span class="required-badge">필수</span>
          </label>
          <select name="item[item_type]" required>
            <option value="">선택하세요</option>
            <option value="mcq">객관식 (MCQ)</option>
            <option value="constructed">주관식 (Constructed)</option>
          </select>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            객관식 또는 주관식 선택
          </span>
        </div>

        <div class="form-field">
          <label>난이도</label>
          <select name="item[difficulty]">
            <option value="">선택하세요</option>
            <option value="hard">상 (어려움)</option>
            <option value="medium">중 (보통)</option>
            <option value="easy">하 (쉬움)</option>
          </select>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            문항의 난이도 수준
          </span>
        </div>
      </div>
    </div>

    <!-- 평가 지표 카드 -->
    <div class="form-card">
      <div class="card-header">
        <div class="card-header-icon">2</div>
        <h2 class="card-header-title">평가 지표</h2>
      </div>

      <div class="form-grid two-col">
        <div class="form-field">
          <label>
            평가 영역
            <span class="required-badge">필수</span>
          </label>
          <select name="item[evaluation_indicator_id]" required>
            <option value="">선택하세요</option>
            <% @evaluation_indicators.each do |indicator| %>
              <option value="<%= indicator.id %>"><%= indicator.name %></option>
            <% end %>
          </select>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            문항이 평가하는 주요 영역
          </span>
        </div>

        <div class="form-field">
          <label>세부 지표</label>
          <select name="item[sub_indicator_id]">
            <option value="">선택하세요</option>
            <% @sub_indicators.each do |sub_indicator| %>
              <option value="<%= sub_indicator.id %>"><%= sub_indicator.name %></option>
            <% end %>
          </select>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            구체적인 세부 평가 지표
          </span>
        </div>
      </div>
    </div>

    <!-- 문항 내용 카드 -->
    <div class="form-card">
      <div class="card-header">
        <div class="card-header-icon">3</div>
        <h2 class="card-header-title">문항 내용</h2>
      </div>

      <div class="form-grid full">
        <div class="form-field">
          <label>
            문항 내용 (Prompt)
            <span class="required-badge">필수</span>
          </label>
          <small class="help-text" style="margin-bottom: 6px;">
            <strong>굵게</strong>, <em>기울임</em>, <u>밑줄</u> 서식을 적용할 수 있습니다. (Ctrl+B / Ctrl+I / Ctrl+U)
          </small>
          <div class="rp-editor-toolbar">
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('bold')" title="굵게 (Ctrl+B)"><strong>B</strong></button>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('italic')" title="기울임 (Ctrl+I)"><em>I</em></button>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('underline')" title="밑줄 (Ctrl+U)"><u>U</u></button>
            <span style="border-left: 1px solid #e0e0e0; margin: 0 4px;"></span>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('strikeThrough')" title="취소선"><s>S</s></button>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('removeFormat')" title="서식 제거" style="font-size: var(--rp-font-size-xs);">✕</button>
          </div>
          <div contenteditable="true"
               id="prompt-editor"
               class="rp-contenteditable"
               oninput="syncPrompt()"
               data-placeholder="학생에게 제시될 문항 내용을 입력하세요"></div>
          <input type="hidden" name="item[prompt]" id="prompt-hidden" value="">
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            학생이 보게 될 문항 질문
          </span>
        </div>
      </div>

      <div class="form-grid full">
        <div class="form-field">
          <label>해설</label>
          <textarea name="item[explanation]" placeholder="정답과 관련된 해설을 입력하세요 (선택사항)"></textarea>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            정답 해설 및 피드백
          </span>
        </div>
      </div>

      <div class="form-grid two-col">
        <div class="form-field">
          <label>관련 지문</label>
          <select name="item[stimulus_id]">
            <option value="">선택하세요</option>
            <% @reading_stimuli.each do |stimulus| %>
              <option value="<%= stimulus.id %>">#<%= stimulus.id %> - <%= truncate(stimulus.title, length: 50) %></option>
            <% end %>
          </select>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            문항과 연결된 지문 선택
          </span>
        </div>

        <div class="form-field">
          <label>초기 상태</label>
          <select name="item[status]">
            <option value="draft" selected>준비중 (Draft)</option>
            <option value="active">활성 (Active)</option>
            <option value="archived">폐기 (Archived)</option>
          </select>
          <span class="help-text">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            문항의 초기 상태 설정
          </span>
        </div>
      </div>
    </div>

    <!-- 액션 바 -->
    <div class="action-bar">
      <div style="font-size: var(--rp-font-size-sm); color: #666;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span style="font-weight: var(--rp-font-weight-semibold);">필수 항목:</span> 문항 코드, 문항 유형, 평가 영역, 문항 내용
      </div>
      <div class="action-buttons">
        <button type="reset" class="btn btn-secondary">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="1 4 1 10 7 10"></polyline>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
          </svg>
          초기화
        </button>
        <a href="<%= researcher_items_path %>" class="btn btn-secondary">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          취소
        </a>
        <button type="submit" class="btn btn-primary">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 11 12 14 22 4"></polyline>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          문항 등록
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  // Sync contenteditable → hidden field
  function syncPrompt() {
    var editor = document.getElementById('prompt-editor');
    var hidden = document.getElementById('prompt-hidden');
    if (editor && hidden) hidden.value = editor.innerHTML;
  }

  // Format command for prompt editor
  function promptFmt(cmd) {
    var editor = document.getElementById('prompt-editor');
    if (editor) {
      editor.focus();
      document.execCommand(cmd, false, null);
      syncPrompt();
    }
  }

  // Reliable sync via click delegation (fires BEFORE submit event)
  document.addEventListener('click', function(e) {
    var btn = e.target.closest('button[type="submit"], input[type="submit"]');
    if (btn) syncPrompt();
  }, true);

  // Also sync on form submit event (safety net)
  document.addEventListener('submit', function() { syncPrompt(); }, true);

  document.addEventListener('keydown', function(e) {
    if (e.target.id !== 'prompt-editor') return;
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'b') { e.preventDefault(); document.execCommand('bold'); syncPrompt(); }
      if (e.key === 'i') { e.preventDefault(); document.execCommand('italic'); syncPrompt(); }
      if (e.key === 'u') { e.preventDefault(); document.execCommand('underline'); syncPrompt(); }
    }
  });
</script>
