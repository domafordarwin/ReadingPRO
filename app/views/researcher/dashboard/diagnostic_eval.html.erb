<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-cache">
<% end %>

<% content_for :portal_title do %>
  진단지 구성
<% end %>
<% content_for :portal_subtitle do %>
  여러 평가 모듈을 조합하여 진단지를 구성하고 관리합니다.
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :scoring %>
<% end %>

<style>
  .diagnostic-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .action-btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .action-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .action-btn-outline {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .action-btn-outline:hover {
    background: #f9fafb;
    border-color: #667eea;
    color: #667eea;
  }

  .action-btn-sm {
    padding: 6px 12px;
    font-size: var(--rp-font-size-sm);
  }

  .action-btn-danger:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: #fef2f2;
  }

  .action-btn-publish {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .action-btn-publish:hover {
    background: #28a745;
    color: white;
    border-color: #28a745;
  }

  .action-btn-unpublish {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }

  .action-btn-unpublish:hover {
    background: #ffc107;
    color: #333;
    border-color: #ffc107;
  }

  .diagnostic-search {
    margin-bottom: 24px;
    display: flex;
    gap: 12px;
  }

  .diagnostic-search input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: var(--rp-font-size-sm);
  }

  .diagnostic-search button {
    padding: 10px 24px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: var(--rp-font-weight-semibold);
  }

  .diagnostic-search button:hover {
    background: #764ba2;
  }

  .diagnostic-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .diagnostic-stat {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    text-align: center;
  }

  .diagnostic-stat__label {
    font-size: var(--rp-font-size-xs);
    color: #666;
    font-weight: var(--rp-font-weight-semibold);
    margin-bottom: 8px;
  }

  .diagnostic-stat__value {
    font-size: var(--rp-font-size-2xl);
    font-weight: var(--rp-font-weight-bold);
    color: #333;
  }

  .diagnostic-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .diagnostic-list-item {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
  }

  .diagnostic-list-item:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
  }

  .diagnostic-list-item__content {
    flex: 1;
    min-width: 0;
  }

  .diagnostic-list-item__title {
    font-weight: var(--rp-font-weight-semibold);
    color: #333;
    margin-bottom: 8px;
  }

  .diagnostic-list-item__meta {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .diagnostic-list-item__count {
    font-size: var(--rp-font-size-sm);
    color: #666;
  }

  .diagnostic-list-item__actions {
    display: flex;
    gap: 8px;
    margin-left: 16px;
  }

  .diagnostic-status {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-semibold);
  }

  .diagnostic-status--draft {
    background: #fff3cd;
    color: #856404;
  }

  .diagnostic-status--active {
    background: #d4edda;
    color: #155724;
  }

  .diagnostic-empty {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .diagnostic-empty__icon {
    font-size: var(--rp-font-size-2xl);
    margin-bottom: 16px;
  }

  .diagnostic-empty__message {
    font-size: var(--rp-font-size-md);
    margin-bottom: 8px;
  }

  .diagnostic-empty__submessage {
    font-size: var(--rp-font-size-sm);
    color: #999;
  }

  .diagnostic-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 24px;
  }

  .diagnostic-pagination a,
  .diagnostic-pagination span {
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: var(--rp-font-size-xs);
    text-decoration: none;
    color: #667eea;
  }

  .diagnostic-pagination a:hover {
    background: #f8f9fa;
  }

  .diagnostic-pagination .active {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .diagnostic-pagination .disabled {
    color: #ccc;
    cursor: not-allowed;
  }

  /* 커버리지 칩 */
  .diagnostic-list-item__coverage {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  .cov-chip {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-semibold);
  }

  .cov-chip--ok {
    background: #dcfce7;
    color: #166534;
  }

  .cov-chip--warn {
    background: #fef3c7;
    color: #92400e;
  }

  .cov-chip--danger {
    background: #fee2e2;
    color: #991b1b;
  }

  .cov-detail-toggle {
    background: none;
    border: none;
    font-size: var(--rp-font-size-xs);
    color: #667eea;
    cursor: pointer;
    padding: 2px 6px;
    font-weight: var(--rp-font-weight-medium);
  }

  .cov-detail-toggle:hover {
    text-decoration: underline;
  }

  .cov-detail {
    display: none;
    margin-top: 8px;
    padding: 10px 12px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
  }

  .cov-detail--open {
    display: block;
  }

  .cov-detail-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 0;
  }

  .cov-detail-row + .cov-detail-row {
    border-top: 1px solid #e2e8f0;
    padding-top: 6px;
    margin-top: 2px;
  }

  .cov-detail-indicator {
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-semibold);
    min-width: 120px;
    flex-shrink: 0;
  }

  .cov-detail-indicator--ok { color: #166534; }
  .cov-detail-indicator--miss { color: #991b1b; }

  .cov-detail-subs {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }

  .cov-sub {
    display: inline-block;
    padding: 1px 7px;
    border-radius: 10px;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-medium);
  }

  .cov-sub--ok {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
  }

  .cov-sub--miss {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  @media (max-width: 768px) {
    .diagnostic-header {
      flex-direction: column;
      align-items: stretch;
      gap: 16px;
    }

    .diagnostic-search {
      flex-direction: column;
    }

    .diagnostic-stats {
      grid-template-columns: repeat(2, 1fr);
    }

    .action-btn-publish,
    .action-btn-unpublish {
      flex: 1;
    }

    .diagnostic-list-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .diagnostic-list-item__content {
      width: 100%;
    }

    .diagnostic-list-item__meta {
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
    }

    .diagnostic-list-item__actions {
      width: 100%;
      margin-left: 0;
    }

    .action-btn {
      flex: 1;
    }
  }
</style>

<!-- 검색 기능 -->
<%= form_with url: researcher_diagnostic_eval_path, method: :get, local: true, class: "diagnostic-search" do |f| %>
  <%= f.text_field :search, placeholder: "진단지명으로 검색...", value: @search_query %>
  <%= f.submit "검색", class: "btn-primary" %>
<% end %>

<!-- 통계 -->
<div class="diagnostic-stats">
  <div class="diagnostic-stat">
    <div class="diagnostic-stat__label">총 진단지</div>
    <div class="diagnostic-stat__value"><%= @total_count %></div>
  </div>
  <div class="diagnostic-stat">
    <div class="diagnostic-stat__label">배포됨</div>
    <div class="diagnostic-stat__value" style="color: #28a745;"><%= DiagnosticForm.active.count %></div>
  </div>
  <div class="diagnostic-stat">
    <div class="diagnostic-stat__label">준비중</div>
    <div class="diagnostic-stat__value" style="color: #856404;"><%= DiagnosticForm.draft.count %></div>
  </div>
  <div class="diagnostic-stat">
    <div class="diagnostic-stat__label">배정된 학교 수</div>
    <div class="diagnostic-stat__value" style="color: #667eea;"><%= DiagnosticAssignment.where.not(school_id: nil).select(:school_id).distinct.count %></div>
  </div>
</div>

<section class="portal-card">
  <div class="diagnostic-header">
    <h2 class="portal-card-title">진단지 목록</h2>
    <%= link_to new_researcher_diagnostic_form_path, class: "action-btn action-btn-primary" do %>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      <span>새 진단지 만들기</span>
    <% end %>
  </div>

  <% if @forms.any? %>
    <div class="diagnostic-list">
      <% @forms.each do |form| %>
        <div class="diagnostic-list-item">
          <div class="diagnostic-list-item__content">
            <div class="diagnostic-list-item__title"><%= form.name %></div>
            <div class="diagnostic-list-item__meta">
              <div class="diagnostic-list-item__count">
                문항 수: <strong><%= form.item_count || 0 %></strong>개
              </div>
              <span class="diagnostic-status diagnostic-status--<%= form.status %>">
                <%= form.status == 'draft' ? '준비중' : '배포됨' %>
              </span>
            </div>
            <% cov = @form_coverages[form.id] %>
            <% if cov && (form.item_count || 0) > 0 %>
              <div class="diagnostic-list-item__coverage">
                <span class="cov-chip <%= cov[:covered_ei] == cov[:total_ei] ? 'cov-chip--ok' : 'cov-chip--warn' %>">
                  평가영역 <%= cov[:covered_ei] %>/<%= cov[:total_ei] %>
                </span>
                <span class="cov-chip <%= cov[:covered_si] == cov[:total_si] ? 'cov-chip--ok' : 'cov-chip--warn' %>">
                  하위영역 <%= cov[:covered_si] %>/<%= cov[:total_si] %>
                </span>
                <% if cov[:unmapped] > 0 %>
                  <span class="cov-chip cov-chip--danger">미매핑 <%= cov[:unmapped] %></span>
                <% end %>
                <button type="button" class="cov-detail-toggle" onclick="this.parentElement.nextElementSibling.classList.toggle('cov-detail--open'); this.textContent = this.textContent === '상세 ▾' ? '접기 ▴' : '상세 ▾'">상세 ▾</button>
              </div>
              <div class="cov-detail">
                <% @all_indicators.each do |ei| %>
                  <% ei_cnt = cov[:indicator_counts][ei.id].to_i %>
                  <div class="cov-detail-row">
                    <span class="cov-detail-indicator <%= ei_cnt > 0 ? 'cov-detail-indicator--ok' : 'cov-detail-indicator--miss' %>">
                      <%= ei_cnt > 0 ? "\u2713" : "\u2717" %> <%= ei.name %> (<%= ei_cnt %>)
                    </span>
                    <span class="cov-detail-subs">
                      <% ei.sub_indicators.each do |si| %>
                        <% si_cnt = cov[:sub_indicator_counts][si.id].to_i %>
                        <span class="cov-sub <%= si_cnt > 0 ? 'cov-sub--ok' : 'cov-sub--miss' %>"><%= si.name %> (<%= si_cnt %>)</span>
                      <% end %>
                    </span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="diagnostic-list-item__actions">
            <% if form.draft? %>
              <%= button_to publish_researcher_diagnostic_form_path(form), method: :patch,
                  data: { turbo_confirm: "'#{form.name}' 진단지를 배포하시겠습니까?\n배포 후 진단교사가 학교에 배정할 수 있습니다." },
                  class: "action-btn action-btn-sm action-btn-publish" do %>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 11 12 14 22 4"></polyline>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                <span>배포</span>
              <% end %>
            <% elsif form.active? %>
              <%= button_to unpublish_researcher_diagnostic_form_path(form), method: :patch,
                  data: { turbo_confirm: "'#{form.name}' 진단지 배포를 취소하시겠습니까?" },
                  class: "action-btn action-btn-sm action-btn-unpublish" do %>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span>배포취소</span>
              <% end %>
            <% end %>
            <%= link_to researcher_diagnostic_form_path(form), class: "action-btn action-btn-outline action-btn-sm" do %>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span>보기</span>
            <% end %>
            <%= link_to edit_researcher_diagnostic_form_path(form), class: "action-btn action-btn-outline action-btn-sm" do %>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              <span>편집</span>
            <% end %>
            <%= button_to researcher_diagnostic_form_path(form), method: :delete,
                data: { turbo_confirm: "정말 이 진단지를 삭제하시겠습니까?" },
                class: "action-btn action-btn-outline action-btn-sm action-btn-danger" do %>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              <span>삭제</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 페이지네이션 -->
    <div class="diagnostic-pagination">
      <% if @page > 1 %>
        <%= link_to "← 이전", researcher_diagnostic_eval_path(page: @page - 1, search: @search_query) %>
      <% else %>
        <span class="disabled">← 이전</span>
      <% end %>

      <% (1..@total_pages).each do |page_num| %>
        <% if page_num == @page %>
          <span class="active"><%= page_num %></span>
        <% else %>
          <%= link_to page_num, researcher_diagnostic_eval_path(page: page_num, search: @search_query) %>
        <% end %>
      <% end %>

      <% if @page < @total_pages %>
        <%= link_to "다음 →", researcher_diagnostic_eval_path(page: @page + 1, search: @search_query) %>
      <% else %>
        <span class="disabled">다음 →</span>
      <% end %>
    </div>
  <% else %>
    <div class="diagnostic-empty">
      <div class="diagnostic-empty__icon">📋</div>
      <div class="diagnostic-empty__message">진단지가 없습니다</div>
      <div class="diagnostic-empty__submessage">
        <% if @search_query.present? %>
          "<%= @search_query %>"에 해당하는 진단지가 없습니다.
        <% else %>
          새로운 진단지를 추가해주세요.
        <% end %>
      </div>
    </div>
  <% end %>
</section>
