<% content_for :portal_title do %>
  ëª¨ë“ˆ ê´€ë¦¬
<% end %>
<% content_for :portal_subtitle do %>
  í‰ê°€ ëª¨ë“ˆ(ì§€ë¬¸ + ë¬¸í•­)ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ëª¨ë“ˆì„ ì¡°í•©í•˜ì—¬ ì§„ë‹¨ì§€ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :item_bank %>
<% end %>

<!-- í˜ì´ì§€ í—¤ë”: íƒ€ì´í‹€ + ì—…ë¡œë“œ ë²„íŠ¼ -->
<div class="page-header">
  <div class="page-header-left">
    <h1 class="page-title">í‰ê°€ ëª¨ë“ˆ</h1>
    <p class="page-description">ì´ <%= @total_count || @assessment_bundles.size %>ê°œì˜ í‰ê°€ ëª¨ë“ˆ</p>
  </div>
  <div class="page-header-right">
    <button type="button" class="btn-upload" onclick="toggleUploadPanel()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      <span>PDF ì—…ë¡œë“œ</span>
    </button>
  </div>
</div>

<!-- ì—…ë¡œë“œ íŒ¨ë„ (í† ê¸€) -->
<div id="upload-panel" class="upload-panel hidden">
  <div class="upload-panel-content">
    <div class="upload-panel-header">
      <h3>ìƒˆ ì§„ë‹¨ì§€ ì—…ë¡œë“œ</h3>
      <button type="button" class="btn-close" onclick="toggleUploadPanel()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <%= form_with url: researcher_upload_pdf_item_bank_path, method: :post, multipart: true, local: true, class: "upload-form-modern", id: "pdf-upload-form" do %>
      <div class="upload-dropzone" id="dropzone">
        <div class="upload-icon-wrapper">
          <svg class="upload-icon" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="12" y1="18" x2="12" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
          </svg>
          <div class="upload-sparkle">âœ¨</div>
        </div>
        <p class="upload-text">
          <span class="upload-text-main">PDFë¥¼ ì—¬ê¸°ì— ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</span>
        </p>
        <p class="upload-hint">
          <span class="upload-hint-icon">ğŸ¤–</span>
          <span>AIê°€ ì§€ë¬¸ê³¼ ë¬¸í•­ì„ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ëª¨ë“ˆì„ ìƒì„±í•©ë‹ˆë‹¤</span>
        </p>
        <div class="upload-features">
          <span class="upload-feature">ğŸ“ ì§€ë¬¸ ìë™ ì¶”ì¶œ</span>
          <span class="upload-feature">ğŸ”µ ê°ê´€ì‹ ìë™ ìƒì„±</span>
          <span class="upload-feature">ğŸŸ£ ì„œìˆ í˜• ìë™ ìƒì„±</span>
        </div>
        <input type="file" name="pdf_file" accept=".pdf" class="file-input-hidden" id="pdf-file-input" required>
      </div>

      <!-- ë ˆë²¨ ì„ íƒ -->
      <div class="grade-level-selector">
        <label class="grade-level-label">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          </svg>
          <span>í•™ë…„ ë ˆë²¨ ì„ íƒ <span class="required-mark">*</span></span>
        </label>
        <div class="grade-level-options">
          <label class="grade-level-option" data-level="elementary_low">
            <input type="radio" name="grade_level" value="elementary_low" required>
            <span class="grade-option-content">
              <span class="grade-option-badge" style="background: #4CAF50;">ì´ˆì €</span>
              <span class="grade-option-text">ì´ˆë“± 1-2í•™ë…„</span>
            </span>
          </label>
          <label class="grade-level-option" data-level="elementary_high">
            <input type="radio" name="grade_level" value="elementary_high">
            <span class="grade-option-content">
              <span class="grade-option-badge" style="background: #2196F3;">ì´ˆê³ </span>
              <span class="grade-option-text">ì´ˆë“± 3-6í•™ë…„</span>
            </span>
          </label>
          <label class="grade-level-option" data-level="middle_low">
            <input type="radio" name="grade_level" value="middle_low">
            <span class="grade-option-content">
              <span class="grade-option-badge" style="background: #FF9800;">ì¤‘ì €</span>
              <span class="grade-option-text">ì¤‘í•™ 1-2í•™ë…„</span>
            </span>
          </label>
          <label class="grade-level-option" data-level="middle_high">
            <input type="radio" name="grade_level" value="middle_high">
            <span class="grade-option-content">
              <span class="grade-option-badge" style="background: #9C27B0;">ì¤‘ê³ </span>
              <span class="grade-option-text">ì¤‘3~ê³ ë“±</span>
            </span>
          </label>
        </div>
      </div>

      <!-- í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
      <div class="upload-progress" id="upload-progress" style="display: none;">
        <div class="progress-info">
          <span class="progress-text" id="progress-text">íŒŒì¼ ì—…ë¡œë“œ ì¤‘...</span>
          <span class="progress-percentage" id="progress-percentage">0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
        <p class="progress-hint">PDFë¥¼ ë¶„ì„í•˜ê³  ë¬¸í•­ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>

        <!-- ì²˜ë¦¬ ë¡œê·¸ -->
        <div class="process-logs" id="process-logs" style="display: none;">
          <div class="logs-header">ì²˜ë¦¬ ê³¼ì •</div>
          <div class="logs-container" id="logs-container"></div>
        </div>
      </div>

      <div class="upload-actions">
        <span class="selected-file" id="selected-file-name"></span>
        <button type="submit" class="btn-submit-upload" id="submit-btn" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <span id="submit-btn-text">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
        </button>
      </div>
    <% end %>
  </div>
</div>

<!-- í†µê³„ ì¹´ë“œ -->
<div class="stats-row">
  <div class="stat-card-modern">
    <div class="stat-icon stat-icon-blue">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      </svg>
    </div>
    <div class="stat-info">
      <span class="stat-number"><%= @total_count || @assessment_bundles.size %></span>
      <span class="stat-text">ì „ì²´ ëª¨ë“ˆ</span>
    </div>
  </div>
  <div class="stat-card-modern">
    <div class="stat-icon stat-icon-green">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/>
      </svg>
    </div>
    <div class="stat-info">
      <span class="stat-number"><%= @assessment_bundles.sum(&:mcq_count) %></span>
      <span class="stat-text">ê°ê´€ì‹</span>
    </div>
  </div>
  <div class="stat-card-modern">
    <div class="stat-icon stat-icon-purple">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
      </svg>
    </div>
    <div class="stat-info">
      <span class="stat-number"><%= @assessment_bundles.sum(&:constructed_count) %></span>
      <span class="stat-text">ì„œìˆ í˜•</span>
    </div>
  </div>
  <div class="stat-card-modern">
    <div class="stat-icon stat-icon-indigo">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10"/>
      </svg>
    </div>
    <div class="stat-info">
      <span class="stat-number"><%= @assessment_bundles.count { |b| b.ai_analyzed? } %></span>
      <span class="stat-text">AI ë¶„ì„</span>
    </div>
  </div>
</div>

<!-- ê²€ìƒ‰ ë° í•„í„° -->
<div class="filters-bar">
  <%= form_with url: researcher_item_bank_path, method: :get, local: true, class: "filters-form-modern" do %>
    <div class="search-wrapper">
      <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input type="text" name="search" value="<%= @search_query %>" placeholder="ì½”ë“œ, ì œëª©, ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰..." class="search-input-modern">
    </div>
    <select name="bundle_status" class="filter-select-modern">
      <option value="">ì „ì²´ ìƒíƒœ</option>
      <% @available_bundle_statuses&.each do |status| %>
        <option value="<%= status %>" <%= 'selected' if @bundle_status_filter == status %>><%= status_label(status) %></option>
      <% end %>
    </select>
    <select name="difficulty" class="filter-select-modern">
      <option value="">ì „ì²´ ë‚œì´ë„</option>
      <option value="easy" <%= 'selected' if params[:difficulty] == 'easy' %>>ì‰¬ì›€</option>
      <option value="medium" <%= 'selected' if params[:difficulty] == 'medium' %>>ë³´í†µ</option>
      <option value="hard" <%= 'selected' if params[:difficulty] == 'hard' %>>ì–´ë ¤ì›€</option>
    </select>
    <select name="grade_level" class="filter-select-modern filter-grade-level">
      <option value="">ì „ì²´ ë ˆë²¨</option>
      <option value="elementary_low" <%= 'selected' if params[:grade_level] == 'elementary_low' %>>ì´ˆì € (ì´ˆ1-2)</option>
      <option value="elementary_high" <%= 'selected' if params[:grade_level] == 'elementary_high' %>>ì´ˆê³  (ì´ˆ3-6)</option>
      <option value="middle_low" <%= 'selected' if params[:grade_level] == 'middle_low' %>>ì¤‘ì € (ì¤‘1-2)</option>
      <option value="middle_high" <%= 'selected' if params[:grade_level] == 'middle_high' %>>ì¤‘ê³  (ì¤‘3-ê³ )</option>
    </select>
    <button type="submit" class="btn-search">ê²€ìƒ‰</button>
    <% if @search_query.present? || @bundle_status_filter.present? || params[:difficulty].present? || params[:grade_level].present? %>
      <%= link_to researcher_item_bank_path, class: "btn-reset" do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        ì´ˆê¸°í™”
      <% end %>
    <% end %>
  <% end %>
</div>

<!-- ì§„ë‹¨ì§€ ì„¸íŠ¸ ê·¸ë¦¬ë“œ -->
<div class="bundles-grid">
  <% if @assessment_bundles.empty? %>
    <div class="empty-state-modern">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
      </svg>
      <h3>ë“±ë¡ëœ ì§„ë‹¨ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>PDFë¥¼ ì—…ë¡œë“œí•˜ì—¬ ì²« ë²ˆì§¸ ì§„ë‹¨ì§€ ì„¸íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
      <button type="button" class="btn-upload-empty" onclick="toggleUploadPanel()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        ìƒˆ ì§„ë‹¨ì§€ ì—…ë¡œë“œ
      </button>
    </div>
  <% else %>
    <% @assessment_bundles.each do |bundle| %>
      <div class="bundle-card-modern <%= 'ai-analyzed' if bundle.ai_analyzed? %>">
        <div class="bundle-card-header">
          <code class="bundle-code-tag"><%= bundle.code %></code>
          <div class="bundle-badges">
            <% if bundle.grade_level_set? %>
              <span class="grade-level-badge" style="background: <%= bundle.grade_level_color %>;" title="<%= bundle.grade_level_label %>">
                <%= bundle.grade_level_short %>
              </span>
            <% end %>
            <span class="status-badge status-<%= bundle.bundle_status %>"><%= status_label(bundle.bundle_status) %></span>
            <% if bundle.ai_analyzed? %>
              <span class="ai-badge" title="AI ë¶„ì„ ì™„ë£Œ">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6a1 1 0 0 0-1 1v5a1 1 0 0 0 .29.71l3 3a1 1 0 0 0 1.42-1.42L13 11.59V7a1 1 0 0 0-1-1z"/></svg>
                AI
              </span>
            <% end %>
          </div>
        </div>

        <h3 class="bundle-title-modern"><%= bundle.title.presence || "ì œëª© ì—†ìŒ" %></h3>

        <p class="bundle-excerpt">
          <% if bundle.ai_summary.present? %>
            <%= bundle.ai_summary %>
          <% else %>
            <%= truncate(bundle.body, length: 120) %>
          <% end %>
        </p>

        <% if bundle.ai_analyzed? %>
          <div class="bundle-meta">
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
              <%= bundle.domain %>
            </span>
            <span class="meta-item difficulty-<%= bundle.difficulty_level %>">
              <%= difficulty_label(bundle.difficulty_level) %>
            </span>
            <% if bundle.target_grade.present? %>
              <span class="meta-item"><%= bundle.target_grade %></span>
            <% end %>
          </div>
          <div class="bundle-tags">
            <% bundle.key_concepts.take(4).each do |concept| %>
              <span class="tag"><%= concept %></span>
            <% end %>
          </div>
        <% end %>

        <div class="bundle-footer">
          <div class="bundle-stats-row">
            <span class="stat-mini"><strong><%= bundle.mcq_count %></strong> ê°ê´€ì‹</span>
            <span class="stat-mini"><strong><%= bundle.constructed_count %></strong> ì„œìˆ í˜•</span>
            <span class="stat-mini"><strong><%= bundle.estimated_time_minutes %></strong>ë¶„</span>
          </div>

          <%# ì •ë‹µ ìƒíƒœ í‘œì‹œ %>
          <%
            mcq_items = bundle.items.where(item_type: 'mcq')
            mcq_without_answer = mcq_items.count - mcq_items.joins(:item_choices).where(item_choices: { is_correct: true }).distinct.count
            constructed_items = bundle.items.where(item_type: 'constructed')
            constructed_without_rubric = constructed_items.count - constructed_items.joins(rubric: :rubric_criteria).distinct.count
            total_missing = mcq_without_answer + constructed_without_rubric
          %>
          <% if total_missing > 0 %>
            <div class="answer-status-row">
              <span class="answer-status-warning">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                ì •ë‹µ/ì±„ì ê¸°ì¤€ ë¯¸ì„¤ì • <%= total_missing %>ê°œ
              </span>
            </div>
          <% end %>

          <div class="bundle-actions-row">
            <%= link_to researcher_passage_path(bundle), class: "btn-action btn-view" do %>
              ìƒì„¸ë³´ê¸°
            <% end %>
            <% if total_missing > 0 %>
              <%= link_to researcher_passage_path(bundle, anchor: "answer-key-section"), class: "btn-action btn-answer-key" do %>
                ì •ë‹µ ë“±ë¡
              <% end %>
            <% end %>
            <% unless bundle.ai_analyzed? %>
              <%= button_to analyze_researcher_passage_path(bundle), method: :post, class: "btn-action btn-analyze", data: { turbo_confirm: "AI ë¶„ì„ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" } do %>
                AI ë¶„ì„
              <% end %>
            <% end %>
            <%= button_to researcher_passage_path(bundle), method: :delete, class: "btn-action btn-delete", data: { turbo_confirm: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ëª¨ë“ˆì˜ ì§€ë¬¸ê³¼ ëª¨ë“  ë¬¸í•­ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\n(ë³´ê´€ì²˜ë¦¬ë¥¼ ì›í•˜ì‹œë©´ ìƒì„¸ë³´ê¸°ì—ì„œ 'ë³´ê´€ì²˜ë¦¬' ë²„íŠ¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”)" } do %>
              ì‚­ì œ
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
<% if @has_next || @has_prev %>
  <div class="pagination-modern">
    <% if @has_prev && @prev_cursor %>
      <%= link_to researcher_item_bank_path(cursor: @prev_cursor, direction: "backward", search: @search_query, bundle_status: @bundle_status_filter), class: "pagination-btn" do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        ì´ì „
      <% end %>
    <% end %>
    <% if @has_next && @next_cursor %>
      <%= link_to researcher_item_bank_path(cursor: @next_cursor, direction: "forward", search: @search_query, bundle_status: @bundle_status_filter), class: "pagination-btn" do %>
        ë‹¤ìŒ
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      <% end %>
    <% end %>
  </div>
<% end %>

<script>
  function toggleUploadPanel() {
    const panel = document.getElementById('upload-panel');
    if (panel) {
      panel.classList.toggle('hidden');
    }
  }

  // Turbo í˜¸í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  function setupUploadPanel() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('pdf-file-input');
    const fileNameDisplay = document.getElementById('selected-file-name');
    const submitBtn = document.getElementById('submit-btn');
    const submitBtnText = document.getElementById('submit-btn-text');
    const uploadForm = document.getElementById('pdf-upload-form');
    const progressContainer = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercentage = document.getElementById('progress-percentage');

    if (!dropzone || !fileInput) {
      console.warn('Upload panel elements not found');
      return;
    }

    // DOM ìš”ì†Œì— ì´ˆê¸°í™” ìƒíƒœ ì €ì¥ - ê°€ì¥ í™•ì‹¤í•œ ì¤‘ë³µ ë°©ì§€ ë°©ë²•
    if (dropzone.dataset.initialized === 'true') {
      console.log('Dropzone already initialized, skipping');
      return;
    }

    console.log('Initializing upload panel');

    // ë“œë¡­ì¡´ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ
    dropzone.addEventListener('click', () => {
      console.log('Dropzone clicked');
      fileInput.click();
    });

    // ë“œë˜ê·¸ ì˜¤ë²„
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.add('dragover');
    });

    // ë“œë˜ê·¸ ë– ë‚¨
    dropzone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove('dragover');
    });

    // ë“œë¡­
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove('dragover');

      if (e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        // Create a new DataTransfer object and add the file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        updateFileName(file.name);
        enableSubmitButton();
        console.log('File dropped:', file.name);
      }
    });

    // íŒŒì¼ ì„ íƒ ë³€ê²½
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        updateFileName(file.name);
        enableSubmitButton();
        console.log('File selected:', file.name);
      }
    });

    // í¼ ì œì¶œ ì²˜ë¦¬
    if (uploadForm) {
      uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();

        if (!fileInput.files.length) {
          alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        console.log('Starting upload...');
        startUpload();
      });
    }

    function updateFileName(name) {
      if (fileNameDisplay) {
        fileNameDisplay.textContent = name;
        fileNameDisplay.style.display = 'inline-block';
      }
    }

    function enableSubmitButton() {
      if (submitBtn && submitBtnText) {
        submitBtn.disabled = false;
        submitBtn.classList.add('enabled');
        submitBtnText.textContent = 'ì—…ë¡œë“œ ë° ë¶„ì„';
      }
    }

    function disableSubmitButton() {
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.classList.remove('enabled');
      }
    }

    // ì´ˆê¸° ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ
    function showInitialProcessingState() {
      const processLogsDiv = document.getElementById('process-logs');
      const logsContainer = document.getElementById('logs-container');

      if (processLogsDiv && logsContainer) {
        logsContainer.innerHTML = '';
        processLogsDiv.style.display = 'block';

        // ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
        const initialMessages = [
          'ğŸ“¤ PDF íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘...',
          'â³ ì„œë²„ì—ì„œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...'
        ];

        initialMessages.forEach((msg, index) => {
          setTimeout(() => {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = msg;
            logEntry.style.opacity = '0';
            logEntry.style.transform = 'translateY(-10px)';
            logsContainer.appendChild(logEntry);

            setTimeout(() => {
              logEntry.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              logEntry.style.opacity = '1';
              logEntry.style.transform = 'translateY(0)';
            }, 10);
          }, index * 200);
        });
      }

      // ì´ˆê¸° ì§„í–‰ ìƒíƒœ í‘œì‹œ
      updateProgress(5, 'PDF ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...');
    }

    function startUpload() {
      // ë²„íŠ¼ ë¹„í™œì„±í™”
      disableSubmitButton();
      if (submitBtnText) {
        submitBtnText.textContent = 'ì—…ë¡œë“œ ì¤‘...';
      }

      // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
      if (progressContainer) {
        progressContainer.style.display = 'block';
      }

      // ë“œë¡­ì¡´ ìˆ¨ê¸°ê¸°
      if (dropzone) {
        dropzone.style.display = 'none';
      }

      // ì´ˆê¸° ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ
      showInitialProcessingState();

      // FormData ìƒì„±
      const formData = new FormData(uploadForm);

      // XMLHttpRequestë¡œ ì—…ë¡œë“œ (ì§„í–‰ ìƒí™© ì¶”ì  ê°€ëŠ¥)
      const xhr = new XMLHttpRequest();

      // ì—…ë¡œë“œ ì§„í–‰ ìƒí™©
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percentComplete = (e.loaded / e.total) * 100;
          updateProgress(percentComplete, 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
        }
      });

      // íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ (ì„œë²„ ì²˜ë¦¬ ì‹œì‘)
      xhr.upload.addEventListener('load', () => {
        // ì—…ë¡œë“œëŠ” ì™„ë£Œ, ì´ì œ ì„œë²„ì—ì„œ AI ë¶„ì„ ì¤‘
        updateProgress(100, 'ğŸ¤– AIê°€ PDFë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
        startPulseAnimation();
        showProcessingMessage('OpenAI APIë¡œ ì§€ë¬¸ê³¼ ë¬¸í•­ì„ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤. ì•½ 30ì´ˆ~2ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      });

      // ì„œë²„ ì‘ë‹µ ì™„ë£Œ
      xhr.addEventListener('load', () => {
        stopPulseAnimation();

        try {
          const response = JSON.parse(xhr.responseText);

          if (xhr.status === 200 && response.success) {
            // ì„±ê³µ: 100% ì™„ë£Œ í‘œì‹œ
            updateProgress(100, 'âœ… ë¶„ì„ ì™„ë£Œ!');

            // ë¡œê·¸ê°€ ìˆìœ¼ë©´ ìˆœì°¨ì ìœ¼ë¡œ í‘œì‹œ
            if (response.logs && response.logs.length > 0) {
              // ì•½ê°„ì˜ ì§€ì—° í›„ ë¡œê·¸ í‘œì‹œ ì‹œì‘
              setTimeout(() => {
                displayProcessLogs(response.logs, () => {
                  // ëª¨ë“  ë¡œê·¸ í‘œì‹œ ì™„ë£Œ í›„ ë¦¬ë””ë ‰ì…˜
                  updateProgress(100, 'âœ… ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ!');
                  setTimeout(() => {
                    window.location.href = response.redirect_url;
                  }, 1500);
                });
              }, 300);
            } else {
              // ë¡œê·¸ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ë¦¬ë””ë ‰ì…˜
              updateProgress(100, 'PDF ë¶„ì„ ë° ë¬¸í•­ ìƒì„± ì™„ë£Œ!');
              setTimeout(() => {
                window.location.href = response.redirect_url;
              }, 1000);
            }
          } else {
            // ì„œë²„ì—ì„œ ì—ëŸ¬ ë°˜í™˜
            const errorMsg = response.message || 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            handleError(errorMsg);
          }
        } catch (e) {
          // JSON íŒŒì‹± ì‹¤íŒ¨
          console.error('Failed to parse response:', e);
          handleError('ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ' + xhr.status + ')');
        }
      });

      // ì—ëŸ¬ ì²˜ë¦¬
      xhr.addEventListener('error', () => {
        handleError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });

      xhr.addEventListener('abort', () => {
        handleError('ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      });

      // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

      xhr.open('POST', uploadForm.action, true);
      if (csrfToken) {
        xhr.setRequestHeader('X-CSRF-Token', csrfToken);
      }
      // JSON ì‘ë‹µ ìš”ì²­
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.send(formData);

      console.log('Upload started via XHR');
    }

    function updateProgress(percent, text) {
      if (progressBar) {
        progressBar.style.width = percent + '%';
      }
      if (progressPercentage) {
        progressPercentage.textContent = Math.round(percent) + '%';
      }
      if (progressText) {
        progressText.textContent = text;
      }
    }

    // AI ì²˜ë¦¬ ì¤‘ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜
    function startPulseAnimation() {
      if (progressBar) {
        progressBar.classList.add('pulse-animation');
      }
    }

    function stopPulseAnimation() {
      if (progressBar) {
        progressBar.classList.remove('pulse-animation');
      }
    }

    // ì²˜ë¦¬ ì¤‘ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    function showProcessingMessage(message) {
      const processLogsDiv = document.getElementById('process-logs');
      const logsContainer = document.getElementById('logs-container');

      if (processLogsDiv && logsContainer) {
        processLogsDiv.style.display = 'block';

        // ê¸°ì¡´ ë¡œê·¸ì— ì¶”ê°€
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry log-entry--processing';
        logEntry.innerHTML = '<span class="processing-spinner"></span> ' + message;
        logsContainer.appendChild(logEntry);

        // í˜ì´ë“œ ì¸
        setTimeout(() => {
          logEntry.style.opacity = '1';
          logEntry.style.transform = 'translateY(0)';
        }, 10);
      }
    }

    function handleError(message) {
      stopPulseAnimation();
      alert(message);

      // ìƒíƒœ ë³µì›
      if (progressContainer) {
        progressContainer.style.display = 'none';
      }
      if (dropzone) {
        dropzone.style.display = 'flex';
      }
      if (progressBar) {
        progressBar.style.width = '0%';
      }

      // í¼ ë¦¬ì…‹
      if (uploadForm) {
        uploadForm.reset();
      }
      if (fileNameDisplay) {
        fileNameDisplay.textContent = '';
        fileNameDisplay.style.display = 'none';
      }

      // ë²„íŠ¼ ë¹„í™œì„±í™” (íŒŒì¼ ë‹¤ì‹œ ì„ íƒí•´ì•¼ í•¨)
      disableSubmitButton();
      if (submitBtnText) {
        submitBtnText.textContent = 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      }
    }

    function resetForm() {
      // í¼ ì™„ì „ ë¦¬ì…‹
      if (uploadForm) {
        uploadForm.reset();
      }
      if (fileNameDisplay) {
        fileNameDisplay.textContent = '';
        fileNameDisplay.style.display = 'none';
      }
      if (progressContainer) {
        progressContainer.style.display = 'none';
      }
      if (dropzone) {
        dropzone.style.display = 'flex';
      }
      if (progressBar) {
        progressBar.style.width = '0%';
      }
      disableSubmitButton();
      if (submitBtnText) {
        submitBtnText.textContent = 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      }
    }

    // ì²˜ë¦¬ ë¡œê·¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ í‘œì‹œ
    function displayProcessLogs(logs, onComplete) {
      const processLogsDiv = document.getElementById('process-logs');
      const logsContainer = document.getElementById('logs-container');

      if (!processLogsDiv || !logsContainer) {
        console.warn('Process logs elements not found');
        if (onComplete) onComplete();
        return;
      }

      // ë¡œê·¸ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ë° í‘œì‹œ
      logsContainer.innerHTML = '';
      processLogsDiv.style.display = 'block';

      // ê° ë¡œê·¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ í‘œì‹œ (300ms ê°„ê²©)
      let currentIndex = 0;
      const displayInterval = setInterval(() => {
        if (currentIndex >= logs.length) {
          clearInterval(displayInterval);
          if (onComplete) {
            setTimeout(onComplete, 500); // ë§ˆì§€ë§‰ ë¡œê·¸ í‘œì‹œ í›„ 0.5ì´ˆ ëŒ€ê¸°
          }
          return;
        }

        const log = logs[currentIndex];
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.textContent = log.message;

        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        logEntry.style.opacity = '0';
        logEntry.style.transform = 'translateY(-10px)';
        logsContainer.appendChild(logEntry);

        // í˜ì´ë“œ ì¸ ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
          logEntry.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          logEntry.style.opacity = '1';
          logEntry.style.transform = 'translateY(0)';
        }, 10);

        // ìë™ ìŠ¤í¬ë¡¤
        logsContainer.scrollTop = logsContainer.scrollHeight;

        currentIndex++;
      }, 300); // 300ms ê°„ê²©ìœ¼ë¡œ í‘œì‹œ
    }

    // ì´ˆê¸°í™” ì™„ë£Œ í‘œì‹œ (DOM ìš”ì†Œì— ì €ì¥)
    dropzone.dataset.initialized = 'true';
    console.log('Upload panel initialized successfully');
  }

  // DOMContentLoadedì™€ turbo:load ëª¨ë‘ ì§€ì›
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupUploadPanel);
  } else {
    setupUploadPanel();
  }

  // Turbo í˜ì´ì§€ ì „í™˜ ì‹œ ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
  document.addEventListener('turbo:before-render', () => {
    console.log('Turbo before render - resetting initialization state');
    const dropzone = document.getElementById('dropzone');
    if (dropzone) {
      delete dropzone.dataset.initialized;
    }
  });

  // í˜ì´ì§€ ë– ë‚  ë•Œ ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
  document.addEventListener('turbo:before-visit', () => {
    console.log('Turbo before visit - cleanup');
    const dropzone = document.getElementById('dropzone');
    if (dropzone) {
      delete dropzone.dataset.initialized;
    }
  });

  document.addEventListener('turbo:load', setupUploadPanel);
</script>

<style>
  /* í˜ì´ì§€ í—¤ë” */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .page-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .page-description {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0.25rem 0 0 0;
  }

  .btn-upload {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .btn-upload:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  /* ì—…ë¡œë“œ íŒ¨ë„ */
  .upload-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 420px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    transform: translateX(0);
    transition: transform 0.3s ease;
  }

  .upload-panel.hidden {
    transform: translateX(100%);
  }

  .upload-panel-content {
    padding: 1.5rem;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .upload-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .upload-panel-header h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
  }

  .btn-close {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: #6b7280;
    border-radius: 6px;
  }

  .btn-close:hover {
    background: #f3f4f6;
    color: #111827;
  }

  .upload-dropzone {
    position: relative;
    border: 3px dashed #d1d5db;
    border-radius: 16px;
    padding: 3.5rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
  }

  .upload-dropzone:hover {
    border-color: #667eea;
    background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
  }

  .upload-dropzone.dragover {
    border-color: #667eea;
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    transform: scale(1.02);
    box-shadow: 0 12px 28px rgba(102, 126, 234, 0.25);
  }

  .upload-icon-wrapper {
    position: relative;
    display: inline-block;
    margin-bottom: 1.5rem;
  }

  .upload-icon {
    color: #667eea;
    filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.2));
    transition: all 0.3s ease;
  }

  .upload-dropzone:hover .upload-icon {
    transform: translateY(-4px);
    color: #764ba2;
  }

  .upload-sparkle {
    position: absolute;
    top: -8px;
    right: -8px;
    font-size: 1.5rem;
    animation: sparkle 2s ease-in-out infinite;
  }

  @keyframes sparkle {
    0%, 100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
    50% {
      transform: scale(1.2) rotate(180deg);
      opacity: 0.8;
    }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .upload-text {
    margin: 0 0 0.75rem 0;
  }

  .upload-text-main {
    display: block;
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
    letter-spacing: -0.01em;
  }

  .upload-hint {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0 0 1.5rem 0;
  }

  .upload-hint-icon {
    font-size: 1.125rem;
  }

  .upload-features {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
  }

  .upload-feature {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: #6b7280;
    padding: 0.375rem 0.75rem;
    background: white;
    border-radius: 20px;
    border: 1px solid #e5e7eb;
    font-weight: 500;
  }

  .upload-dropzone:hover .upload-feature {
    border-color: #c7d2fe;
    background: #f0f4ff;
    color: #667eea;
  }

  /* ë ˆë²¨ ì„ íƒê¸° */
  .grade-level-selector {
    margin-top: 1.5rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
    border-radius: 12px;
    border: 1px solid #e5e7eb;
  }

  .grade-level-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
  }

  .grade-level-label svg {
    color: #667eea;
  }

  .required-mark {
    color: #ef4444;
    font-weight: 600;
  }

  .grade-level-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }

  .grade-level-option {
    position: relative;
    display: block;
    cursor: pointer;
  }

  .grade-level-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 1;
  }

  .grade-option-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    transition: all 0.2s ease;
  }

  .grade-level-option:hover .grade-option-content {
    border-color: #c7d2fe;
    background: #f0f4ff;
  }

  .grade-level-option input[type="radio"]:checked + .grade-option-content {
    border-color: #667eea;
    background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  }

  .grade-option-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.625rem;
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    border-radius: 6px;
    min-width: 42px;
    letter-spacing: 0.02em;
  }

  .grade-option-text {
    font-size: 0.8125rem;
    font-weight: 500;
    color: #4b5563;
  }

  .grade-level-option input[type="radio"]:checked + .grade-option-content .grade-option-text {
    color: #374151;
    font-weight: 600;
  }

  .file-input-hidden {
    display: none;
  }

  .upload-actions {
    margin-top: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .selected-file {
    font-size: 0.8125rem;
    color: #667eea;
    display: none;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .btn-submit-upload {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: not-allowed;
    margin-left: auto;
    opacity: 0.6;
    transition: all 0.2s ease;
  }

  .btn-submit-upload.enabled {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
    opacity: 1;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .btn-submit-upload.enabled:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-submit-upload:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  /* í”„ë¡œê·¸ë ˆìŠ¤ë°” ìŠ¤íƒ€ì¼ */
  .upload-progress {
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 8px;
  }

  .progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .progress-text {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary, #111827);
  }

  .progress-percentage {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary, #667eea);
  }

  .progress-bar-container {
    width: 100%;
    height: 8px;
    background: var(--bg-tertiary, #e5e7eb);
    border-radius: 999px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 999px;
    transition: width 0.3s ease;
  }

  /* AI ì²˜ë¦¬ ì¤‘ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
  .progress-bar.pulse-animation {
    animation: pulse-glow 1.5s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% {
      opacity: 1;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
    }
    50% {
      opacity: 0.7;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.8), 0 0 30px rgba(118, 75, 162, 0.6);
    }
  }

  .progress-hint {
    margin-top: 0.75rem;
    font-size: 0.75rem;
    color: var(--text-muted, #6b7280);
    text-align: center;
  }

  /* ì²˜ë¦¬ ë¡œê·¸ ìŠ¤íƒ€ì¼ */
  .process-logs {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border, #e5e7eb);
  }

  .logs-header {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary, #111827);
    margin-bottom: 0.75rem;
  }

  .logs-container {
    max-height: 200px;
    overflow-y: auto;
    background: white;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 6px;
    padding: 0.75rem;
  }

  .log-entry {
    font-size: 0.8125rem;
    color: var(--text-secondary, #374151);
    padding: 0.375rem 0;
    font-family: 'Consolas', 'Monaco', monospace;
    line-height: 1.5;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  /* AI ì²˜ë¦¬ ì¤‘ ë¡œê·¸ ì—”íŠ¸ë¦¬ */
  .log-entry--processing {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #667eea;
    font-weight: 500;
    opacity: 0;
    transform: translateY(-10px);
  }

  /* ì²˜ë¦¬ ì¤‘ ìŠ¤í”¼ë„ˆ */
  .processing-spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #e5e7eb;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .log-entry:not(:last-child) {
    border-bottom: 1px solid var(--border-light, #f3f4f6);
  }

  /* í†µê³„ ì¹´ë“œ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card-modern {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem 1.25rem;
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .stat-icon-blue { background: #dbeafe; color: #2563eb; }
  .stat-icon-green { background: #d1fae5; color: #059669; }
  .stat-icon-purple { background: #ede9fe; color: #7c3aed; }
  .stat-icon-indigo { background: #e0e7ff; color: #4f46e5; }

  .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    display: block;
  }

  .stat-text {
    font-size: 0.8125rem;
    color: #6b7280;
  }

  /* í•„í„° ë°” */
  .filters-bar {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }

  .filters-form-modern {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-wrapper {
    position: relative;
    flex: 1;
    min-width: 200px;
  }

  .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
  }

  .search-input-modern {
    width: 100%;
    padding: 0.625rem 0.75rem 0.625rem 2.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
  }

  .search-input-modern:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .filter-select-modern {
    padding: 0.625rem 2rem 0.625rem 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 8px center;
    appearance: none;
    cursor: pointer;
  }

  .btn-search {
    padding: 0.625rem 1.25rem;
    background: #111827;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
  }

  .btn-reset {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.625rem 1rem;
    background: white;
    color: #6b7280;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    text-decoration: none;
  }

  /* ë²ˆë“¤ ê·¸ë¦¬ë“œ */
  .bundles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 1.25rem;
  }

  .bundle-card-modern {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
  }

  .bundle-card-modern:hover {
    border-color: #d1d5db;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  }

  .bundle-card-modern.ai-analyzed {
    border-left: 3px solid #667eea;
  }

  .bundle-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
  }

  .bundle-code-tag {
    font-size: 0.6875rem;
    background: #f3f4f6;
    color: #6b7280;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .bundle-badges {
    display: flex;
    gap: 0.375rem;
  }

  .status-badge {
    font-size: 0.6875rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
  }

  .status-draft { background: #fef3c7; color: #92400e; }
  .status-active { background: #d1fae5; color: #065f46; }
  .status-archived { background: #f3f4f6; color: #6b7280; }

  .ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.6875rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    background: #dbeafe;
    color: #1e40af;
    font-weight: 500;
  }

  .grade-level-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6875rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    color: white;
    font-weight: 600;
    letter-spacing: 0.02em;
    min-width: 32px;
  }

  .bundle-title-modern {
    font-size: 1.0625rem;
    font-weight: 600;
    color: #111827;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
  }

  .bundle-excerpt {
    font-size: 0.8125rem;
    color: #6b7280;
    line-height: 1.6;
    margin: 0 0 1rem 0;
    flex: 1;
  }

  .bundle-meta {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: #6b7280;
  }

  .meta-item.difficulty-easy { color: #059669; }
  .meta-item.difficulty-medium { color: #d97706; }
  .meta-item.difficulty-hard { color: #dc2626; }

  .bundle-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 1rem;
  }

  .tag {
    font-size: 0.6875rem;
    background: #f0f4ff;
    color: #4f46e5;
    padding: 0.2rem 0.5rem;
    border-radius: 99px;
  }

  .bundle-footer {
    border-top: 1px solid #f3f4f6;
    padding-top: 1rem;
    margin-top: auto;
  }

  .bundle-stats-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .stat-mini {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .stat-mini strong {
    color: #111827;
  }

  .bundle-actions-row {
    display: flex;
    gap: 0.5rem;
  }

  .btn-action {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    font-size: 0.8125rem;
    font-weight: 500;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s;
    border: none;
  }

  .btn-view {
    background: #f3f4f6;
    color: #374151;
  }

  .btn-view:hover {
    background: #e5e7eb;
  }

  .btn-analyze {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-answer-key {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
  }

  .btn-answer-key:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
  }

  .btn-delete {
    background: #fef2f2;
    color: #dc2626;
  }

  .btn-delete:hover {
    background: #dc2626;
    color: white;
  }

  /* ì •ë‹µ ìƒíƒœ í‘œì‹œ */
  .answer-status-row {
    margin-bottom: 0.75rem;
  }

  .answer-status-warning {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: #fef3c7;
    color: #92400e;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .answer-status-warning svg {
    flex-shrink: 0;
  }

  /* ë¹ˆ ìƒíƒœ */
  .empty-state-modern {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
    background: #fafafa;
    border-radius: 16px;
    border: 2px dashed #e5e7eb;
  }

  .empty-state-modern svg {
    color: #d1d5db;
    margin-bottom: 1rem;
  }

  .empty-state-modern h3 {
    font-size: 1.125rem;
    color: #374151;
    margin: 0 0 0.5rem 0;
  }

  .empty-state-modern p {
    font-size: 0.875rem;
    color: #9ca3af;
    margin: 0 0 1.5rem 0;
  }

  .btn-upload-empty {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
  }

  /* í˜ì´ì§€ë„¤ì´ì…˜ */
  .pagination-modern {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 2rem;
  }

  .pagination-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    color: #374151;
    text-decoration: none;
    transition: all 0.15s;
  }

  .pagination-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 1024px) {
    .stats-row {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .stats-row {
      grid-template-columns: 1fr 1fr;
    }

    .upload-panel {
      width: 100%;
    }

    .bundles-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
