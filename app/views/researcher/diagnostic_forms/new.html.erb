<% content_for :portal_title do %>
  새 진단지 만들기
<% end %>
<% content_for :portal_subtitle do %>
  평가 모듈을 선택하여 새로운 진단지를 구성하세요.
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :scoring %>
<% end %>

<section class="portal-card">
  <% if flash[:alert] %>
    <div class="alert alert-error">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span><%= flash[:alert] %></span>
    </div>
  <% end %>

  <%= form_with model: @diagnostic_form, url: researcher_diagnostic_forms_path, local: true, class: "diagnostic-form" do |f| %>
    <!-- 기본 정보 -->
    <div class="form-section">
      <h3 class="form-section-title">기본 정보</h3>

      <div class="form-group">
        <%= f.label :name, "진단지 이름", class: "form-label" %>
        <%= f.text_field :name, class: "form-input", placeholder: "예: 2026년 1학기 중간고사 읽기 진단", required: true %>
      </div>

      <div class="form-group">
        <%= f.label :description, "설명", class: "form-label" %>
        <%= f.text_area :description, class: "form-textarea", placeholder: "진단지에 대한 설명을 입력하세요 (선택사항)", rows: 3 %>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :time_limit_minutes, "제한 시간 (분)", class: "form-label" %>
          <%= f.number_field :time_limit_minutes, class: "form-input", placeholder: "60", min: 1 %>
        </div>

        <div class="form-group">
          <%= f.label :status, "상태", class: "form-label" %>
          <%= f.select :status, [["준비중", "draft"], ["활성", "active"]], {}, class: "form-select" %>
        </div>
      </div>
    </div>

    <!-- 모듈 선택 -->
    <div class="form-section">
      <h3 class="form-section-title">평가 모듈 선택</h3>
      <p class="form-section-description">진단지에 포함할 모듈을 선택하세요. 각 모듈은 하나의 지문과 연결된 문항들을 포함합니다.</p>

      <% if @available_modules.any? %>
        <div class="module-selection">
          <% @available_modules.each do |stimulus| %>
            <div class="module-card" data-module-id="<%= stimulus.id %>" data-module-title="<%= stimulus.title %>" data-module-level="<%= stimulus.grade_level_short if stimulus.grade_level_set? %>" data-module-level-color="<%= stimulus.grade_level_color if stimulus.grade_level_set? %>" data-module-mcq="<%= stimulus.mcq_count %>" data-module-constructed="<%= stimulus.constructed_count %>" data-module-time="<%= stimulus.estimated_time_minutes %>">
              <label class="module-card-label">
                <input type="checkbox" class="module-checkbox" data-module-id="<%= stimulus.id %>" id="module_select_<%= stimulus.id %>">
                <div class="module-card-content">
                  <div class="module-card-header">
                    <div class="module-header-left">
                      <% if stimulus.grade_level_set? %>
                        <span class="module-level-badge" style="background: <%= stimulus.grade_level_color %>;">
                          <%= stimulus.grade_level_short %>
                        </span>
                      <% end %>
                      <h4 class="module-title"><%= stimulus.title %></h4>
                    </div>
                    <span class="module-code"><%= stimulus.code %></span>
                  </div>
                  <div class="module-stats">
                    <span class="module-stat">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/>
                      </svg>
                      객관식 <%= stimulus.mcq_count %>개
                    </span>
                    <span class="module-stat">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                      </svg>
                      서술형 <%= stimulus.constructed_count %>개
                    </span>
                    <span class="module-stat">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                      </svg>
                      예상 <%= stimulus.estimated_time_minutes %>분
                    </span>
                  </div>
                </div>
              </label>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state">
          <p>사용 가능한 모듈이 없습니다.</p>
          <p class="empty-state-hint">먼저 <%= link_to "모듈 관리", researcher_item_bank_path, class: "link" %> 페이지에서 모듈을 생성해주세요.</p>
        </div>
      <% end %>
    </div>

    <!-- 선택된 모듈 순서 -->
    <div class="form-section" id="selected-modules-section" style="display: none;">
      <h3 class="form-section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        선택된 모듈 순서
      </h3>
      <p class="form-section-description">드래그하여 모듈 순서를 변경하세요. 순서대로 학생에게 제시됩니다.</p>

      <div id="selected-modules-list" class="selected-modules-list">
        <!-- 선택된 모듈이 여기에 동적으로 추가됨 -->
      </div>

      <!-- 순서 정보를 hidden input으로 전송 -->
      <div id="module-order-inputs"></div>
    </div>

    <!-- 평가 영역 커버리지 분석 -->
    <div class="form-section" id="coverage-panel" style="display: none;">
      <h3 class="form-section-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        평가 영역 커버리지
      </h3>
      <p class="form-section-description">선택한 모듈의 평가 영역 커버리지를 실시간으로 확인합니다.</p>
      <div id="coverage-content"></div>
    </div>

    <!-- 액션 버튼 -->
    <div class="form-actions">
      <%= link_to "취소", researcher_diagnostic_eval_path, class: "btn-secondary" %>
      <%= f.submit "진단지 만들기", class: "btn-primary" %>
    </div>
  <% end %>
</section>

<style>
  .diagnostic-form {
    max-width: 900px;
  }

  .form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .form-section:last-of-type {
    border-bottom: none;
  }

  .form-section-title {
    font-size: var(--rp-font-size-lg);
    font-weight: var(--rp-font-weight-semibold);
    color: #111827;
    margin-bottom: 0.5rem;
  }

  .form-section-description {
    font-size: var(--rp-font-size-sm);
    color: #6b7280;
    margin-bottom: 1rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .form-label {
    display: block;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .form-input,
  .form-textarea,
  .form-select {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: var(--rp-font-size-sm);
    transition: all 0.2s;
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .module-selection {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
  }

  .module-card {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .module-card:has(.module-checkbox:checked) {
    border-color: #667eea;
    background: #f0f4ff;
  }

  .module-card-label {
    display: block;
    cursor: pointer;
    padding: 1rem;
  }

  .module-checkbox {
    margin-right: 0.75rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .module-card-content {
    display: inline-block;
    vertical-align: top;
    width: calc(100% - 30px);
  }

  .module-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
  }

  .module-header-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    min-width: 0;
  }

  .module-level-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.125rem 0.5rem;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-bold);
    color: white;
    border-radius: 4px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .module-title {
    font-size: var(--rp-font-size-md);
    font-weight: var(--rp-font-weight-semibold);
    color: #111827;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .module-code {
    font-size: var(--rp-font-size-xs);
    color: #6b7280;
    font-family: monospace;
  }

  .module-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .module-stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: var(--rp-font-size-sm);
    color: #6b7280;
  }

  .module-stat svg {
    color: #9ca3af;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  .empty-state-hint {
    margin-top: 0.5rem;
    font-size: var(--rp-font-size-sm);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.625rem 1.5rem;
    border-radius: 6px;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .btn-secondary:hover {
    background: #f9fafb;
  }

  .link {
    color: #667eea;
    text-decoration: underline;
  }

  .link:hover {
    color: #764ba2;
  }

  .alert {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-size: var(--rp-font-size-sm);
  }

  .alert svg {
    flex-shrink: 0;
  }

  .alert-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
  }

  /* 선택된 모듈 순서 섹션 */
  #selected-modules-section .form-section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  #selected-modules-section .form-section-title svg {
    color: #667eea;
  }

  .selected-modules-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-height: 60px;
    padding: 1rem;
    background: #f9fafb;
    border: 2px dashed #e5e7eb;
    border-radius: 8px;
  }

  .selected-module-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    cursor: grab;
    transition: all 0.2s;
    user-select: none;
  }

  .selected-module-item:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
  }

  .selected-module-item:active {
    cursor: grabbing;
  }

  .selected-module-item.dragging {
    opacity: 0.5;
    background: #f0f4ff;
  }

  .selected-module-item.drag-over {
    border-color: #667eea;
    border-style: dashed;
    background: #f0f4ff;
  }

  .module-order-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-bold);
    flex-shrink: 0;
  }

  .module-drag-handle {
    color: #9ca3af;
    cursor: grab;
    flex-shrink: 0;
  }

  .module-drag-handle:active {
    cursor: grabbing;
  }

  .selected-module-info {
    flex: 1;
    min-width: 0;
  }

  .selected-module-title {
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    color: #111827;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .selected-module-meta {
    font-size: var(--rp-font-size-xs);
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .selected-module-level {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.125rem 0.375rem;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-bold);
    color: white;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .module-remove-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: none;
    border: none;
    color: #9ca3af;
    border-radius: 4px;
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .module-remove-btn:hover {
    background: #fef2f2;
    color: #ef4444;
  }

  .selected-modules-empty {
    text-align: center;
    padding: 1.5rem;
    color: #9ca3af;
    font-size: var(--rp-font-size-sm);
  }

  /* 커버리지 패널 */
  .coverage-summary-bar { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
  .coverage-summary-item { flex: 1; min-width: 110px; padding: 0.75rem 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; }
  .coverage-summary-item.cov-complete { background: #f0fdf4; border-color: #86efac; }
  .coverage-summary-item.cov-incomplete { background: #fef3c7; border-color: #fde68a; }
  .coverage-summary-item.cov-warning { background: #fef2f2; border-color: #fecaca; }
  .coverage-summary-label { display: block; font-size: var(--rp-font-size-xs); font-weight: var(--rp-font-weight-semibold); color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; }
  .coverage-summary-value { font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-bold); color: #111827; }
  .cov-complete .coverage-summary-value { color: #166534; }
  .cov-incomplete .coverage-summary-value { color: #92400e; }
  .cov-warning .coverage-summary-value { color: #991b1b; }
  .coverage-detail-grid { display: flex; flex-direction: column; gap: 0.75rem; }
  .coverage-indicator { padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; }
  .coverage-indicator--covered { background: #f8fafc; border-color: #e2e8f0; }
  .coverage-indicator--missing { background: #fef2f2; border-color: #fecaca; }
  .coverage-indicator-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
  .coverage-indicator-status { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; font-size: var(--rp-font-size-xs); flex-shrink: 0; }
  .coverage-indicator--covered .coverage-indicator-status { background: #dcfce7; color: #166534; }
  .coverage-indicator--missing .coverage-indicator-status { background: #fecaca; color: #991b1b; }
  .coverage-indicator-name { font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-semibold); color: #111827; flex: 1; }
  .coverage-indicator-count { font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #6b7280; }
  .coverage-sub-list { display: flex; gap: 0.5rem; flex-wrap: wrap; padding-left: 1.75rem; }
  .coverage-sub-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.625rem; border-radius: 12px; font-size: var(--rp-font-size-xs); font-weight: var(--rp-font-weight-medium); }
  .coverage-sub-badge--covered { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
  .coverage-sub-badge--missing { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
</style>

<script>
  const INDICATOR_TAXONOMY = <%= json_escape(@all_indicators.map { |ei| { id: ei.id, name: ei.name, code: ei.code, sub_indicators: ei.sub_indicators.map { |si| { id: si.id, name: si.name } } } }.to_json) %>;
  const MODULE_INDICATOR_MAP = <%= json_escape(@module_indicator_map.to_json) %>;
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const moduleCheckboxes = document.querySelectorAll('.module-checkbox');
  const selectedModulesSection = document.getElementById('selected-modules-section');
  const selectedModulesList = document.getElementById('selected-modules-list');
  const moduleOrderInputs = document.getElementById('module-order-inputs');

  let selectedModules = [];
  let draggedItem = null;

  // 체크박스 변경 이벤트
  moduleCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const moduleId = this.dataset.moduleId;
      const moduleCard = this.closest('.module-card');

      if (this.checked) {
        // 모듈 추가
        const moduleData = {
          id: moduleId,
          title: moduleCard.dataset.moduleTitle,
          level: moduleCard.dataset.moduleLevel,
          levelColor: moduleCard.dataset.moduleLevelColor,
          mcq: moduleCard.dataset.moduleMcq,
          constructed: moduleCard.dataset.moduleConstructed,
          time: moduleCard.dataset.moduleTime
        };
        selectedModules.push(moduleData);
      } else {
        // 모듈 제거
        selectedModules = selectedModules.filter(m => m.id !== moduleId);
      }

      updateSelectedModulesList();
    });
  });

  // 선택된 모듈 목록 업데이트
  function updateSelectedModulesList() {
    if (selectedModules.length === 0) {
      selectedModulesSection.style.display = 'none';
      selectedModulesList.innerHTML = '';
      moduleOrderInputs.innerHTML = '';
      return;
    }

    selectedModulesSection.style.display = 'block';

    // 목록 렌더링
    selectedModulesList.innerHTML = selectedModules.map((module, index) => `
      <div class="selected-module-item" draggable="true" data-module-id="${module.id}">
        <span class="module-order-number">${index + 1}</span>
        <span class="module-drag-handle">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/>
            <circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>
          </svg>
        </span>
        <div class="selected-module-info">
          <h5 class="selected-module-title">
            ${module.level ? `<span class="selected-module-level" style="background: ${module.levelColor}">${module.level}</span>` : ''}
            ${module.title}
          </h5>
          <div class="selected-module-meta">
            객관식 ${module.mcq}개 · 서술형 ${module.constructed}개 · 예상 ${module.time}분
          </div>
        </div>
        <button type="button" class="module-remove-btn" data-module-id="${module.id}" title="제거">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    `).join('');

    // hidden inputs 업데이트
    moduleOrderInputs.innerHTML = selectedModules.map(module =>
      `<input type="hidden" name="module_ids[]" value="${module.id}">`
    ).join('');

    // 드래그 이벤트 등록
    setupDragEvents();

    // 제거 버튼 이벤트 등록
    setupRemoveButtons();

    // 커버리지 패널 업데이트
    updateCoveragePanel();
  }

  // 평가 영역 커버리지 분석
  function updateCoveragePanel() {
    const panel = document.getElementById('coverage-panel');
    const content = document.getElementById('coverage-content');
    if (!panel || !content) return;

    if (selectedModules.length === 0) {
      panel.style.display = 'none';
      return;
    }
    panel.style.display = 'block';

    const agg = { indicators: {}, subIndicators: {}, unmapped: 0, total: 0 };
    selectedModules.forEach(m => {
      const data = MODULE_INDICATOR_MAP[m.id];
      if (!data) return;
      agg.total += data.total_count;
      agg.unmapped += data.unmapped_count;
      for (const [eiId, info] of Object.entries(data.coverage)) {
        agg.indicators[eiId] = (agg.indicators[eiId] || 0) + info.count;
        for (const [siId, cnt] of Object.entries(info.sub_ids)) {
          agg.subIndicators[siId] = (agg.subIndicators[siId] || 0) + cnt;
        }
      }
    });

    const totalEI = INDICATOR_TAXONOMY.length;
    const coveredEI = INDICATOR_TAXONOMY.filter(ei => agg.indicators[ei.id] > 0).length;
    const totalSI = INDICATOR_TAXONOMY.reduce((s, ei) => s + ei.sub_indicators.length, 0);
    const coveredSI = INDICATOR_TAXONOMY.reduce((s, ei) => s + ei.sub_indicators.filter(si => agg.subIndicators[si.id] > 0).length, 0);

    let html = `<div class="coverage-summary-bar">
      <div class="coverage-summary-item ${coveredEI === totalEI ? 'cov-complete' : 'cov-incomplete'}">
        <span class="coverage-summary-label">평가 영역</span>
        <span class="coverage-summary-value">${coveredEI}/${totalEI}</span>
      </div>
      <div class="coverage-summary-item ${coveredSI === totalSI ? 'cov-complete' : 'cov-incomplete'}">
        <span class="coverage-summary-label">하위 영역</span>
        <span class="coverage-summary-value">${coveredSI}/${totalSI}</span>
      </div>
      <div class="coverage-summary-item">
        <span class="coverage-summary-label">전체 문항</span>
        <span class="coverage-summary-value">${agg.total}</span>
      </div>
      ${agg.unmapped > 0 ? `<div class="coverage-summary-item cov-warning">
        <span class="coverage-summary-label">미매핑 문항</span>
        <span class="coverage-summary-value">${agg.unmapped}</span>
      </div>` : ''}
    </div><div class="coverage-detail-grid">`;

    INDICATOR_TAXONOMY.forEach(ei => {
      const cnt = agg.indicators[ei.id] || 0;
      const cls = cnt > 0 ? 'covered' : 'missing';
      html += `<div class="coverage-indicator coverage-indicator--${cls}">
        <div class="coverage-indicator-header">
          <span class="coverage-indicator-status">${cnt > 0 ? '&#10003;' : '&#10007;'}</span>
          <span class="coverage-indicator-name">${ei.name}</span>
          <span class="coverage-indicator-count">${cnt}개 문항</span>
        </div><div class="coverage-sub-list">`;
      ei.sub_indicators.forEach(si => {
        const sc = agg.subIndicators[si.id] || 0;
        html += `<span class="coverage-sub-badge coverage-sub-badge--${sc > 0 ? 'covered' : 'missing'}">${si.name} (${sc})</span>`;
      });
      html += `</div></div>`;
    });
    html += `</div>`;
    content.innerHTML = html;
  }

  // 드래그 이벤트 설정
  function setupDragEvents() {
    const items = selectedModulesList.querySelectorAll('.selected-module-item');

    items.forEach(item => {
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragend', handleDragEnd);
      item.addEventListener('dragover', handleDragOver);
      item.addEventListener('drop', handleDrop);
      item.addEventListener('dragleave', handleDragLeave);
    });
  }

  function handleDragStart(e) {
    draggedItem = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.selected-module-item').forEach(item => {
      item.classList.remove('drag-over');
    });
  }

  function handleDragOver(e) {
    e.preventDefault();
    if (this !== draggedItem) {
      this.classList.add('drag-over');
    }
  }

  function handleDragLeave(e) {
    this.classList.remove('drag-over');
  }

  function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    if (this !== draggedItem) {
      const draggedId = draggedItem.dataset.moduleId;
      const targetId = this.dataset.moduleId;

      const draggedIndex = selectedModules.findIndex(m => m.id === draggedId);
      const targetIndex = selectedModules.findIndex(m => m.id === targetId);

      // 순서 변경
      const [removed] = selectedModules.splice(draggedIndex, 1);
      selectedModules.splice(targetIndex, 0, removed);

      updateSelectedModulesList();
    }
  }

  // 제거 버튼 설정
  function setupRemoveButtons() {
    const removeButtons = selectedModulesList.querySelectorAll('.module-remove-btn');

    removeButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const moduleId = this.dataset.moduleId;

        // 체크박스 해제
        const checkbox = document.querySelector(`.module-checkbox[data-module-id="${moduleId}"]`);
        if (checkbox) {
          checkbox.checked = false;
        }

        // 목록에서 제거
        selectedModules = selectedModules.filter(m => m.id !== moduleId);
        updateSelectedModulesList();
      });
    });
  }
});
</script>
