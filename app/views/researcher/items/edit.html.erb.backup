<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :items %>
<% end %>

<% meta = @item.scoring_meta || {} %>
<% stimulus = @item.stimulus %>
<% project_name = meta["project"] || meta["category_main"] || "프로젝트 미지정" %>
<% grade_band = meta["grade_band"] || "학년군 미지정" %>
<% difficulty_label = @item.difficulty || "미지정" %>
<% item_type_label = @item.item_type == "mcq" ? "MCQ" : "서술형" %>
<% status_label = case @item.status
                 when "draft" then "Draft"
                 when "active" then "Published"
                 when "retired" then "Retired"
                 else "Draft"
                 end %>
<% status_class = case @item.status
                  when "draft" then "is-draft"
                  when "active" then "is-published"
                  when "retired" then "is-retired"
                  else "is-draft"
                  end %>
<% choices = @choices || @item.item_choices.includes(:choice_score).order(:choice_no) %>
<% correct_choice = choices.find { |choice| choice.choice_score&.is_key } %>
<% score_points = meta["points"] || meta["score"] || meta["total_score"] %>
<% review_status = meta["review_status"] || "미검수" %>
<% proximity_ready = choices.any? { |choice| choice.choice_score && choice.choice_score.score_percent.to_i > 0 && !choice.choice_score.is_key } %>
<% rubric_levels_count = @criteria.present? ? @criteria.flat_map(&:rubric_levels).map(&:level_score).uniq.size : 0 %>
<% tag_count = Array(meta["wrong_answer_tags"] || meta["tags"] || meta["error_tags"]).size %>

<% content_for :portal_header do %>
  <div class="item-admin-header-wrap">
    <header class="item-admin-header">
      <div class="item-admin-header-left">
        <button type="button" class="item-icon-button" aria-label="메뉴 열기">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 6h16M4 12h16M4 18h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
          </svg>
        </button>
        <div class="item-admin-header-logo">
          <span class="item-admin-header-logo-text">ReadingPRO Administrator</span>
        </div>
      </div>
      <div class="item-admin-header-title">정답/채점 기준 설정</div>
      <div class="item-admin-header-right">
        <a class="item-link" href="#">가이드</a>
        <button type="button" class="item-icon-button" aria-label="알림">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 4a5 5 0 0 0-5 5v2.4c0 .7-.3 1.3-.8 1.8L4.5 15h15l-1.7-1.8a2.5 2.5 0 0 1-.8-1.8V9a5 5 0 0 0-5-5Z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M9.5 18a2.5 2.5 0 0 0 5 0" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
          </svg>
        </button>
        <div class="item-avatar" aria-label="관리자 프로필">KA</div>
      </div>
    </header>
    <div class="item-admin-divider"></div>
    <div class="item-admin-subbar">
      <div class="item-admin-subbar-left">
        <a class="item-back" href="<%= researcher_items_path %>">
          <span aria-hidden="true">&lt;</span>
          문항 목록으로
        </a>
        <div class="item-breadcrumb">
          <%= project_name %> <span class="item-breadcrumb-sep">&gt;</span> <%= stimulus&.title || "지문" %>
          <span class="item-breadcrumb-sep">&gt;</span> 문항 <span class="item-breadcrumb-sep">&gt;</span> 정답/채점
        </div>
      </div>
      <div class="item-admin-subbar-right">
        <span class="item-badge is-outline">문항 코드 <strong><%= @item.code %></strong></span>
        <span class="item-badge is-pill is-review"><%= item_type_label %></span>
        <span class="item-badge is-pill <%= status_class %>"><%= status_label %></span>
      </div>
    </div>
  </div>
<% end %>

<div class="item-admin-page" data-default-state="<%= @item.mcq? ? "mcq-default" : "essay-rubric" %>" data-ai-correct="<%= meta["correct_answer"] %>">
  <div class="item-admin-container">
    <div class="item-state-toggle" role="tablist" aria-label="문항 상태 전환">
      <button type="button" class="item-state-button" data-item-state="mcq-default">MCQ 정답</button>
      <button type="button" class="item-state-button" data-item-state="mcq-proximity">MCQ 근접점수</button>
      <button type="button" class="item-state-button" data-item-state="essay-rubric">서술형 루브릭</button>
    </div>
  </div>

  <section class="item-frame" data-state="mcq-default">
    <%= form_with url: researcher_item_path(@item), method: :patch, class: "item-admin-form", local: true do %>
      <div class="item-frame-header item-admin-container">
        <div>
          <h2>MCQ 정답 설정 화면</h2>
          <p>보기 라디오 선택 + 근접점수 미설정 경고 상태입니다.</p>
        </div>
        <div class="item-frame-badges">
          <span class="item-badge is-pill is-review">MCQ</span>
          <% unless proximity_ready %>
            <span class="item-badge is-pill is-warning">근접점수 미설정</span>
          <% end %>
        </div>
      </div>

      <div class="item-admin-container item-admin-grid">
        <div class="item-col-left">
          <section class="item-card item-info-card">
            <div class="item-card-header">
              <h3>문항 정보 요약</h3>
              <button type="button" class="item-button ghost">학생 화면 미리보기</button>
            </div>
            <div class="item-info-grid">
              <div>
                <span class="item-label">프로젝트</span>
                <strong><%= project_name %></strong>
              </div>
              <div>
                <span class="item-label">학년군</span>
                <strong><%= grade_band %></strong>
              </div>
              <div>
                <span class="item-label">난이도</span>
                <strong><%= difficulty_label %></strong>
              </div>
              <div>
                <span class="item-label">지문</span>
                <strong><a href="#"><%= stimulus&.title || "지문 미지정" %></a></strong>
              </div>
            </div>
            <div class="item-info-row">
              <span class="item-label">문항 코드</span>
              <span class="item-chip"><%= @item.code %></span>
              <span class="item-label">문항 유형</span>
              <span class="item-chip"><%= item_type_label %></span>
            </div>
          </section>
          <section class="item-card item-content-card">
            <div class="item-card-header">
              <h3>문항 콘텐츠</h3>
              <button type="button" class="item-button ghost">펼치기/접기</button>
            </div>
            <div class="item-passage">
              <h4>지문: <%= stimulus&.title || "지문 미지정" %></h4>
              <p><%= truncate(stimulus&.body.to_s, length: 240, omission: "...") %></p>
            </div>
            <div class="item-question">
              <p><strong><%= @item.prompt %></strong></p>
            </div>
            <ul class="item-option-list" data-choice-list>
              <% choices.each do |choice| %>
                <% option_letter = choice.choice_no.to_i.between?(1, 26) ? ("A".ord + choice.choice_no.to_i - 1).chr : choice.choice_no %>
                <% choice_score = choice.choice_score %>
                <% score_percent = choice_score&.score_percent %>
                <% badge_text = if choice_score&.is_key
                                  "정답"
                                elsif score_percent.to_i > 0
                                  "근접 #{score_percent}%"
                                else
                                  "미설정"
                                end %>
                <li>
                  <label class="item-option <%= "is-correct" if choice_score&.is_key %>" data-choice-no="<%= choice.choice_no %>">
                    <input type="radio" name="correct_choice_id" value="<%= choice.id %>" <%= "checked" if choice_score&.is_key %>>
                    <span class="item-option-label"><%= option_letter %></span>
                    <span class="item-option-text"><%= choice.content %></span>
                    <span class="item-badge is-outline"><%= badge_text %></span>
                  </label>
                </li>
              <% end %>
            </ul>
          </section>

          <section class="item-card">
            <h3>관련 태그/메모</h3>
            <div class="item-tag-list">
              <span class="item-tag">대분류: <%= meta["category_main"] || "미지정" %></span>
              <span class="item-tag">소분류: <%= meta["category_sub"] || "미지정" %></span>
              <span class="item-tag">출제 의도: <%= meta["intent"] || "미지정" %></span>
            </div>
          </section>
        </div>

        <div class="item-col-center">
          <section class="item-card item-ai-card">
            <div class="item-card-header">
              <div>
                <h3>AI 채점/정답 검수</h3>
                <p class="item-muted">AI가 정답 설정의 일관성/모호성/배점 타당성을 검토합니다.</p>
              </div>
              <button type="button" class="item-button secondary">분석하기</button>
            </div>

            <div class="item-ai-section">
              <div class="item-ai-title">
                <span class="item-ai-icon">◎</span>
                정답 타당성 검토
              </div>
              <p>정답 타당성: 보기 C가 지문 근거와 가장 직접적으로 연결됩니다.</p>
              <p>현재 정답 선택이 지문 근거와 일치하는지 확인하세요.</p>
              <ul>
                <li>정답 후보를 검토하고 확정하세요.</li>
                <li>근거 문장을 정답 설명에 반영하세요.</li>
              </ul>
              <div class="item-ai-actions">
                <button type="button" class="item-button ghost" data-ai-apply="mcq-correct">제안 적용</button>
                <button type="button" class="item-button ghost">무시</button>
                <button type="button" class="item-button ghost">코멘트 남기기</button>
              </div>
            </div>

            <div class="item-ai-section">
              <div class="item-ai-title">
                <span class="item-ai-icon">!</span>
                문항 모호성/중의성 경고
              </div>
              <p>모호성 경고: 보기 B도 부분 정답으로 해석될 수 있어 표현을 수정하세요.</p>
              <p>보기 간 차별성을 높여 오답률을 안정화하세요.</p>
              <ul>
                <li>보기 B의 조건을 명확히 한정하세요.</li>
                <li>보기 D를 다른 관점으로 변경하세요.</li>
              </ul>
              <div class="item-ai-actions">
                <button type="button" class="item-button ghost">제안 적용</button>
                <button type="button" class="item-button ghost">무시</button>
                <button type="button" class="item-button ghost">코멘트 남기기</button>
              </div>
            </div>

            <div class="item-ai-section">
              <div class="item-ai-title">
                <span class="item-ai-icon">∑</span>
                배점/근접점수 제안
              </div>
              <p>MCQ 근접점수는 아직 설정되지 않았습니다.</p>
              <p>근접점수 탭에서 보기별 점수를 입력하세요.</p>
              <ul>
                <li>근접점수 분포를 확인하고 입력하세요.</li>
                <li>교육청 기준에 맞게 총점을 조정하세요.</li>
              </ul>
              <div class="item-ai-actions">
                <button type="button" class="item-button ghost">제안 적용</button>
                <button type="button" class="item-button ghost">무시</button>
                <button type="button" class="item-button ghost">코멘트 남기기</button>
              </div>
            </div>
          </section>
        </div>
        <div class="item-col-right">
          <section class="item-panel">
            <div class="item-panel-actions">
              <button type="submit" name="commit_action" value="save" class="item-button secondary">임시저장</button>
              <button type="submit" name="commit_action" value="publish" class="item-button primary">게시</button>
            </div>
            <p class="item-panel-note">게시 시 시험지/리포트에 즉시 반영됩니다.</p>

            <div class="item-card">
              <h3>설정 요약</h3>
              <div class="item-summary-grid">
                <div>
                  <span class="item-label">문항 유형</span>
                  <strong><%= item_type_label %></strong>
                </div>
                <div>
                  <span class="item-label">정답 설정</span>
                  <span class="item-badge is-pill <%= correct_choice ? "is-complete" : "is-incomplete" %>">
                    <%= correct_choice ? "완료" : "미완료" %>
                  </span>
                </div>
                <div>
                  <span class="item-label">배점</span>
                  <strong><%= score_points.present? ? "#{score_points}점" : "미지정" %></strong>
                </div>
                <div>
                  <span class="item-label">검수 상태</span>
                  <span class="item-badge is-pill is-review"><%= review_status %></span>
                </div>
                <div>
                  <span class="item-label">마지막 저장</span>
                  <strong><%= @item.updated_at.strftime("%Y-%m-%d %H:%M") %></strong>
                </div>
              </div>
            </div>

            <div class="item-card">
              <h3>필수 점검</h3>
              <div class="item-checklist">
                <label><input type="checkbox" <%= "checked" if correct_choice %>> 정답 지정 완료</label>
                <label><input type="checkbox" <%= "checked" if score_points.present? %>> 배점 입력 완료</label>
                <label><input type="checkbox" <%= "checked" if proximity_ready %>> 근접점수 설정 완료</label>
                <label><input type="checkbox"> 미리보기 확인 완료</label>
              </div>
            </div>

            <div class="item-card">
              <h3>통계/정보</h3>
              <div class="item-summary-grid">
                <div>
                  <span class="item-label">보기 개수</span>
                  <strong><%= choices.size %></strong>
                </div>
                <div>
                  <span class="item-label">오답 유형 태그 수</span>
                  <strong><%= tag_count %></strong>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    <% end %>
  </section>

  <section class="item-frame" data-state="mcq-proximity">
    <%= form_with url: researcher_item_path(@item), method: :patch, class: "item-admin-form", local: true do %>
      <div class="item-frame-header item-admin-container">
        <div>
          <h2>MCQ 근접점수 탭 활성</h2>
          <p>중앙에 근접점수 제안 강조 상태입니다.</p>
        </div>
        <div class="item-frame-badges">
          <span class="item-badge is-pill is-review">MCQ</span>
          <span class="item-badge is-pill is-complete">근접점수 제안 활성</span>
        </div>
      </div>

      <div class="item-admin-container item-admin-grid">
        <div class="item-col-left">
          <section class="item-card item-info-card">
            <div class="item-card-header">
              <h3>문항 정보 요약</h3>
              <button type="button" class="item-button ghost">학생 화면 미리보기</button>
            </div>
            <div class="item-info-grid">
              <div>
                <span class="item-label">프로젝트</span>
                <strong><%= project_name %></strong>
              </div>
              <div>
                <span class="item-label">학년군</span>
                <strong><%= grade_band %></strong>
              </div>
              <div>
                <span class="item-label">난이도</span>
                <strong><%= difficulty_label %></strong>
              </div>
              <div>
                <span class="item-label">지문</span>
                <strong><a href="#"><%= stimulus&.title || "지문 미지정" %></a></strong>
              </div>
            </div>
            <div class="item-info-row">
              <span class="item-label">문항 코드</span>
              <span class="item-chip"><%= @item.code %></span>
              <span class="item-label">문항 유형</span>
              <span class="item-chip"><%= item_type_label %></span>
            </div>
          </section>
          <section class="item-card item-content-card">
            <div class="item-card-header">
              <h3>문항 콘텐츠</h3>
              <button type="button" class="item-button ghost">펼치기/접기</button>
            </div>
            <div class="item-passage">
              <h4>지문: <%= stimulus&.title || "지문 미지정" %></h4>
              <p><%= truncate(stimulus&.body.to_s, length: 240, omission: "...") %></p>
            </div>
            <div class="item-question">
              <p><strong><%= @item.prompt %></strong></p>
            </div>
            <ul class="item-option-list">
              <% choices.each do |choice| %>
                <% option_letter = choice.choice_no.to_i.between?(1, 26) ? ("A".ord + choice.choice_no.to_i - 1).chr : choice.choice_no %>
                <% choice_score = choice.choice_score %>
                <li>
                  <label class="item-option <%= "is-correct" if choice_score&.is_key %>" data-choice-no="<%= choice.choice_no %>">
                    <input type="radio" name="correct_choice_id" value="<%= choice.id %>" <%= "checked" if choice_score&.is_key %>>
                    <span class="item-option-label"><%= option_letter %></span>
                    <span class="item-option-text"><%= choice.content %></span>
                    <span class="item-badge is-outline"><%= choice_score&.is_key ? "정답" : "보기 #{option_letter}" %></span>
                  </label>
                </li>
              <% end %>
            </ul>
          </section>

          <section class="item-card">
            <h3>근접점수 설정</h3>
            <div class="item-score-list">
              <% choices.each do |choice| %>
                <% option_letter = choice.choice_no.to_i.between?(1, 26) ? ("A".ord + choice.choice_no.to_i - 1).chr : choice.choice_no %>
                <% choice_score = choice.choice_score %>
                <label class="item-score-row" data-choice-no="<%= choice.choice_no %>">
                  <span class="item-badge is-outline">보기 <%= option_letter %></span>
                  <input type="number" min="0" max="100" step="1" name="choice_scores[<%= choice.id %>][score_percent]" value="<%= choice_score&.score_percent %>">
                  <span class="item-muted">%</span>
                </label>
              <% end %>
            </div>
          </section>
        </div>

        <div class="item-col-center">
          <section class="item-card item-ai-card">
            <div class="item-card-header">
              <div>
                <h3>AI 채점/정답 검수</h3>
                <p class="item-muted">AI가 정답 설정의 일관성/모호성/배점 타당성을 검토합니다.</p>
              </div>
              <button type="button" class="item-button secondary">분석하기</button>
            </div>

            <div class="item-ai-section">
              <div class="item-ai-title">
                <span class="item-ai-icon">◎</span>
                정답 타당성 검토
              </div>
              <p>정답 타당성: 보기 C가 지문 근거와 가장 직접적으로 연결됩니다.</p>
              <ul>
                <li>정답 후보를 검토하고 확정하세요.</li>
                <li>정답 설명을 구체화하세요.</li>
              </ul>
              <div class="item-ai-actions">
                <button type="button" class="item-button ghost" data-ai-apply="mcq-correct">제안 적용</button>
                <button type="button" class="item-button ghost">무시</button>
                <button type="button" class="item-button ghost">코멘트 남기기</button>
              </div>
            </div>
            <div class="item-ai-section is-highlight" data-ai-section="proximity">
              <div class="item-ai-title">
                <span class="item-ai-icon">∑</span>
                근접점수 제안
              </div>
              <p>AI가 근접점수 분포를 계산했습니다. 기본 배점 기준입니다.</p>
              <div class="item-score-table">
                <% choices.each do |choice| %>
                  <div>
                    <span class="item-label">보기 <%= choice.choice_no %></span>
                    <strong><%= choice.choice_score&.score_percent || 0 %>%</strong>
                  </div>
                <% end %>
              </div>
              <ul>
                <li>근접점수를 입력하고 저장하세요.</li>
                <li>시험 운영 정책과 맞는지 확인하세요.</li>
              </ul>
              <div class="item-ai-actions">
                <button type="button" class="item-button" data-ai-apply="mcq-proximity">제안 적용</button>
                <button type="button" class="item-button ghost">무시</button>
                <button type="button" class="item-button ghost">코멘트 남기기</button>
              </div>
            </div>

            <div class="item-ai-section">
              <div class="item-ai-title">
                <span class="item-ai-icon">!</span>
                문항 모호성/중의성 경고
              </div>
              <p>보기 B와 D가 모두 정답 가능성이 있어 표현을 수정하세요.</p>
              <ul>
                <li>보기 B를 단일 조건으로 변경하세요.</li>
                <li>보기 D에 반례 조건을 추가하세요.</li>
              </ul>
              <div class="item-ai-actions">
                <button type="button" class="item-button ghost">제안 적용</button>
                <button type="button" class="item-button ghost">무시</button>
                <button type="button" class="item-button ghost">코멘트 남기기</button>
              </div>
            </div>
          </section>
        </div>

        <div class="item-col-right">
          <section class="item-panel">
            <div class="item-panel-actions">
              <button type="submit" name="commit_action" value="save" class="item-button secondary">임시저장</button>
              <button type="submit" name="commit_action" value="publish" class="item-button primary">게시</button>
            </div>
            <p class="item-panel-note">게시 시 시험지/리포트에 즉시 반영됩니다.</p>

            <div class="item-card">
              <h3>설정 요약</h3>
              <div class="item-summary-grid">
                <div>
                  <span class="item-label">문항 유형</span>
                  <strong><%= item_type_label %></strong>
                </div>
                <div>
                  <span class="item-label">정답 설정</span>
                  <span class="item-badge is-pill <%= correct_choice ? "is-complete" : "is-incomplete" %>">
                    <%= correct_choice ? "완료" : "미완료" %>
                  </span>
                </div>
                <div>
                  <span class="item-label">배점</span>
                  <strong><%= score_points.present? ? "#{score_points}점" : "미지정" %></strong>
                </div>
                <div>
                  <span class="item-label">검수 상태</span>
                  <span class="item-badge is-pill is-review"><%= review_status %></span>
                </div>
                <div>
                  <span class="item-label">마지막 저장</span>
                  <strong><%= @item.updated_at.strftime("%Y-%m-%d %H:%M") %></strong>
                </div>
              </div>
            </div>

            <div class="item-card">
              <h3>필수 점검</h3>
              <div class="item-checklist">
                <label><input type="checkbox" <%= "checked" if correct_choice %>> 정답 지정 완료</label>
                <label><input type="checkbox" <%= "checked" if score_points.present? %>> 배점 입력 완료</label>
                <label><input type="checkbox" <%= "checked" if proximity_ready %>> 근접점수 설정 완료</label>
                <label><input type="checkbox"> 미리보기 확인 완료</label>
              </div>
            </div>

            <div class="item-card">
              <h3>통계/정보</h3>
              <div class="item-summary-grid">
                <div>
                  <span class="item-label">보기 개수</span>
                  <strong><%= choices.size %></strong>
                </div>
                <div>
                  <span class="item-label">오답 유형 태그 수</span>
                  <strong><%= tag_count %></strong>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    <% end %>
  </section>

  <section class="item-frame" data-state="essay-rubric">
    <%= form_with url: researcher_item_path(@item), method: :patch, class: "item-admin-form", local: true do %>
      <div class="item-frame-header item-admin-container">
        <div>
          <h2>서술형 루브릭 편집 화면</h2>
          <p>루브릭 빌더 + AI 제안 적용 버튼이 포함된 상태입니다.</p>
        </div>
        <div class="item-frame-badges">
          <span class="item-badge is-pill is-review">서술형</span>
          <span class="item-badge is-pill is-complete">AI 제안 준비됨</span>
        </div>
      </div>

      <div class="item-admin-container item-admin-grid">
        <div class="item-col-left">
          <section class="item-card item-info-card">
            <div class="item-card-header">
              <h3>문항 정보 요약</h3>
              <button type="button" class="item-button ghost">학생 화면 미리보기</button>
            </div>
            <div class="item-info-grid">
              <div>
                <span class="item-label">프로젝트</span>
                <strong><%= project_name %></strong>
              </div>
              <div>
                <span class="item-label">학년군</span>
                <strong><%= grade_band %></strong>
              </div>
              <div>
                <span class="item-label">난이도</span>
                <strong><%= difficulty_label %></strong>
              </div>
              <div>
                <span class="item-label">지문</span>
                <strong><a href="#"><%= stimulus&.title || "지문 미지정" %></a></strong>
              </div>
            </div>
            <div class="item-info-row">
              <span class="item-label">문항 코드</span>
              <span class="item-chip"><%= @item.code %></span>
              <span class="item-label">문항 유형</span>
              <span class="item-chip">서술형</span>
            </div>
          </section>
          <section class="item-card item-content-card">
            <div class="item-card-header">
              <h3>문항 콘텐츠</h3>
              <button type="button" class="item-button ghost">펼치기/접기</button>
            </div>
            <div class="item-passage">
              <h4>지문: <%= stimulus&.title || "지문 미지정" %></h4>
              <p><%= truncate(stimulus&.body.to_s, length: 240, omission: "...") %></p>
            </div>
            <div class="item-question">
              <p><strong><%= @item.prompt %></strong></p>
            </div>
            <div class="item-answer-box">
              <label class="item-label">서술형 입력 예시</label>
              <textarea rows="3" placeholder="학생이 여기에 답안을 작성합니다." disabled></textarea>
            </div>
          </section>

          <section class="item-card">
            <h3>정답(샘플 답안)</h3>
            <% @item.item_sample_answers.each do |answer| %>
              <label class="item-field">
                답안
                <textarea name="sample_answers[<%= answer.id %>]" rows="3"><%= answer.answer %></textarea>
              </label>
              <label class="item-inline-check">
                <input type="checkbox" name="delete_sample_answers[]" value="<%= answer.id %>">
                이 답안 삭제
              </label>
            <% end %>
            <label class="item-field">
              새 답안 추가
              <textarea name="new_sample_answer" rows="3" placeholder="새 샘플 답안을 입력하세요"></textarea>
            </label>
          </section>
        </div>

        <div class="item-col-center">
          <section class="item-card item-ai-card">
            <div class="item-card-header">
              <div>
                <h3>AI 채점/정답 검수</h3>
                <p class="item-muted">AI가 정답 설정의 일관성/모호성/배점 타당성을 검토합니다.</p>
              </div>
              <button type="button" class="item-button secondary">분석하기</button>
            </div>

            <div class="item-ai-section is-highlight">
              <div class="item-ai-title">
                <span class="item-ai-icon">✦</span>
                루브릭 수준 제안
              </div>
              <p>AI가 서술형 답안의 핵심 요소를 기준으로 루브릭 초안을 생성했습니다.</p>
              <ul>
                <li>핵심 근거 제시 여부</li>
                <li>문장 구조와 논리적 연결성</li>
                <li>핵심 용어 정확성</li>
              </ul>
              <div class="item-ai-actions">
                <button type="button" class="item-button" data-ai-apply="rubric">AI 제안 적용</button>
                <button type="button" class="item-button ghost">무시</button>
                <button type="button" class="item-button ghost">코멘트 남기기</button>
              </div>
            </div>

            <div class="item-card item-rubric-card">
              <div class="item-card-header">
                <h3>루브릭 빌더</h3>
                <span class="item-badge is-outline">레벨 0-3</span>
              </div>
              <label class="item-field">
                루브릭 제목
                <input type="text" name="rubric[title]" value="<%= @rubric.title %>">
              </label>
              <% @criteria.each do |criterion| %>
                <div class="item-rubric-criterion">
                  <div class="item-rubric-header">
                    <label class="item-field">
                      기준명
                      <input type="text" name="criteria[<%= criterion.id %>][name]" value="<%= criterion.name %>">
                    </label>
                    <div class="item-rubric-actions">
                      <%= button_to "위로", move_criterion_researcher_item_path(@item, criterion_id: criterion.id, direction: "up"),
                                    method: :patch, class: "item-button secondary item-button-sm" %>
                      <%= button_to "아래로", move_criterion_researcher_item_path(@item, criterion_id: criterion.id, direction: "down"),
                                    method: :patch, class: "item-button secondary item-button-sm" %>
                    </div>
                  </div>
                  <label class="item-inline-check">
                    <input type="checkbox" name="delete_criteria[]" value="<%= criterion.id %>">
                    이 기준 삭제
                  </label>
                  <div class="item-rubric-levels">
                    <% (0..3).each do |score| %>
                      <% level = criterion.rubric_levels.find { |l| l.level_score == score } %>
                      <label class="item-field">
                        <span class="item-badge is-outline">레벨 <%= score %></span>
                        <textarea name="criteria[<%= criterion.id %>][levels][<%= score %>]" rows="3"><%= level&.descriptor %></textarea>
                      </label>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <div class="item-rubric-criterion">
                <h4>새 기준 추가</h4>
                <label class="item-field">
                  기준명
                  <input type="text" name="new_criterion[name]" placeholder="새 기준명을 입력하세요">
                </label>
                <div class="item-rubric-levels">
                  <% (0..3).each do |score| %>
                    <label class="item-field">
                      <span class="item-badge is-outline">레벨 <%= score %></span>
                      <textarea name="new_criterion[levels][<%= score %>]" rows="3" placeholder="설명을 입력하세요"></textarea>
                    </label>
                  <% end %>
                </div>
              </div>
            </div>
          </section>
        </div>
        <div class="item-col-right">
          <section class="item-panel">
            <div class="item-panel-actions">
              <button type="submit" name="commit_action" value="save" class="item-button secondary">임시저장</button>
              <button type="submit" name="commit_action" value="publish" class="item-button primary">게시</button>
            </div>
            <p class="item-panel-note">게시 시 시험지/리포트에 즉시 반영됩니다.</p>

            <div class="item-card">
              <h3>설정 요약</h3>
              <div class="item-summary-grid">
                <div>
                  <span class="item-label">문항 유형</span>
                  <strong>서술형</strong>
                </div>
                <div>
                  <span class="item-label">정답 설정</span>
                  <span class="item-badge is-pill is-complete">완료</span>
                </div>
                <div>
                  <span class="item-label">배점</span>
                  <strong><%= score_points.present? ? "#{score_points}점" : "미지정" %></strong>
                </div>
                <div>
                  <span class="item-label">검수 상태</span>
                  <span class="item-badge is-pill is-review"><%= review_status %></span>
                </div>
                <div>
                  <span class="item-label">마지막 저장</span>
                  <strong><%= @item.updated_at.strftime("%Y-%m-%d %H:%M") %></strong>
                </div>
              </div>
            </div>

            <div class="item-card">
              <h3>필수 점검</h3>
              <div class="item-checklist">
                <label><input type="checkbox" checked> 정답 지정 완료</label>
                <label><input type="checkbox" <%= "checked" if score_points.present? %>> 배점 입력 완료</label>
                <label><input type="checkbox" <%= "checked" if rubric_levels_count.positive? %>> 루브릭 레벨 설정 완료</label>
                <label><input type="checkbox"> 미리보기 확인 완료</label>
              </div>
            </div>
            <div class="item-card">
              <h3>통계/정보</h3>
              <div class="item-summary-grid">
                <div>
                  <span class="item-label">루브릭 레벨 수</span>
                  <strong><%= rubric_levels_count %></strong>
                </div>
                <div>
                  <span class="item-label">오답 유형 태그 수</span>
                  <strong><%= tag_count %></strong>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    <% end %>
  </section>
</div>

<div class="portal-modal" id="delete-confirm-modal" aria-hidden="true">
  <div class="portal-modal-card">
    <h3>삭제 확인</h3>
    <p class="portal-muted">선택한 항목을 삭제합니다. 계속할까요?</p>
    <div class="portal-cta">
      <button type="button" class="portal-button" id="confirm-delete">삭제 계속</button>
      <button type="button" class="portal-button secondary" id="cancel-delete">취소</button>
    </div>
  </div>
</div>

<script>
  (function () {
    const page = document.querySelector(".item-admin-page")
    if (page) {
      const buttons = page.querySelectorAll(".item-state-button")
      const frames = page.querySelectorAll(".item-frame")
      const params = new URLSearchParams(window.location.search)
      const defaultState = params.get("state") || page.dataset.defaultState || "mcq-default"

      const setState = (state) => {
        page.setAttribute("data-active-state", state)
        buttons.forEach((button) => {
          button.classList.toggle("is-active", button.dataset.itemState === state)
        })
        frames.forEach((frame) => {
          frame.hidden = frame.dataset.state !== state
        })
      }

      setState(defaultState)

      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          setState(button.dataset.itemState)
        })
      })
    }

    const applyCorrect = (container) => {
      const correct = container.dataset.aiCorrect
      if (!correct) return
      const options = container.querySelectorAll("[data-choice-no]")
      options.forEach((option) => {
        if (option.dataset.choiceNo === correct.toString()) {
          const radio = option.querySelector("input[type='radio']")
          if (radio) radio.checked = true
        }
      })
    }

    document.querySelectorAll("[data-ai-apply='mcq-correct']").forEach((button) => {
      button.addEventListener("click", () => {
        const container = document.querySelector(".item-admin-page")
        if (container) applyCorrect(container)
      })
    })

    document.querySelectorAll("[data-ai-apply='mcq-proximity']").forEach((button) => {
      button.addEventListener("click", () => {
        const frame = button.closest(".item-frame")
        if (!frame) return
        frame.querySelectorAll(".item-score-row").forEach((row) => {
          const input = row.querySelector("input")
          if (input && input.value === "") {
            input.value = 0
          }
        })
      })
    })

    document.querySelectorAll("[data-ai-apply='rubric']").forEach((button) => {
      button.addEventListener("click", () => {
        const frame = button.closest(".item-frame")
        if (!frame) return
        frame.querySelectorAll(".item-rubric-levels textarea").forEach((textarea, index) => {
          if (textarea.value.trim() === "") {
            textarea.value = `핵심 근거 ${index % 3 + 1}을 포함해 설명합니다.`
          }
        })
      })
    })

    const forms = document.querySelectorAll("form.item-admin-form")
    const modal = document.getElementById("delete-confirm-modal")
    const confirmBtn = document.getElementById("confirm-delete")
    const cancelBtn = document.getElementById("cancel-delete")
    if (!forms.length || !modal || !confirmBtn || !cancelBtn) return

    let confirmed = false
    let activeForm = null

    forms.forEach((form) => {
      form.addEventListener("submit", (event) => {
        const deleteChecks = form.querySelectorAll(
          "input[name='delete_sample_answers[]']:checked, input[name='delete_criteria[]']:checked"
        )
        if (!deleteChecks.length || confirmed) return

        event.preventDefault()
        activeForm = form
        modal.setAttribute("aria-hidden", "false")
        modal.classList.add("is-open")
      })
    })

    confirmBtn.addEventListener("click", () => {
      confirmed = true
      modal.setAttribute("aria-hidden", "true")
      modal.classList.remove("is-open")
      if (activeForm) activeForm.requestSubmit()
    })

    cancelBtn.addEventListener("click", () => {
      modal.setAttribute("aria-hidden", "true")
      modal.classList.remove("is-open")
    })
  })()
</script>
