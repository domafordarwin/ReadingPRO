<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :items %>
<% end %>

<% stimulus = @item.stimulus %>
<% project_name = @item.evaluation_indicator&.name || @item.category || "평가 영역 미지정" %>
<% grade_band = @item.evaluation_indicator ? "Level #{@item.evaluation_indicator.level}" : "학년군 미지정" %>
<% difficulty_label = @item.difficulty || "미지정" %>
<% item_type_label = @item.item_type == "mcq" ? "MCQ" : "서술형" %>
<% status_label = case @item.status
                when "draft" then "Draft"
                when "active" then "Published"
                when "archived" then "Archived"
                else "Draft"
                end %>
<% status_class = case @item.status
                 when "draft" then "rp-badge--warning"
                 when "active" then "rp-badge--success"
                 when "archived" then "rp-badge--danger"
                 else "rp-badge--warning"
                 end %>
<% choices = @choices || @item.item_choices.order(:id) %>
<% correct_choice = choices.find { |choice| choice.is_correct } %>
<% proximity_ready = choices.any? { |choice| !choice.is_correct } %>
<% rubric_levels_count = @criteria.present? ? @criteria.flat_map(&:rubric_levels).map(&:level).uniq.size : 0 %>

<% content_for :portal_header do %>
  <div class="rp-header-wrapper">
    <header class="rp-header">
      <div class="rp-header__left">
        <button type="button" class="rp-icon-button" aria-label="메뉴 열기">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 6h16M4 12h16M4 18h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
          </svg>
        </button>
        <div class="rp-header__logo">
          <span class="rp-header__logo-text">ReadingPRO Administrator</span>
        </div>
      </div>
      <div class="rp-header__title">정답/채점 기준 설정</div>
      <div class="rp-header__right">
        <a class="rp-link" href="#">가이드</a>
        <button type="button" class="rp-icon-button" aria-label="알림">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 4a5 5 0 0 0-5 5v2.4c0 .7-.3 1.3-.8 1.8L4.5 15h15l-1.7-1.8a2.5 2.5 0 0 1-.8-1.8V9a5 5 0 0 0-5-5Z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M9.5 18a2.5 2.5 0 0 0 5 0" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
          </svg>
        </button>
        <div class="rp-avatar" aria-label="관리자 프로필">KA</div>
      </div>
    </header>
    <div class="rp-header-divider"></div>
    <div class="rp-header-subbar">
      <div class="rp-header-subbar__left">
        <a class="rp-back-link" href="<%= researcher_items_path %>">
          <span aria-hidden="true">&lt;</span>
          문항 목록으로
        </a>
        <div class="rp-breadcrumb">
          <%= project_name %> <span class="rp-breadcrumb__sep">&gt;</span> <%= stimulus&.title || "지문" %>
          <span class="rp-breadcrumb__sep">&gt;</span> 문항 <span class="rp-breadcrumb__sep">&gt;</span> 정답/채점
        </div>
      </div>
      <div class="rp-header-subbar__right">
        <span class="rp-badge">문항 코드 <strong><%= @item.code %></strong></span>
        <span class="rp-badge rp-badge--pill rp-badge--info"><%= item_type_label %></span>
        <span class="rp-badge rp-badge--pill <%= status_class %>"><%= status_label %></span>
      </div>
    </div>
  </div>
<% end %>

<div class="rp-main" data-default-state="<%= @item.mcq? ? "mcq-default" : "essay-rubric" %>">
  <div class="rp-main__container">
    <!-- Page Header -->
    <div class="rp-page-header" style="margin-bottom: 24px;">
      <div class="rp-page-header__top">
        <%= link_to researcher_items_path, class: "rp-back-button" do %>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          <span>문항 목록으로 돌아가기</span>
        <% end %>
      </div>
      <h1 class="rp-page-header__title">문항 편집: <%= @item.code %></h1>
      <p class="rp-page-header__subtitle">정답/채점 기준을 설정하세요</p>
    </div>

    <!-- Item Preview Section (Always Visible) -->
    <div class="item-preview-section">
      <!-- Item Type & Metadata (Display Only) -->
      <%
        difficulty_kr = { "easy" => "쉬움", "medium" => "보통", "hard" => "어려움" }
        sub_indicator = @item.sub_indicator_id.present? ? SubIndicator.find_by(id: @item.sub_indicator_id) : nil
      %>
      <div class="item-meta-badges">
        <span class="item-type-badge item-type-badge--<%= @item.item_type %>">
          <%= @item.item_type == "mcq" ? "객관식 (MCQ)" : "서술형" %>
        </span>
        <span class="difficulty-badge difficulty-badge--<%= @item.difficulty || 'medium' %>">
          난이도: <%= difficulty_kr[@item.difficulty] || "미지정" %>
        </span>
        <% if @item.evaluation_indicator %>
          <span class="indicator-badge"><%= @item.evaluation_indicator.name %></span>
        <% end %>
        <% if sub_indicator %>
          <span class="indicator-badge indicator-badge--sub"><%= sub_indicator.name %></span>
        <% end %>
      </div>

      <!-- Stimulus (Reading Passage) - 먼저 표시 -->
      <% if stimulus %>
        <div class="stimulus-card">
          <div class="stimulus-card-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <h3>지문</h3>
            <% if stimulus.code %>
              <span class="stimulus-code-badge"><%= stimulus.code %></span>
            <% end %>
          </div>
          <div class="stimulus-title-section">
            <h4><%= stimulus.title %></h4>
          </div>
          <div class="stimulus-body-section">
            <%= simple_format(stimulus.body) %>
          </div>
        </div>
      <% end %>

      <!-- Item Prompt (Question) - 지문 다음에 표시 (편집 가능) -->
      <div class="item-prompt-card">
        <div class="item-prompt-header">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4M12 8h.01"></path>
          </svg>
          <h3>문항 발문</h3>
          <div class="prompt-format-toolbar">
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('bold')" title="굵게 (Ctrl+B)"><strong>B</strong></button>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('italic')" title="기울임 (Ctrl+I)"><em>I</em></button>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('underline')" title="밑줄 (Ctrl+U)"><u>U</u></button>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('strikeThrough')" title="취소선"><s>S</s></button>
            <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="promptFmt('removeFormat')" title="서식 제거" style="font-size: 11px;">✕</button>
          </div>
        </div>
        <div contenteditable="true"
             id="prompt-editor"
             class="item-prompt-body item-prompt-editor"
             oninput="syncPromptToForms()"><%= sanitize(@item.prompt, tags: %w[b strong i em u s br span p div], attributes: %w[style class]) %></div>
      </div>

      <!-- MCQ Choices Editor (only for MCQ items) - 발문 아래 편집 가능 -->
      <% if @item.mcq? && @choices.any? %>
        <div class="item-choices-preview">
          <div class="item-choices-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <h3>선택지</h3>
            <div class="choice-format-toolbar-top">
              <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="choiceFmt('bold')" title="굵게 (Ctrl+B)"><strong>B</strong></button>
              <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="choiceFmt('italic')" title="기울임 (Ctrl+I)"><em>I</em></button>
              <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="choiceFmt('underline')" title="밑줄 (Ctrl+U)"><u>U</u></button>
              <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="choiceFmt('strikeThrough')" title="취소선"><s>S</s></button>
              <button type="button" class="rp-fmt-btn" onmousedown="event.preventDefault()" onclick="choiceFmt('removeFormat')" title="서식 제거" style="font-size: 11px;">✕</button>
            </div>
          </div>
          <div class="choices-grid">
            <% @choices.each do |choice| %>
              <% option_letter = choice.choice_no.to_i.between?(1, 26) ? ("A".ord + choice.choice_no.to_i - 1).chr : choice.choice_no %>
              <div class="choice-preview <%= 'choice-preview--correct' if choice.is_correct %>">
                <div class="choice-preview-label"><%= option_letter %></div>
                <div contenteditable="true"
                     class="choice-preview-text rp-choice-editor"
                     data-choice-id="<%= choice.id %>"
                     oninput="syncChoiceContent(<%= choice.id %>)"><%= sanitize(choice.content, tags: %w[b strong i em u s br span], attributes: %w[style class]) %></div>
                <% if choice.is_correct %>
                  <span class="correct-indicator">✓ 정답</span>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Mode Tabs -->
    <div class="rp-tabs" role="tablist" aria-label="문항 편집 모드">
      <% if @item.mcq? %>
        <button type="button" class="rp-tab rp-tab--active" data-state="mcq-default" role="tab">MCQ 정답</button>
        <button type="button" class="rp-tab" data-state="mcq-proximity" role="tab">MCQ 근접점수</button>
      <% else %>
        <button type="button" class="rp-tab rp-tab--active" data-state="essay-rubric" role="tab">서술형 루브릭</button>
      <% end %>
    </div>

    <!-- MCQ Default Mode -->
    <section class="rp-frame" data-state="mcq-default" style="<%= 'display: none;' unless @item.mcq? %>">
      <%= form_with url: researcher_item_path(@item), method: :patch, class: "rp-form", data: { turbo: false } do %>
        <input type="hidden" name="item[prompt]" class="prompt-hidden-field" value="<%= sanitize(@item.prompt, tags: %w[b strong i em u s br span p div], attributes: %w[style class]) %>">
        <div class="rp-grid rp-grid--2" style="grid-template-columns: 65fr 35fr; gap: 24px;">

          <!-- LEFT COLUMN: Choices Selection -->
          <div class="rp-col-left">
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">정답 선택</h3>
                <span class="rp-badge rp-badge--info">총 <%= choices.count %>개 선택지</span>
              </div>
              <div class="rp-card__body">
                <p class="rp-instruction-text">올바른 선택지를 클릭하여 정답으로 지정하세요. 선택지 내용은 위 미리보기에서 편집할 수 있습니다.</p>

                <div class="rp-choices-list">
                  <% choices.each do |choice| %>
                    <% option_letter = choice.choice_no.to_i.between?(1, 26) ? ("A".ord + choice.choice_no.to_i - 1).chr : choice.choice_no %>
                    <div class="rp-choice-option <%= 'rp-choice-option--correct' if choice.is_correct %>">
                      <label class="rp-choice-select-area" for="choice_radio_<%= choice.id %>">
                        <%= radio_button_tag "correct_choice_id", choice.id, choice.is_correct, class: "rp-radio", id: "choice_radio_#{choice.id}" %>
                        <span class="rp-choice-label"><%= option_letter %></span>
                        <% if choice.is_correct %>
                          <span class="rp-badge rp-badge--success">정답</span>
                        <% end %>
                      </label>
                      <span class="rp-choice-text" id="choice-display-<%= choice.id %>"><%= sanitize(choice.content, tags: %w[b strong i em u s br span], attributes: %w[style class]) %></span>
                      <input type="hidden" name="choice_contents[<%= choice.id %>]" id="choice-hidden-<%= choice.id %>"
                             value="<%= sanitize(choice.content, tags: %w[b strong i em u s br span], attributes: %w[style class]) %>">
                    </div>
                  <% end %>
                </div>
              </div>
            </div>

            <!-- Additional Info -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">평가 정보</h3>
              </div>
              <div class="rp-card__body">
                <div class="rp-info-row">
                  <span class="rp-info-label">평가 영역</span>
                  <span class="rp-info-value"><%= @item.evaluation_indicator&.name || "미지정" %></span>
                </div>
                <div class="rp-info-row">
                  <span class="rp-info-label">세부 지표</span>
                  <span class="rp-info-value"><%= @item.sub_indicator&.name || "미지정" %></span>
                </div>
                <div class="rp-info-row">
                  <span class="rp-info-label">난이도</span>
                  <span class="rp-info-value"><%= difficulty_label %></span>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN: Summary, AI, Actions -->
          <div class="rp-col-right">
            <!-- Summary Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">설정 요약</h3>
              </div>
              <div class="rp-card__body">
                <div class="rp-summary-grid">
                  <div class="rp-summary-item">
                    <span class="rp-label">문항 유형</span>
                    <span class="rp-value">객관식</span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">정답 설정</span>
                    <span class="rp-badge rp-badge--pill <%= correct_choice ? 'rp-badge--success' : 'rp-badge--danger' %>">
                      <%= correct_choice ? "완료" : "미완료" %>
                    </span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">선택지 수</span>
                    <span class="rp-value"><%= choices.count %>개</span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">난이도</span>
                    <select name="item_meta[difficulty]" class="rp-meta-select">
                      <option value="easy" <%= "selected" if @item.difficulty == "easy" %>>쉬움</option>
                      <option value="medium" <%= "selected" if @item.difficulty == "medium" %>>보통</option>
                      <option value="hard" <%= "selected" if @item.difficulty == "hard" %>>어려움</option>
                    </select>
                  </div>
                  <div class="rp-summary-item rp-summary-item--full">
                    <span class="rp-label">평가영역</span>
                    <div class="rp-meta-select-wrap">
                      <select name="item_meta[evaluation_indicator_id]" class="rp-meta-select meta-indicator-select"
                              onchange="filterSubIndicators(this)">
                        <option value="">-- 선택 --</option>
                        <% @evaluation_indicators.each do |ind| %>
                          <option value="<%= ind.id %>" <%= "selected" if @item.evaluation_indicator_id == ind.id %>><%= ind.name %></option>
                        <% end %>
                      </select>
                      <button type="button" class="rp-add-btn" onclick="showAddIndicator(this)" title="새 평가영역 추가">+</button>
                    </div>
                    <div class="rp-add-inline" style="display:none;">
                      <input type="text" class="rp-input rp-input--sm" placeholder="새 평가영역명" maxlength="100">
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--primary" onclick="createIndicator(this)">추가</button>
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--secondary" onclick="hideAddInline(this)">취소</button>
                    </div>
                  </div>
                  <div class="rp-summary-item rp-summary-item--full">
                    <span class="rp-label">하위분류</span>
                    <div class="rp-meta-select-wrap">
                      <select name="item_meta[sub_indicator_id]" class="rp-meta-select meta-sub-select">
                        <option value="">-- 선택 --</option>
                        <% @sub_indicators.each do |sub| %>
                          <option value="<%= sub.id %>" data-parent="<%= sub.evaluation_indicator_id %>"
                                  <%= "selected" if @item.sub_indicator_id == sub.id %>><%= sub.name %></option>
                        <% end %>
                      </select>
                      <button type="button" class="rp-add-btn" onclick="showAddSubIndicator(this)" title="새 하위분류 추가">+</button>
                    </div>
                    <div class="rp-add-inline" style="display:none;">
                      <input type="text" class="rp-input rp-input--sm" placeholder="새 하위분류명" maxlength="100">
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--primary" onclick="createSubIndicator(this)">추가</button>
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--secondary" onclick="hideAddInline(this)">취소</button>
                    </div>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">마지막 저장</span>
                    <span class="rp-value"><%= @item.updated_at.strftime("%Y-%m-%d %H:%M") %></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Collapsible AI Suggestions -->
            <details class="rp-card rp-card--collapsible">
              <summary class="rp-card__header rp-card__header--clickable">
                <div class="rp-card__title-group">
                  <svg class="rp-icon-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                  <h3 class="rp-card__title">AI 제안</h3>
                </div>
                <span class="rp-badge rp-badge--ai">GPT-4</span>
              </summary>
              <div class="rp-card__body">
                <div class="rp-ai-suggestion rp-ai-suggestion--spaced">
                  <h4 class="rp-ai-suggestion__title">정답 타당성 검토</h4>
                  <p class="rp-ai-suggestion__desc">정답 타당성: 보기 C가 지문 근거와 가장 직접적으로 연결됩니다.</p>
                  <ul class="rp-ai-suggestion__list">
                    <li>정답 후보를 검토하고 확정하세요.</li>
                    <li>근거 문장을 정답 설명에 반영하세요.</li>
                  </ul>
                  <button type="button" class="rp-btn rp-btn--secondary rp-btn--sm rp-btn--full" data-ai-apply="mcq-correct">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    제안 적용
                  </button>
                </div>

                <div class="rp-ai-suggestion rp-ai-suggestion--warning rp-ai-suggestion--spaced">
                  <h4 class="rp-ai-suggestion__title">문항 모호성 경고</h4>
                  <p class="rp-ai-suggestion__desc">보기 B도 부분 정답으로 해석될 수 있어 표현을 수정하세요.</p>
                  <ul class="rp-ai-suggestion__list">
                    <li>보기 B의 조건을 명확히 한정하세요.</li>
                    <li>보기 D를 다른 관점으로 변경하세요.</li>
                  </ul>
                </div>
              </div>
            </details>

            <!-- Checklist Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">필수 점검</h3>
              </div>
              <div class="rp-card__body">
                <div class="rp-checklist">
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if correct_choice %>>
                    <span>정답 지정 완료</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if choices.count >= 4 %>>
                    <span>선택지 4개 이상</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if proximity_ready %>>
                    <span>근접점수 설정</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox">
                    <span>미리보기 확인</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="rp-card rp-card__footer">
              <button type="submit" name="commit_action" value="save" class="rp-btn rp-btn--secondary rp-btn--full">임시저장</button>
              <button type="submit" name="commit_action" value="publish" class="rp-btn rp-btn--primary rp-btn--full">게시</button>
              <% if stimulus.present? %>
                <a href="<%= researcher_passage_path(stimulus) %>" class="rp-btn rp-btn--outline rp-btn--full" style="margin-top: 4px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                  지문 모듈로 돌아가기
                </a>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </section>

    <!-- MCQ Proximity Mode -->
    <section class="rp-frame" data-state="mcq-proximity" style="display: none;">
      <%= form_with url: researcher_item_path(@item), method: :patch, class: "rp-form", data: { turbo: false } do %>
        <input type="hidden" name="item[prompt]" class="prompt-hidden-field" value="<%= sanitize(@item.prompt, tags: %w[b strong i em u s br span p div], attributes: %w[style class]) %>">
        <div class="rp-grid rp-grid--2" style="grid-template-columns: 65fr 35fr; gap: 24px;">

          <!-- LEFT COLUMN: Proximity Score Setting -->
          <div class="rp-col-left">
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">선택지별 근접점수 설정</h3>
                <span class="rp-badge rp-badge--info">0-100%</span>
              </div>
              <div class="rp-card__body">
                <div class="rp-instruction-box">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                  <p>정답을 선택하고 각 선택지별로 부분 점수를 설정하세요. 정답은 자동으로 100%로 설정되며, 오답에만 근접점수를 부여할 수 있습니다.</p>
                </div>

                <div class="rp-proximity-scores-list">
                  <% choices.each do |choice| %>
                    <% option_letter = choice.choice_no.to_i.between?(1, 26) ? ("A".ord + choice.choice_no.to_i - 1).chr : choice.choice_no %>
                    <div class="rp-proximity-score-item <%= 'rp-proximity-score-item--correct' if choice.is_correct %>" data-choice-id="<%= choice.id %>">
                      <div class="rp-proximity-score-header">
                        <%= radio_button_tag "correct_choice_id", choice.id, choice.is_correct,
                                            class: "rp-radio-proximity",
                                            id: "proximity_choice_#{choice.id}",
                                            data: { choice_id: choice.id } %>
                        <label for="proximity_choice_<%= choice.id %>" class="rp-choice-label-large" style="cursor: pointer;"><%= option_letter %></label>
                        <% if choice.is_correct %>
                          <span class="rp-badge rp-badge--success">정답</span>
                        <% end %>
                      </div>
                      <div class="rp-choice-text-display"><%= sanitize(choice.content, tags: %w[b strong i em u s br span], attributes: %w[style class]) %></div>
                      <div class="rp-proximity-score-bottom">
                        <div class="rp-proximity-score-input-group">
                          <label class="rp-score-input-label">점수 비율</label>
                          <%= number_field_tag "choice_scores[#{choice.id}][score_percent]",
                                               choice.proximity_score || (choice.is_correct ? 100 : 0),
                                               min: 0, max: 100, step: 5,
                                               disabled: choice.is_correct,
                                               class: "rp-input rp-input--score-large",
                                               id: "score_input_#{choice.id}" %>
                          <span class="rp-score-unit-large">%</span>
                        </div>
                        <div class="rp-proximity-reason-group">
                          <label class="rp-score-input-label">설정 사유</label>
                          <%= text_field_tag "choice_scores[#{choice.id}][reason]",
                                             choice.proximity_reason,
                                             placeholder: choice.is_correct ? "정답 (자동 100%) - 사유를 입력할 수 있습니다" : "근접점수 부여 사유를 입력하세요",
                                             class: "rp-input rp-input--reason",
                                             id: "reason_input_#{choice.id}" %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>

                <div class="rp-instruction-box" style="margin-top: 16px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                  <p><strong>안내:</strong> 정답은 자동으로 100%로 고정됩니다. 오답 선택지에만 부분 점수(0-95%)를 설정할 수 있습니다.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN: Summary, AI, Actions -->
          <div class="rp-col-right">
            <!-- Summary Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">설정 요약</h3>
              </div>
              <div class="rp-card__body">
                <div class="rp-summary-grid">
                  <div class="rp-summary-item">
                    <span class="rp-label">문항 유형</span>
                    <span class="rp-value">객관식 (근접점수)</span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">정답 설정</span>
                    <span class="rp-badge rp-badge--pill <%= correct_choice ? 'rp-badge--success' : 'rp-badge--danger' %>">
                      <%= correct_choice ? "완료" : "미완료" %>
                    </span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">선택지 수</span>
                    <span class="rp-value"><%= choices.count %>개</span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">난이도</span>
                    <select name="item_meta[difficulty]" class="rp-meta-select">
                      <option value="easy" <%= "selected" if @item.difficulty == "easy" %>>쉬움</option>
                      <option value="medium" <%= "selected" if @item.difficulty == "medium" %>>보통</option>
                      <option value="hard" <%= "selected" if @item.difficulty == "hard" %>>어려움</option>
                    </select>
                  </div>
                  <div class="rp-summary-item rp-summary-item--full">
                    <span class="rp-label">평가영역</span>
                    <div class="rp-meta-select-wrap">
                      <select name="item_meta[evaluation_indicator_id]" class="rp-meta-select meta-indicator-select"
                              onchange="filterSubIndicators(this)">
                        <option value="">-- 선택 --</option>
                        <% @evaluation_indicators.each do |ind| %>
                          <option value="<%= ind.id %>" <%= "selected" if @item.evaluation_indicator_id == ind.id %>><%= ind.name %></option>
                        <% end %>
                      </select>
                      <button type="button" class="rp-add-btn" onclick="showAddIndicator(this)" title="새 평가영역 추가">+</button>
                    </div>
                    <div class="rp-add-inline" style="display:none;">
                      <input type="text" class="rp-input rp-input--sm" placeholder="새 평가영역명" maxlength="100">
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--primary" onclick="createIndicator(this)">추가</button>
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--secondary" onclick="hideAddInline(this)">취소</button>
                    </div>
                  </div>
                  <div class="rp-summary-item rp-summary-item--full">
                    <span class="rp-label">하위분류</span>
                    <div class="rp-meta-select-wrap">
                      <select name="item_meta[sub_indicator_id]" class="rp-meta-select meta-sub-select">
                        <option value="">-- 선택 --</option>
                        <% @sub_indicators.each do |sub| %>
                          <option value="<%= sub.id %>" data-parent="<%= sub.evaluation_indicator_id %>"
                                  <%= "selected" if @item.sub_indicator_id == sub.id %>><%= sub.name %></option>
                        <% end %>
                      </select>
                      <button type="button" class="rp-add-btn" onclick="showAddSubIndicator(this)" title="새 하위분류 추가">+</button>
                    </div>
                    <div class="rp-add-inline" style="display:none;">
                      <input type="text" class="rp-input rp-input--sm" placeholder="새 하위분류명" maxlength="100">
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--primary" onclick="createSubIndicator(this)">추가</button>
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--secondary" onclick="hideAddInline(this)">취소</button>
                    </div>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">마지막 저장</span>
                    <span class="rp-value"><%= @item.updated_at.strftime("%Y-%m-%d %H:%M") %></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Collapsible AI Suggestions -->
            <details class="rp-card rp-card--collapsible">
              <summary class="rp-card__header rp-card__header--clickable">
                <div class="rp-card__title-group">
                  <svg class="rp-icon-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                  <h3 class="rp-card__title">AI 제안</h3>
                </div>
                <span class="rp-badge rp-badge--ai">GPT-4</span>
              </summary>
              <div class="rp-card__body">
                <div class="rp-ai-suggestion rp-ai-suggestion--spaced">
                  <h4 class="rp-ai-suggestion__title">현재 근접점수 설정</h4>
                  <p class="rp-ai-suggestion__desc">저장된 근접점수 분포입니다. 변경 후 반드시 저장하세요.</p>
                  <div class="rp-score-preview-table" id="proximity-score-preview">
                    <% choices.each do |choice| %>
                      <% option_letter = choice.choice_no.to_i.between?(1, 26) ? ("A".ord + choice.choice_no.to_i - 1).chr : choice.choice_no %>
                      <div class="rp-score-preview-row" data-preview-choice-id="<%= choice.id %>">
                        <span class="rp-label">보기 <%= option_letter %></span>
                        <strong class="proximity-preview-value"><%= choice.proximity_score || (choice.is_correct ? 100 : 0) %>%</strong>
                      </div>
                      <% if choice.proximity_reason.present? %>
                        <div class="rp-score-preview-reason">
                          <span class="rp-reason-text"><%= choice.proximity_reason %></span>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                  <ul class="rp-ai-suggestion__list">
                    <li>좌측에서 근접점수를 입력한 뒤 아래 <strong>저장</strong> 버튼을 클릭하세요.</li>
                    <li>정답은 자동으로 100%입니다.</li>
                  </ul>
                </div>

                <div class="rp-ai-suggestion rp-ai-suggestion--warning rp-ai-suggestion--spaced">
                  <h4 class="rp-ai-suggestion__title">문항 모호성 경고</h4>
                  <p class="rp-ai-suggestion__desc">보기 B와 D가 모두 정답 가능성이 있어 표현을 수정하세요.</p>
                  <ul class="rp-ai-suggestion__list">
                    <li>보기 B를 단일 조건으로 변경하세요.</li>
                    <li>보기 D에 반례 조건을 추가하세요.</li>
                  </ul>
                </div>
              </div>
            </details>

            <!-- Checklist Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">필수 점검</h3>
              </div>
              <div class="rp-card__body">
                <div class="rp-checklist">
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if correct_choice %>>
                    <span>정답 지정 완료</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if proximity_ready %>>
                    <span>근접점수 설정 완료</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox">
                    <span>총점 확인 (100% 기준)</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox">
                    <span>미리보기 확인</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="rp-card rp-card__footer">
              <button type="submit" name="commit_action" value="save" class="rp-btn rp-btn--primary rp-btn--full">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                근접점수 저장
              </button>
              <button type="submit" name="commit_action" value="publish" class="rp-btn rp-btn--secondary rp-btn--full">게시</button>
              <% if stimulus.present? %>
                <a href="<%= researcher_passage_path(stimulus) %>" class="rp-btn rp-btn--outline rp-btn--full" style="margin-top: 4px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                  지문 모듈로 돌아가기
                </a>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </section>

    <!-- Essay Rubric Mode -->
    <section class="rp-frame" data-state="essay-rubric" style="<%= 'display: none;' if @item.mcq? %>">
      <%= form_with url: researcher_item_path(@item), method: :patch, class: "rp-form", data: { turbo: false } do %>
        <input type="hidden" name="item[prompt]" class="prompt-hidden-field" value="<%= sanitize(@item.prompt, tags: %w[b strong i em u s br span p div], attributes: %w[style class]) %>">
        <div class="rp-grid rp-grid--2" style="grid-template-columns: 65fr 35fr; gap: 24px;">

          <!-- LEFT COLUMN: Model Answer + Rubric Builder -->
          <div class="rp-col-left">
            <!-- Model Answer Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">모범답안</h3>
                <span class="rp-badge rp-badge--<%= @item.model_answer.present? ? 'success' : 'warning' %>">
                  <%= @item.model_answer.present? ? '등록됨' : '미등록' %>
                </span>
              </div>
              <div class="rp-card__body">
                <div class="rp-form-group">
                  <label class="rp-label">모범답안 내용</label>
                  <%= text_area_tag "item[model_answer]",
                                    @item.model_answer,
                                    class: "rp-textarea",
                                    placeholder: "서술형 문항의 모범답안을 입력하세요. 루브릭 채점 시 참고 기준이 됩니다.",
                                    rows: 5,
                                    style: "resize: vertical; min-height: 100px;" %>
                </div>
              </div>
            </div>

            <!-- Rubric Builder Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">루브릭 빌더</h3>
                <span class="rp-badge rp-badge--info">레벨 0-3</span>
              </div>
              <div class="rp-card__body">
                <div class="rp-form-group">
                  <label class="rp-label">루브릭 제목</label>
                  <input type="text" name="rubric[name]" value="<%= @rubric&.name %>" class="rp-input" placeholder="예: 읽기 이해 평가 루브릭">
                </div>

                <div class="rp-criteria-list">
                  <% if @criteria.present? %>
                    <% @criteria.each do |criterion| %>
                      <div class="rp-criterion-card">
                        <div class="rp-criterion-header">
                          <input type="text"
                                 name="criteria[<%= criterion.id %>][name]"
                                 value="<%= criterion.criterion_name %>"
                                 class="rp-input rp-criterion-name"
                                 placeholder="평가 기준 이름 (예: 핵심 개념 이해도)">
                          <div class="rp-criterion-actions">
                            <span class="rp-text-muted" style="font-size: 12px;">ID순 정렬</span>
                          </div>
                        </div>

                        <label class="rp-checkbox rp-checkbox--delete">
                          <input type="checkbox" name="delete_criteria[]" value="<%= criterion.id %>">
                          <span>이 기준 삭제</span>
                        </label>

                        <div class="rp-levels-grid rp-levels-grid--4col">
                          <% (0..3).each do |score| %>
                            <% level = criterion.rubric_levels.find { |l| l.level == score } %>
                            <% default_desc = score == 0 ? "답안을 제출하지 않음" : nil %>
                            <div class="rp-level-cell">
                              <label class="rp-level-label rp-level-label--score-<%= score %>"><%= score %>점</label>
                              <%= text_area_tag "criteria[#{criterion.id}][levels][#{score}]",
                                                level&.description || default_desc,
                                                class: "rp-textarea rp-textarea--level",
                                                placeholder: score == 0 ? "답안을 제출하지 않음" : "#{score}점 수준의 답안 설명을 입력하세요",
                                                rows: 3 %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>

                <div id="new-criteria-container"></div>

                <button type="button" class="rp-btn rp-btn--add-criterion" onclick="addNewCriterion()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  새 평가 기준 추가
                </button>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN: Summary, AI, Actions -->
          <div class="rp-col-right">
            <!-- Summary Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">설정 요약</h3>
              </div>
              <div class="rp-card__body">
                <div class="rp-summary-grid">
                  <div class="rp-summary-item">
                    <span class="rp-label">문항 유형</span>
                    <span class="rp-value">서술형</span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">채점 방식</span>
                    <span class="rp-value">루브릭 기반</span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">평가 기준</span>
                    <span class="rp-value"><%= @criteria.count %>개</span>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">난이도</span>
                    <select name="item_meta[difficulty]" class="rp-meta-select">
                      <option value="easy" <%= "selected" if @item.difficulty == "easy" %>>쉬움</option>
                      <option value="medium" <%= "selected" if @item.difficulty == "medium" %>>보통</option>
                      <option value="hard" <%= "selected" if @item.difficulty == "hard" %>>어려움</option>
                    </select>
                  </div>
                  <div class="rp-summary-item rp-summary-item--full">
                    <span class="rp-label">평가영역</span>
                    <div class="rp-meta-select-wrap">
                      <select name="item_meta[evaluation_indicator_id]" class="rp-meta-select meta-indicator-select"
                              onchange="filterSubIndicators(this)">
                        <option value="">-- 선택 --</option>
                        <% @evaluation_indicators.each do |ind| %>
                          <option value="<%= ind.id %>" <%= "selected" if @item.evaluation_indicator_id == ind.id %>><%= ind.name %></option>
                        <% end %>
                      </select>
                      <button type="button" class="rp-add-btn" onclick="showAddIndicator(this)" title="새 평가영역 추가">+</button>
                    </div>
                    <div class="rp-add-inline" style="display:none;">
                      <input type="text" class="rp-input rp-input--sm" placeholder="새 평가영역명" maxlength="100">
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--primary" onclick="createIndicator(this)">추가</button>
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--secondary" onclick="hideAddInline(this)">취소</button>
                    </div>
                  </div>
                  <div class="rp-summary-item rp-summary-item--full">
                    <span class="rp-label">하위분류</span>
                    <div class="rp-meta-select-wrap">
                      <select name="item_meta[sub_indicator_id]" class="rp-meta-select meta-sub-select">
                        <option value="">-- 선택 --</option>
                        <% @sub_indicators.each do |sub| %>
                          <option value="<%= sub.id %>" data-parent="<%= sub.evaluation_indicator_id %>"
                                  <%= "selected" if @item.sub_indicator_id == sub.id %>><%= sub.name %></option>
                        <% end %>
                      </select>
                      <button type="button" class="rp-add-btn" onclick="showAddSubIndicator(this)" title="새 하위분류 추가">+</button>
                    </div>
                    <div class="rp-add-inline" style="display:none;">
                      <input type="text" class="rp-input rp-input--sm" placeholder="새 하위분류명" maxlength="100">
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--primary" onclick="createSubIndicator(this)">추가</button>
                      <button type="button" class="rp-btn rp-btn--xs rp-btn--secondary" onclick="hideAddInline(this)">취소</button>
                    </div>
                  </div>
                  <div class="rp-summary-item">
                    <span class="rp-label">마지막 저장</span>
                    <span class="rp-value"><%= @item.updated_at.strftime("%Y-%m-%d %H:%M") %></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Collapsible AI Suggestions -->
            <details class="rp-card rp-card--collapsible">
              <summary class="rp-card__header rp-card__header--clickable">
                <div class="rp-card__title-group">
                  <svg class="rp-icon-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                  <h3 class="rp-card__title">AI 제안</h3>
                </div>
                <span class="rp-badge rp-badge--ai">GPT-4</span>
              </summary>
              <div class="rp-card__body">
                <div class="rp-ai-suggestion">
                  <h4 class="rp-ai-suggestion__title">루브릭 수준 제안</h4>
                  <p class="rp-ai-suggestion__desc">AI가 서술형 답안의 핵심 요소를 기준으로 루브릭 초안을 생성했습니다.</p>
                  <ul class="rp-ai-suggestion__list">
                    <li>핵심 근거 제시 여부</li>
                    <li>문장 구조와 논리적 연결성</li>
                    <li>핵심 용어 정확성</li>
                  </ul>
                  <button type="button" class="rp-btn rp-btn--secondary rp-btn--sm rp-btn--full" data-ai-apply="rubric">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    AI 제안 적용
                  </button>
                </div>
              </div>
            </details>

            <!-- Checklist Card -->
            <div class="rp-card">
              <div class="rp-card__header">
                <h3 class="rp-card__title">필수 점검</h3>
              </div>
              <div class="rp-card__body">
                <div class="rp-checklist">
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if @item.model_answer.present? %>>
                    <span>모범답안 입력</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if @rubric&.name.present? %>>
                    <span>루브릭 제목 입력</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if @criteria.any? %>>
                    <span>평가 기준 추가</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox" <%= "checked" if rubric_levels_count.positive? %>>
                    <span>레벨별 설명 작성</span>
                  </label>
                  <label class="rp-checkbox">
                    <input type="checkbox">
                    <span>미리보기 확인</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="rp-card rp-card__footer">
              <button type="submit" name="commit_action" value="save" class="rp-btn rp-btn--secondary rp-btn--full">임시저장</button>
              <button type="submit" name="commit_action" value="publish" class="rp-btn rp-btn--primary rp-btn--full">게시</button>
              <% if stimulus.present? %>
                <a href="<%= researcher_passage_path(stimulus) %>" class="rp-btn rp-btn--outline rp-btn--full" style="margin-top: 4px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                  지문 모듈로 돌아가기
                </a>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </section>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="rp-modal" id="delete-confirm-modal" aria-hidden="true">
  <div class="rp-modal__card">
    <h3>삭제 확인</h3>
    <p class="rp-text-muted">선택한 항목을 삭제합니다. 계속할까요?</p>
    <div class="rp-modal__actions">
      <button type="button" class="rp-btn rp-btn--primary" id="confirm-delete">삭제 계속</button>
      <button type="button" class="rp-btn rp-btn--secondary" id="cancel-delete">취소</button>
    </div>
  </div>
</div>

<script>
  // Sub-indicator filtering based on selected evaluation indicator
  function filterSubIndicators(indicatorSelect) {
    const selectedId = indicatorSelect.value;
    const form = indicatorSelect.closest('form');
    const subSelect = form ? form.querySelector('.meta-sub-select') : null;
    if (!subSelect) return;

    const options = subSelect.querySelectorAll('option[data-parent]');
    let hasSelected = false;

    options.forEach(function(opt) {
      if (!selectedId || opt.dataset.parent === selectedId) {
        opt.style.display = '';
      } else {
        opt.style.display = 'none';
        if (opt.selected) { opt.selected = false; hasSelected = true; }
      }
    });

    if (hasSelected) subSelect.value = '';
  }

  // Initialize sub-indicator filtering on page load
  document.querySelectorAll('.meta-indicator-select').forEach(function(sel) {
    filterSubIndicators(sel);
  });

  // --- Add new indicator/sub-indicator inline ---
  function showAddIndicator(btn) {
    var wrap = btn.closest('.rp-summary-item--full');
    var inlineEl = wrap.querySelector('.rp-add-inline');
    inlineEl.style.display = 'flex';
    inlineEl.querySelector('input').focus();
  }

  function showAddSubIndicator(btn) {
    var wrap = btn.closest('.rp-summary-item--full');
    var form = btn.closest('form');
    var indicatorSelect = form.querySelector('.meta-indicator-select');
    if (!indicatorSelect || !indicatorSelect.value) {
      alert('평가영역을 먼저 선택하세요.');
      return;
    }
    var inlineEl = wrap.querySelector('.rp-add-inline');
    inlineEl.style.display = 'flex';
    inlineEl.querySelector('input').focus();
  }

  function hideAddInline(btn) {
    var inlineEl = btn.closest('.rp-add-inline');
    inlineEl.style.display = 'none';
    inlineEl.querySelector('input').value = '';
  }

  function getCSRFToken() {
    var meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
  }

  function createIndicator(btn) {
    var inlineEl = btn.closest('.rp-add-inline');
    var input = inlineEl.querySelector('input');
    var name = input.value.trim();
    if (name.length < 3) { alert('이름은 3자 이상이어야 합니다.'); return; }

    fetch('<%= researcher_evaluation_indicators_path %>', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRFToken() },
      body: JSON.stringify({ name: name })
    })
    .then(function(resp) { return resp.json(); })
    .then(function(data) {
      if (data.error) { alert(data.error); return; }
      // Add to ALL indicator selects on the page
      document.querySelectorAll('.meta-indicator-select').forEach(function(sel) {
        if (!sel.querySelector('option[value="' + data.id + '"]')) {
          var opt = document.createElement('option');
          opt.value = data.id;
          opt.textContent = data.name;
          sel.appendChild(opt);
        }
      });
      // Select the new option in the current form
      var form = btn.closest('form');
      var sel = form.querySelector('.meta-indicator-select');
      sel.value = data.id;
      filterSubIndicators(sel);
      hideAddInline(btn);
    })
    .catch(function(err) { alert('오류가 발생했습니다: ' + err.message); });
  }

  function createSubIndicator(btn) {
    var inlineEl = btn.closest('.rp-add-inline');
    var input = inlineEl.querySelector('input');
    var name = input.value.trim();
    if (name.length < 3) { alert('이름은 3자 이상이어야 합니다.'); return; }

    var form = btn.closest('form');
    var indicatorSelect = form.querySelector('.meta-indicator-select');
    var parentId = indicatorSelect.value;
    if (!parentId) { alert('평가영역을 먼저 선택하세요.'); return; }

    fetch('<%= researcher_sub_indicators_path %>', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRFToken() },
      body: JSON.stringify({ name: name, evaluation_indicator_id: parentId })
    })
    .then(function(resp) { return resp.json(); })
    .then(function(data) {
      if (data.error) { alert(data.error); return; }
      // Add to ALL sub-indicator selects on the page
      document.querySelectorAll('.meta-sub-select').forEach(function(sel) {
        if (!sel.querySelector('option[value="' + data.id + '"]')) {
          var opt = document.createElement('option');
          opt.value = data.id;
          opt.dataset.parent = data.evaluation_indicator_id;
          opt.textContent = data.name;
          sel.appendChild(opt);
        }
      });
      // Select the new option and re-filter
      var subSel = form.querySelector('.meta-sub-select');
      filterSubIndicators(indicatorSelect);
      subSel.value = data.id;
      hideAddInline(btn);
    })
    .catch(function(err) { alert('오류가 발생했습니다: ' + err.message); });
  }

  // --- Dynamic rubric criterion add ---
  var newCriterionIdx = 0;

  function addNewCriterion() {
    var container = document.getElementById('new-criteria-container');
    if (!container) return;

    var idx = newCriterionIdx++;
    var div = document.createElement('div');
    div.className = 'rp-criterion-card rp-criterion-card--new';
    div.dataset.newIdx = idx;

    var levelsHtml = '';
    for (var s = 0; s <= 3; s++) {
      var defaultVal = s === 0 ? '답안을 제출하지 않음' : '';
      var ph = s === 0 ? '답안을 제출하지 않음' : s + '점 수준 설명';
      levelsHtml +=
        '<div class="rp-level-cell">' +
          '<label class="rp-level-label rp-level-label--score-' + s + '">' + s + '점</label>' +
          '<textarea name="new_criteria[' + idx + '][levels][' + s + ']" class="rp-textarea rp-textarea--level" placeholder="' + ph + '" rows="3">' + defaultVal + '</textarea>' +
        '</div>';
    }

    div.innerHTML =
      '<div class="rp-criterion-header">' +
        '<input type="text" name="new_criteria[' + idx + '][name]" class="rp-input rp-criterion-name" placeholder="평가 기준 이름 (예: 논리적 구성력)" autofocus>' +
        '<button type="button" class="rp-btn-remove-criterion" onclick="removeNewCriterion(this)" title="삭제">&times;</button>' +
      '</div>' +
      '<div class="rp-levels-grid rp-levels-grid--4col">' + levelsHtml + '</div>';

    container.appendChild(div);
    div.querySelector('input').focus();
  }

  function removeNewCriterion(btn) {
    var card = btn.closest('.rp-criterion-card--new');
    if (card) card.remove();
  }

  (function () {
    // Tab switching
    const tabs = document.querySelectorAll(".rp-tab");
    const frames = document.querySelectorAll(".rp-frame");
    const page = document.querySelector(".rp-main");
    const params = new URLSearchParams(window.location.search);
    const defaultState = params.get("state") || (page ? page.dataset.defaultState : "mcq-default");

    const setState = (state) => {
      // Update tabs
      tabs.forEach((tab) => {
        tab.classList.toggle("rp-tab--active", tab.dataset.state === state);
      });
      // Update frames
      frames.forEach((frame) => {
        frame.style.display = frame.dataset.state === state ? "block" : "none";
      });
    };

    if (defaultState) {
      setState(defaultState);
    }

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        setState(tab.dataset.state);
      });
    });

    // AI suggestion handlers
    const applyCorrect = () => {
      if (!page) return;
      const correct = page.dataset.aiCorrect;
      if (!correct) return;
      const radios = document.querySelectorAll("input[name='correct_choice_id']");
      radios.forEach((radio) => {
        radio.checked = false;
      });
      const correctRadio = Array.from(radios).find((r) => {
        const choiceNo = r.value;
        const label = r.closest(".rp-choice-option");
        return label && label.querySelector("[data-choice-no]");
      });
      if (correctRadio) correctRadio.checked = true;
    };

    document.querySelectorAll("[data-ai-apply='mcq-correct']").forEach((button) => {
      button.addEventListener("click", applyCorrect);
    });

    // Sync proximity score inputs to AI preview panel in real-time
    const syncProximityPreview = () => {
      const previewTable = document.getElementById("proximity-score-preview");
      if (!previewTable) return;

      document.querySelectorAll(".rp-proximity-score-item").forEach((item) => {
        const choiceId = item.dataset.choiceId;
        const scoreInput = item.querySelector(".rp-input--score-large");
        if (!scoreInput) return;

        const previewRow = previewTable.querySelector(`[data-preview-choice-id="${choiceId}"]`);
        if (previewRow) {
          const valueEl = previewRow.querySelector(".proximity-preview-value");
          if (valueEl) valueEl.textContent = scoreInput.value + "%";
        }
      });
    };

    // Attach input event listeners for real-time sync
    document.querySelectorAll(".rp-input--score-large").forEach((input) => {
      input.addEventListener("input", syncProximityPreview);
    });

    document.querySelectorAll("[data-ai-apply='rubric']").forEach((button) => {
      button.addEventListener("click", () => {
        const frame = button.closest(".rp-frame");
        if (!frame) return;
        frame.querySelectorAll(".rp-textarea--sm").forEach((textarea, index) => {
          if (!textarea.value.trim()) {
            textarea.value = `핵심 근거 ${(index % 4) + 1}을 포함해 설명합니다.`;
          }
        });
      });
    });

    // Delete confirmation modal
    const forms = document.querySelectorAll("form.rp-form");
    const modal = document.getElementById("delete-confirm-modal");
    const confirmBtn = document.getElementById("confirm-delete");
    const cancelBtn = document.getElementById("cancel-delete");
    if (!forms.length || !modal || !confirmBtn || !cancelBtn) return;

    let confirmed = false;
    let activeForm = null;

    forms.forEach((form) => {
      form.addEventListener("submit", (event) => {
        const deleteChecks = form.querySelectorAll(
          "input[name='delete_criteria[]']:checked"
        );
        if (!deleteChecks.length || confirmed) return;

        event.preventDefault();
        activeForm = form;
        modal.setAttribute("aria-hidden", "false");
        modal.classList.add("is-open");
      });
    });

    confirmBtn.addEventListener("click", () => {
      confirmed = true;
      modal.setAttribute("aria-hidden", "true");
      modal.classList.remove("is-open");
      if (activeForm) activeForm.requestSubmit();
    });

    cancelBtn.addEventListener("click", () => {
      modal.setAttribute("aria-hidden", "true");
      modal.classList.remove("is-open");
    });

    // Proximity score tab: handle correct answer change
    const proximityRadios = document.querySelectorAll(".rp-radio-proximity");
    proximityRadios.forEach((radio) => {
      radio.addEventListener("change", (event) => {
        const selectedChoiceId = event.target.value;

        // Update all proximity score items
        document.querySelectorAll(".rp-proximity-score-item").forEach((item) => {
          const choiceId = item.dataset.choiceId;
          const scoreInput = item.querySelector(".rp-input--score-large");
          const badge = item.querySelector(".rp-badge--success");
          const isCorrect = (choiceId === selectedChoiceId);

          // Update visual state
          if (isCorrect) {
            item.classList.add("rp-proximity-score-item--correct");
            scoreInput.value = 100;
            scoreInput.disabled = true;

            // Add "정답" badge if not exists
            if (!badge) {
              const newBadge = document.createElement("span");
              newBadge.className = "rp-badge rp-badge--success";
              newBadge.textContent = "정답";
              item.querySelector(".rp-proximity-score-header").appendChild(newBadge);
            }
          } else {
            item.classList.remove("rp-proximity-score-item--correct");
            scoreInput.value = scoreInput.value === "100" ? 0 : scoreInput.value;
            scoreInput.disabled = false;

            // Remove "정답" badge if exists
            if (badge) {
              badge.remove();
            }
          }
        });

        // Sync preview after correct answer change
        syncProximityPreview();
      });
    });
  })();

  // === Prompt content formatting ===
  function promptFmt(cmd) {
    var editor = document.getElementById('prompt-editor');
    if (editor) {
      editor.focus();
      document.execCommand(cmd, false, null);
      syncPromptToForms();
    }
  }

  function syncPromptToForms() {
    var editor = document.getElementById('prompt-editor');
    if (!editor) return;
    var html = editor.innerHTML;
    document.querySelectorAll('.prompt-hidden-field').forEach(function(field) {
      field.value = html;
    });
  }

  // Keyboard shortcuts for prompt editor
  document.addEventListener('keydown', function(e) {
    if (e.target.id !== 'prompt-editor') return;
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'b') { e.preventDefault(); document.execCommand('bold'); syncPromptToForms(); }
      if (e.key === 'i') { e.preventDefault(); document.execCommand('italic'); syncPromptToForms(); }
      if (e.key === 'u') { e.preventDefault(); document.execCommand('underline'); syncPromptToForms(); }
    }
  });

  // === Choice content formatting ===
  var lastFocusedChoiceEditor = null;

  // Track which choice editor was last focused
  document.addEventListener('focusin', function(e) {
    if (e.target.classList && e.target.classList.contains('rp-choice-editor')) {
      lastFocusedChoiceEditor = e.target;
    }
  });

  // Apply format command to the last focused choice editor
  function choiceFmt(cmd) {
    if (!lastFocusedChoiceEditor) {
      // Focus the first choice editor if none focused
      var first = document.querySelector('.rp-choice-editor');
      if (first) { first.focus(); lastFocusedChoiceEditor = first; }
      else return;
    }
    lastFocusedChoiceEditor.focus();
    document.execCommand(cmd, false, null);
    var choiceId = lastFocusedChoiceEditor.dataset.choiceId;
    if (choiceId) syncChoiceContent(choiceId);
  }

  // Sync contenteditable → hidden field + tab display
  function syncChoiceContent(choiceId) {
    var editor = document.querySelector('.rp-choice-editor[data-choice-id="' + choiceId + '"]');
    var hidden = document.getElementById('choice-hidden-' + choiceId);
    var display = document.getElementById('choice-display-' + choiceId);
    if (editor && hidden) hidden.value = editor.innerHTML;
    if (editor && display) display.innerHTML = editor.innerHTML;
  }

  // Keyboard shortcuts in choice editors
  document.addEventListener('keydown', function(e) {
    if (!e.target.classList || !e.target.classList.contains('rp-choice-editor')) return;
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'b') { e.preventDefault(); document.execCommand('bold'); syncChoiceContent(e.target.dataset.choiceId); }
      if (e.key === 'i') { e.preventDefault(); document.execCommand('italic'); syncChoiceContent(e.target.dataset.choiceId); }
      if (e.key === 'u') { e.preventDefault(); document.execCommand('underline'); syncChoiceContent(e.target.dataset.choiceId); }
    }
  });

  // Initialize: sync all editors to hidden fields + sync before form submit
  function initEditorSync() {
    // Initial sync for prompt
    syncPromptToForms();

    // Initial sync for choice editors
    document.querySelectorAll('.rp-choice-editor').forEach(function(editor) {
      var choiceId = editor.dataset.choiceId;
      if (choiceId) syncChoiceContent(choiceId);
    });

    // Sync all editors before form submit
    document.querySelectorAll('form.rp-form').forEach(function(form) {
      if (form.dataset.syncAttached) return; // prevent double-binding
      form.dataset.syncAttached = '1';
      form.addEventListener('submit', function() {
        syncPromptToForms();
        document.querySelectorAll('.rp-choice-editor').forEach(function(editor) {
          var choiceId = editor.dataset.choiceId;
          if (choiceId) syncChoiceContent(choiceId);
        });
      });
    });
  }

  // Support both regular page load and Turbo navigation
  document.addEventListener('DOMContentLoaded', initEditorSync);
  document.addEventListener('turbo:load', initEditorSync);

  // Also run immediately if DOM is already loaded (Turbo page visit)
  if (document.readyState !== 'loading') {
    initEditorSync();
  }
</script>

<style>
  /* Page Header with Back Button */
  .rp-page-header__top {
    margin-bottom: 16px;
  }

  .rp-back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    color: #374151;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
  }

  .rp-back-button:hover {
    background: #f9fafb;
    border-color: #9ca3af;
    color: #111827;
    transform: translateX(-2px);
  }

  .rp-back-button svg {
    flex-shrink: 0;
  }

  /* Item Preview Section - Always Visible Above Tabs */
  .item-preview-section {
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
    border: 1px solid #e0e7ff;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .item-meta-badges {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .item-type-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
  }

  .item-type-badge--mcq {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  }

  .item-type-badge--constructed {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
  }

  .difficulty-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
  }

  .difficulty-badge--easy { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
  .difficulty-badge--medium { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
  .difficulty-badge--hard { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

  .indicator-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .indicator-badge--sub {
    background: #f0f9ff;
    color: #0369a1;
    border: 1px solid #bae6fd;
  }

  /* Meta select in summary - full width items */
  .rp-summary-item--full {
    flex-direction: column;
    align-items: stretch;
    gap: 4px;
  }

  .rp-meta-select-wrap {
    display: flex;
    align-items: center;
    gap: 4px;
    width: 100%;
  }

  .rp-meta-select {
    flex: 1;
    min-width: 0;
    padding: 6px 28px 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
    color: #374151;
    background: white;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236b7280' fill='none' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    transition: border-color 0.15s, box-shadow 0.15s;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .rp-meta-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
  }

  .rp-add-btn {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #f9fafb;
    color: #6b7280;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .rp-add-btn:hover {
    background: #eff6ff;
    border-color: #3b82f6;
    color: #3b82f6;
  }

  .rp-add-inline {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 6px;
  }

  .rp-add-inline .rp-input--sm {
    flex: 1;
    padding: 4px 8px;
    font-size: 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
  }

  .rp-btn--xs {
    padding: 3px 8px;
    font-size: 11px;
    border-radius: 4px;
    cursor: pointer;
    border: none;
    font-weight: 500;
  }

  .rp-btn--xs.rp-btn--primary {
    background: #3b82f6;
    color: white;
  }

  .rp-btn--xs.rp-btn--primary:hover {
    background: #2563eb;
  }

  .rp-btn--xs.rp-btn--secondary {
    background: #f3f4f6;
    color: #374151;
  }

  .rp-btn--xs.rp-btn--secondary:hover {
    background: #e5e7eb;
  }

  /* Add criterion button */
  .rp-btn--add-criterion {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    background: #f9fafb;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .rp-btn--add-criterion:hover {
    border-color: #7c3aed;
    background: #faf5ff;
    color: #7c3aed;
  }

  .rp-criterion-card--new {
    border: 1px solid #d8b4fe;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
    background: #faf5ff;
  }

  .rp-btn-remove-criterion {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #fca5a5;
    border-radius: 6px;
    background: #fef2f2;
    color: #dc2626;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .rp-btn-remove-criterion:hover {
    background: #fee2e2;
    border-color: #dc2626;
  }

  /* Item Prompt Card */
  .item-prompt-card {
    background: white;
    border: 2px solid #e0e7ff; /* 더 강한 테두리 */
    border-radius: 10px;
    padding: 20px 24px; /* 좌우 패딩 증가 */
    margin-bottom: 20px; /* 일관된 간격 */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06); /* 더 부드러운 그림자 */
    transition: all 0.2s;
  }

  .item-prompt-card:hover {
    border-color: #c7d2fe;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  }

  .item-prompt-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 14px; /* 여백 증가 */
    padding-bottom: 10px; /* 하단 패딩 추가 */
    border-bottom: 1px solid #f3f4f6; /* 구분선 추가 */
  }

  .item-prompt-header svg {
    color: #6366f1;
  }

  .item-prompt-header h3 {
    font-size: 15px;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .item-prompt-body {
    font-size: 15px;
    line-height: 1.7;
    color: #1f2937;
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 40px; /* 최소 높이로 일관된 느낌 */
    /* 높이는 내용에 따라 자동 조절 - 고정 높이 없음 */
  }

  .item-prompt-body p {
    margin: 0 0 10px 0;
  }

  .item-prompt-body p:last-child {
    margin-bottom: 0;
  }

  /* Choices Preview Grid */
  .item-choices-preview {
    background: white;
    border: 2px solid #d1fae5; /* 초록색 테두리 */
    border-radius: 10px;
    padding: 20px 24px;
    margin-bottom: 20px; /* 일관된 간격 */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
    transition: all 0.2s;
  }

  .item-choices-preview:hover {
    border-color: #a7f3d0;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  }

  .item-choices-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    color: #059669;
  }

  .item-choices-header h3 {
    font-size: 15px;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .choices-grid {
    display: grid;
    gap: 12px;
  }

  .choice-preview {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .choice-preview:hover {
    background: #f3f4f6;
  }

  .choice-preview--correct {
    background: #f0fdf4;
    border-color: #86efac;
  }

  .choice-preview-label {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 2px solid #d1d5db;
    border-radius: 50%;
    font-weight: 700;
    font-size: 14px;
    color: #374151;
  }

  .choice-preview--correct .choice-preview-label {
    background: #10b981;
    border-color: #10b981;
    color: white;
  }

  .choice-preview-text {
    flex: 1;
    font-size: 14px;
    line-height: 1.5;
    color: #374151;
    min-height: 20px;
    padding: 2px 6px;
    border: 1px solid transparent;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .choice-preview-text[contenteditable="true"]:hover {
    border-color: #d1d5db;
    background: rgba(255,255,255,0.7);
  }

  .choice-preview-text[contenteditable="true"]:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    background: #fff;
  }

  .choice-preview-text u { text-decoration: underline; }
  .choice-preview-text b, .choice-preview-text strong { font-weight: 700; }
  .choice-preview-text i, .choice-preview-text em { font-style: italic; }
  .choice-preview-text s { text-decoration: line-through; }

  .choice-format-toolbar-top {
    display: flex;
    gap: 3px;
    margin-left: auto;
  }

  .correct-indicator {
    flex-shrink: 0;
    padding: 4px 10px;
    background: #10b981;
    color: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }

  /* Stimulus Card (Reading Passage) */
  .stimulus-card {
    background: white;
    border: 2px solid #dbeafe;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px; /* 일관된 간격 */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
    transition: all 0.2s;
  }

  .stimulus-card:hover {
    border-color: #bfdbfe;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  }

  .stimulus-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px 20px;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-bottom: 1px solid #bfdbfe;
  }

  .stimulus-card-header svg {
    flex-shrink: 0;
    color: #3b82f6;
  }

  .stimulus-card-header h3 {
    font-size: 15px;
    font-weight: 600;
    color: #1e40af;
    margin: 0;
    flex: 1;
  }

  .stimulus-code-badge {
    padding: 4px 10px;
    background: white;
    border: 1px solid #93c5fd;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
    color: #1e40af;
    font-weight: 600;
  }

  .stimulus-title-section {
    padding: 16px 20px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
  }

  .stimulus-title-section h4 {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .stimulus-body-section {
    padding: 20px;
    font-size: 15px;
    line-height: 1.8;
    color: #374151;
    max-height: 400px;
    overflow-y: auto;
  }

  .stimulus-body-section p {
    margin: 0 0 12px 0;
  }

  .stimulus-body-section p:last-child {
    margin-bottom: 0;
  }

  /* Scrollbar styling for stimulus body */
  .stimulus-body-section::-webkit-scrollbar {
    width: 8px;
  }

  .stimulus-body-section::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 4px;
  }

  .stimulus-body-section::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
  }

  .stimulus-body-section::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .item-preview-section {
      padding: 16px;
    }

    .item-meta-editor {
      gap: 8px;
    }

    .item-meta-form {
      gap: 6px;
    }

    .meta-field-label {
      display: none;
    }

    .choices-grid {
      gap: 8px;
    }

    .choice-preview {
      padding: 10px 12px;
    }

    .item-prompt-card {
      padding: 16px 18px; /* 모바일에서 패딩 축소 */
    }

    .item-prompt-body {
      font-size: 14px;
    }

    .item-choices-preview {
      padding: 16px 18px; /* 모바일에서 패딩 축소 */
    }

    .stimulus-card-header {
      padding: 12px 16px;
    }

    .stimulus-title-section {
      padding: 12px 16px;
    }

    .stimulus-body-section {
      padding: 16px;
      font-size: 14px;
      max-height: 300px;
    }
  }

  /* ========================================
     Rubric Builder Interface Styles
     ======================================== */

  /* 2-Column Grid Layout */
  .rp-grid--2 {
    display: grid;
  }

  /* Basic Card Styles */
  .rp-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .rp-card__header {
    padding: 16px 20px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .rp-card__title-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .rp-card__title {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .rp-card__body {
    padding: 20px;
  }

  .rp-card__footer {
    padding: 16px 20px;
    border-top: 1px solid #f3f4f6;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Collapsible Card with <details> */
  .rp-card--collapsible {
    border: 2px solid #e0e7ff;
  }

  .rp-card--collapsible[open] {
    border-color: #c7d2fe;
  }

  .rp-card__header--clickable {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
  }

  .rp-card__header--clickable:hover {
    background-color: #f9fafb;
  }

  .rp-icon-chevron {
    transition: transform 0.2s;
    color: #6b7280;
  }

  details[open] .rp-icon-chevron {
    transform: rotate(180deg);
  }

  /* Badge Styles */
  .rp-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .rp-badge--info {
    background: #dbeafe;
    color: #1e40af;
  }

  .rp-badge--ai {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
  }

  /* Form Elements */
  .rp-form-group {
    margin-bottom: 20px;
  }

  .rp-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
  }

  .rp-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
  }

  .rp-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .rp-textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.2s;
  }

  .rp-textarea:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .rp-textarea--level {
    min-height: 80px;
    line-height: 1.5;
  }

  /* Criterion Card */
  .rp-criteria-list {
    margin-bottom: 24px;
  }

  .rp-criterion-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .rp-criterion-header {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 12px;
  }

  .rp-criterion-name {
    flex: 1;
    font-weight: 600;
  }

  .rp-criterion-actions {
    display: flex;
    gap: 4px;
  }

  /* Checkbox */
  .rp-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #6b7280;
    cursor: pointer;
    margin-bottom: 12px;
  }

  .rp-checkbox--delete {
    color: #dc2626;
  }

  .rp-checkbox input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  /* 4-Column Levels Grid */
  .rp-levels-grid--4col {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 12px;
  }

  .rp-level-cell {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .rp-level-label {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    text-align: center;
  }

  .rp-level-label--score-0 {
    background: #fee2e2;
    color: #991b1b;
  }

  .rp-level-label--score-1 {
    background: #fef3c7;
    color: #92400e;
  }

  .rp-level-label--score-2 {
    background: #dbeafe;
    color: #1e40af;
  }

  .rp-level-label--score-3 {
    background: #d1fae5;
    color: #065f46;
  }

  /* New Criterion Section */
  .rp-new-criterion {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px dashed #bae6fd;
    border-radius: 8px;
    padding: 20px;
  }

  .rp-new-criterion .rp-label {
    color: #0369a1;
  }

  /* AI Suggestion Styles */
  .rp-ai-suggestion {
    background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    border: 1px solid #e9d5ff;
    border-radius: 8px;
    padding: 16px;
  }

  .rp-ai-suggestion__title {
    font-size: 14px;
    font-weight: 600;
    color: #6b21a8;
    margin: 0 0 8px 0;
  }

  .rp-ai-suggestion__desc {
    font-size: 13px;
    color: #6b7280;
    margin: 0 0 12px 0;
  }

  .rp-ai-suggestion__list {
    margin: 0 0 12px 0;
    padding-left: 20px;
    font-size: 13px;
    color: #4b5563;
  }

  .rp-ai-suggestion__list li {
    margin-bottom: 4px;
  }

  /* Summary Grid */
  .rp-summary-grid {
    display: grid;
    gap: 12px;
  }

  .rp-summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .rp-summary-item:last-child {
    border-bottom: none;
  }

  .rp-summary-item .rp-label {
    margin: 0;
    font-weight: 500;
    color: #6b7280;
  }

  .rp-summary-item .rp-value {
    font-weight: 600;
    color: #111827;
  }

  /* Checklist */
  .rp-checklist {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Button Styles */
  .rp-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .rp-btn--primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .rp-btn--primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .rp-btn--secondary {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .rp-btn--secondary:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .rp-btn--sm {
    padding: 6px 12px;
    font-size: 13px;
  }

  .rp-btn--full {
    width: 100%;
  }

  .rp-btn--ghost {
    background: transparent;
    color: #6b7280;
    border: 1px solid #e5e7eb;
    padding: 4px 8px;
  }

  .rp-btn--ghost:hover {
    background: #f3f4f6;
    color: #374151;
  }

  /* Instruction and Info Elements */
  .rp-instruction-text {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 16px;
    line-height: 1.6;
  }

  .rp-instruction-box {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 20px;
    font-size: 13px;
    color: #1e40af;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .rp-instruction-box p {
    margin: 0;
    line-height: 1.6;
  }

  .rp-instruction-box svg {
    flex-shrink: 0;
    color: #3b82f6;
    margin-top: 2px;
  }

  .rp-note-box {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 6px;
    padding: 12px 16px;
    margin-top: 16px;
    font-size: 13px;
    color: #92400e;
  }

  .rp-note-box strong {
    font-weight: 600;
  }

  /* Choices List for MCQ */
  .rp-choices-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* Prompt editor */
  .prompt-format-toolbar {
    display: flex;
    gap: 4px;
    margin-left: auto;
  }

  .prompt-format-toolbar .rp-fmt-btn {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 2px 8px;
    cursor: pointer;
    font-size: 13px;
    line-height: 1.4;
    color: #334155;
    min-width: 28px;
    text-align: center;
  }
  .prompt-format-toolbar .rp-fmt-btn:hover { background: #e2e8f0; }

  .item-prompt-editor {
    outline: none;
    border: 1px solid transparent;
    border-radius: 0 0 8px 8px;
    transition: border-color 0.2s, box-shadow 0.2s;
    cursor: text;
  }

  .item-prompt-editor:hover {
    border-color: #d1d5db;
  }

  .item-prompt-editor:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    background: #fff;
  }

  .item-prompt-editor u { text-decoration: underline; }
  .item-prompt-editor b, .item-prompt-editor strong { font-weight: 700; }
  .item-prompt-editor i, .item-prompt-editor em { font-style: italic; }
  .item-prompt-editor s { text-decoration: line-through; }

  .rp-choice-format-toolbar {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 8px;
    margin-bottom: 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
  }

  .rp-choice-format-label {
    font-size: 12px;
    color: #64748b;
    margin-right: 4px;
    font-weight: 500;
  }

  .rp-choice-format-toolbar .rp-fmt-btn {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 2px 8px;
    cursor: pointer;
    font-size: 13px;
    line-height: 1.4;
    color: #334155;
    min-width: 28px;
    text-align: center;
  }
  .rp-choice-format-toolbar .rp-fmt-btn:hover { background: #e2e8f0; }

  .rp-choice-option {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .rp-choice-option:hover {
    border-color: #c7d2fe;
    background: #f9fafb;
  }

  .rp-choice-option--correct {
    border-color: #6ee7b7;
    background: #d1fae5;
  }

  .rp-choice-select-area {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .rp-radio {
    width: 18px;
    height: 18px;
    margin-top: 2px;
    cursor: pointer;
  }

  .rp-choice-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .rp-choice-label {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: #f3f4f6;
    border-radius: 50%;
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    flex-shrink: 0;
  }

  .rp-choice-text {
    flex: 1;
    font-size: 14px;
    color: #1f2937;
    line-height: 1.6;
  }

  .rp-choice-editor {
    flex: 1;
    min-height: 24px;
    padding: 4px 8px;
    font-size: 14px;
    color: #1f2937;
    line-height: 1.6;
    border: 1px solid transparent;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    cursor: text;
  }

  .rp-choice-editor:hover {
    border-color: #d1d5db;
    background: rgba(255,255,255,0.5);
  }

  .rp-choice-editor:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    background: #fff;
  }

  .rp-choice-editor u { text-decoration: underline; }
  .rp-choice-editor b, .rp-choice-editor strong { font-weight: 700; }
  .rp-choice-editor i, .rp-choice-editor em { font-style: italic; }
  .rp-choice-editor s { text-decoration: line-through; }

  /* Info Row */
  .rp-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .rp-info-row:last-child {
    border-bottom: none;
  }

  .rp-info-label {
    font-size: 13px;
    font-weight: 500;
    color: #6b7280;
  }

  .rp-info-value {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
  }

  /* AI Suggestion Variants */
  .rp-ai-suggestion--spaced {
    margin-bottom: 16px;
  }

  .rp-ai-suggestion--spaced:last-child {
    margin-bottom: 0;
  }

  .rp-ai-suggestion--warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-color: #fcd34d;
  }

  .rp-ai-suggestion--warning .rp-ai-suggestion__title {
    color: #92400e;
  }

  /* Proximity Score Elements */
  .rp-proximity-scores-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rp-proximity-score-item {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 16px;
    transition: all 0.2s;
  }

  .rp-proximity-score-item:hover {
    border-color: #c7d2fe;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .rp-proximity-score-item--correct {
    border-color: #6ee7b7;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  }

  .rp-proximity-score-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .rp-radio-proximity {
    width: 20px;
    height: 20px;
    cursor: pointer;
    margin: 0;
  }

  .rp-choice-label-large {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: #667eea;
    color: white;
    border-radius: 50%;
    font-size: 16px;
    font-weight: 700;
  }

  .rp-choice-text-display {
    font-size: 14px;
    color: #374151;
    line-height: 1.6;
    margin-bottom: 12px;
  }

  .rp-proximity-score-bottom {
    display: flex;
    align-items: flex-start;
    gap: 16px;
  }

  .rp-proximity-score-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  .rp-proximity-reason-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    min-width: 0;
  }

  .rp-input--reason {
    flex: 1;
    min-width: 0;
    font-size: 13px;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #fff;
    color: #374151;
    transition: border-color 0.15s;
  }

  .rp-input--reason:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
  }

  .rp-input--reason:disabled {
    background: #f3f4f6;
    color: #9ca3af;
    cursor: not-allowed;
  }

  .rp-input--reason::placeholder {
    color: #9ca3af;
    font-style: italic;
  }

  .rp-score-input-label {
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
    white-space: nowrap;
  }

  .rp-input--score-large {
    width: 100px;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
  }

  .rp-score-unit-large {
    font-size: 16px;
    font-weight: 600;
    color: #6b7280;
  }

  /* Score Preview Table */
  .rp-score-preview-table {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 12px;
  }

  .rp-score-preview-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .rp-score-preview-row:last-child {
    border-bottom: none;
  }

  .rp-score-preview-reason {
    padding: 2px 0 6px 8px;
    border-bottom: 1px solid #f3f4f6;
  }

  .rp-score-preview-reason:last-child {
    border-bottom: none;
  }

  .rp-reason-text {
    font-size: 11px;
    color: #6b7280;
    font-style: italic;
  }

  .rp-score-preview-row .rp-label {
    margin: 0;
    font-size: 13px;
  }

  .rp-score-preview-row strong {
    font-size: 14px;
    color: #111827;
  }

  /* Badge Pill */
  .rp-badge--pill {
    border-radius: 12px;
  }

  .rp-badge--success {
    background: #d1fae5;
    color: #065f46;
  }

  .rp-badge--danger {
    background: #fee2e2;
    color: #991b1b;
  }

  /* Responsive Adjustments */
  @media (max-width: 1200px) {
    .rp-grid--2 {
      grid-template-columns: 1fr !important;
    }

    .rp-levels-grid--4col {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .rp-levels-grid--4col {
      grid-template-columns: 1fr;
    }

    .rp-proximity-score-bottom {
      flex-direction: column;
      gap: 8px;
    }

    .rp-proximity-score-input-group {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    .rp-proximity-reason-group {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      width: 100%;
    }

    .rp-input--score-large {
      width: 80px;
    }

    .rp-input--reason {
      width: 100%;
    }
  }
</style>
