<% content_for :portal_title do %>
  ë¬¸í•­ ê´€ë¦¬
<% end %>
<% content_for :portal_subtitle do %>
  ëª¨ë“  ë¬¸í•­ì„ ê´€ë¦¬í•˜ê³  ì •ë‹µ ë° ë£¨ë¸Œë¦­ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :items %>
<% end %>

<div class="portal-card">
  <div class="portal-card-header" style="display: flex; justify-content: space-between; align-items: center;">
    <h2 class="portal-card-title" style="margin: 0;">ë¬¸í•­ ê´€ë¦¬</h2>
    <%= link_to "+ ìƒˆ ë¬¸í•­ ì¶”ê°€", researcher_item_create_path, class: "btn btn-success" %>
  </div>

  <div style="padding: 20px 0;">
    <!-- Page Header -->
    <div style="margin-bottom: 24px;">
      <p style="color: #666; font-size: var(--rp-font-size-sm); margin: 0;">ë¬¸í•­ë³„ ì •ë‹µ ë° ë£¨ë¸Œë¦­ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>

    <!-- Status Tabs -->
    <div class="rp-tabs" role="tablist" aria-label="ë¬¸í•­ ìƒíƒœ í•„í„°">
      <%= link_to "ì „ì²´", researcher_items_path, class: "rp-tab rp-tab--#{params[:status].blank? ? 'active' : ''}" %>
      <%= link_to "ì´ˆì•ˆ", researcher_items_path(status: 'draft'), class: "rp-tab rp-tab--#{params[:status] == 'draft' ? 'active' : ''}" %>
      <%= link_to "ë°°í¬ë¨", researcher_items_path(status: 'active'), class: "rp-tab rp-tab--#{params[:status] == 'active' ? 'active' : ''}" %>
      <%= link_to "ë³´ê´€ë¨", researcher_items_path(status: 'retired'), class: "rp-tab rp-tab--#{params[:status] == 'retired' ? 'active' : ''}" %>
    </div>

    <!-- Search & Filter Card -->
    <div class="rp-card" style="margin-bottom: 28px;">
      <div class="rp-card__header">
        <h3 class="rp-card__title">ê²€ìƒ‰ ë° í•„í„°</h3>
      </div>
      <div class="rp-card__body">
        <%= form_with url: researcher_items_path, method: :get, local: true, class: "rp-search-form" do %>
          <div class="rp-search-form__fields">
            <div class="rp-form-group">
              <label class="rp-label">í‚¤ì›Œë“œ</label>
              <input type="text" name="q" value="<%= params[:q] %>" placeholder="ë¬¸í•­ ì½”ë“œ ë˜ëŠ” ë‚´ìš©" class="rp-input">
            </div>

            <div class="rp-form-group">
              <label class="rp-label">ë¬¸í•­ ìœ í˜•</label>
              <select name="item_type" class="rp-select">
                <option value="">ì „ì²´</option>
                <option value="mcq" <%= "selected" if params[:item_type] == "mcq" %>>ê°ê´€ì‹</option>
                <option value="constructed" <%= "selected" if params[:item_type] == "constructed" %>>ì„œìˆ í˜•</option>
              </select>
            </div>

            <div class="rp-form-group">
              <label class="rp-label">ë£¨ë¸Œë¦­</label>
              <select name="rubric" class="rp-select">
                <option value="">ì „ì²´</option>
                <option value="with" <%= "selected" if params[:rubric] == "with" %>>ìˆìŒ</option>
                <option value="without" <%= "selected" if params[:rubric] == "without" %>>ì—†ìŒ</option>
              </select>
            </div>

            <div class="rp-form-actions">
              <button type="submit" class="rp-btn rp-btn--primary">ê²€ìƒ‰</button>
              <%= link_to "ì´ˆê¸°í™”", researcher_items_path, class: "rp-btn rp-btn--secondary" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Items Table -->
    <div class="rp-card">
      <div class="rp-card__header">
        <h3 class="rp-card__title">ë¬¸í•­ ëª©ë¡</h3>
        <span class="rp-text-muted">ì´ <%= @total_count %>ê±´</span>
      </div>
      <div class="rp-card__body">
        <% if @items.any? %>
          <div class="rp-table-wrapper">
            <table class="rp-table">
              <thead>
                <tr>
                  <th class="rp-table__header">ì œëª©</th>
                  <th class="rp-table__header">ë‚œì´ë„</th>
                  <th class="rp-table__header">ë¬¸í•­ ìœ í˜•</th>
                  <th class="rp-table__header">ì§€ë¬¸</th>
                  <th class="rp-table__header">ìƒíƒœ</th>
                  <th class="rp-table__header">ìƒì„±ì¼</th>
                  <th class="rp-table__header">ì‘ì—…</th>
                </tr>
              </thead>
              <tbody>
                <% @items.each do |item| %>
                  <% status_class = case item.status
                                   when "draft" then "rp-badge--warning"
                                   when "active" then "rp-badge--success"
                                   when "retired" then "rp-badge--danger"
                                   else "rp-badge--warning"
                                   end %>
                  <% status_label = case item.status
                                   when "draft" then "ì´ˆì•ˆ"
                                   when "active" then "ë°°í¬ë¨"
                                   when "retired" then "ë³´ê´€ë¨"
                                   else "ì´ˆì•ˆ"
                                   end %>
                  <% difficulty_label = case item.difficulty
                                       when "easy" then "í•˜"
                                       when "medium" then "ì¤‘"
                                       when "hard" then "ìƒ"
                                       else "-"
                                       end %>
                  <tr class="rp-table__row" onclick="openItemPreview(event, <%= item.id %>)">
                    <td class="rp-table__cell">
                      <div class="rp-item-title">
                        <strong class="rp-item-code"><%= item.code || "##{item.id}" %></strong>
                        <p class="rp-item-description"><%= truncate(strip_tags(item.prompt), length: 100) %></p>
                      </div>
                    </td>
                    <td class="rp-table__cell"><%= difficulty_label %></td>
                    <td class="rp-table__cell">
                      <span class="rp-badge rp-badge--pill rp-badge--info">
                        <%= item.item_type == "mcq" ? "ê°ê´€ì‹" : "ì„œìˆ í˜•" %>
                      </span>
                    </td>
                    <td class="rp-table__cell">
                      <%= item.stimulus ? truncate(item.stimulus.title, length: 30) : "-" %>
                    </td>
                    <td class="rp-table__cell">
                      <span class="rp-badge rp-badge--pill <%= status_class %>">
                        <%= status_label %>
                      </span>
                    </td>
                    <td class="rp-table__cell">
                      <span class="rp-text-muted"><%= item.created_at.strftime("%Y. %m. %d.") %></span>
                    </td>
                    <td class="rp-table__cell" onclick="event.stopPropagation();">
                      <div class="rp-table__actions">
                        <%= link_to "", edit_researcher_item_path(item),
                                    class: "rp-icon-link rp-icon-link--edit",
                                    title: "í¸ì§‘",
                                    aria_label: "í¸ì§‘" %>
                        <a href="#" class="rp-icon-link rp-icon-link--view" title="ë¯¸ë¦¬ë³´ê¸°" aria-label="ë¯¸ë¦¬ë³´ê¸°"
                           onclick="openItemPreview(event, <%= item.id %>); return false;"></a>
                        <%= button_to researcher_item_path(item),
                                    method: :delete,
                                    form: { data: { turbo: false }, class: "rp-inline-form" },
                                    data: { turbo_confirm: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" },
                                    class: "rp-icon-link rp-icon-link--delete",
                                    title: "ì‚­ì œ",
                                    aria: { label: "ì‚­ì œ" } %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <% if @total_pages > 1 %>
            <div class="rp-pagination" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--rp-border);">
              <% if @page > 1 %>
                <%= link_to "ì´ì „", researcher_items_path(params.permit(:q, :item_type, :rubric, :status).merge(page: @page - 1)),
                           class: "rp-pagination-btn" %>
              <% end %>

              <% (1..@total_pages).each do |page| %>
                <% if page == @page %>
                  <span class="rp-pagination-number rp-pagination-number--active"><%= page %></span>
                <% else %>
                  <%= link_to page, researcher_items_path(params.permit(:q, :item_type, :rubric, :status).merge(page: page)),
                             class: "rp-pagination-number" %>
                <% end %>
              <% end %>

              <% if @page < @total_pages %>
                <%= link_to "ë‹¤ìŒ", researcher_items_path(params.permit(:q, :item_type, :rubric, :status).merge(page: @page + 1)),
                           class: "rp-pagination-btn" %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <div class="rp-empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="9"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            <p>ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Item Preview Modal -->
<div class="rp-preview-modal" id="itemPreviewModal" onclick="closeItemPreview(event)">
  <div class="rp-preview-modal__content" onclick="event.stopPropagation();">
    <!-- Close Button -->
    <button class="rp-preview-modal__close" onclick="closeItemPreview()">Ã—</button>

    <!-- Preview Content -->
    <div class="rp-preview-content">
      <!-- Header -->
      <div class="rp-preview-header">
        <svg class="rp-preview-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
        </svg>
        <h2 id="previewTitle" class="rp-preview-title">í‰ê°€ ì œëª©</h2>
        <span id="previewGrade" class="rp-preview-badge">í•™ë…„êµ°</span>
      </div>

      <!-- Info Grid -->
      <div class="rp-preview-grid">
        <!-- Left Column -->
        <div class="rp-preview-column">
          <div class="rp-preview-section">
            <div class="rp-preview-section__header">
              <svg class="rp-preview-section-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
              </svg>
              <h3 class="rp-preview-section__title">í‰ê°€ ì •ë³´</h3>
            </div>
            <div class="rp-preview-section__body">
              <div class="rp-preview-item">
                <span class="rp-preview-label">ì´ ë¬¸í•­ ìˆ˜</span>
                <span id="previewTotalItems" class="rp-preview-value">25ë¬¸í•­</span>
              </div>
              <div class="rp-preview-item">
                <span class="rp-preview-label">ë¬¸í•­ êµ¬ì„±</span>
                <span id="previewItemType" class="rp-preview-value">ê°ê´€ì‹ 18ë¬¸í•­ + ì„œìˆ í˜• 7ë¬¸í•­</span>
              </div>
              <div class="rp-preview-item">
                <span class="rp-preview-label">ì œí•œ ì‹œê°„</span>
                <span id="previewTimeLimit" class="rp-preview-value">60ë¶„</span>
              </div>
              <div class="rp-preview-item">
                <span class="rp-preview-label">ì´ì </span>
                <span id="previewTotalScore" class="rp-preview-value">71ì </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="rp-preview-column">
          <div class="rp-preview-section">
            <div class="rp-preview-section__header">
              <svg class="rp-preview-section-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              <h3 class="rp-preview-section__title">ì§€ë¬¸ êµ¬ì„±</h3>
            </div>
            <div class="rp-preview-section__body" id="previewStimuliList">
              <div class="rp-preview-stimulus">
                <span class="rp-preview-stimulus-label">ì§€ë¬¸ 1</span>
                <span class="rp-preview-stimulus-title">ì§€ë¬¸ ì œëª©</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notice Section -->
      <div class="rp-preview-notice">
        <div class="rp-preview-notice__header">
          <svg class="rp-preview-notice-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
          </svg>
          <h4 class="rp-preview-notice__title">ì•ˆë‚´ì‚¬í•­</h4>
        </div>
        <ul class="rp-preview-notice__list">
          <li>í‰ê°€ ì‹œì‘ í›„ íƒ€ì´ë¨¸ê°€ ì‘ë™í•©ë‹ˆë‹¤.</li>
          <li>ë¬¸í•­ ì´ë™ì€ ììœ ë¡­ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>'ë‚˜ì¤‘ì— ë³´ê¸°' í‘œì‹œë¥¼ í™œìš©í•˜ì—¬ ì–´ë ¤ìš´ ë¬¸í•­ì„ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì œí•œ ì‹œê°„ì´ ì¢…ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.</li>
        </ul>
      </div>

      <!-- Action Button -->
      <button id="previewActionBtn" class="rp-preview-action-btn">í‰ê°€ ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>
</div>

<style>
  /* Preview Modal */
  .rp-preview-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
    padding: 40px 20px;
  }

  .rp-preview-modal.is-open {
    display: flex;
  }

  .rp-preview-modal__content {
    background: white;
    border-radius: var(--rp-radius-xl);
    padding: 60px 40px;
    max-width: 900px;
    width: 100%;
    position: relative;
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.3);
  }

  .rp-preview-modal__close {
    position: absolute;
    top: 24px;
    right: 24px;
    background: none;
    border: none;
    font-size: var(--rp-font-size-2xl);
    color: var(--rp-text-muted);
    cursor: pointer;
    transition: color 0.2s ease;
    padding: 8px;
    line-height: 1;
  }

  .rp-preview-modal__close:hover {
    color: var(--rp-text-title);
  }

  /* Preview Content */
  .rp-preview-content {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  /* Preview Header */
  .rp-preview-header {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding-bottom: 24px;
    border-bottom: 2px solid var(--rp-border);
  }

  .rp-preview-icon {
    width: 48px;
    height: 48px;
    color: var(--rp-primary);
  }

  .rp-preview-title {
    font-size: var(--rp-font-size-2xl);
    font-weight: var(--rp-font-weight-bold);
    color: var(--rp-text-title);
    margin: 0;
    line-height: 1.4;
  }

  .rp-preview-badge {
    display: inline-block;
    padding: 8px 16px;
    background: var(--rp-primary);
    color: white;
    border-radius: 20px;
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
  }

  /* Preview Grid */
  .rp-preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
  }

  .rp-preview-column {
    display: flex;
    flex-direction: column;
  }

  /* Preview Section */
  .rp-preview-section {
    border: 1px solid var(--rp-border);
    border-radius: var(--rp-radius-md);
    padding: 24px;
    background: white;
  }

  .rp-preview-section__header {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--rp-border);
  }

  .rp-preview-section-icon {
    width: 24px;
    height: 24px;
    color: var(--rp-primary);
  }

  .rp-preview-section__title {
    font-size: var(--rp-font-size-md);
    font-weight: var(--rp-font-weight-semibold);
    color: var(--rp-text-title);
    margin: 0;
  }

  .rp-preview-section__body {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Preview Items */
  .rp-preview-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .rp-preview-label {
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-medium);
    color: var(--rp-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rp-preview-value {
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    color: var(--rp-text-title);
  }

  /* Stimuli List */
  .rp-preview-stimulus {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 12px 0;
    border-bottom: 1px solid var(--rp-border);
  }

  .rp-preview-stimulus:last-child {
    border-bottom: none;
  }

  .rp-preview-stimulus-label {
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-semibold);
    color: var(--rp-text-muted);
  }

  .rp-preview-stimulus-title {
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-body);
  }

  /* Notice Section */
  .rp-preview-notice {
    background: #E0F2FE;
    border: 1px solid #BAE6FD;
    border-radius: var(--rp-radius-md);
    padding: 20px;
  }

  .rp-preview-notice__header {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 12px;
  }

  .rp-preview-notice-icon {
    width: 20px;
    height: 20px;
    color: #0EA5E9;
  }

  .rp-preview-notice__title {
    font-size: var(--rp-font-size-sm);
    font-weight: var(--rp-font-weight-semibold);
    color: #0284C7;
    margin: 0;
  }

  .rp-preview-notice__list {
    list-style: disc;
    padding-left: 24px;
    margin: 0;
    font-size: var(--rp-font-size-sm);
    color: #0284C7;
    line-height: 1.8;
  }

  .rp-preview-notice__list li {
    margin-bottom: 6px;
  }

  /* Action Button */
  .rp-preview-action-btn {
    padding: 14px 32px;
    background: var(--rp-primary);
    color: white;
    border: none;
    border-radius: var(--rp-radius-md);
    font-size: var(--rp-font-size-md);
    font-weight: var(--rp-font-weight-semibold);
    cursor: pointer;
    transition: all 0.2s ease;
    align-self: center;
    min-width: 240px;
  }

  .rp-preview-action-btn:hover {
    background: var(--rp-primary-hover);
    box-shadow: 0 4px 12px rgba(47, 91, 255, 0.2);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .rp-preview-modal__content {
      padding: 40px 24px;
    }

    .rp-preview-grid {
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .rp-preview-title {
      font-size: var(--rp-font-size-xl);
    }

    .rp-preview-section {
      padding: 16px;
    }
  }

  /* Search Form */
  .rp-search-form__fields {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: flex-end;
  }

  .rp-form-actions {
    display: flex;
    gap: 8px;
  }

  .rp-form-actions .rp-btn {
    flex: 1;
    margin: 0;
  }

  /* Table Styles */
  .rp-table-wrapper {
    overflow-x: auto;
  }

  .rp-table {
    width: 100%;
    border-collapse: collapse;
  }

  .rp-table__header {
    padding: 14px 16px;
    text-align: left;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-semibold);
    color: var(--rp-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--rp-border);
    background: var(--rp-bg-subtle);
  }

  .rp-table__row {
    border-bottom: 1px solid var(--rp-border);
    transition: all 0.2s ease;
  }

  .rp-table__row:hover {
    background: var(--rp-bg-subtle);
  }

  .rp-table__cell {
    padding: 16px;
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-body);
    vertical-align: middle;
  }

  /* Item Title Column */
  .rp-item-title {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .rp-item-code {
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-title);
    font-weight: var(--rp-font-weight-semibold);
  }

  .rp-item-description {
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-muted);
    margin: 0;
    line-height: 1.4;
  }

  /* Table Actions */
  .rp-table__actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .rp-inline-form {
    display: inline;
    margin: 0;
    padding: 0;
  }

  .rp-icon-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: var(--rp-radius-md);
    color: var(--rp-text-muted);
    transition: all 0.2s ease;
    cursor: pointer;
    text-decoration: none;
    border: 1px solid transparent;
    background: transparent;
    padding: 0;
  }

  .rp-icon-link:hover {
    background: var(--rp-bg-subtle);
    color: var(--rp-primary);
  }

  .rp-icon-link--edit::before {
    content: "âœï¸";
    font-size: var(--rp-font-size-md);
  }

  .rp-icon-link--view::before {
    content: "ğŸ‘ï¸";
    font-size: var(--rp-font-size-md);
  }

  .rp-icon-link--delete::before {
    content: "ğŸ—‘ï¸";
    font-size: var(--rp-font-size-md);
  }

  .rp-icon-link--delete:hover {
    color: var(--rp-danger);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .rp-search-form__fields {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .rp-table__header,
    .rp-table__cell {
      padding: 12px;
      font-size: var(--rp-font-size-xs);
    }

    .rp-item-code {
      font-size: var(--rp-font-size-sm);
    }

    .rp-item-description {
      font-size: var(--rp-font-size-xs);
    }

    .rp-icon-link {
      width: 32px;
      height: 32px;
    }
  }
</style>

<script>
  // Sample item data for preview (in production, this would be fetched from the server)
  const itemsData = {
    <% @items.each do |item| %>
      <%= item.id %>: {
        title: '<%= item.code || "##{item.id}" %>',
        grade: '<%= item.difficulty || "ë¯¸ì§€ì •" %>',
        totalItems: <%= item.item_choices.count %>,
        itemType: '<%= item.item_type == "mcq" ? "ê°ê´€ì‹" : "ì„œìˆ í˜•" %>',
        timeLimit: '60ë¶„',
        totalScore: '100ì ',
        stimuli: [
          <% if item.stimulus %>
            { number: 1, title: '<%= item.stimulus.title.gsub("'", "\\\\'") %>' }
          <% end %>
        ]
      },
    <% end %>
  };

  function openItemPreview(event, itemId) {
    event.preventDefault();
    const modal = document.getElementById('itemPreviewModal');
    const data = itemsData[itemId];

    if (!data) return;

    // Populate modal with item data
    document.getElementById('previewTitle').textContent = data.title;
    document.getElementById('previewGrade').textContent = data.grade;
    document.getElementById('previewTotalItems').textContent = data.totalItems + 'ë¬¸í•­';
    document.getElementById('previewItemType').textContent = data.itemType === 'MCQ' ? 'ê°ê´€ì‹' : 'ì„œìˆ í˜•';
    document.getElementById('previewTimeLimit').textContent = data.timeLimit;
    document.getElementById('previewTotalScore').textContent = data.totalScore;

    // Populate stimuli list
    const stimuliList = document.getElementById('previewStimuliList');
    stimuliList.innerHTML = '';
    if (data.stimuli && data.stimuli.length > 0) {
      data.stimuli.forEach((stimulus, idx) => {
        const div = document.createElement('div');
        div.className = 'rp-preview-stimulus';
        div.innerHTML = `
          <span class="rp-preview-stimulus-label">ì§€ë¬¸ ${stimulus.number}</span>
          <span class="rp-preview-stimulus-title">${stimulus.title}</span>
        `;
        stimuliList.appendChild(div);
      });
    }

    // Set action button href
    const actionBtn = document.getElementById('previewActionBtn');
    actionBtn.onclick = function() {
      window.location.href = '/researcher/items/<%= %>${itemId}<%= %>/edit';
    };

    modal.classList.add('is-open');
  }

  function closeItemPreview(event) {
    if (event && event.target.id !== 'itemPreviewModal') return;
    const modal = document.getElementById('itemPreviewModal');
    modal.classList.remove('is-open');
  }

  // Close modal when pressing Escape
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeItemPreview();
    }
  });
</script>
