<% content_for :portal_title do %>
  독서력 진단지 상세
<% end %>
<% content_for :portal_subtitle do %>
  진단지 정보와 문항 목록을 확인할 수 있습니다.
<% end %>
<% content_for :portal_nav do %>
  <%= render "researcher/shared/nav", current: :reading_proficiency %>
<% end %>

<%
  status_class = case @diagnostic.status
                 when "draft" then "rp-badge--warning"
                 when "active" then "rp-badge--success"
                 when "archived" then "rp-badge--danger"
                 else "rp-badge--warning"
                 end
  status_label = case @diagnostic.status
                 when "draft" then "초안"
                 when "active" then "배포됨"
                 when "archived" then "보관됨"
                 else "초안"
                 end
  level_class = @diagnostic.level == "elementary" ? "rp-badge--info" : "rp-badge--purple"
%>

<div class="portal-card">
  <div class="portal-card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
    <div>
      <h2 class="portal-card-title" style="margin: 0;"><%= @diagnostic.name %></h2>
      <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
        <span class="rp-badge rp-badge--pill <%= level_class %>"><%= @diagnostic.level_label %></span>
        <span class="rp-badge rp-badge--pill rp-badge--info"><%= @diagnostic.year %>년</span>
        <span class="rp-badge rp-badge--pill <%= status_class %>"><%= status_label %></span>
      </div>
    </div>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
      <%= link_to "문항 편집", edit_items_researcher_reading_proficiency_diagnostic_path(@diagnostic),
                  class: "btn btn-primary", style: "font-size: var(--rp-font-size-sm);" %>
      <%= link_to "엑셀 다운로드", download_template_researcher_reading_proficiency_diagnostic_path(@diagnostic),
                  class: "btn btn-outline-primary", style: "font-size: var(--rp-font-size-sm);" %>
      <%= link_to "정보 편집", edit_researcher_reading_proficiency_diagnostic_path(@diagnostic),
                  class: "btn btn-outline-secondary", style: "font-size: var(--rp-font-size-sm);" %>
      <%= link_to "목록", researcher_reading_proficiency_diagnostics_path,
                  class: "btn btn-secondary", style: "font-size: var(--rp-font-size-sm);" %>
    </div>
  </div>

  <div style="padding: 20px 0;">
    <% if @diagnostic.description.present? %>
      <div style="margin-bottom: 24px;">
        <p style="color: #666; font-size: var(--rp-font-size-base); margin: 0;"><%= @diagnostic.description %></p>
      </div>
    <% end %>

    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; margin-bottom: 28px;">
      <div class="rp-card" style="text-align: center; padding: 16px;">
        <div style="font-size: var(--rp-font-size-3xl); font-weight: var(--rp-font-weight-bold); color: var(--rp-primary, #4f46e5);"><%= @diagnostic.item_count %></div>
        <div style="font-size: var(--rp-font-size-sm); color: #666; margin-top: 4px;">총 문항</div>
      </div>
      <% ReadingProficiencyItem::FACTOR_LABELS.each do |key, label| %>
        <div class="rp-card" style="text-align: center; padding: 16px;">
          <div style="font-size: var(--rp-font-size-3xl); font-weight: var(--rp-font-weight-bold); color: var(--rp-primary, #4f46e5);"><%= @factor_counts[key] || 0 %></div>
          <div style="font-size: var(--rp-font-size-sm); color: #666; margin-top: 4px;"><%= label %></div>
        </div>
      <% end %>
    </div>

    <!-- Items Table -->
    <div class="rp-card">
      <div class="rp-card__header">
        <h3 class="rp-card__title">문항 목록</h3>
        <span class="rp-text-muted">총 <%= @items.size %>건</span>
      </div>
      <div class="rp-card__body">
        <% if @items.any? %>
          <div class="rp-table-wrapper">
            <table class="rp-table">
              <thead>
                <tr>
                  <th class="rp-table__header" style="width: 60px;">연번</th>
                  <th class="rp-table__header">발문</th>
                  <th class="rp-table__header" style="width: 100px;">문항유형</th>
                  <th class="rp-table__header" style="width: 120px;">측정 요소</th>
                </tr>
              </thead>
              <tbody>
                <% @items.each do |item| %>
                  <% factor_color = case item.measurement_factor
                                    when "cognitive" then "#3b82f6"
                                    when "emotional" then "#f59e0b"
                                    when "behavioral" then "#10b981"
                                    when "social" then "#8b5cf6"
                                    else "#6b7280"
                                    end %>
                  <tr class="rp-table__row">
                    <td class="rp-table__cell" style="text-align: center; font-weight: var(--rp-font-weight-semibold);"><%= item.position %></td>
                    <td class="rp-table__cell">
                      <div><%= sanitize_choice_text(item.prompt) %></div>
                      <% if item.image.attached? %>
                        <div style="margin-top: 8px;">
                          <%= image_tag item.image, style: "max-width: 300px; max-height: 200px; border-radius: 6px; border: 1px solid #e2e8f0;", onerror: "this.parentElement.style.display='none'" %>
                        </div>
                      <% end %>
                    </td>
                    <td class="rp-table__cell" style="text-align: center;">
                      <span class="rp-badge rp-badge--pill rp-badge--info">
                        <%= item.item_type == "mcq" ? "객관식" : "서술형" %>
                      </span>
                    </td>
                    <td class="rp-table__cell" style="text-align: center;">
                      <span class="rp-badge rp-badge--pill" style="background-color: <%= factor_color %>15; color: <%= factor_color %>;">
                        <%= item.factor_label %>
                      </span>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="rp-empty-state">
            <p>등록된 문항이 없습니다.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<style>
  .rp-badge--purple {
    background-color: #f3e8ff;
    color: #7c3aed;
  }
</style>
