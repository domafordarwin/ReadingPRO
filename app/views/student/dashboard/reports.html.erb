<% content_for :portal_title do %>
  ë‚´ í‰ê°€ ê²°ê³¼
<% end %>
<% content_for :portal_subtitle do %>
  ìµœê·¼ ì§„ë‹¨ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<% end %>
<% content_for :portal_nav do %>
  <%= render "student/shared/nav", current: :reports %>
<% end %>

<style>
  .dashboard-header {
    margin-bottom: 32px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: box-shadow 0.3s ease;
  }

  .stat-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .stat-label {
    font-size: var(--rp-font-size-xs);
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .stat-number {
    font-size: var(--rp-font-size-4xl);
    font-weight: 700;
    color: #667eea;
    margin-bottom: 4px;
  }

  .stat-unit {
    font-size: var(--rp-font-size-xs);
    color: #999;
  }

  .reports-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 16px;
  }

  .report-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 16px;
    transition: box-shadow 0.3s ease;
    cursor: pointer;
  }

  .report-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .report-card-link {
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 16px;
    height: 100%;
  }

  .report-card-left {
    flex: 1;
  }

  .report-title {
    font-size: var(--rp-font-size-lg);
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
  }

  .report-meta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 12px;
    font-size: var(--rp-font-size-sm);
    color: #666;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: var(--rp-font-size-2xs);
    font-weight: 600;
    margin-right: 8px;
  }

  .status-draft {
    background-color: #fff3cd;
    color: #856404;
  }

  .status-generated {
    background-color: #d4edda;
    color: #155724;
  }

  .status-published {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .status-none {
    background-color: #f8d7da;
    color: #721c24;
  }

  .report-card-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
  }

  .report-score {
    text-align: center;
    margin-bottom: 16px;
  }

  .score-number {
    font-size: var(--rp-font-size-4xl);
    font-weight: 700;
    color: #667eea;
  }

  .score-label {
    font-size: var(--rp-font-size-xs);
    color: #999;
    margin-top: 4px;
  }

  .report-action-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: var(--rp-font-size-sm);
    font-weight: 600;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
  }

  .report-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
  }

  .empty-state {
    text-align: center;
    padding: 48px 16px;
    color: #999;
  }

  .empty-state-icon {
    font-size: var(--rp-font-size-4xl);
    margin-bottom: 16px;
  }

  .loading {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .reports-list {
      grid-template-columns: 1fr;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<% if @attempts.any? %>
  <!-- í†µê³„ ì¹´ë“œ -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">ì´ ì‘ì‹œ</div>
      <div class="stat-number"><%= @attempts.count %></div>
      <div class="stat-unit">íšŒ</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">ì œì  ì™„ë£Œ</div>
      <div class="stat-number"><%= @attempts.count { |a| a.attempt_report.present? } %></div>
      <div class="stat-unit">ê±´</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">í‰ê·  ì ìˆ˜</div>
      <div class="stat-number"><%= calculate_average_score(@attempts) %></div>
      <div class="stat-unit">ì </div>
    </div>
  </div>

  <!-- ë¦¬í¬íŠ¸ ëª©ë¡ -->
  <div class="reports-list">
    <% @attempts.each do |attempt| %>
      <% attempt_score = calculate_attempt_score(attempt) %>
      <% report = attempt.attempt_report %>
      <% has_published_report = report&.report_status == "published" && report&.report_sections.present? %>
      <div class="report-card" data-attempt-id="<%= attempt.id %>">
        <div class="report-card-left">
          <div class="report-title">
            <%= attempt.diagnostic_form&.name || "ì§„ë‹¨ í‰ê°€" %>
          </div>

          <div class="report-meta">
            <% if has_published_report %>
              <span class="status-badge status-published">ë³´ê³ ì„œ ë°°í¬ë¨</span>
            <% elsif report.present? %>
              <span class="status-badge status-draft">ë³´ê³ ì„œ ìƒì„±ë¨</span>
            <% else %>
              <span class="status-badge status-generated">ì œì  ì™„ë£Œ</span>
            <% end %>

            <span class="meta-item">
              ğŸ“… <%= attempt.started_at&.strftime("%Y.%m.%d %H:%M") %>
            </span>

            <% if attempt.submitted_at.present? %>
              <span class="meta-item">
                ì™„ë£Œ: <%= attempt.submitted_at.strftime("%Y.%m.%d %H:%M") %>
              </span>
            <% end %>
          </div>
        </div>

        <div class="report-card-right">
          <div class="report-score">
            <div class="score-number"><%= attempt_score %></div>
            <div class="score-label">/100ì </div>
          </div>

          <div style="display: flex; flex-direction: row; gap: 8px; width: 100%;">
            <a href="<%= student_show_attempt_path(attempt.id) %>" class="report-action-btn" style="text-align: center; padding: 8px 12px; font-size: var(--rp-font-size-xs); flex: 1; text-decoration: none;">
              ì§„ë‹¨ ê²°ê³¼ ë³´ê¸°
            </a>
            <% if has_published_report %>
              <a href="<%= student_comprehensive_report_show_path(attempt.id) %>" class="report-action-btn" style="text-align: center; padding: 8px 12px; font-size: var(--rp-font-size-xs); flex: 1; text-decoration: none;">
                ì¢…í•©ë³´ê³ ì„œ ë³´ê¸°
              </a>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-state">
    <div class="empty-state-icon">ğŸ“‹</div>
    <p>ì§„í–‰í•œ ì§„ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    <p style="font-size: var(--rp-font-size-xs); margin-top: 8px;">ë¨¼ì € ì§„ë‹¨ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>
  </div>
<% end %>

<script>
  function navigateTo(path) {
    window.location.href = path;
  }

  function generateReport(attemptId) {
    if (confirm('ì´ ì§„ë‹¨ì— ëŒ€í•œ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ìƒì„±ì¤‘...';

      fetch('<%= student_generate_report_path %>', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ attempt_id: attemptId })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data && data.success) {
          // ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ í›„ ìƒì„¸ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = '/student/reports/' + attemptId;
        } else {
          alert('ì˜¤ë¥˜: ' + data.message);
          btn.disabled = false;
          btn.innerHTML = 'ë¦¬í¬íŠ¸ ìƒì„±';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ë¦¬í¬íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        btn.disabled = false;
        btn.innerHTML = 'ë¦¬í¬íŠ¸ ìƒì„±';
      });
    }
  }

  function updateReportStatus(attemptId, newStatus) {
    const statusName = newStatus === 'generated' ? 'ìƒì„± ì™„ë£Œ' : 'ë°œí–‰';
    if (confirm(`ë¦¬í¬íŠ¸ë¥¼ ${statusName} ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ì²˜ë¦¬ì¤‘...';

      fetch('<%= student_update_report_status_path %>', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          attempt_id: attemptId,
          status: newStatus
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data && data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('ì˜¤ë¥˜: ' + data.message);
          btn.disabled = false;
          btn.innerHTML = newStatus === 'generated' ? 'ìƒì„± ì™„ë£Œ' : 'ë°œí–‰í•˜ê¸°';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        btn.disabled = false;
        btn.innerHTML = newStatus === 'generated' ? 'ìƒì„± ì™„ë£Œ' : 'ë°œí–‰í•˜ê¸°';
      });
    }
  }

  function downloadReport(attemptId) {
    alert('PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
  }
</script>

<% content_for :portal_actions do %>
  <a class="portal-button" href="<%= student_diagnostics_path %>">ìƒˆë¡œìš´ ì§„ë‹¨</a>
<% end %>
