<% content_for :page_title do %>종합보고서<% end %>
<% content_for :head do %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<% end %>

<div class="cr-stu-header">
  <h1 class="cr-stu-header__title">나의 진단 리포트</h1>
  <% if @report && @published_attempts && @published_attempts.size > 1 %>
    <a href="<%= student_comprehensive_report_path %>" class="cr-stu-header__back">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
      목록으로 돌아가기
    </a>
  <% end %>
</div>

<% if @published_attempts && @published_attempts.size > 1 && @report.nil? %>
  <!-- 다건 목록 표시 -->
  <div class="cr-stu-list">
    <p class="cr-stu-list__desc">총 <strong><%= @published_attempts.size %></strong>건의 종합보고서가 있습니다.</p>
    <div class="cr-stu-list__grid">
      <% @published_attempts.each_with_index do |attempt, idx| %>
        <% report = attempt.attempt_report %>
        <% summary = report.section_data("overall_summary") %>
        <a href="<%= student_comprehensive_report_show_path(attempt_id: attempt.id) %>" class="cr-stu-list__card" data-turbo="false">
          <div class="cr-stu-list__card-num"><%= idx + 1 %></div>
          <div class="cr-stu-list__card-body">
            <div class="cr-stu-list__card-title"><%= attempt.diagnostic_form&.name || "진단 ##{attempt.id}" %></div>
            <div class="cr-stu-list__card-meta">
              <span>진단일: <%= attempt.submitted_at&.strftime("%Y-%m-%d") %></span>
              <% if summary["score_percentage"].present? %>
                <span class="cr-stu-list__card-score"><%= summary["score_percentage"] %>점</span>
              <% end %>
            </div>
            <div class="cr-stu-list__card-date">배포일: <%= report.published_at&.strftime("%Y-%m-%d") %></div>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </a>
      <% end %>
    </div>
  </div>

<% elsif @report&.report_status == "published" && @report.comprehensive_report_generated? %>

  <div id="report-printable-area">
  <!-- 학생 프로필 + 성과 요약 -->
  <% summary_data = @report.section_data("overall_summary") %>
  <div class="cr-stu-profile">
    <div class="cr-stu-profile__avatar"><%= @student.name&.first || "?" %></div>
    <div class="cr-stu-profile__info">
      <div class="cr-stu-profile__name"><%= @student.name %>의 읽기 능력 종합 보고서</div>
      <div class="cr-stu-profile__meta">
        <span>진단지: <%= @attempt&.diagnostic_form&.name %></span>
        <span class="cr-stu-profile__sep">·</span>
        <span>진단일: <%= summary_data["test_date"] || @attempt&.submitted_at&.strftime("%Y-%m-%d") %></span>
      </div>
    </div>
  </div>

  <!-- 성과 요약 카드 -->
  <% if summary_data.any? %>
  <div class="cr-stu-stats">
    <div class="cr-stu-stat">
      <div class="cr-stu-stat__icon cr-stu-stat__icon--slate">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div>
        <div class="cr-stu-stat__label">총점</div>
        <div class="cr-stu-stat__value"><%= summary_data["score_percentage"] || "-" %>%</div>
      </div>
    </div>
    <div class="cr-stu-stat">
      <div class="cr-stu-stat__icon cr-stu-stat__icon--blue">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      </div>
      <div>
        <div class="cr-stu-stat__label">객관식</div>
        <div class="cr-stu-stat__value cr-stu-stat__value--blue"><%= summary_data["mcq_correct"] || 0 %>/<%= summary_data["mcq_count"] || 0 %></div>
      </div>
    </div>
    <div class="cr-stu-stat">
      <div class="cr-stu-stat__icon cr-stu-stat__icon--green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      </div>
      <div>
        <div class="cr-stu-stat__label">서술형</div>
        <div class="cr-stu-stat__value cr-stu-stat__value--green"><%= summary_data["constructed_earned"] || 0 %>/<%= summary_data["constructed_max"] || 0 %></div>
      </div>
    </div>
    <div class="cr-stu-stat">
      <div class="cr-stu-stat__icon cr-stu-stat__icon--purple">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      </div>
      <%
        level = summary_data["performance_level"] || @report.performance_level
        level_labels = { "advanced" => "우수", "proficient" => "양호", "developing" => "보통", "beginning" => "기초" }
        level_value_classes = { "advanced" => "cr-stu-stat__value--green", "proficient" => "cr-stu-stat__value--blue", "developing" => "cr-stu-stat__value--yellow", "beginning" => "cr-stu-stat__value--red" }
      %>
      <div>
        <div class="cr-stu-stat__label">수행수준</div>
        <div class="cr-stu-stat__value <%= level_value_classes[level] %>"><%= level_labels[level] || "-" %></div>
      </div>
    </div>
  </div>
  <% end %>

  <!-- 보고서 섹션들 -->
  <%
    section_colors = { "overall_summary" => "#667eea", "area_analysis" => "#3b82f6", "mcq_analysis" => "#8b5cf6", "constructed_analysis" => "#16a34a", "reader_tendency" => "#d97706", "comprehensive_opinion" => "#dc2626", "learning_recommendations" => "#0891b2" }
    section_icons_svg = {
      "overall_summary" => '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>',
      "area_analysis" => '<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>',
      "mcq_analysis" => '<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>',
      "constructed_analysis" => '<path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>',
      "reader_tendency" => '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
      "comprehensive_opinion" => '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
      "learning_recommendations" => '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
    }
  %>

  <% AttemptReport::SECTION_KEYS.each_with_index do |key, idx| %>
    <% section = @report.section(key) %>
    <% next unless section["content"].present? %>
    <% color = section_colors[key] || "#64748b" %>

    <div class="cr-stu-section">
      <div class="cr-stu-section__header">
        <span class="cr-stu-section__number" style="background: <%= color %>;"><%= idx + 1 %></span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="<%= color %>" stroke-width="2"><%= raw section_icons_svg[key] %></svg>
        <h3 class="cr-stu-section__title"><%= AttemptReport::SECTION_TITLES[key] %></h3>
      </div>

      <% if key == "area_analysis" && section.dig("data", "indicators").present? %>
        <div class="cr-stu-section__data">
          <% radar_data = section.dig("data", "radar_data") %>
          <%
            indicator_colors = {
              "이해력" => { bg: "#eff6ff", border: "#bfdbfe", text: "#1e40af", bar: "#3b82f6", icon_bg: "#dbeafe" },
              "심미적 감수성" => { bg: "#faf5ff", border: "#e9d5ff", text: "#6b21a8", bar: "#8b5cf6", icon_bg: "#f3e8ff" },
              "의사소통 능력" => { bg: "#f0fdf4", border: "#bbf7d0", text: "#166534", bar: "#16a34a", icon_bg: "#dcfce7" }
            }
            indicator_icons = {
              "이해력" => '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
              "심미적 감수성" => '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>',
              "의사소통 능력" => '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>'
            }
          %>
          <div class="cr-stu-area-split">
            <!-- 왼쪽: 영역별 지수 카드 -->
            <div class="cr-stu-area-left">
              <% section.dig("data", "indicators")&.each do |ind| %>
                <%
                  colors = indicator_colors[ind["name"]] || { bg: "#f8fafc", border: "#e2e8f0", text: "#334155", bar: "#64748b", icon_bg: "#f1f5f9" }
                  icon_svg = indicator_icons[ind["name"]] || '<circle cx="12" cy="12" r="10"/>'
                  accuracy = ind["mcq_accuracy"].to_f
                  level_text = accuracy >= 80 ? "우수" : (accuracy >= 60 ? "양호" : (accuracy >= 40 ? "보통" : "기초"))
                  level_class = accuracy >= 80 ? "green" : (accuracy >= 60 ? "blue" : (accuracy >= 40 ? "yellow" : "red"))
                %>
                <div class="cr-stu-area-card" style="border-left: 3px solid <%= colors[:bar] %>;">
                  <div class="cr-stu-area-card__top">
                    <div class="cr-stu-area-card__icon" style="background: <%= colors[:icon_bg] %>;">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="<%= colors[:bar] %>" stroke-width="2"><%= raw icon_svg %></svg>
                    </div>
                    <div class="cr-stu-area-card__info">
                      <div class="cr-stu-area-card__name" style="color: <%= colors[:text] %>;"><%= ind["name"] %></div>
                      <div class="cr-stu-area-card__meta">문항 <%= ind["total_items"] %>개</div>
                    </div>
                    <div class="cr-stu-area-card__score">
                      <span class="cr-stu-area-card__pct" style="color: <%= colors[:bar] %>;"><%= accuracy.round(1) %>%</span>
                      <span class="cr-stu-area-card__level cr-stu-area-card__level--<%= level_class %>"><%= level_text %></span>
                    </div>
                  </div>
                  <div class="cr-stu-area-card__bar">
                    <div class="cr-stu-area-card__bar-fill" style="width: <%= accuracy %>%; background: <%= colors[:bar] %>;"></div>
                  </div>
                  <% sub_indicators = radar_data&.select { |r| r["group"] == ind["name"] } %>
                  <% if sub_indicators.present? %>
                    <div class="cr-stu-area-card__subs">
                      <% sub_indicators.each do |si| %>
                        <div class="cr-stu-area-card__sub">
                          <span class="cr-stu-area-card__sub-name"><%= si["name"] %></span>
                          <span class="cr-stu-area-card__sub-score" style="color: <%= colors[:bar] %>;"><%= si["score"] %>%</span>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>

            <!-- 오른쪽: 레이더 차트 -->
            <% if radar_data.present? %>
              <div class="cr-stu-area-right">
                <h4 class="cr-stu-area-right__title">세부 지표별 달성률</h4>
                <div class="cr-radar-chart" id="radar-chart-student">
                  <svg id="radar-svg-student" viewBox="0 0 460 420" width="100%"
                       data-radar-data="<%= radar_data.to_json %>"></svg>
                </div>
                <div class="cr-radar-legend" id="radar-legend-student"></div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="cr-stu-section__content">
        <div class="cr-stu-section__text"><%= render_markdown(section["content"]) %></div>
      </div>
    </div>
  <% end %>

  <!-- 보고서 발행 정보 -->
  <div class="cr-stu-footer">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    이 보고서는 <%= @report.published_at&.strftime("%Y년 %m월 %d일") %>에 작성되었습니다.
  </div>
  </div><!-- end report-printable-area -->

  <!-- PDF 저장 / 인쇄 액션 바 -->
  <div class="cr-stu-actions-bar no-print">
    <button onclick="downloadPdf()" class="cr-stu-actions-bar__btn cr-stu-actions-bar__btn--pdf" id="pdf-download-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      PDF 저장
    </button>
    <button onclick="window.print()" class="cr-stu-actions-bar__btn cr-stu-actions-bar__btn--print">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
      인쇄
    </button>
  </div>

<% else %>
  <!-- 보고서 미배포 상태 -->
  <div class="cr-stu-empty">
    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
    </svg>
    <h3 class="cr-stu-empty__title">종합보고서가 아직 준비되지 않았습니다</h3>
    <p class="cr-stu-empty__desc">선생님이 종합보고서를 작성한 후 확인할 수 있습니다.</p>
    <p class="cr-stu-empty__hint">완료된 진단의 개별 결과는 <strong>문해력 검사</strong> 페이지에서 확인할 수 있습니다.</p>
    <div class="cr-stu-empty__action">
      <%= link_to student_diagnostics_path, class: "cr-stu-btn cr-stu-btn--primary" do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        문해력 검사로 이동
      <% end %>
    </div>
  </div>
<% end %>

<!-- 레이더 차트 공통 함수 -->
<script>
function drawRadarChart(svgId, legendId, data) {
  const svg = document.getElementById(svgId);
  const legend = document.getElementById(legendId);
  if (!svg || !data || data.length === 0) return;

  const ns = 'http://www.w3.org/2000/svg';
  const cx = 230, cy = 195, radius = 150;
  const n = data.length;
  const levels = 5;
  const groupColors = {
    '이해력': { fill: 'rgba(59,130,246,0.15)', stroke: '#3b82f6', dot: '#2563eb' },
    '심미적 감수성': { fill: 'rgba(139,92,246,0.15)', stroke: '#8b5cf6', dot: '#7c3aed' },
    '의사소통 능력': { fill: 'rgba(22,163,74,0.15)', stroke: '#16a34a', dot: '#15803d' }
  };
  const defaultColor = { fill: 'rgba(100,116,139,0.15)', stroke: '#64748b', dot: '#475569' };

  function getPoint(index, value) {
    const angle = (Math.PI * 2 * index / n) - Math.PI / 2;
    const r = radius * (value / 100);
    return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
  }

  for (let lvl = 1; lvl <= levels; lvl++) {
    const r = radius * lvl / levels;
    let pts = [];
    for (let i = 0; i < n; i++) {
      const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
      pts.push(`${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`);
    }
    const polygon = document.createElementNS(ns, 'polygon');
    polygon.setAttribute('points', pts.join(' '));
    polygon.setAttribute('fill', 'none');
    polygon.setAttribute('stroke', lvl === levels ? '#cbd5e1' : '#e2e8f0');
    polygon.setAttribute('stroke-width', lvl === levels ? '1.5' : '0.8');
    svg.appendChild(polygon);
    if (lvl % 2 === 0 || lvl === levels) {
      const pct = document.createElementNS(ns, 'text');
      pct.setAttribute('x', cx + 4); pct.setAttribute('y', cy - r + 12);
      pct.setAttribute('fill', '#94a3b8'); pct.setAttribute('font-size', '10');
      pct.textContent = (lvl * 20) + '%';
      svg.appendChild(pct);
    }
  }

  data.forEach((d, i) => {
    const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
    const endX = cx + radius * Math.cos(angle);
    const endY = cy + radius * Math.sin(angle);
    const line = document.createElementNS(ns, 'line');
    line.setAttribute('x1', cx); line.setAttribute('y1', cy);
    line.setAttribute('x2', endX); line.setAttribute('y2', endY);
    line.setAttribute('stroke', '#e2e8f0'); line.setAttribute('stroke-width', '0.8');
    svg.appendChild(line);

    const labelR = radius + 28;
    const lx = cx + labelR * Math.cos(angle);
    const ly = cy + labelR * Math.sin(angle);
    const colors = groupColors[d.group] || defaultColor;

    const label = document.createElementNS(ns, 'text');
    label.setAttribute('x', lx); label.setAttribute('y', ly);
    label.setAttribute('text-anchor', 'middle'); label.setAttribute('dominant-baseline', 'middle');
    label.setAttribute('fill', colors.stroke); label.setAttribute('font-size', '11'); label.setAttribute('font-weight', '600');
    label.textContent = d.name;
    svg.appendChild(label);

    const scoreLabel = document.createElementNS(ns, 'text');
    scoreLabel.setAttribute('x', lx); scoreLabel.setAttribute('y', ly + 14);
    scoreLabel.setAttribute('text-anchor', 'middle'); scoreLabel.setAttribute('fill', '#94a3b8'); scoreLabel.setAttribute('font-size', '10');
    scoreLabel.textContent = d.score + '%';
    svg.appendChild(scoreLabel);
  });

  let dataPoints = data.map((d, i) => { const pt = getPoint(i, d.score); return `${pt.x},${pt.y}`; });
  const dataPolygon = document.createElementNS(ns, 'polygon');
  dataPolygon.setAttribute('points', dataPoints.join(' '));
  dataPolygon.setAttribute('fill', 'rgba(99,102,241,0.12)');
  dataPolygon.setAttribute('stroke', '#6366f1'); dataPolygon.setAttribute('stroke-width', '2');
  svg.appendChild(dataPolygon);

  data.forEach((d, i) => {
    const pt = getPoint(i, d.score);
    const colors = groupColors[d.group] || defaultColor;
    const dot = document.createElementNS(ns, 'circle');
    dot.setAttribute('cx', pt.x); dot.setAttribute('cy', pt.y); dot.setAttribute('r', '5');
    dot.setAttribute('fill', colors.dot); dot.setAttribute('stroke', 'white'); dot.setAttribute('stroke-width', '2');
    svg.appendChild(dot);
  });

  if (legend) {
    legend.innerHTML = '';
    [...new Set(data.map(d => d.group))].forEach(group => {
      const colors = groupColors[group] || defaultColor;
      const item = document.createElement('div');
      item.className = 'cr-radar-legend__item';
      item.innerHTML = `<span class="cr-radar-legend__dot" style="background:${colors.stroke}"></span><span>${group}</span>`;
      legend.appendChild(item);
    });
  }
}

// 레이더 차트 자동 초기화 (data 속성에서 읽어 즉시 실행)
document.querySelectorAll('svg[data-radar-data]').forEach(function(svg) {
  try {
    var data = JSON.parse(svg.dataset.radarData);
    var legendId = svg.id.replace('svg', 'legend');
    if (data && data.length > 0) drawRadarChart(svg.id, legendId, data);
  } catch(e) { console.error('Radar chart init error:', e); }
});

function downloadPdf() {
  var element = document.getElementById('report-printable-area');
  if (!element) return;
  var btn = document.getElementById('pdf-download-btn');
  var originalHTML = btn.innerHTML;
  btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg> PDF 생성 중...';
  btn.disabled = true;
  var opt = {
    margin: [10, 10, 10, 10],
    filename: '<%= j @student&.name || "학생" %>_종합보고서.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, logging: false },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };
  html2pdf().set(opt).from(element).save().then(function() {
    btn.innerHTML = originalHTML; btn.disabled = false;
  }).catch(function() {
    btn.innerHTML = originalHTML; btn.disabled = false;
  });
}
</script>

<style>
  /* ── 헤더 ── */
  .cr-stu-header { margin-bottom: 24px; display: flex; align-items: center; gap: 16px; }
  .cr-stu-header__title { font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-bold); color: #0f172a; margin: 0; }
  .cr-stu-header__back {
    font-size: var(--rp-font-size-lg); color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 4px;
    margin-left: auto; padding: 6px 12px; border-radius: 6px; transition: background 0.15s;
  }
  .cr-stu-header__back:hover { background: #f1f5f9; color: #334155; }

  /* ── 목록 ── */
  .cr-stu-list__desc { font-size: var(--rp-font-size-lg); color: #64748b; margin-bottom: 16px; }
  .cr-stu-list__grid { display: flex; flex-direction: column; gap: 10px; }
  .cr-stu-list__card {
    display: flex; align-items: center; gap: 14px;
    background: var(--rp-surface, #fff); border: 1px solid #e2e8f0; border-radius: 10px;
    padding: 16px 20px; text-decoration: none; color: inherit;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .cr-stu-list__card:hover { border-color: #667eea; box-shadow: 0 2px 8px rgba(102,126,234,0.12); }
  .cr-stu-list__card-num {
    width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
    background: linear-gradient(135deg, #667eea, #764ba2); color: #fff;
    font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); display: flex; align-items: center; justify-content: center;
  }
  .cr-stu-list__card-body { flex: 1; min-width: 0; }
  .cr-stu-list__card-title { font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-semibold); color: #0f172a; margin-bottom: 4px; }
  .cr-stu-list__card-meta { font-size: var(--rp-font-size-lg); color: #64748b; display: flex; gap: 12px; flex-wrap: wrap; }
  .cr-stu-list__card-score { font-weight: var(--rp-font-weight-semibold); color: #667eea; }
  .cr-stu-list__card-date { font-size: var(--rp-font-size-md); color: #94a3b8; margin-top: 4px; }

  /* ── 프로필 카드 ── */
  .cr-stu-profile {
    display: flex; align-items: center; gap: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(102,126,234,0.25);
  }
  .cr-stu-profile__avatar {
    width: 48px; height: 48px; background: rgba(255,255,255,0.2);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-bold); flex-shrink: 0;
  }
  .cr-stu-profile__name { font-size: var(--rp-font-size-2xl); font-weight: var(--rp-font-weight-bold); margin-bottom: 4px; }
  .cr-stu-profile__meta { font-size: var(--rp-font-size-lg); opacity: 0.85; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .cr-stu-profile__sep { opacity: 0.5; }

  /* ── 통계 카드 ── */
  .cr-stu-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
  .cr-stu-stat {
    display: flex; align-items: center; gap: 12px; background: white; border: 1px solid #e2e8f0;
    border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    transition: box-shadow 0.2s, transform 0.2s;
  }
  .cr-stu-stat:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
  .cr-stu-stat__icon {
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .cr-stu-stat__icon--slate { background: #f1f5f9; color: #475569; }
  .cr-stu-stat__icon--blue { background: #eff6ff; color: #3b82f6; }
  .cr-stu-stat__icon--green { background: #f0fdf4; color: #16a34a; }
  .cr-stu-stat__icon--purple { background: #faf5ff; color: #8b5cf6; }
  .cr-stu-stat__label { font-size: var(--rp-font-size-sm); color: #94a3b8; font-weight: var(--rp-font-weight-medium); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
  .cr-stu-stat__value { font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-bold); color: #0f172a; }
  .cr-stu-stat__value--blue { color: #2563eb; }
  .cr-stu-stat__value--green { color: #16a34a; }
  .cr-stu-stat__value--yellow { color: #d97706; }
  .cr-stu-stat__value--red { color: #dc2626; }

  /* ── 섹션 카드 ── */
  .cr-stu-section {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px;
    overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .cr-stu-section__header {
    display: flex; align-items: center; gap: 10px; padding: 16px 20px;
    border-bottom: 1px solid #f1f5f9;
  }
  .cr-stu-section__number {
    width: 26px; height: 26px; color: white; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); flex-shrink: 0;
  }
  .cr-stu-section__title { font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-semibold); color: #0f172a; margin: 0; }
  .cr-stu-section__data { padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid #f1f5f9; }
  .cr-stu-section__content { padding: 20px; }
  .cr-stu-section__text { font-size: var(--rp-font-size-lg); line-height: 1.8; color: #334155; }
  .cr-stu-section__text .md-h3 { font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-semibold); color: #0f172a; margin: 16px 0 8px; }
  .cr-stu-section__text .md-h4 { font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #1e293b; margin: 12px 0 6px; }
  .cr-stu-section__text .md-ol, .cr-stu-section__text .md-ul { margin: 8px 0; padding-left: 24px; }
  .cr-stu-section__text .md-ol li, .cr-stu-section__text .md-ul li { margin-bottom: 4px; }

  /* ── 이분할 레이아웃 ── */
  .cr-stu-area-split { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: stretch; }
  .cr-stu-area-left { display: flex; flex-direction: column; gap: 12px; }
  .cr-stu-area-right {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px;
    text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    display: flex; flex-direction: column; justify-content: center;
  }
  .cr-stu-area-right__title { font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #475569; margin: 0 0 12px 0; }

  /* 영역 카드 */
  .cr-stu-area-card {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: box-shadow 0.2s, transform 0.2s;
  }
  .cr-stu-area-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
  .cr-stu-area-card__top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .cr-stu-area-card__icon {
    width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .cr-stu-area-card__info { flex: 1; min-width: 0; }
  .cr-stu-area-card__name { font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); }
  .cr-stu-area-card__meta { font-size: var(--rp-font-size-sm); color: #94a3b8; margin-top: 1px; }
  .cr-stu-area-card__score { text-align: right; flex-shrink: 0; }
  .cr-stu-area-card__pct { font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-bold); display: block; line-height: 1.2; }
  .cr-stu-area-card__level {
    display: inline-block; font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); padding: 2px 8px; border-radius: 10px; margin-top: 2px;
  }
  .cr-stu-area-card__level--green { background: #dcfce7; color: #166534; }
  .cr-stu-area-card__level--blue { background: #dbeafe; color: #1e40af; }
  .cr-stu-area-card__level--yellow { background: #fef3c7; color: #92400e; }
  .cr-stu-area-card__level--red { background: #fee2e2; color: #991b1b; }

  .cr-stu-area-card__bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
  .cr-stu-area-card__bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

  .cr-stu-area-card__subs { display: flex; flex-direction: column; gap: 4px; }
  .cr-stu-area-card__sub {
    display: flex; justify-content: space-between; align-items: center;
    padding: 4px 8px; background: #f8fafc; border-radius: 6px; font-size: var(--rp-font-size-md);
  }
  .cr-stu-area-card__sub-name { color: #64748b; }
  .cr-stu-area-card__sub-score { font-weight: var(--rp-font-weight-semibold); }

  /* ── 푸터 ── */
  .cr-stu-footer {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    padding: 20px; color: #94a3b8; font-size: var(--rp-font-size-md);
  }

  /* ── PDF/Print 액션 바 ── */
  .cr-stu-actions-bar {
    display: flex; justify-content: center; gap: 12px; padding: 24px 0; margin-top: 8px;
  }
  .cr-stu-actions-bar__btn {
    display: inline-flex; align-items: center; gap: 8px; padding: 12px 28px;
    border-radius: 10px; font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-medium); cursor: pointer;
    border: 1px solid transparent; transition: all 0.2s;
  }
  .cr-stu-actions-bar__btn--pdf { background: #dc2626; color: white; }
  .cr-stu-actions-bar__btn--pdf:hover { background: #b91c1c; box-shadow: 0 4px 12px rgba(220,38,38,0.3); }
  .cr-stu-actions-bar__btn--pdf:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
  .cr-stu-actions-bar__btn--print { background: white; color: #475569; border-color: #e2e8f0; }
  .cr-stu-actions-bar__btn--print:hover { background: #f8fafc; border-color: #cbd5e1; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

  /* ── 빈 상태 ── */
  .cr-stu-empty {
    text-align: center; padding: 80px 40px; background: white;
    border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .cr-stu-empty svg { margin-bottom: 20px; }
  .cr-stu-empty__title { font-size: var(--rp-font-size-2xl); font-weight: var(--rp-font-weight-semibold); color: #0f172a; margin: 0 0 12px 0; }
  .cr-stu-empty__desc { font-size: var(--rp-font-size-lg); color: #64748b; margin: 0 0 8px 0; }
  .cr-stu-empty__hint { font-size: var(--rp-font-size-lg); color: #94a3b8; margin: 0; }
  .cr-stu-empty__action { margin-top: 24px; }

  /* ── 버튼 ── */
  .cr-stu-btn {
    display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: 8px;
    font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-medium); text-decoration: none; cursor: pointer;
    border: none; transition: all 0.15s;
  }
  .cr-stu-btn--primary { background: #2563eb; color: white; }
  .cr-stu-btn--primary:hover { background: #1d4ed8; box-shadow: 0 2px 8px rgba(37,99,235,0.2); }

  /* ── 레이더 차트 ── */
  .cr-radar-wrapper { text-align: center; margin-bottom: 16px; }
  .cr-radar-wrapper__title { font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #334155; margin: 0 0 12px 0; }
  .cr-radar-chart { display: flex; justify-content: center; }
  .cr-radar-chart svg { max-width: 460px; width: 100%; height: auto; }
  .cr-radar-legend { display: flex; justify-content: center; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
  .cr-radar-legend__item { display: flex; align-items: center; gap: 6px; font-size: var(--rp-font-size-md); color: #475569; font-weight: var(--rp-font-weight-medium); }
  .cr-radar-legend__dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* ── 반응형 ── */
  @media (max-width: 900px) {
    .cr-stu-area-split { grid-template-columns: 1fr; }
    .cr-stu-area-right { order: -1; }
  }
  @media (max-width: 768px) {
    .cr-stu-stats { grid-template-columns: repeat(2, 1fr); }
  }
  @media print {
    .cr-radar-chart svg { max-width: 350px; }
    .cr-radar-legend { gap: 12px; }
    .cr-stu-actions-bar, .cr-stu-header, .no-print { display: none !important; }
    .rp-header, .rp-sidebar { display: none !important; }
    .rp-layout, .rp-layout__body { display: block !important; }
    .rp-main { width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
    .rp-main__container { padding: 0 !important; max-width: 100% !important; }
    body { background: white !important; }
    .cr-stu-section { break-inside: avoid; }
  }
</style>
