<% content_for :portal_title do %>
  ì§„ë‹¨ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„¸
<% end %>

<% content_for :portal_subtitle do %>
  <%= @student.name %> í•™ìƒì˜ ìƒì„¸ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.
<% end %>

<% content_for :portal_nav do %>
  <%= render "student/shared/nav", current: :reports %>
<% end %>

<style>
  .report-header {
    padding: 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    margin-bottom: 24px;
  }

  .report-header h1 {
    margin: 0 0 8px 0;
    font-size: 28px;
  }

  .report-header p {
    margin: 4px 0;
    font-size: 14px;
    opacity: 0.9;
  }

  .status-indicator {
    display: inline-block;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 12px;
  }

  .report-section {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .report-section-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #667eea;
  }

  .insight-box {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 4px;
  }

  .insight-label {
    font-size: 12px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .insight-value {
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .achievement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .achievement-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
  }

  .achievement-card h3 {
    margin: 0 0 8px 0;
    font-size: 14px;
    opacity: 0.9;
  }

  .achievement-card .score {
    font-size: 32px;
    font-weight: 700;
    margin: 8px 0;
  }

  .achievement-card p {
    margin: 0;
    font-size: 12px;
    opacity: 0.8;
  }

  .direction-list {
    list-style: none;
    padding: 0;
  }

  .direction-item {
    padding: 16px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 12px;
    border-left: 4px solid #667eea;
  }

  .direction-item h4 {
    margin: 0 0 8px 0;
    color: #333;
    font-size: 14px;
  }

  .direction-item p {
    margin: 0;
    color: #666;
    font-size: 12px;
    line-height: 1.6;
  }

  .reader-type {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 8px;
    text-align: center;
  }

  .reader-type h3 {
    margin: 0;
    font-size: 16px;
    opacity: 0.9;
    margin-bottom: 8px;
  }

  .reader-type .type-name {
    font-size: 32px;
    font-weight: 700;
    margin: 12px 0;
  }

  .reader-type p {
    margin: 8px 0 0 0;
    font-size: 12px;
    opacity: 0.8;
    line-height: 1.6;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  .action-btn {
    padding: 12px 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .action-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .action-btn.primary {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .action-btn.primary:hover {
    background: #764ba2;
    border-color: #764ba2;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 16px;
    color: #667eea;
    text-decoration: none;
    font-size: 14px;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .empty-message {
    text-align: center;
    padding: 32px 16px;
    color: #999;
    font-size: 14px;
  }
</style>

<a href="<%= student_reports_path %>" class="back-link">â† ë¦¬í¬íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

<div class="report-header">
  <h1>ì§„ë‹¨ ê²°ê³¼ ë¦¬í¬íŠ¸</h1>
  <p><%= @student.name %> í•™ìƒ</p>
  <p>ì§„ë‹¨ì¼: <%= @attempt.started_at&.strftime("%Yë…„ %mì›” %dì¼ %H:%M") %></p>
  <span class="status-indicator">
    ìƒíƒœ: <%= translate_report_status(@report.status) %>
  </span>
</div>

<% if @comprehensive_analysis %>
  <div class="report-section">
    <div class="report-section-title">ì¢…í•© ë¶„ì„</div>

    <div class="insight-box">
      <div class="insight-label">ì¢…í•© í‰ê°€</div>
      <div class="insight-value">
        <%= @comprehensive_analysis.overall_summary || "í‰ê°€ ì¤‘ì…ë‹ˆë‹¤." %>
      </div>
    </div>

    <% if @comprehensive_analysis.improvement_areas.present? %>
      <div class="insight-box">
        <div class="insight-label">ê°œì„  ì˜ì—­</div>
        <div class="insight-value">
          <%= @comprehensive_analysis.improvement_areas %>
        </div>
      </div>
    <% end %>

    <% if @comprehensive_analysis.comprehension_analysis.present? %>
      <div class="insight-box">
        <div class="insight-label">ë…í•´ë ¥ ë¶„ì„</div>
        <div class="insight-value">
          <%= @comprehensive_analysis.comprehension_analysis %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<% if @reader_tendency %>
  <div class="report-section">
    <div class="report-section-title">ë…ì ì„±í–¥</div>

    <div class="reader-type">
      <h3>ë‹¹ì‹ ì˜ ë…ì ìœ í˜•</h3>
      <div class="type-name">
        <%= @reader_tendency.reader_type&.name || "ë¶„ì„ì¤‘" %>
      </div>
      <p>
        <%= @reader_tendency.reader_type&.characteristics || "ë‹¹ì‹ ì˜ ì½ê¸° ì„±í–¥ì„ ë¶„ì„í•©ë‹ˆë‹¤." %>
      </p>
    </div>
  </div>
<% end %>

<% if @literacy_achievements.any? %>
  <div class="report-section">
    <div class="report-section-title">ë¬¸í•´ë ¥ ì„±ì·¨</div>

    <div class="achievement-grid">
      <% @literacy_achievements.each do |achievement| %>
        <div class="achievement-card">
          <h3><%= achievement.evaluation_indicator&.name || "ë¬¸í•´ë ¥" %></h3>
          <div class="score"><%= "#{achievement.correct_answers}/#{achievement.total_questions}" %></div>
          <p>ì •ë‹µë¥ : <%= "#{achievement.accuracy_rate}%" || "í‰ê°€ ì¤‘ì…ë‹ˆë‹¤." %></p>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<% if @guidance_directions.any? %>
  <div class="report-section">
    <div class="report-section-title">í•™ìŠµ ì§€ë„ ë°©í–¥</div>

    <ul class="direction-list">
      <% @guidance_directions.each do |direction| %>
        <li class="direction-item">
          <h4><%= direction.evaluation_indicator&.name || "í•™ìŠµ ì˜ì—­" %></h4>
          <p><%= direction.content || "ì§€ë„ ë‚´ìš©ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤." %></p>
        </li>
      <% end %>
    </ul>
  </div>
<% end %>

<% unless @comprehensive_analysis || @reader_tendency || @literacy_achievements.any? || @guidance_directions.any? %>
  <div class="report-section">
    <div class="empty-message">
      <p>ğŸ“Š ë¶„ì„ ë°ì´í„°ê°€ ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
      <p>ë¦¬í¬íŠ¸ëŠ” ì§„ë‹¨ì´ ì™„ë£Œëœ í›„ ìƒì„±ë©ë‹ˆë‹¤.</p>
    </div>
  </div>
<% end %>

<div class="report-section">
  <div class="action-buttons">
    <% if @report.draft? %>
      <button class="action-btn primary" onclick="updateReportStatus(<%= @attempt.id %>, 'generated')">
        ìƒì„± ì™„ë£Œ
      </button>
    <% elsif @report.generated? %>
      <button class="action-btn primary" onclick="updateReportStatus(<%= @attempt.id %>, 'published')">
        ë°œí–‰í•˜ê¸°
      </button>
    <% elsif @report.published? %>
      <button class="action-btn" onclick="downloadPDF()">
        PDF ë‹¤ìš´ë¡œë“œ
      </button>
    <% end %>

    <button class="action-btn" onclick="printReport()">
      ì¸ì‡„í•˜ê¸°
    </button>
  </div>
</div>

<script>
  function updateReportStatus(attemptId, newStatus) {
    const statusName = newStatus === 'generated' ? 'ìƒì„± ì™„ë£Œ' : 'ë°œí–‰';
    if (confirm(`ë¦¬í¬íŠ¸ë¥¼ ${statusName} ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = 'ì²˜ë¦¬ì¤‘...';

      fetch('<%= student_update_report_status_path %>', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          attempt_id: attemptId,
          status: newStatus
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('ì˜¤ë¥˜: ' + data.message);
          btn.disabled = false;
          btn.innerHTML = newStatus === 'generated' ? 'ìƒì„± ì™„ë£Œ' : 'ë°œí–‰í•˜ê¸°';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        btn.disabled = false;
        btn.innerHTML = newStatus === 'generated' ? 'ìƒì„± ì™„ë£Œ' : 'ë°œí–‰í•˜ê¸°';
      });
    }
  }

  function downloadPDF() {
    alert('PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
  }

  function printReport() {
    window.print();
  }
</script>

<% content_for :portal_actions do %>
  <a class="portal-button" href="<%= student_reports_path %>">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
<% end %>
