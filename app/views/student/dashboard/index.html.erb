<% content_for :page_title do %>학생 대시보드<% end %>

<!-- Page Header -->
<div class="rp-page-header">
  <h1 class="rp-page-header__title">안녕하세요, <%= @student&.name || "학생" %>님!</h1>
  <p class="rp-page-header__subtitle">오늘의 진단 현황과 읽기 활동을 한눈에 확인하세요.</p>
</div>

<!-- CTA Card -->
<% if @latest_assignment.present? %>
  <div class="rp-card rp-card--highlight rp-mb-6">
    <div class="rp-flex rp-items-center rp-justify-between">
      <div>
        <h2 class="rp-card__title">새로운 진단이 배정되었습니다</h2>
        <p class="rp-card__subtitle"><%= @latest_assignment.name %></p>
      </div>
      <%= link_to student_diagnostics_path, class: "rp-btn rp-btn--primary rp-btn--lg" do %>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polygon points="10 8 16 12 10 16 10 8"></polygon>
        </svg>
        진단 시작하기
      <% end %>
    </div>
  </div>
<% elsif @pending_count > 0 %>
  <div class="rp-card rp-card--highlight rp-mb-6">
    <div class="rp-flex rp-items-center rp-justify-between">
      <div>
        <h2 class="rp-card__title">배정된 진단이 있습니다</h2>
        <p class="rp-card__subtitle">미완료 진단 <%= @pending_count %>건</p>
      </div>
      <%= link_to student_diagnostics_path, class: "rp-btn rp-btn--primary rp-btn--lg" do %>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polygon points="10 8 16 12 10 16 10 8"></polygon>
        </svg>
        진단 시작하기
      <% end %>
    </div>
  </div>
<% end %>

<!-- Stats Grid: 좌측 3칸(역량 요약 열) + 우측 1칸(최근 피드백 열) -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--rp-space-4, 16px);" class="rp-stagger rp-mb-6">
  <!-- 좌측: 3개 통계 박스 -->
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--rp-space-4, 16px);">
    <div class="rp-stat">
      <div class="rp-stat__label">완료한 진단</div>
      <div class="rp-stat__value"><%= @completed_count %>건</div>
    </div>
    <div class="rp-stat">
      <div class="rp-stat__label">배정된 진단</div>
      <div class="rp-stat__value"><%= @pending_count %>건</div>
      <% if @pending_count > 0 %>
        <div class="rp-stat__trend">미완료</div>
      <% end %>
    </div>
    <div class="rp-stat">
      <div class="rp-stat__label">최근 점수</div>
      <% if @latest_attempt&.attempt_report %>
        <div class="rp-stat__value" style="color: var(--rp-primary);"><%= @latest_attempt.attempt_report.score_percentage&.round(0) || "-" %>점</div>
      <% else %>
        <div class="rp-stat__value" style="color: var(--rp-primary);">-</div>
      <% end %>
    </div>
  </div>
  <!-- 우측: 최근 진단 (최근 피드백 열 너비) -->
  <div class="rp-stat">
    <div class="rp-stat__label">최근 진단</div>
    <% if @latest_attempt %>
      <div class="rp-stat__value" style="font-size: var(--rp-font-size-xl);"><%= @latest_attempt.diagnostic_form&.name || "-" %></div>
      <div class="rp-stat__trend"><%= @latest_attempt.submitted_at&.strftime("%Y-%m-%d") %></div>
    <% else %>
      <div class="rp-stat__value">-</div>
    <% end %>
  </div>
</div>

<!-- Main Content Grid -->
<div class="rp-grid rp-grid--2 rp-mb-6">
  <!-- Competency Summary -->
  <div class="rp-card">
    <div class="rp-card__header">
      <div>
        <h3 class="rp-card__title">역량 요약</h3>
        <% if @radar_data.any? %>
          <p class="rp-card__subtitle"><%= @radar_data.map { |d| d[:group] }.uniq.join(" · ") %></p>
        <% else %>
          <p class="rp-card__subtitle">진단 결과가 없습니다</p>
        <% end %>
      </div>
      <% if @best_attempt %>
        <span class="rp-badge rp-badge--primary">최고 점수</span>
      <% end %>
    </div>
    <div class="rp-card__body">
      <% if @radar_data.any? %>
        <div style="display: flex; justify-content: center; align-items: center;">
          <svg id="dashboard-radar-svg" viewBox="0 0 460 420" style="width: 100%; max-width: 380px; height: auto;"></svg>
        </div>
        <div id="dashboard-radar-legend" class="dashboard-radar-legend"></div>
        <style>
          .dashboard-radar-legend { display: flex; justify-content: center; gap: 16px; margin-top: 8px; flex-wrap: wrap; }
          .dashboard-radar-legend__item { display: flex; align-items: center; gap: 6px; font-size: var(--rp-font-size-xs); color: #475569; font-weight: var(--rp-font-weight-medium); }
          .dashboard-radar-legend__dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        </style>
        <script>
          document.addEventListener("turbo:load", function() {
            var svg = document.getElementById("dashboard-radar-svg");
            if (!svg) return;
            svg.innerHTML = '';
            var data = <%= json_escape(@radar_data.to_json) %>;
            if (!data || data.length === 0) return;

            var ns = 'http://www.w3.org/2000/svg';
            var cx = 230, cy = 195, radius = 150;
            var n = data.length;
            var levels = 5;
            var groupColors = {
              '이해력': { fill: 'rgba(59,130,246,0.15)', stroke: '#3b82f6', dot: '#2563eb' },
              '심미적 감수성': { fill: 'rgba(139,92,246,0.15)', stroke: '#8b5cf6', dot: '#7c3aed' },
              '의사소통 능력': { fill: 'rgba(22,163,74,0.15)', stroke: '#16a34a', dot: '#15803d' }
            };
            var defaultColor = { fill: 'rgba(100,116,139,0.15)', stroke: '#64748b', dot: '#475569' };

            function getPoint(index, value) {
              var angle = (Math.PI * 2 * index / n) - Math.PI / 2;
              var r = radius * (value / 100);
              return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
            }

            // Grid levels
            for (var lvl = 1; lvl <= levels; lvl++) {
              var r = radius * lvl / levels;
              var pts = [];
              for (var i = 0; i < n; i++) {
                var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
                pts.push((cx + r * Math.cos(angle)) + ',' + (cy + r * Math.sin(angle)));
              }
              var polygon = document.createElementNS(ns, 'polygon');
              polygon.setAttribute('points', pts.join(' '));
              polygon.setAttribute('fill', 'none');
              polygon.setAttribute('stroke', lvl === levels ? '#cbd5e1' : '#e2e8f0');
              polygon.setAttribute('stroke-width', lvl === levels ? '1.5' : '0.8');
              svg.appendChild(polygon);
              if (lvl % 2 === 0 || lvl === levels) {
                var pct = document.createElementNS(ns, 'text');
                pct.setAttribute('x', cx + 4); pct.setAttribute('y', cy - r + 12);
                pct.setAttribute('fill', '#94a3b8'); pct.setAttribute('font-size', '10');
                pct.textContent = (lvl * 20) + '%';
                svg.appendChild(pct);
              }
            }

            // Axis lines + labels
            data.forEach(function(d, i) {
              var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
              var endX = cx + radius * Math.cos(angle);
              var endY = cy + radius * Math.sin(angle);
              var line = document.createElementNS(ns, 'line');
              line.setAttribute('x1', cx); line.setAttribute('y1', cy);
              line.setAttribute('x2', endX); line.setAttribute('y2', endY);
              line.setAttribute('stroke', '#e2e8f0'); line.setAttribute('stroke-width', '0.8');
              svg.appendChild(line);

              var labelR = radius + 28;
              var lx = cx + labelR * Math.cos(angle);
              var ly = cy + labelR * Math.sin(angle);
              var colors = groupColors[d.group] || defaultColor;

              var label = document.createElementNS(ns, 'text');
              label.setAttribute('x', lx); label.setAttribute('y', ly);
              label.setAttribute('text-anchor', 'middle'); label.setAttribute('dominant-baseline', 'middle');
              label.setAttribute('fill', colors.stroke); label.setAttribute('font-size', '11'); label.setAttribute('font-weight', '600');
              label.textContent = d.name;
              svg.appendChild(label);

              var scoreLabel = document.createElementNS(ns, 'text');
              scoreLabel.setAttribute('x', lx); scoreLabel.setAttribute('y', ly + 14);
              scoreLabel.setAttribute('text-anchor', 'middle'); scoreLabel.setAttribute('fill', '#94a3b8'); scoreLabel.setAttribute('font-size', '10');
              scoreLabel.textContent = d.score + '%';
              svg.appendChild(scoreLabel);
            });

            // Data polygon
            var dataPoints = data.map(function(d, i) { var pt = getPoint(i, d.score); return pt.x + ',' + pt.y; });
            var dataPolygon = document.createElementNS(ns, 'polygon');
            dataPolygon.setAttribute('points', dataPoints.join(' '));
            dataPolygon.setAttribute('fill', 'rgba(99,102,241,0.12)');
            dataPolygon.setAttribute('stroke', '#6366f1'); dataPolygon.setAttribute('stroke-width', '2');
            svg.appendChild(dataPolygon);

            // Data dots
            data.forEach(function(d, i) {
              var pt = getPoint(i, d.score);
              var colors = groupColors[d.group] || defaultColor;
              var dot = document.createElementNS(ns, 'circle');
              dot.setAttribute('cx', pt.x); dot.setAttribute('cy', pt.y); dot.setAttribute('r', '5');
              dot.setAttribute('fill', colors.dot); dot.setAttribute('stroke', 'white'); dot.setAttribute('stroke-width', '2');
              svg.appendChild(dot);
            });

            // Legend
            var legend = document.getElementById('dashboard-radar-legend');
            if (legend) {
              legend.innerHTML = '';
              var seen = {};
              data.forEach(function(d) {
                if (seen[d.group]) return;
                seen[d.group] = true;
                var colors = groupColors[d.group] || defaultColor;
                var item = document.createElement('div');
                item.className = 'dashboard-radar-legend__item';
                item.innerHTML = '<span class="dashboard-radar-legend__dot" style="background:' + colors.stroke + '"></span><span>' + d.group + '</span>';
                legend.appendChild(item);
              });
            }
          });
        </script>
      <% else %>
        <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
          <p style="margin: 0;">진단을 완료하면 역량 분석 결과가 표시됩니다.</p>
        </div>
      <% end %>
    </div>
    <div class="rp-card__footer">
      <%= link_to "상세 리포트 보기", student_reports_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
    </div>
  </div>

  <!-- Recent Feedback -->
  <div class="rp-card" style="display: flex; flex-direction: column;">
    <div class="rp-card__header">
      <h3 class="rp-card__title">최근 피드백</h3>
      <% if @recent_feedbacks.any? %>
        <span class="rp-badge rp-badge--info"><%= @recent_feedbacks.size %>건</span>
      <% end %>
    </div>
    <div class="rp-card__body" style="flex: 1; display: flex; flex-direction: column;">
      <% if @recent_feedbacks.any? %>
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
          <% @recent_feedbacks.each do |fb| %>
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <div style="min-width: 0; flex: 1;">
                <strong style="font-size: var(--rp-font-size-sm);"><%= fb.response&.item&.prompt&.truncate(22) || "문항" %></strong>
                <div class="rp-text-muted" style="font-size: var(--rp-font-size-xs); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><%= fb.feedback&.truncate(36) %></div>
              </div>
              <span class="rp-badge rp-badge--default" style="flex-shrink: 0; margin-left: 8px; font-size: var(--rp-font-size-2xs);"><%= time_ago_in_words(fb.created_at) %> 전</span>
            </div>
          <% end %>
        </div>
      <% else %>
        <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
          <p style="margin: 0;">아직 받은 피드백이 없습니다.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 공지사항 -->
<div class="rp-card rp-mb-6">
  <div class="rp-card__header">
    <div>
      <h3 class="rp-card__title">공지사항</h3>
      <p class="rp-card__subtitle">최신 안내 사항을 확인하세요.</p>
    </div>
    <%= link_to "전체 보기", student_about_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
  </div>
  <div class="rp-card__body">
    <% if @notices.any? %>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <% @notices.each do |notice| %>
          <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; background: var(--rp-bg-subtle, #f8fafc); border-radius: 8px;">
            <% if notice.important? %>
              <span class="rp-badge rp-badge--warning" style="flex-shrink: 0; margin-top: 2px;">중요</span>
            <% else %>
              <span class="rp-badge rp-badge--default" style="flex-shrink: 0; margin-top: 2px;">안내</span>
            <% end %>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: var(--rp-font-weight-semibold); color: var(--rp-text-title, #1e293b); margin-bottom: 4px;"><%= notice.title %></div>
              <div class="rp-text-muted" style="font-size: var(--rp-font-size-sm); line-height: 1.5;"><%= truncate(strip_tags(notice.content), length: 80) %></div>
            </div>
            <div class="rp-text-muted" style="flex-shrink: 0; font-size: var(--rp-font-size-xs); white-space: nowrap;">
              <%= notice.published_at&.strftime("%m/%d") %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
        <p style="margin: 0;">현재 공지사항이 없습니다.</p>
      </div>
    <% end %>
  </div>
</div>
