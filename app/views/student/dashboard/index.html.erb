<% content_for :page_title do %>학생 대시보드<% end %>

<!-- Page Header -->
<div class="rp-page-header">
  <h1 class="rp-page-header__title">안녕하세요, <%= @student&.name || "학생" %>님!</h1>
  <p class="rp-page-header__subtitle">오늘의 진단 현황과 읽기 활동을 한눈에 확인하세요.</p>
</div>

<!-- CTA Card -->
<% if @latest_assignment.present? %>
  <div class="rp-card rp-card--highlight rp-mb-6">
    <div class="rp-flex rp-items-center rp-justify-between">
      <div>
        <h2 class="rp-card__title">새로운 진단이 배정되었습니다</h2>
        <p class="rp-card__subtitle"><%= @latest_assignment.name %></p>
      </div>
      <%= link_to student_diagnostics_path, class: "rp-btn rp-btn--primary rp-btn--lg" do %>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polygon points="10 8 16 12 10 16 10 8"></polygon>
        </svg>
        진단 시작하기
      <% end %>
    </div>
  </div>
<% elsif @pending_count > 0 %>
  <div class="rp-card rp-card--highlight rp-mb-6">
    <div class="rp-flex rp-items-center rp-justify-between">
      <div>
        <h2 class="rp-card__title">배정된 진단이 있습니다</h2>
        <p class="rp-card__subtitle">미완료 진단 <%= @pending_count %>건</p>
      </div>
      <%= link_to student_diagnostics_path, class: "rp-btn rp-btn--primary rp-btn--lg" do %>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polygon points="10 8 16 12 10 16 10 8"></polygon>
        </svg>
        진단 시작하기
      <% end %>
    </div>
  </div>
<% end %>

<!-- Stats Grid: 좌측 3칸(역량 요약 열) + 우측 1칸(최근 피드백 열) -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--rp-space-4, 16px);" class="rp-stagger rp-mb-6">
  <!-- 좌측: 3개 통계 박스 -->
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--rp-space-4, 16px);">
    <div class="rp-stat">
      <div class="rp-stat__label">완료한 진단</div>
      <div class="rp-stat__value"><%= @completed_count %>건</div>
    </div>
    <div class="rp-stat">
      <div class="rp-stat__label">배정된 진단</div>
      <div class="rp-stat__value"><%= @pending_count %>건</div>
      <% if @pending_count > 0 %>
        <div class="rp-stat__trend">미완료</div>
      <% end %>
    </div>
    <div class="rp-stat">
      <div class="rp-stat__label">최근 점수</div>
      <% if @latest_attempt&.attempt_report %>
        <div class="rp-stat__value" style="color: var(--rp-primary);"><%= @latest_attempt.attempt_report.score_percentage&.round(0) || "-" %>점</div>
      <% else %>
        <div class="rp-stat__value" style="color: var(--rp-primary);">-</div>
      <% end %>
    </div>
  </div>
  <!-- 우측: 최근 진단 (최근 피드백 열 너비) -->
  <div class="rp-stat">
    <div class="rp-stat__label">최근 진단</div>
    <% if @latest_attempt %>
      <div class="rp-stat__value" style="font-size: 20px;"><%= @latest_attempt.diagnostic_form&.name || "-" %></div>
      <div class="rp-stat__trend"><%= @latest_attempt.submitted_at&.strftime("%Y-%m-%d") %></div>
    <% else %>
      <div class="rp-stat__value">-</div>
    <% end %>
  </div>
</div>

<!-- Main Content Grid -->
<div class="rp-grid rp-grid--2 rp-mb-6">
  <!-- Competency Summary -->
  <div class="rp-card">
    <div class="rp-card__header">
      <div>
        <h3 class="rp-card__title">역량 요약</h3>
        <% if @literacy_achievements.any? %>
          <p class="rp-card__subtitle"><%= @literacy_achievements.map { |a| a.evaluation_indicator&.name }.compact.join(" · ") %></p>
        <% else %>
          <p class="rp-card__subtitle">진단 결과가 없습니다</p>
        <% end %>
      </div>
      <% if @latest_attempt %>
        <span class="rp-badge rp-badge--primary">최신</span>
      <% end %>
    </div>
    <div class="rp-card__body">
      <% if @literacy_achievements.any? %>
        <div style="display: flex; justify-content: center; align-items: center; height: 220px;">
          <canvas id="radarChart" width="280" height="220"></canvas>
        </div>
        <div class="rp-flex rp-gap-2 rp-mt-4" style="flex-wrap: wrap; justify-content: center;">
          <% badge_classes = %w[rp-badge--primary rp-badge--info rp-badge--success rp-badge--warning] %>
          <% @literacy_achievements.each_with_index do |achievement, i| %>
            <span class="rp-badge <%= badge_classes[i % badge_classes.length] %>">
              <%= achievement.evaluation_indicator&.name %> <%= achievement.accuracy_rate.round(0) %>점
            </span>
          <% end %>
        </div>
        <script>
          document.addEventListener("turbo:load", function() {
            var canvas = document.getElementById("radarChart");
            if (!canvas) return;
            var ctx = canvas.getContext("2d");
            var dpr = window.devicePixelRatio || 1;
            var w = 280, h = 220;
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            canvas.style.width = w + "px";
            canvas.style.height = h + "px";
            ctx.scale(dpr, dpr);

            var labels = [<%= raw @literacy_achievements.map { |a| "\"#{a.evaluation_indicator&.name || '영역'}\"" }.join(",") %>];
            var values = [<%= @literacy_achievements.map { |a| a.accuracy_rate.round(1) }.join(",") %>];
            var n = labels.length;
            var cx = w / 2, cy = h / 2 + 5;
            var radius = 75;
            var levels = 4;
            var angleStep = (2 * Math.PI) / n;
            var startAngle = -Math.PI / 2;

            function getPoint(i, r) {
              var angle = startAngle + i * angleStep;
              return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
            }

            // Grid
            for (var lv = 1; lv <= levels; lv++) {
              var r = (radius / levels) * lv;
              ctx.beginPath();
              for (var i = 0; i <= n; i++) {
                var p = getPoint(i % n, r);
                if (i === 0) ctx.moveTo(p.x, p.y);
                else ctx.lineTo(p.x, p.y);
              }
              ctx.closePath();
              ctx.strokeStyle = lv === levels ? "#cbd5e1" : "#e2e8f0";
              ctx.lineWidth = lv === levels ? 1.2 : 0.7;
              ctx.stroke();
            }

            // Axis lines
            for (var i = 0; i < n; i++) {
              var p = getPoint(i, radius);
              ctx.beginPath();
              ctx.moveTo(cx, cy);
              ctx.lineTo(p.x, p.y);
              ctx.strokeStyle = "#e2e8f0";
              ctx.lineWidth = 0.7;
              ctx.stroke();
            }

            // Level labels (25, 50, 75, 100)
            ctx.fillStyle = "#94a3b8";
            ctx.font = "9px sans-serif";
            ctx.textAlign = "left";
            for (var lv = 1; lv <= levels; lv++) {
              var val = (100 / levels) * lv;
              var r = (radius / levels) * lv;
              ctx.fillText(val.toFixed(0), cx + 3, cy - r + 3);
            }

            // Data polygon
            ctx.beginPath();
            for (var i = 0; i <= n; i++) {
              var idx = i % n;
              var r = (values[idx] / 100) * radius;
              var p = getPoint(idx, r);
              if (i === 0) ctx.moveTo(p.x, p.y);
              else ctx.lineTo(p.x, p.y);
            }
            ctx.closePath();
            ctx.fillStyle = "rgba(99, 102, 241, 0.15)";
            ctx.fill();
            ctx.strokeStyle = "#6366f1";
            ctx.lineWidth = 2;
            ctx.stroke();

            // Data points
            for (var i = 0; i < n; i++) {
              var r = (values[i] / 100) * radius;
              var p = getPoint(i, r);
              ctx.beginPath();
              ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
              ctx.fillStyle = "#6366f1";
              ctx.fill();
              ctx.strokeStyle = "#ffffff";
              ctx.lineWidth = 2;
              ctx.stroke();
            }

            // Labels
            ctx.fillStyle = "#334155";
            ctx.font = "bold 11px sans-serif";
            ctx.textAlign = "center";
            for (var i = 0; i < n; i++) {
              var p = getPoint(i, radius + 22);
              var align = "center";
              if (p.x < cx - 10) align = "right";
              else if (p.x > cx + 10) align = "left";
              ctx.textAlign = align;
              ctx.fillText(labels[i], p.x, p.y + 4);
            }
          });
        </script>
      <% else %>
        <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
          <p style="margin: 0;">진단을 완료하면 역량 분석 결과가 표시됩니다.</p>
        </div>
      <% end %>
    </div>
    <div class="rp-card__footer">
      <%= link_to "상세 리포트 보기", student_reports_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
    </div>
  </div>

  <!-- Recent Feedback -->
  <div class="rp-card">
    <div class="rp-card__header">
      <h3 class="rp-card__title">최근 피드백</h3>
      <% if @recent_feedbacks.any? %>
        <span class="rp-badge rp-badge--info"><%= @recent_feedbacks.size %>건</span>
      <% end %>
    </div>
    <div class="rp-card__body">
      <% if @recent_feedbacks.any? %>
        <div class="rp-table-wrapper">
          <table class="rp-table">
            <tbody>
              <% @recent_feedbacks.each do |fb| %>
                <tr>
                  <td>
                    <strong><%= fb.response&.item&.prompt&.truncate(20) || "문항" %></strong>
                    <div class="rp-text-muted" style="font-size: 12px;"><%= fb.feedback&.truncate(40) %></div>
                  </td>
                  <td class="rp-text-right">
                    <span class="rp-badge rp-badge--default"><%= time_ago_in_words(fb.created_at) %> 전</span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
          <p style="margin: 0;">아직 받은 피드백이 없습니다.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 공지사항 -->
<div class="rp-card rp-mb-6">
  <div class="rp-card__header">
    <div>
      <h3 class="rp-card__title">공지사항</h3>
      <p class="rp-card__subtitle">최신 안내 사항을 확인하세요.</p>
    </div>
    <%= link_to "전체 보기", student_about_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
  </div>
  <div class="rp-card__body">
    <% if @notices.any? %>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <% @notices.each do |notice| %>
          <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; background: var(--rp-bg-subtle, #f8fafc); border-radius: 8px;">
            <% if notice.important? %>
              <span class="rp-badge rp-badge--warning" style="flex-shrink: 0; margin-top: 2px;">중요</span>
            <% else %>
              <span class="rp-badge rp-badge--default" style="flex-shrink: 0; margin-top: 2px;">안내</span>
            <% end %>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: var(--rp-text-title, #1e293b); margin-bottom: 4px;"><%= notice.title %></div>
              <div class="rp-text-muted" style="font-size: 13px; line-height: 1.5;"><%= truncate(strip_tags(notice.content), length: 80) %></div>
            </div>
            <div class="rp-text-muted" style="flex-shrink: 0; font-size: 12px; white-space: nowrap;">
              <%= notice.published_at&.strftime("%m/%d") %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
        <p style="margin: 0;">현재 공지사항이 없습니다.</p>
      </div>
    <% end %>
  </div>
</div>
