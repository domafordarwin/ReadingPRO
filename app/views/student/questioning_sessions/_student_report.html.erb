<%#
  í•™ìƒìš© ë°œë¬¸ ì—­ëŸ‰ ì¢…í•© ë³´ê³ ì„œ
  Local variables:
    - report (QuestioningReport)
    - level (String: "elementary_low", "elementary_high", "middle", "high")
  ë°ì´í„° ì†ŒìŠ¤: QuestioningReport.report_sections (ë°œë¬¸ í•™ìŠµ ë°ì´í„° ê¸°ë°˜ GPT-4o-mini í‰ê°€)
  êµì‚¬ìš©(_report.html.erb)ê³¼ ë™ì¼í•œ ë°ì´í„°ë¥¼ í•™ìƒ ìˆ˜ì¤€ì— ë§ê²Œ í‘œì‹œ
%>

<%
  level ||= "elementary_low"
  is_l1 = level == "elementary_low"

  level_config = case level
    when "elementary_low"
      { title: "ë‚˜ì˜ ì½ê¸° ë³´ê³ ì„œ", summary_title: "ì„ ìƒë‹˜ì˜ ì´ì•¼ê¸°",
        feedback_length: 200, show_radar: false,
        accent_bg: "#fffbeb", accent_border: "#fcd34d", accent_text: "#92400e",
        header_gradient: "linear-gradient(135deg, #fef3c7, #ffedd5)",
        section_title: "ì–´ë–¤ ì ì´ ì¢‹ì•˜ì„ê¹Œ?", rec_title: "ì´ëŸ° ê²ƒë„ í•´ë³´ì!" }
    when "elementary_high"
      { title: "ë‚˜ì˜ ë°œë¬¸ ì—­ëŸ‰ ë³´ê³ ì„œ", summary_title: "ì„±ì¥ ë¶„ì„",
        feedback_length: 300, show_radar: true,
        accent_bg: "#eff6ff", accent_border: "#93c5fd", accent_text: "#1e40af",
        header_gradient: "linear-gradient(135deg, #dbeafe, #ede9fe)",
        section_title: "ì—­ëŸ‰ë³„ ìƒì„¸ ë¶„ì„", rec_title: "ì„±ì¥ì„ ìœ„í•œ ì œì•ˆ" }
    when "middle"
      { title: "ë°œë¬¸ ì—­ëŸ‰ ë³´ê³ ì„œ", summary_title: "ì¢…í•© í‰ê°€",
        feedback_length: 500, show_radar: true,
        accent_bg: "#f5f3ff", accent_border: "#c4b5fd", accent_text: "#5b21b6",
        header_gradient: "linear-gradient(135deg, #ede9fe, #f0f4ff)",
        section_title: "ì—­ëŸ‰ë³„ ë¶„ì„", rec_title: "í•™ìŠµ ê¶Œê³ ì‚¬í•­" }
    when "high"
      { title: "ë°œë¬¸ ì—­ëŸ‰ ì‹¬ì¸µ ë¶„ì„", summary_title: "ì¢…í•© ë¶„ì„",
        feedback_length: 0, show_radar: true,
        accent_bg: "#fdf2f8", accent_border: "#f9a8d4", accent_text: "#9d174d",
        header_gradient: "linear-gradient(135deg, #fce7f3, #f5f3ff)",
        section_title: "ì—­ëŸ‰ë³„ ì‹¬ì¸µ ë¶„ì„", rec_title: "ì‹¬í™” í•™ìŠµ ë°©í–¥" }
    else
      { title: "ë°œë¬¸ ì—­ëŸ‰ ë³´ê³ ì„œ", summary_title: "ì¢…í•© í‰ê°€",
        feedback_length: 400, show_radar: true,
        accent_bg: "#f5f3ff", accent_border: "#c4b5fd", accent_text: "#5b21b6",
        header_gradient: "linear-gradient(135deg, #ede9fe, #f0f4ff)",
        section_title: "ì—­ëŸ‰ë³„ ë¶„ì„", rec_title: "í•™ìŠµ ê¶Œê³ ì‚¬í•­" }
    end

  sections = report.report_sections || {}

  # 9ê°œ í•„ìˆ˜ ì—­ëŸ‰
  radar_mapping = [
    { key: "reading_comprehension", label: "ì½ê¸° ì´í•´ë ¥", group: "ì´í•´ ì—­ëŸ‰", emoji: "ğŸ“–" },
    { key: "inferential_reasoning", label: "ì¶”ë¡  ëŠ¥ë ¥", group: "ì´í•´ ì—­ëŸ‰", emoji: "ğŸ”" },
    { key: "critical_thinking", label: "ë¹„íŒì  ì‚¬ê³ ë ¥", group: "ì´í•´ ì—­ëŸ‰", emoji: "ğŸ¤”" },
    { key: "creative_thinking", label: "ì°½ì˜ì  ì‚¬ê³ ë ¥", group: "ì‚¬ê³  ì—­ëŸ‰", emoji: "ğŸ’¡" },
    { key: "metacognition", label: "ë©”íƒ€ì¸ì§€", group: "ì‚¬ê³  ì—­ëŸ‰", emoji: "ğŸ§ " },
    { key: "vocabulary_usage", label: "ì–´íœ˜ í™œìš©", group: "ì‚¬ê³  ì—­ëŸ‰", emoji: "ğŸ“" },
    { key: "text_connection", label: "í…ìŠ¤íŠ¸ ì—°ê²°", group: "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰", emoji: "ğŸ”—" },
    { key: "communication", label: "ì˜ì‚¬ì†Œí†µ", group: "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰", emoji: "ğŸ’¬" },
    { key: "personal_application", label: "ì‚¶ ì ìš©", group: "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰", emoji: "ğŸŒ" }
  ]

  radar_data = radar_mapping.map do |item|
    score = sections.dig(item[:key], "score") || 0
    { name: item[:label], group: item[:group], score: score, emoji: item[:emoji] }
  end

  # ì¡°ê±´ë¶€ ì—­ëŸ‰
  conditional_sections = [
    { key: "discussion_competency", label: "í† ë¡  ì—­ëŸ‰", emoji: "ğŸ—£ï¸" },
    { key: "argumentative_writing", label: "ë…¼ì¦ì  ê¸€ì“°ê¸°", emoji: "âœï¸" }
  ].select { |cs| sections.dig(cs[:key], "score").present? }

  # í†µê³„
  avg_score = radar_data.any? ? (radar_data.sum { |d| d[:score] } / radar_data.size.to_f).round(1) : 0
  top_areas = radar_data.sort_by { |d| -d[:score] }.first(3)
  weak_areas = radar_data.sort_by { |d| d[:score] }.first(3)

  # ìˆ˜ì¤€ ì´ëª¨ì§€
  level_emoji = case report.literacy_level
    when "beginning" then "ğŸŒ±"
    when "developing" then "â­"
    when "proficient" then "ğŸŒŸ"
    when "advanced" then "ğŸ†"
    else "ğŸ“Š"
  end

  group_colors = {
    "ì´í•´ ì—­ëŸ‰" => { bg: "#eff6ff", border: "#bfdbfe", title: "#1e40af", bar: "#3b82f6" },
    "ì‚¬ê³  ì—­ëŸ‰" => { bg: "#faf5ff", border: "#e9d5ff", title: "#6b21a8", bar: "#8b5cf6" },
    "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰" => { bg: "#f0fdf4", border: "#bbf7d0", title: "#166534", bar: "#16a34a" }
  }
%>

<div style="margin-top: var(--rp-space-5);" id="student-report-section">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     1. í—¤ë” + ì„±ì·¨ ìˆ˜ì¤€
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="padding: var(--rp-space-5); background: <%= level_config[:header_gradient] %>; border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5); border: 1px solid <%= level_config[:accent_border] %>; text-align: center;">
  <div style="font-size: <%= is_l1 ? 'var(--rp-font-size-sm)' : 'var(--rp-font-size-xs)' %>; font-weight: var(--rp-font-weight-semibold); color: <%= level_config[:accent_text] %>; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--rp-space-3);"><%= level_config[:title] %></div>

  <!-- ì„±ì·¨ ìˆ˜ì¤€ ì´ëª¨ì§€ + ë¼ë²¨ -->
  <div style="font-size: <%= is_l1 ? '56px' : '40px' %>; margin-bottom: var(--rp-space-2);"><%= level_emoji %></div>
  <div style="font-size: <%= is_l1 ? 'var(--rp-font-size-lg)' : 'var(--rp-font-size-md)' %>; font-weight: var(--rp-font-weight-bold); color: <%= level_config[:accent_text] %>; margin-bottom: var(--rp-space-2);"><%= report.literacy_level_label %></div>

  <!-- í‰ê·  ì ìˆ˜ -->
  <div style="display: inline-flex; align-items: center; gap: var(--rp-space-2); padding: var(--rp-space-2) var(--rp-space-4); background: rgba(255,255,255,0.7); border-radius: 999px; margin-bottom: var(--rp-space-3);">
    <span style="font-size: <%= is_l1 ? 'var(--rp-font-size-2xl)' : 'var(--rp-font-size-xl)' %>; font-weight: 700; color: <%= level_config[:accent_text] %>;"><%= avg_score %></span>
    <span style="font-size: var(--rp-font-size-xs); color: var(--rp-text-muted);">/ 100</span>
  </div>

  <!-- ì¢…í•© ìš”ì•½ -->
  <% if report.overall_summary.present? %>
    <div style="margin-top: var(--rp-space-3); text-align: left; font-size: <%= is_l1 ? 'var(--rp-font-size-sm)' : 'var(--rp-font-size-sm)' %>; line-height: 1.8; color: var(--rp-text-body); padding: var(--rp-space-3); background: rgba(255,255,255,0.5); border-radius: var(--rp-radius-md);">
      <div style="font-size: var(--rp-font-size-xs); font-weight: var(--rp-font-weight-semibold); color: <%= level_config[:accent_text] %>; margin-bottom: var(--rp-space-2);"><%= level_config[:summary_title] %></div>
      <%= simple_format(report.overall_summary) %>
    </div>
  <% end %>
</div>

<% if level_config[:show_radar] %>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2. ë ˆì´ë” ì°¨íŠ¸ (L2-L4)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="padding: var(--rp-space-5); background: var(--rp-surface); border: 1px solid var(--rp-border); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5);">
  <h3 style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title); margin: 0 0 var(--rp-space-3) 0; text-align: center;">9ê°œ ì—­ëŸ‰ í”„ë¡œí•„</h3>
  <div style="display: flex; justify-content: center;">
    <svg id="sr-radar-svg" viewBox="0 0 460 420" style="max-width: 380px; width: 100%; height: auto;"></svg>
  </div>
  <div id="sr-radar-legend" style="display: flex; justify-content: center; gap: 16px; margin-top: var(--rp-space-2); flex-wrap: wrap;"></div>

  <!-- ì ìˆ˜ ìš”ì•½ ë°” -->
  <div style="margin-top: var(--rp-space-4); max-width: 500px; margin-left: auto; margin-right: auto;">
    <% radar_data.each do |rd| %>
      <%
        sc = rd[:score]
        bar_color = sc >= 80 ? "#16a34a" : sc >= 60 ? "#2563eb" : sc >= 40 ? "#f59e0b" : "#dc2626"
      %>
      <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: 6px;">
        <span style="font-size: var(--rp-font-size-xs); color: var(--rp-text-muted); width: 85px; flex-shrink: 0; text-align: right;"><%= rd[:name] %></span>
        <div style="flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
          <div style="width: <%= sc %>%; height: 100%; background: <%= bar_color %>; border-radius: 4px;"></div>
        </div>
        <span style="font-size: var(--rp-font-size-xs); font-weight: 600; color: <%= bar_color %>; width: 32px; text-align: right;"><%= sc.to_i %></span>
      </div>
    <% end %>
  </div>
</div>

<% else %>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2. ì´ëª¨ì§€ ì ìˆ˜ ì¹´ë“œ (L1 ì „ìš©)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="padding: var(--rp-space-4); background: var(--rp-surface); border: 1px solid var(--rp-border); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5);">
  <h3 style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title); margin: 0 0 var(--rp-space-4) 0; text-align: center;">ğŸ“Š ë‚´ê°€ ì˜í•œ ê²ƒì€?</h3>
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--rp-space-3);">
    <% radar_data.each do |rd| %>
      <%
        sc = rd[:score]
        stars = sc >= 80 ? 3 : sc >= 50 ? 2 : 1
        card_bg = sc >= 80 ? "#f0fdf4" : sc >= 50 ? "#fffbeb" : "#fef2f2"
        card_border = sc >= 80 ? "#bbf7d0" : sc >= 50 ? "#fde68a" : "#fecaca"
      %>
      <div style="padding: var(--rp-space-3); background: <%= card_bg %>; border: 1px solid <%= card_border %>; border-radius: var(--rp-radius-md); text-align: center;">
        <div style="font-size: 24px; margin-bottom: 4px;"><%= rd[:emoji] %></div>
        <div style="font-size: var(--rp-font-size-xs); font-weight: 600; color: var(--rp-text-title); margin-bottom: 6px; line-height: 1.3;"><%= rd[:name] %></div>
        <div style="font-size: 16px; letter-spacing: 2px;"><% stars.times do %>â­<% end %></div>
      </div>
    <% end %>
  </div>
</div>
<% end %>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     3. ì—­ëŸ‰ë³„ ìƒì„¸ ë¶„ì„
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="margin-bottom: var(--rp-space-5);">
  <h3 style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title); margin: 0 0 var(--rp-space-4) 0;"><%= level_config[:section_title] %></h3>

  <% if is_l1 %>
    <!-- L1: ê°„ë‹¨í•œ ì¹´ë“œ -->
    <div style="display: flex; flex-direction: column; gap: var(--rp-space-3);">
      <% radar_data.each do |rd| %>
        <%
          item = radar_mapping.find { |m| m[:label] == rd[:name] }
          section = sections[item[:key]] || {}
          feedback = section["feedback"]
          strengths = section["strengths"] || []
          improvements = section["improvements"] || []
          sc = rd[:score]
          stars = sc >= 80 ? 3 : sc >= 50 ? 2 : 1
        %>
        <div style="padding: var(--rp-space-4); background: #fffbeb; border: 1px solid #fde68a; border-radius: var(--rp-radius-md);">
          <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-2);">
            <span style="font-size: 20px;"><%= rd[:emoji] %></span>
            <span style="font-size: var(--rp-font-size-sm); font-weight: 600; color: #92400e;"><%= rd[:name] %></span>
            <span style="margin-left: auto; font-size: var(--rp-font-size-sm); letter-spacing: 2px;"><% stars.times do %>â­<% end %></span>
          </div>
          <% if feedback.present? %>
            <div style="font-size: var(--rp-font-size-sm); line-height: 1.7; color: var(--rp-text-body); margin-bottom: var(--rp-space-2);"><%= simple_format(feedback.truncate(200)) %></div>
          <% end %>
          <% if strengths.any? %>
            <% strengths.first(2).each do |s| %>
              <div style="font-size: var(--rp-font-size-xs); color: #16a34a; display: flex; align-items: flex-start; gap: 6px; margin-bottom: 2px;">
                <span style="flex-shrink: 0;">âœ…</span> <span><%= s %></span>
              </div>
            <% end %>
          <% end %>
          <% if improvements.any? %>
            <% improvements.first(1).each do |imp| %>
              <div style="font-size: var(--rp-font-size-xs); color: #d97706; display: flex; align-items: flex-start; gap: 6px; margin-top: 4px;">
                <span style="flex-shrink: 0;">ğŸ’¡</span> <span><%= imp %></span>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>

  <% else %>
    <!-- L2-L4: ê·¸ë£¹ë³„ ì¹´ë“œ -->
    <% ["ì´í•´ ì—­ëŸ‰", "ì‚¬ê³  ì—­ëŸ‰", "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰"].each do |group_name| %>
      <% group_items = radar_mapping.select { |r| r[:group] == group_name } %>
      <% gc = group_colors[group_name] %>

      <div style="margin-bottom: var(--rp-space-4);">
        <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-bold); color: <%= gc[:title] %>; margin: 0 0 var(--rp-space-3) 0; padding-bottom: var(--rp-space-2); border-bottom: 2px solid <%= gc[:border] %>;">
          <%= group_name %>
        </h4>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--rp-space-3);">
          <% group_items.each do |item| %>
            <%
              section = sections[item[:key]] || {}
              score = section["score"]
              feedback = section["feedback"]
              strengths = section["strengths"] || []
              improvements = section["improvements"] || []
              trunc_len = level_config[:feedback_length]

              score_color = if score.nil?
                "var(--rp-text-muted)"
              elsif score >= 80
                "#16a34a"
              elsif score >= 60
                "#2563eb"
              elsif score >= 40
                "#f59e0b"
              else
                "#dc2626"
              end
            %>
            <div style="padding: var(--rp-space-4); background: <%= gc[:bg] %>; border: 1px solid <%= gc[:border] %>; border-radius: var(--rp-radius-md);">
              <!-- í—¤ë” -->
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--rp-space-2);">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 16px;"><%= item[:emoji] %></span>
                  <span style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: <%= gc[:title] %>;"><%= item[:label] %></span>
                </div>
                <% if score.present? %>
                  <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: <%= score_color %>;"><%= score.is_a?(Float) ? score.round(1) : score %></span>
                <% end %>
              </div>

              <!-- ì ìˆ˜ ë°” -->
              <% if score.present? %>
                <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.6); border-radius: 3px; margin-bottom: var(--rp-space-3); overflow: hidden;">
                  <div style="width: <%= score %>%; height: 100%; background: <%= gc[:bar] %>; border-radius: 3px;"></div>
                </div>
              <% end %>

              <!-- í”¼ë“œë°± -->
              <% if feedback.present? %>
                <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); line-height: 1.6; margin-bottom: var(--rp-space-2);">
                  <%= simple_format(trunc_len > 0 ? feedback.truncate(trunc_len) : feedback) %>
                </div>
              <% end %>

              <!-- ê°•ì  -->
              <% if strengths.any? %>
                <div style="margin-top: var(--rp-space-2);">
                  <% strengths.first(3).each do |s| %>
                    <div style="font-size: var(--rp-font-size-xs); color: #16a34a; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                      <span style="flex-shrink: 0;">âœ“</span> <span><%= s %></span>
                    </div>
                  <% end %>
                </div>
              <% end %>

              <!-- ê°œì„ ì  -->
              <% if improvements.any? %>
                <div style="margin-top: var(--rp-space-1);">
                  <% improvements.first(3).each do |imp| %>
                    <div style="font-size: var(--rp-font-size-xs); color: #f59e0b; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                      <span style="flex-shrink: 0;">â–³</span> <span><%= imp %></span>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     3-1. ì¡°ê±´ë¶€ ì—­ëŸ‰ (í† ë¡ /ì—ì„¸ì´)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<% if conditional_sections.any? %>
  <div style="margin-bottom: var(--rp-space-5);">
    <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-bold); color: #475569; margin: 0 0 var(--rp-space-3) 0; padding-bottom: var(--rp-space-2); border-bottom: 2px solid #e2e8f0;">
      ì¶”ê°€ ì—­ëŸ‰ í‰ê°€
    </h4>
    <div style="display: grid; grid-template-columns: repeat(<%= conditional_sections.size %>, 1fr); gap: var(--rp-space-3);">
      <% conditional_sections.each do |cs| %>
        <%
          section = sections[cs[:key]] || {}
          score = section["score"]
          feedback = section["feedback"]
          strengths = section["strengths"] || []
          improvements = section["improvements"] || []
          score_color = score.nil? ? "var(--rp-text-muted)" : score >= 80 ? "#16a34a" : score >= 60 ? "#2563eb" : score >= 40 ? "#f59e0b" : "#dc2626"
        %>
        <div style="padding: var(--rp-space-4); background: #f8fafc; border: 1px solid #e2e8f0; border-radius: var(--rp-radius-md);">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: var(--rp-space-2);">
            <span style="font-size: 16px;"><%= cs[:emoji] %></span>
            <span style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #334155;"><%= cs[:label] %></span>
            <span style="margin-left: auto; font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: <%= score_color %>;"><%= score %></span>
          </div>
          <% if score.present? %>
            <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-bottom: var(--rp-space-3); overflow: hidden;">
              <div style="width: <%= score %>%; height: 100%; background: #6366f1; border-radius: 3px;"></div>
            </div>
          <% end %>
          <% if feedback.present? %>
            <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); line-height: 1.6;"><%= simple_format(is_l1 ? feedback.truncate(150) : feedback.truncate(level_config[:feedback_length] > 0 ? level_config[:feedback_length] : 9999)) %></div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     4. ì¢…í•© ì˜ê²¬
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="padding: var(--rp-space-5); background: var(--rp-surface); border: 1px solid var(--rp-border); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5);">
  <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-4);">
    <span style="font-size: 20px;"><%= is_l1 ? "ğŸŒˆ" : "ğŸ“‹" %></span>
    <h3 style="margin: 0; font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title);"><%= is_l1 ? "ë‚˜ëŠ” ì´ëŸ° ê²ƒì„ ì˜í•´!" : "ì¢…í•© ì˜ê²¬" %></h3>
  </div>

  <!-- ìš°ìˆ˜/ë³´ì™„ ì˜ì—­ -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--rp-space-3); margin-bottom: var(--rp-space-4);">
    <!-- ì˜í•œ ì˜ì—­ -->
    <div style="padding: var(--rp-space-3); background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: var(--rp-radius-md);">
      <div style="font-size: var(--rp-font-size-xs); font-weight: var(--rp-font-weight-semibold); color: #16a34a; margin-bottom: var(--rp-space-2);"><%= is_l1 ? "ğŸŒŸ ì˜í•œ ê²ƒ!" : "âœ“ ìš°ìˆ˜ ì˜ì—­" %></div>
      <% top_areas.each do |a| %>
        <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
          <span style="font-weight: 600; color: #166534;"><%= a[:name] %></span>
          <span style="color: #16a34a; font-weight: 600;"><%= a[:score].to_i %>ì </span>
        </div>
      <% end %>
    </div>
    <!-- ë” ë…¸ë ¥í•  ì˜ì—­ -->
    <div style="padding: var(--rp-space-3); background: #fffbeb; border: 1px solid #fde68a; border-radius: var(--rp-radius-md);">
      <div style="font-size: var(--rp-font-size-xs); font-weight: var(--rp-font-weight-semibold); color: #d97706; margin-bottom: var(--rp-space-2);"><%= is_l1 ? "ğŸ’ª ë” í•´ë³´ì!" : "â–³ ë³´ì™„ ì˜ì—­" %></div>
      <% weak_areas.each do |a| %>
        <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
          <span style="font-weight: 600; color: #92400e;"><%= a[:name] %></span>
          <span style="color: #d97706; font-weight: 600;"><%= a[:score].to_i %>ì </span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ì£¼ìš” ê°•ì  ëª©ë¡ -->
  <%
    all_strengths = radar_mapping.flat_map { |item|
      (sections.dig(item[:key], "strengths") || []).map { |st| { area: item[:label], text: st } }
    }.uniq { |x| x[:text] }

    all_improvements = radar_mapping.flat_map { |item|
      (sections.dig(item[:key], "improvements") || []).map { |i| { area: item[:label], text: i } }
    }.uniq { |x| x[:text] }
  %>

  <% if all_strengths.any? %>
    <div style="margin-bottom: var(--rp-space-3);">
      <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #16a34a; margin: 0 0 var(--rp-space-2) 0;"><%= is_l1 ? "âœ… ì˜í•œ ì " : "ì£¼ìš” ê°•ì " %></h4>
      <div style="display: grid; grid-template-columns: 1fr <%= is_l1 ? '' : '1fr' %>; gap: 6px;">
        <% all_strengths.first(is_l1 ? 4 : 6).each do |s| %>
          <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); display: flex; align-items: flex-start; gap: 6px; padding: 6px 10px; background: #f0fdf4; border-radius: var(--rp-radius-sm);">
            <span style="color: #16a34a; flex-shrink: 0; font-weight: 600;">âœ“</span>
            <span><strong style="color: #166534;"><%= s[:area] %></strong> â€” <%= s[:text] %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if all_improvements.any? %>
    <div>
      <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #d97706; margin: 0 0 var(--rp-space-2) 0;"><%= is_l1 ? "ğŸ’¡ ë‹¤ìŒì— í•´ë³´ì" : level_config[:rec_title] %></h4>
      <div style="display: grid; grid-template-columns: 1fr <%= is_l1 ? '' : '1fr' %>; gap: 6px;">
        <% all_improvements.first(is_l1 ? 3 : 6).each do |imp| %>
          <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); display: flex; align-items: flex-start; gap: 6px; padding: 6px 10px; background: #fffbeb; border-radius: var(--rp-radius-sm);">
            <span style="color: #d97706; flex-shrink: 0; font-weight: 600;">â–³</span>
            <span><strong style="color: #92400e;"><%= imp[:area] %></strong> â€” <%= imp[:text] %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

</div><!-- /#student-report-section -->

<% if level_config[:show_radar] %>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë ˆì´ë” ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (L2-L4)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(function() {
  var radarData = <%= json_escape(radar_data.to_json) %>;

  function draw() {
    var svg = document.getElementById('sr-radar-svg');
    var legend = document.getElementById('sr-radar-legend');
    if (!svg || !radarData || radarData.length === 0) return;

    svg.innerHTML = '';

    var ns = 'http://www.w3.org/2000/svg';
    var cx = 230, cy = 195, radius = 150;
    var n = radarData.length;
    var levels = 5;
    var groupColors = {
      'ì´í•´ ì—­ëŸ‰': { fill: 'rgba(59,130,246,0.12)', stroke: '#3b82f6', dot: '#2563eb' },
      'ì‚¬ê³  ì—­ëŸ‰': { fill: 'rgba(139,92,246,0.12)', stroke: '#8b5cf6', dot: '#7c3aed' },
      'ì†Œí†µÂ·ì ìš© ì—­ëŸ‰': { fill: 'rgba(22,163,74,0.12)', stroke: '#16a34a', dot: '#15803d' }
    };

    function getPoint(index, value) {
      var angle = (Math.PI * 2 * index / n) - Math.PI / 2;
      var r = radius * (value / 100);
      return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
    }

    // Grid polygons
    for (var lvl = 1; lvl <= levels; lvl++) {
      var r = radius * lvl / levels;
      var pts = [];
      for (var i = 0; i < n; i++) {
        var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
        pts.push((cx + r * Math.cos(angle)) + ',' + (cy + r * Math.sin(angle)));
      }
      var polygon = document.createElementNS(ns, 'polygon');
      polygon.setAttribute('points', pts.join(' '));
      polygon.setAttribute('fill', lvl % 2 === 0 ? 'rgba(241,245,249,0.5)' : 'none');
      polygon.setAttribute('stroke', lvl === levels ? '#cbd5e1' : '#e2e8f0');
      polygon.setAttribute('stroke-width', lvl === levels ? '1.5' : '0.8');
      svg.appendChild(polygon);
      if (lvl % 2 === 0 || lvl === levels) {
        var pct = document.createElementNS(ns, 'text');
        pct.setAttribute('x', cx + 4); pct.setAttribute('y', cy - r + 12);
        pct.setAttribute('fill', '#94a3b8'); pct.setAttribute('font-size', '10');
        pct.textContent = (lvl * 20) + '';
        svg.appendChild(pct);
      }
    }

    // Axis lines & labels
    radarData.forEach(function(d, i) {
      var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
      var endX = cx + radius * Math.cos(angle);
      var endY = cy + radius * Math.sin(angle);
      var line = document.createElementNS(ns, 'line');
      line.setAttribute('x1', cx); line.setAttribute('y1', cy);
      line.setAttribute('x2', endX); line.setAttribute('y2', endY);
      line.setAttribute('stroke', '#e2e8f0'); line.setAttribute('stroke-width', '0.8');
      svg.appendChild(line);

      var labelR = radius + 28;
      var lx = cx + labelR * Math.cos(angle);
      var ly = cy + labelR * Math.sin(angle);
      var colors = groupColors[d.group] || { stroke: '#64748b' };

      var label = document.createElementNS(ns, 'text');
      label.setAttribute('x', lx); label.setAttribute('y', ly);
      label.setAttribute('text-anchor', 'middle'); label.setAttribute('dominant-baseline', 'middle');
      label.setAttribute('fill', colors.stroke); label.setAttribute('font-size', '11'); label.setAttribute('font-weight', '600');
      label.textContent = d.name;
      svg.appendChild(label);

      var scoreLabel = document.createElementNS(ns, 'text');
      scoreLabel.setAttribute('x', lx); scoreLabel.setAttribute('y', ly + 14);
      scoreLabel.setAttribute('text-anchor', 'middle'); scoreLabel.setAttribute('fill', '#94a3b8'); scoreLabel.setAttribute('font-size', '10');
      scoreLabel.textContent = d.score + 'ì ';
      svg.appendChild(scoreLabel);
    });

    // Data polygon
    var dataPoints = radarData.map(function(d, i) {
      var pt = getPoint(i, d.score);
      return pt.x + ',' + pt.y;
    });
    var dataPolygon = document.createElementNS(ns, 'polygon');
    dataPolygon.setAttribute('points', dataPoints.join(' '));
    dataPolygon.setAttribute('fill', 'rgba(99,102,241,0.12)');
    dataPolygon.setAttribute('stroke', '#6366f1');
    dataPolygon.setAttribute('stroke-width', '2.5');
    svg.appendChild(dataPolygon);

    // Data dots
    radarData.forEach(function(d, i) {
      var pt = getPoint(i, d.score);
      var colors = groupColors[d.group] || { dot: '#475569' };
      var dot = document.createElementNS(ns, 'circle');
      dot.setAttribute('cx', pt.x); dot.setAttribute('cy', pt.y); dot.setAttribute('r', '5');
      dot.setAttribute('fill', colors.dot); dot.setAttribute('stroke', 'white'); dot.setAttribute('stroke-width', '2');
      svg.appendChild(dot);
    });

    // Legend
    if (legend) {
      legend.innerHTML = '';
      ['ì´í•´ ì—­ëŸ‰', 'ì‚¬ê³  ì—­ëŸ‰', 'ì†Œí†µÂ·ì ìš© ì—­ëŸ‰'].forEach(function(group) {
        var colors = groupColors[group];
        var item = document.createElement('div');
        item.style.cssText = 'display:flex;align-items:center;gap:6px;font-size:16px;color:#475569;font-weight:500;';
        item.innerHTML = '<span style="width:10px;height:10px;border-radius:50%;background:' + colors.stroke + ';flex-shrink:0;"></span><span>' + group + '</span>';
        legend.appendChild(item);
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', draw);
  } else {
    draw();
  }
  document.addEventListener('turbo:load', draw);
})();
</script>
<% end %>

<!-- ë°˜ì‘í˜• -->
<style>
  @media (max-width: 768px) {
    #student-report-section div[style*="grid-template-columns: repeat(3"] {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    #student-report-section div[style*="grid-template-columns: 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
