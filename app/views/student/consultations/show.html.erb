<% content_for :page_title, @post.title %>

<div class="rp-consultation-detail">
  <!-- 헤더 -->
  <div class="rp-page-header">
    <div class="rp-page-header__breadcrumb">
      <%= link_to "상담 게시판", student_consultations_path, class: "rp-breadcrumb__link" %>
      <span class="rp-breadcrumb__separator">/</span>
      <span class="rp-breadcrumb__current">상세보기</span>
    </div>
  </div>

  <!-- 게시글 카드 -->
  <div class="rp-card">
    <div class="rp-card__header">
      <div class="rp-consultation-meta">
        <!-- 상태 배지 -->
        <% if @post.closed? %>
          <span class="rp-badge rp-badge--gray">마감</span>
        <% elsif @post.answered? %>
          <span class="rp-badge rp-badge--success">답변완료</span>
        <% else %>
          <span class="rp-badge rp-badge--warning">답변대기</span>
        <% end %>

        <!-- 카테고리 -->
        <span class="rp-badge rp-badge--outline"><%= @post.category_label %></span>

        <!-- 공개/비공개 -->
        <% if @post.private? %>
          <span class="rp-badge rp-badge--secondary">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            비공개
          </span>
        <% else %>
          <span class="rp-badge rp-badge--info">공개</span>
        <% end %>
      </div>

      <h1 class="rp-consultation-detail__title"><%= @post.title %></h1>

      <div class="rp-consultation-detail__info">
        <span><%= @post.student.name %></span>
        <span class="rp-separator">·</span>
        <span><%= l(@post.created_at, format: :long) %></span>
        <span class="rp-separator">·</span>
        <span>조회 <%= @post.views_count %></span>
      </div>
    </div>

    <div class="rp-card__body">
      <div class="rp-consultation-detail__content">
        <%= simple_format(@post.content) %>
      </div>
    </div>

    <div class="rp-card__footer">
      <div class="rp-consultation-detail__actions">
        <% if @post.created_by_id == current_user&.id %>
          <%= link_to "수정", edit_student_consultation_path(@post), class: "rp-btn rp-btn--secondary" %>
          <%= button_to "삭제", student_consultation_path(@post), method: :delete,
              data: { turbo_confirm: "정말 삭제하시겠습니까?" },
              class: "rp-btn rp-btn--danger" %>

          <% if @post.open? || @post.answered? %>
            <%= button_to "마감", close_student_consultation_path(@post), method: :patch,
                data: { turbo_confirm: "이 게시글을 마감하시겠습니까?" },
                class: "rp-btn rp-btn--secondary" %>
          <% elsif @post.closed? %>
            <%= button_to "다시 열기", reopen_student_consultation_path(@post), method: :patch,
                class: "rp-btn rp-btn--primary" %>
          <% end %>
        <% end %>

        <%= link_to "목록으로", student_consultations_path, class: "rp-btn rp-btn--outline" %>
      </div>
    </div>
  </div>

  <!-- 댓글 섹션 -->
  <div class="rp-comments-section">
    <h2 class="rp-comments-section__title">
      댓글 <%= @comments.count %>개
    </h2>

    <!-- 댓글 목록 -->
    <div class="rp-comments-list">
      <% if @comments.any? %>
        <% @comments.each do |comment| %>
          <div class="rp-comment <%= 'rp-comment--teacher' if comment.from_teacher? %>">
            <div class="rp-comment__header">
              <div class="rp-comment__author">
                <%= comment.created_by.name %>
                <% if comment.from_teacher? %>
                  <span class="rp-badge rp-badge--small rp-badge--primary">진단담당교사</span>
                <% end %>
              </div>
              <div class="rp-comment__meta">
                <%= time_ago_in_words(comment.created_at) %> 전
                <% if comment.created_by_id == current_user&.id %>
                  <%= button_to "삭제",
                      student_consultation_comment_path(@post, comment),
                      method: :delete,
                      data: { turbo_confirm: "댓글을 삭제하시겠습니까?" },
                      class: "rp-comment__delete" %>
                <% end %>
              </div>
            </div>
            <div class="rp-comment__content">
              <%= simple_format(comment.content) %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="rp-empty-state rp-empty-state--small">
          <p>아직 댓글이 없습니다.</p>
        </div>
      <% end %>
    </div>

    <!-- 댓글 작성 폼 -->
    <% if @post.can_reply?(current_user) && !@post.closed? %>
      <div class="rp-comment-form">
        <h3 class="rp-comment-form__title">댓글 작성</h3>
        <%= form_with model: @new_comment,
            url: student_consultation_comments_path(@post),
            class: "rp-form",
            local: true do |f| %>
          <div class="rp-form__group">
            <%= f.text_area :content,
                placeholder: "댓글을 입력하세요...",
                rows: 4,
                class: "rp-textarea",
                required: true %>
          </div>
          <div class="rp-form__actions">
            <%= f.submit "댓글 작성", class: "rp-btn rp-btn--primary" %>
          </div>
        <% end %>
      </div>
    <% elsif @post.closed? %>
      <div class="rp-alert rp-alert--info">
        마감된 게시글입니다. 댓글을 작성할 수 없습니다.
      </div>
    <% end %>
  </div>
</div>

<style>
  .rp-page-header__breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: var(--rp-font-size-base);
    margin-bottom: 16px;
  }

  .rp-breadcrumb__link {
    color: #2f5bff;
    text-decoration: none;
  }

  .rp-breadcrumb__link:hover {
    text-decoration: underline;
  }

  .rp-breadcrumb__separator {
    color: #cbd5e1;
  }

  .rp-breadcrumb__current {
    color: #475569;
  }

  .rp-consultation-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .rp-consultation-detail__title {
    font-size: var(--rp-font-size-3xl);
    font-weight: 700;
    color: #0f172a;
    margin: 0 0 12px 0;
    line-height: 1.3;
  }

  .rp-consultation-detail__info {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: var(--rp-font-size-sm);
    color: #94a3b8;
  }

  .rp-separator {
    color: #cbd5e1;
  }

  .rp-consultation-detail__content {
    font-size: var(--rp-font-size-base);
    line-height: 1.7;
    color: #475569;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .rp-consultation-detail__actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .rp-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: var(--rp-font-size-sm);
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .rp-btn--primary {
    background: #2f5bff;
    color: white;
  }

  .rp-btn--primary:hover {
    background: #1e4ae8;
  }

  .rp-btn--secondary {
    background: #ffffff;
    color: #475569;
    border-color: #e2e8f0;
  }

  .rp-btn--secondary:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }

  .rp-btn--danger {
    background: #ef4444;
    color: white;
  }

  .rp-btn--danger:hover {
    background: #dc2626;
  }

  .rp-btn--outline {
    background: transparent;
    color: #475569;
    border-color: #e2e8f0;
  }

  .rp-btn--outline:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }

  .rp-comments-section {
    margin-top: 32px;
  }

  .rp-comments-section__title {
    font-size: var(--rp-font-size-lg);
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 16px;
  }

  .rp-comments-list {
    margin-bottom: 24px;
  }

  .rp-comment {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }

  .rp-comment--teacher {
    background: #f0f4ff;
    border-color: #dee2ff;
  }

  .rp-comment__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .rp-comment__author {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: var(--rp-font-size-base);
    font-weight: 500;
    color: #0f172a;
  }

  .rp-comment__meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: var(--rp-font-size-xs);
    color: #94a3b8;
  }

  .rp-comment__delete {
    background: transparent;
    border: none;
    color: #ef4444;
    cursor: pointer;
    font-size: var(--rp-font-size-xs);
    padding: 0;
    text-decoration: underline;
  }

  .rp-comment__content {
    font-size: var(--rp-font-size-base);
    line-height: 1.6;
    color: #475569;
    white-space: pre-wrap;
  }

  .rp-comment-form {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
  }

  .rp-comment-form__title {
    font-size: var(--rp-font-size-base);
    font-weight: 600;
    color: #0f172a;
    margin: 0 0 12px 0;
  }

  .rp-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-family: inherit;
    font-size: var(--rp-font-size-base);
    color: #475569;
    resize: vertical;
  }

  .rp-textarea:focus {
    outline: none;
    border-color: #2f5bff;
    box-shadow: 0 0 0 3px rgba(47, 91, 255, 0.1);
  }

  .rp-form__actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .rp-empty-state--small {
    padding: 24px;
    text-align: center;
    font-size: var(--rp-font-size-base);
    color: #94a3b8;
  }

  .rp-alert {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: var(--rp-font-size-base);
  }

  .rp-alert--info {
    background: #e0f2fe;
    color: #0369a1;
    border: 1px solid #bae6fd;
  }

  .rp-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: var(--rp-font-size-xs);
    font-weight: 600;
  }

  .rp-badge--small {
    padding: 2px 6px;
    font-size: var(--rp-font-size-2xs);
  }

  .rp-badge--primary {
    background: #ede9fe;
    color: #4f46e5;
  }

  .rp-badge--success {
    background: #dcfce7;
    color: #15803d;
  }

  .rp-badge--warning {
    background: #fef3c7;
    color: #b45309;
  }

  .rp-badge--info {
    background: #e0f2fe;
    color: #0369a1;
  }

  .rp-badge--gray {
    background: #f1f5f9;
    color: #64748b;
  }

  .rp-badge--secondary {
    background: #f3e8ff;
    color: #7c3aed;
  }

  .rp-badge--outline {
    background: transparent;
    border: 1px solid #cbd5e1;
    color: #475569;
    padding: 3px 7px;
  }
</style>
