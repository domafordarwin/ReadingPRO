<% content_for :page_title, "ÏßÑÎã® ÏùëÏãú" %>

<div class="assessment-container"
     data-controller="module-assessment"
     data-module-assessment-attempt-id-value="<%= @attempt.id %>"
     data-module-assessment-time-limit-value="<%= (@diagnostic_form.time_limit_minutes || 60) * 60 %>"
     data-module-assessment-total-items-value="<%= @diagnostic_form_items.count %>"
     data-module-assessment-total-modules-value="<%= @modules.count %>">

  <!-- Top Header -->
  <div class="assessment-header">
    <div class="assessment-header__title">
      <h1><%= @diagnostic_form.name %></h1>
      <p><%= @diagnostic_form_items.count %>Í∞ú Î¨∏Ìï≠ ¬∑ <%= @modules.count %>Í∞ú Î™®Îìà</p>
    </div>

    <div class="assessment-header__controls">
      <!-- Timer -->
      <div class="timer-box">
        <div class="timer-box__icon">‚è±Ô∏è</div>
        <div class="timer-box__content">
          <div class="timer-box__time" data-module-assessment-target="timer">60:00</div>
          <div class="timer-box__label">ÎÇ®ÏùÄ ÏãúÍ∞Ñ</div>
        </div>
      </div>

      <!-- Auto-save Indicator -->
      <div class="autosave-indicator"
           data-module-assessment-target="autosaveIndicator"
           style="opacity: 0;">
        Ï†ÄÏû• Ï§ë...
      </div>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="assessment-progress">
    <div class="assessment-progress__info">
      <span class="assessment-progress__label" data-module-assessment-target="progressLabel">
        Î™®Îìà 1 / <%= @modules.count %> ¬∑ Î¨∏Ìï≠ 1 / <%= @diagnostic_form_items.count %>
      </span>
      <span class="assessment-progress__percent" data-module-assessment-target="progressPercent">0%</span>
    </div>
    <div class="assessment-progress__bar">
      <div class="assessment-progress__fill" data-module-assessment-target="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <!-- Main Content: Split Layout -->
  <div class="assessment-main">
    <!-- Left Panel: Stimulus (Reading Passage) -->
    <div class="assessment-left">
      <div class="stimulus-panel">
        <% @modules.each_with_index do |module_data, module_index| %>
          <div class="stimulus-content"
               data-module-assessment-target="stimulus"
               data-module-index="<%= module_index %>"
               <%= 'style=display:none;' if module_index > 0 %>>
            <% if module_data[:stimulus] %>
              <div class="stimulus-header">
                <div class="stimulus-badge">üìñ ÏßÄÎ¨∏</div>
                <h2 class="stimulus-title"><%= module_data[:stimulus].title %></h2>
              </div>
              <div class="stimulus-body">
                <%= simple_format(module_data[:stimulus].body) %>
              </div>
            <% else %>
              <div class="stimulus-header">
                <h2 class="stimulus-title">Î™®Îìà <%= module_index + 1 %></h2>
              </div>
              <div class="stimulus-empty">
                <p>Ïù¥ Î™®ÎìàÏóêÎäî ÏßÄÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Right Panel: Questions -->
    <div class="assessment-right">
      <div class="question-panel">
        <% item_global_index = 0 %>
        <% @modules.each_with_index do |module_data, module_index| %>
          <% module_data[:items].each_with_index do |item_data, item_index| %>
            <% item = item_data[:item] %>
            <% dfi = item_data[:diagnostic_form_item] %>
            <% response = item_data[:response] || @attempt.responses.find_or_initialize_by(item: item) %>

            <div class="question-card"
                 data-module-assessment-target="question"
                 data-module-index="<%= module_index %>"
                 data-item-index="<%= item_index %>"
                 data-global-index="<%= item_global_index %>"
                 data-item-id="<%= item.id %>"
                 data-item-type="<%= item.item_type %>"
                 <%= 'style=display:none;' if item_global_index > 0 %>>

              <!-- Question Header -->
              <div class="question-header">
                <div class="question-number">
                  Î¨∏Ìï≠ <%= dfi.position %> / <%= @diagnostic_form_items.count %>
                </div>
                <div class="question-badges">
                  <span class="question-badge question-badge--<%= item.item_type %>">
                    <%= item.item_type == "mcq" ? "Í∞ùÍ¥ÄÏãù" : "ÏÑúÏà†Ìòï" %>
                  </span>
                </div>
              </div>

              <!-- Question Prompt -->
              <div class="question-prompt">
                <%= sanitize_rich_text(item.prompt) %>
              </div>

              <!-- MCQ Choices -->
              <% if item.item_type == "mcq" %>
                <div class="question-choices">
                  <% item.item_choices.order(:choice_no).each_with_index do |choice, i| %>
                    <label class="choice-item">
                      <input type="radio"
                             name="response_<%= item.id %>"
                             value="<%= choice.id %>"
                             data-module-assessment-target="mcqChoice"
                             data-action="change->module-assessment#saveResponse"
                             data-item-id="<%= item.id %>"
                             <%= 'checked' if response.selected_choice_id == choice.id %>>
                      <span class="choice-number"><%= choice.choice_no %></span>
                      <span class="choice-content"><%= sanitize_choice_text(choice.content) %></span>
                    </label>
                  <% end %>
                </div>
              <% else %>
                <!-- Constructed Response -->
                <div class="question-answer">
                  <textarea class="answer-textarea"
                            data-module-assessment-target="constructedAnswer"
                            data-action="input->module-assessment#saveResponse"
                            data-item-id="<%= item.id %>"
                            placeholder="ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            rows="8"><%= response.answer_text %></textarea>
                </div>
              <% end %>

              <!-- Question Footer -->
              <div class="question-footer">
                <button class="flag-button <%= 'active' if response.flagged_for_review %>"
                        data-module-assessment-target="flagButton"
                        data-action="click->module-assessment#toggleFlag"
                        data-item-id="<%= item.id %>">
                  üö© ÎÇòÏ§ëÏóê Îã§Ïãú Î≥¥Í∏∞
                </button>
              </div>
            </div>

            <% item_global_index += 1 %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Navigation Footer -->
  <div class="assessment-footer">
    <button class="nav-btn nav-btn--secondary"
            data-module-assessment-target="prevButton"
            data-action="click->module-assessment#previousQuestion"
            disabled>
      ‚Üê Ïù¥Ï†Ñ Î¨∏Ìï≠
    </button>

    <button class="nav-btn nav-btn--primary"
            data-module-assessment-target="nextButton"
            data-action="click->module-assessment#nextQuestion">
      Îã§Ïùå Î¨∏Ìï≠ ‚Üí
    </button>

    <button class="nav-btn nav-btn--danger"
            data-module-assessment-target="submitButton"
            data-action="click->module-assessment#submitAttempt"
            style="display: none;">
      Ï†úÏ∂úÌïòÍ∏∞
    </button>
  </div>
</div>

<!-- Styles -->
<style>
  .assessment-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  .assessment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 32px;
    background: white;
    border-bottom: 2px solid #e5e7eb;
    flex-shrink: 0;
  }

  .assessment-header__title h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #111827;
  }

  .assessment-header__title p {
    margin: 4px 0 0 0;
    font-size: 13px;
    color: #6b7280;
  }

  .assessment-header__controls {
    display: flex;
    gap: 20px;
    align-items: center;
  }

  .timer-box {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
  }

  .timer-box__icon {
    font-size: 24px;
  }

  .timer-box__time {
    font-size: 20px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
  }

  .timer-box__label {
    font-size: 11px;
    opacity: 0.9;
  }

  .timer-box.warning {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  }

  .timer-box.danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }

  .autosave-indicator {
    font-size: 13px;
    color: #6b7280;
    transition: opacity 0.3s;
  }

  .autosave-indicator.saving {
    color: #fbbf24;
  }

  .autosave-indicator.saved {
    color: #10b981;
  }

  .assessment-progress {
    padding: 16px 32px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    flex-shrink: 0;
  }

  .assessment-progress__info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .assessment-progress__label {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
  }

  .assessment-progress__percent {
    font-size: 14px;
    font-weight: 700;
    color: #667eea;
  }

  .assessment-progress__bar {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
  }

  .assessment-progress__fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
  }

  .assessment-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    flex: 1;
    overflow: hidden;
  }

  .assessment-left,
  .assessment-right {
    overflow-y: auto;
    height: 100%;
  }

  .assessment-left {
    background: #f9fafb;
    border-right: 2px solid #e5e7eb;
  }

  .assessment-right {
    background: white;
  }

  .stimulus-panel {
    padding: 32px;
  }

  .stimulus-content {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .stimulus-header {
    margin-bottom: 24px;
  }

  .stimulus-badge {
    display: inline-block;
    padding: 6px 12px;
    background: #667eea;
    color: white;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 12px;
  }

  .stimulus-title {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .stimulus-body {
    line-height: 2;
    color: #374151;
    font-size: 16px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .stimulus-empty {
    padding: 40px;
    text-align: center;
    color: #9ca3af;
  }

  .question-panel {
    padding: 32px;
  }

  .question-card {
    animation: fadeIn 0.3s ease;
  }

  .question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e5e7eb;
  }

  .question-number {
    font-size: 14px;
    font-weight: 700;
    color: #6b7280;
  }

  .question-badges {
    display: flex;
    gap: 8px;
  }

  .question-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .question-badge--mcq {
    background: #dbeafe;
    color: #1e40af;
  }

  .question-badge--constructed {
    background: #e0e7ff;
    color: #5b21b6;
  }

  .question-prompt {
    font-size: 17px;
    font-weight: 600;
    line-height: 1.8;
    color: #111827;
    margin-bottom: 24px;
  }

  .question-choices {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
  }

  .choice-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .choice-item:hover {
    background: #f3f4f6;
    border-color: #667eea;
  }

  .choice-item:has(input:checked) {
    background: #eef2ff;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .choice-item input[type="radio"] {
    margin-top: 2px;
    cursor: pointer;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .choice-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: white;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
  }

  .choice-item:has(input:checked) .choice-number {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .choice-content {
    flex: 1;
    font-size: 15px;
    color: #374151;
    line-height: 1.6;
  }

  .question-answer {
    margin-bottom: 24px;
  }

  .answer-textarea {
    width: 100%;
    padding: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-family: inherit;
    font-size: 15px;
    line-height: 1.6;
    resize: vertical;
    transition: border-color 0.2s;
  }

  .answer-textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .question-footer {
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
  }

  .flag-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
  }

  .flag-button:hover {
    background: #f9fafb;
    border-color: #fbbf24;
    color: #f59e0b;
  }

  .flag-button.active {
    background: #fef3c7;
    border-color: #fbbf24;
    color: #f59e0b;
  }

  .assessment-footer {
    display: flex;
    gap: 16px;
    padding: 20px 32px;
    background: white;
    border-top: 2px solid #e5e7eb;
    flex-shrink: 0;
  }

  .nav-btn {
    flex: 1;
    padding: 14px 24px;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .nav-btn--secondary {
    background: #f3f4f6;
    color: #374151;
  }

  .nav-btn--secondary:hover:not(:disabled) {
    background: #e5e7eb;
  }

  .nav-btn--primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .nav-btn--primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .nav-btn--danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  }

  .nav-btn--danger:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .assessment-main {
      grid-template-columns: 1fr;
    }

    .assessment-left {
      border-right: none;
      border-bottom: 2px solid #e5e7eb;
      max-height: 40vh;
    }
  }

  @media (max-width: 768px) {
    .assessment-header {
      flex-direction: column;
      gap: 16px;
      align-items: flex-start;
    }

    .assessment-header__controls {
      width: 100%;
      justify-content: space-between;
    }

    .stimulus-panel,
    .question-panel {
      padding: 20px;
    }

    .assessment-footer {
      flex-direction: column;
    }
  }
</style>
