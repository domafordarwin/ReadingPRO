<% content_for :page_title, "진단 응시" %>

<div class="rp-assessment"
     data-controller="assessment"
     data-assessment-attempt-id-value="<%= @attempt.id %>"
     data-assessment-time-limit-value="<%= (@attempt.diagnostic_form.time_limit_minutes || 60) * 60 %>"
     data-assessment-total-questions-value="<%= @attempt.diagnostic_form.items.count %>">

  <!-- Header with Timer -->
  <div class="rp-assessment__header">
    <div class="rp-assessment__title-section">
      <h1 class="rp-assessment__title"><%= @attempt.diagnostic_form.name %></h1>
      <p class="rp-assessment__subtitle"><%= @attempt.diagnostic_form.items.count %>개 문항</p>
    </div>

    <div class="rp-assessment__controls">
      <div class="timer-section">
        <div class="timer" data-assessment-target="timer">60:00</div>
        <div class="timer-label">남은 시간</div>
      </div>

      <div class="autosave-indicator"
           data-assessment-target="autosaveIndicator"
           style="opacity: 0; transition: opacity 0.3s ease;">
        Saving...
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="rp-progress-section">
    <div class="progress-label" data-assessment-target="progress">
      Question 1 of <%= @attempt.diagnostic_form.items.count %>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
  </div>

  <!-- Questions Container -->
  <div class="rp-questions-container">
    <% @attempt.diagnostic_form.items.each_with_index do |item, index| %>
      <% response = @attempt.responses.find_or_initialize_by(item: item) %>
      <div class="rp-question"
           data-assessment-target="question"
           data-response-id="<%= response.id %>"
           data-item-type="<%= response.item.item_type %>"
           <%= 'hidden' if index > 0 %}>

        <!-- Question Number -->
        <div class="question-number">
          문항 <%= index + 1 %>
        </div>

        <!-- Stimulus (if any) -->
        <% if response.item.stimulus %>
          <div class="rp-stimulus">
            <div class="rp-stimulus__title">
              <%= response.item.stimulus.title %>
            </div>
            <div class="rp-stimulus__body">
              <%= simple_format(response.item.stimulus.body) %>
            </div>
          </div>
        <% end %>

        <!-- Question Prompt -->
        <div class="rp-question__prompt">
          <%= simple_format(response.item.prompt) %>
        </div>

        <!-- MCQ Choices -->
        <% if response.item.item_type == 'mcq' %>
          <div class="rp-choices">
            <% response.item.item_choices.each_with_index do |choice, i| %>
              <label class="rp-choice">
                <input type="radio"
                       name="response_<%= response.id %>"
                       value="<%= choice.id %>"
                       data-assessment-target="mcqChoice"
                       data-action="change->assessment#saveResponse"
                       <%= 'checked' if response.selected_choice_id == choice.id %>>
                <span class="choice-number"><%= i + 1 %></span>
                <span class="choice-content"><%= choice.content %></span>
              </label>
            <% end %>
          </div>
        <% else %>
          <!-- Constructed Response -->
          <div class="rp-constructed-response">
            <textarea class="rp-textarea"
                      data-assessment-target="constructedAnswer"
                      data-action="input->assessment#saveResponse"
                      placeholder="답변을 입력하세요"
                      rows="6"><%= response.answer_text %></textarea>
          </div>
        <% end %>

        <!-- Flag for Review Button -->
        <div class="rp-question__footer">
          <button class="rp-btn rp-btn--ghost rp-flag-button
                         <%= 'active' if response.flagged_for_review %>"
                  data-assessment-target="flagButton"
                  data-action="click->assessment#toggleFlag">
            <%= icon 'flag' %>
            복습하기 (F)
          </button>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Navigation Buttons -->
  <div class="rp-navigation">
    <button class="rp-btn rp-btn--secondary"
            data-action="click->assessment#previousQuestion">
      ← 이전
    </button>

    <button class="rp-btn rp-btn--primary"
            data-action="click->assessment#nextQuestion">
      다음 →
    </button>

    <!-- Submit Button - Form Submission -->
    <form action="<%= student_assessments_path %>"
          method="POST"
          class="rp-submit-form"
          style="display: inline;">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <%= hidden_field_tag :attempt_id, @attempt.id %>

      <button type="submit"
              class="rp-btn rp-btn--danger"
              data-assessment-target="submitButton"
              onclick="return confirm('진단을 제출하시겠습니까? 제출 후에는 답변을 수정할 수 없습니다.');">
        제출하기
      </button>
    </form>
  </div>
</div>

<!-- Styles -->
<style>
  .rp-assessment {
    max-width: 900px;
    margin: 0 auto;
    padding: var(--rp-space-6);
  }

  .rp-assessment__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--rp-space-6);
    padding-bottom: var(--rp-space-4);
    border-bottom: 1px solid var(--rp-border);
  }

  .rp-assessment__title-section {
    flex: 1;
  }

  .rp-assessment__title {
    font-size: var(--rp-font-size-2xl);
    font-weight: 700;
    margin: 0 0 var(--rp-space-1) 0;
  }

  .rp-assessment__subtitle {
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-muted);
    margin: 0;
  }

  .rp-assessment__controls {
    display: flex;
    gap: var(--rp-space-4);
    align-items: center;
  }

  .timer-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--rp-space-1);
  }

  .timer {
    font-size: 24px;
    font-weight: 700;
    color: var(--rp-text-title);
    font-family: 'Courier New', monospace;
    min-width: 80px;
    text-align: center;
  }

  .timer.text-success {
    color: var(--rp-success);
  }

  .timer.text-warning {
    color: var(--rp-warning);
  }

  .timer.text-danger {
    color: var(--rp-danger);
  }

  .timer-label {
    font-size: var(--rp-font-size-xs);
    color: var(--rp-text-muted);
  }

  .autosave-indicator {
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-muted);
    min-height: 20px;
    text-align: center;
  }

  .autosave-indicator.saving {
    color: var(--rp-warning);
  }

  .autosave-indicator.saved {
    color: var(--rp-success);
  }

  .autosave-indicator.error {
    color: var(--rp-danger);
  }

  .rp-progress-section {
    margin-bottom: var(--rp-space-6);
    background: var(--rp-bg-subtle);
    padding: var(--rp-space-4);
    border-radius: var(--rp-radius-md);
  }

  .progress-label {
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-muted);
    margin-bottom: var(--rp-space-2);
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--rp-border);
    border-radius: var(--rp-radius-full);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--rp-primary);
    width: 0%;
    transition: width 0.3s ease;
  }

  .rp-questions-container {
    margin-bottom: var(--rp-space-6);
  }

  .rp-question {
    background: white;
    border: 1px solid var(--rp-border);
    border-radius: var(--rp-radius-lg);
    padding: var(--rp-space-6);
    margin-bottom: var(--rp-space-4);
  }

  .rp-question.hidden {
    display: none;
  }

  .rp-question.flagged {
    border-left: 4px solid var(--rp-warning);
  }

  .question-number {
    font-size: var(--rp-font-size-sm);
    color: var(--rp-text-muted);
    font-weight: 600;
    margin-bottom: var(--rp-space-4);
  }

  .rp-stimulus {
    background: var(--rp-bg-subtle);
    border-left: 4px solid var(--rp-primary);
    border-radius: var(--rp-radius-md);
    padding: var(--rp-space-4);
    margin-bottom: var(--rp-space-4);
  }

  .rp-stimulus__title {
    font-weight: 600;
    margin-bottom: var(--rp-space-2);
    font-size: var(--rp-font-size-md);
  }

  .rp-stimulus__body {
    color: var(--rp-text-body);
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .rp-question__prompt {
    font-size: var(--rp-font-size-base);
    font-weight: 600;
    margin-bottom: var(--rp-space-4);
    line-height: 1.6;
  }

  .rp-choices {
    display: flex;
    flex-direction: column;
    gap: var(--rp-space-3);
    margin-bottom: var(--rp-space-4);
  }

  .rp-choice {
    display: flex;
    align-items: flex-start;
    gap: var(--rp-space-3);
    padding: var(--rp-space-3);
    border: 1px solid var(--rp-border);
    border-radius: var(--rp-radius-md);
    cursor: pointer;
    transition: all var(--rp-transition-fast);
  }

  .rp-choice:hover {
    background: var(--rp-bg-subtle);
    border-color: var(--rp-primary);
  }

  .rp-choice input[type="radio"] {
    margin-top: 2px;
    cursor: pointer;
  }

  .rp-choice input[type="radio"]:checked + .choice-number {
    color: var(--rp-primary);
    font-weight: 700;
  }

  .choice-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--rp-bg-subtle);
    border-radius: var(--rp-radius-sm);
    font-weight: 600;
    flex-shrink: 0;
  }

  .choice-content {
    flex: 1;
  }

  .rp-constructed-response {
    margin-bottom: var(--rp-space-4);
  }

  .rp-textarea {
    width: 100%;
    padding: var(--rp-space-3);
    border: 1px solid var(--rp-border);
    border-radius: var(--rp-radius-md);
    font-family: inherit;
    font-size: var(--rp-font-size-base);
    resize: vertical;
  }

  .rp-textarea:focus {
    outline: none;
    border-color: var(--rp-primary);
    box-shadow: 0 0 0 3px var(--rp-primary-soft);
  }

  .rp-question__footer {
    border-top: 1px solid var(--rp-border);
    padding-top: var(--rp-space-4);
    margin-top: var(--rp-space-4);
  }

  .rp-flag-button {
    display: flex;
    align-items: center;
    gap: var(--rp-space-2);
  }

  .rp-flag-button.active {
    background: var(--rp-warning-soft);
    color: var(--rp-warning);
    border-color: var(--rp-warning);
  }

  .rp-navigation {
    display: flex;
    justify-content: space-between;
    gap: var(--rp-space-4);
    padding-top: var(--rp-space-4);
    border-top: 1px solid var(--rp-border);
  }

  .rp-navigation .rp-btn {
    flex: 1;
  }

  .rp-submit-form {
    flex: 1;
  }

  .rp-submit-form .rp-btn {
    width: 100%;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .rp-assessment {
      padding: var(--rp-space-4);
    }

    .rp-assessment__header {
      flex-direction: column;
      gap: var(--rp-space-4);
    }

    .rp-assessment__controls {
      width: 100%;
      justify-content: space-between;
    }

    .rp-question {
      padding: var(--rp-space-4);
    }

    .rp-navigation {
      flex-direction: column;
    }

    .timer {
      font-size: 20px;
    }
  }
</style>
