<% content_for :page_title, "진단 응시" %>

<div class="rp-assessment">
  <!-- CSRF Token -->
  <input type="hidden" id="csrf-token" value="<%= form_authenticity_token %>">

  <!-- Header -->
  <div class="rp-assessment__header">
    <h1 class="rp-assessment__title"><%= @form&.title || "진단" %></h1>
    <p class="rp-assessment__subtitle"><%= @attempt_items&.count || 0 %>개 문항</p>
  </div>

  <!-- Progress Bar -->
  <div class="rp-progress">
    <div class="rp-progress__header">
      <p class="rp-progress__label">진행률</p>
      <div class="rp-progress__percentage"><span id="progress-percentage">0</span>%</div>
    </div>
    <div class="rp-progress__bar">
      <div class="rp-progress__fill" id="progress-fill"></div>
    </div>
  </div>

  <!-- Question Container -->
  <div id="question-container" class="rp-question-section"></div>

  <!-- Navigation -->
  <div class="rp-navigation">
    <button class="rp-btn rp-btn--secondary" id="prev-button" onclick="previousQuestion()">
      ← 이전
    </button>
    <div class="rp-navigation__counter">
      <span id="question-counter">1</span> / <span id="total-counter"><%= @attempt_items&.count || 0 %></span>
    </div>
    <div class="rp-navigation__buttons">
      <button class="rp-btn rp-btn--primary" id="next-button" onclick="nextQuestion()">
        다음 →
      </button>
    </div>
  </div>

  <!-- Question Navigation Grid -->
  <div class="rp-question-nav">
    <div class="rp-question-nav__label">문항 선택</div>
    <div class="rp-question-nav__grid" id="question-nav-items"></div>
  </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="rp-modal--assessment" id="submit-modal">
  <div class="rp-modal--assessment__content">
    <h2 class="rp-modal--assessment__title">진단 제출</h2>
    <p class="rp-modal--assessment__message">
      진단을 제출하시겠습니까?<br>
      제출 후에는 답변을 수정할 수 없습니다.
    </p>
    <div class="rp-modal--assessment__buttons">
      <button class="rp-btn rp-btn--secondary" onclick="closeSubmitModal()">취소</button>
      <button class="rp-btn rp-btn--primary" onclick="confirmSubmit()">제출</button>
    </div>
  </div>
</div>

<style>
  .rp-assessment {
    max-width: 900px;
    margin: 0 auto;
    padding: 24px;
  }

  .rp-assessment__header {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid #ddd;
  }

  .rp-assessment__title {
    font-size: 24px;
    font-weight: 700;
    margin: 0;
  }

  .rp-assessment__subtitle {
    font-size: 13px;
    color: #666;
    margin: 0;
  }

  .rp-progress {
    margin-bottom: 32px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 20px;
  }

  .rp-progress__header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .rp-progress__label {
    font-size: 12px;
    font-weight: 600;
    color: #999;
  }

  .rp-progress__percentage {
    font-size: 14px;
    font-weight: 700;
    color: #2f5bff;
  }

  .rp-progress__bar {
    width: 100%;
    height: 8px;
    background: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
  }

  .rp-progress__fill {
    height: 100%;
    background: #2f5bff;
    width: 0%;
    transition: width 0.3s ease;
  }

  .rp-question-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 32px;
  }

  .rp-stimulus {
    background: #f9f9f9;
    border-left: 4px solid #2f5bff;
    padding: 16px;
    margin-bottom: 24px;
    border-radius: 8px;
  }

  .rp-stimulus__label {
    font-size: 11px;
    font-weight: 700;
    color: #2f5bff;
    margin-bottom: 8px;
    text-transform: uppercase;
  }

  .rp-stimulus__text {
    font-size: 13px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .rp-question__number {
    font-size: 12px;
    font-weight: 600;
    color: #999;
    margin-bottom: 8px;
  }

  .rp-question__prompt {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .rp-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .rp-option {
    display: flex;
    padding: 16px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .rp-option:hover {
    border-color: #2f5bff;
    background: #f9f9ff;
  }

  .rp-option--selected {
    border-color: #2f5bff;
    background: rgba(47, 91, 255, 0.04);
  }

  .rp-option input[type="radio"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
  }

  .rp-option__label {
    font-weight: 600;
  }

  .rp-textarea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-family: inherit;
    font-size: 13px;
    line-height: 1.6;
    resize: vertical;
  }

  .rp-textarea:focus {
    outline: none;
    border-color: #2f5bff;
  }

  .rp-navigation {
    display: flex;
    justify-content: space-between;
    padding-top: 24px;
    border-top: 1px solid #ddd;
    gap: 16px;
  }

  .rp-question-nav {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid #ddd;
  }

  .rp-question-nav__label {
    font-size: 12px;
    font-weight: 700;
    color: #999;
    margin-bottom: 16px;
  }

  .rp-question-nav__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
    gap: 8px;
  }

  .rp-question-nav__item {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
  }

  .rp-question-nav__item--current {
    background: #2f5bff;
    color: white;
    border-color: #2f5bff;
  }

  .rp-modal--assessment {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .rp-modal--assessment.show {
    display: flex;
  }

  .rp-modal--assessment__content {
    background: white;
    border-radius: 12px;
    padding: 32px;
    max-width: 420px;
    text-align: center;
  }

  .rp-modal--assessment__title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .rp-modal--assessment__message {
    margin-bottom: 28px;
    line-height: 1.6;
  }

  .rp-modal--assessment__buttons {
    display: flex;
    gap: 12px;
  }

  .rp-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  }

  .rp-btn--primary {
    background: #2f5bff;
    color: white;
  }

  .rp-btn--secondary {
    background: #f0f0f0;
    color: #333;
  }
</style>

<script>
  // Parse assessment data from server
  const assessmentDataJson = <%= raw(@assessment_data) %>;
  const data = JSON.parse(assessmentDataJson);

  const attemptId = data.attemptId;
  const totalItems = data.totalItems;
  let attemptItems = data.attemptItems;
  let responses = data.responses;
  let currentIndex = 0;

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    if (totalItems > 0) {
      renderQuestion(0);
    } else {
      document.getElementById('question-container').innerHTML = '<p>문항이 없습니다.</p>';
    }
  });

  function renderQuestion(index) {
    if (index < 0 || index >= attemptItems.length) return;

    currentIndex = index;
    const attemptItem = attemptItems[index];
    const item = attemptItem.item;
    const response = responses[String(item.id)] || {};

    let html = '';

    // Stimulus
    if (item.stimulus && item.stimulus.body) {
      html += `<div class="rp-stimulus">
        <div class="rp-stimulus__label">지문</div>
        <div class="rp-stimulus__text">${escapeHtml(item.stimulus.body)}</div>
      </div>`;
    }

    // Question number and prompt
    html += `<div class="rp-question__number">문항 ${index + 1}</div>`;
    html += `<div class="rp-question__prompt">${escapeHtml(item.prompt)}</div>`;

    // Answer input
    if (item.item_type === 'mcq') {
      html += '<div class="rp-options">';
      item.item_choices.forEach(choice => {
        const isSelected = response.selected_choice_id === choice.id;
        html += `<label class="rp-option${isSelected ? ' rp-option--selected' : ''}">
          <input type="radio" name="answer" value="${choice.id}" ${isSelected ? 'checked' : ''}
            onchange="saveResponse(${item.id}, 'mcq', this.value)">
          <span class="rp-option__label">${choice.choice_no}. ${escapeHtml(choice.content)}</span>
        </label>`;
      });
      html += '</div>';
    } else if (item.item_type === 'constructed') {
      const answerText = response.answer_text || '';
      html += `<textarea class="rp-textarea" placeholder="여기에 답변을 입력하세요..."
        onchange="saveResponse(${item.id}, 'constructed', this.value)">${escapeHtml(answerText)}</textarea>`;
    }

    document.getElementById('question-container').innerHTML = html;
    document.getElementById('prev-button').disabled = index === 0;
    document.getElementById('next-button').innerHTML = index === attemptItems.length - 1 ? '제출 →' : '다음 →';
    document.getElementById('next-button').onclick = index === attemptItems.length - 1 ? openSubmitModal : nextQuestion;
    document.getElementById('question-counter').textContent = currentIndex + 1;

    updateProgressBar();
    updateQuestionNav();
  }

  function saveResponse(itemId, itemType, value) {
    const itemIdStr = String(itemId);
    if (itemType === 'mcq') {
      responses[itemIdStr] = { selected_choice_id: parseInt(value) };
      fetch('<%= submit_response_student_assessments_path %>', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.getElementById('csrf-token').value },
        body: JSON.stringify({ attempt_id: attemptId, item_id: itemId, item_type: itemType, selected_choice_id: parseInt(value) })
      }).catch(err => console.error('Error:', err));
    } else {
      responses[itemIdStr] = { answer_text: value };
      fetch('<%= submit_response_student_assessments_path %>', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.getElementById('csrf-token').value },
        body: JSON.stringify({ attempt_id: attemptId, item_id: itemId, item_type: itemType, answer_text: value })
      }).catch(err => console.error('Error:', err));
    }
  }

  function nextQuestion() {
    if (currentIndex < attemptItems.length - 1) {
      renderQuestion(currentIndex + 1);
    }
  }

  function previousQuestion() {
    if (currentIndex > 0) {
      renderQuestion(currentIndex - 1);
    }
  }

  function openSubmitModal() {
    document.getElementById('submit-modal').classList.add('show');
  }

  function closeSubmitModal() {
    document.getElementById('submit-modal').classList.remove('show');
  }

  function confirmSubmit() {
    fetch('<%= submit_attempt_student_assessments_path %>', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.getElementById('csrf-token').value },
      body: JSON.stringify({ attempt_id: attemptId })
    }).then(res => res.json()).then(data => {
      if (data.success) {
        window.location.href = data.redirect_url;
      }
    }).catch(err => alert('제출 중 오류가 발생했습니다.'));
  }

  function updateProgressBar() {
    const progress = ((currentIndex + 1) / attemptItems.length) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';
    document.getElementById('progress-percentage').textContent = Math.round(progress);
  }

  function updateQuestionNav() {
    const navGrid = document.getElementById('question-nav-items');
    navGrid.innerHTML = '';
    for (let i = 0; i < attemptItems.length; i++) {
      const btn = document.createElement('button');
      btn.className = 'rp-question-nav__item' + (i === currentIndex ? ' rp-question-nav__item--current' : '');
      btn.textContent = i + 1;
      btn.onclick = () => renderQuestion(i);
      navGrid.appendChild(btn);
    }
  }

  function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }
</script>
