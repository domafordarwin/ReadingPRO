<% content_for :portal_title do %>
  학생 관리
<% end %>
<% content_for :portal_subtitle do %>
  학생 등록 및 학급별 현황을 관리합니다.
<% end %>
<% content_for :portal_nav do %>
  <%= render "school_admin/shared/nav", current: :students %>
<% end %>

<% if flash[:temp_password].present? %>
  <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
    <h3 style="margin: 0 0 12px 0; color: #166534; font-size: 16px;">비밀번호가 초기화되었습니다</h3>
    <p style="margin: 0 0 8px 0; font-size: 14px; color: #166534;">
      <strong>학생:</strong> <%= flash[:reset_student_name] %>
    </p>
    <p style="margin: 0 0 12px 0; font-size: 14px; color: #166534;">
      <strong>임시 비밀번호:</strong>
      <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 16px; font-weight: 700; color: #dc2626;"><%= flash[:temp_password] %></code>
    </p>
    <p style="margin: 0; font-size: 12px; color: #15803d;">이 비밀번호를 학생에게 전달해주세요. 다음 로그인 시 비밀번호 변경이 필요합니다.</p>
  </div>
<% end %>

<section class="portal-card" style="margin-bottom: 24px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h2 class="portal-card-title" style="margin: 0;">학생 목록 (<%= @students.total_count %>명)</h2>
    <div style="display: flex; gap: 8px; align-items: center;">
      <%= link_to "학생 일괄 생성", new_school_admin_import_path,
            style: "padding: 8px 16px; background: #10b981; color: white; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none; white-space: nowrap;" %>
      <%= form_with url: school_admin_students_path, method: :get, local: true, data: { turbo: false }, style: "display: flex; gap: 8px;" do %>
        <input type="text" name="search" value="<%= @search_query %>" placeholder="학생 ID로 검색..."
               style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
        <button type="submit" style="padding: 8px 16px; background: #2f5bff; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">검색</button>
      <% end %>
    </div>
  </div>

  <% if @students.any? %>
    <table class="portal-table">
      <thead>
        <tr>
          <th>학생 ID</th>
          <th>학년</th>
          <th>반</th>
          <th>이메일</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody>
        <% @students.each do |student| %>
          <tr>
            <td><strong><%= student.name %></strong></td>
            <td><span class="rp-count-badge rp-count-badge--blue"><%= student.grade %>학년</span></td>
            <td><%= student.class_name %></td>
            <td style="font-size: 13px; color: #64748b;"><%= student.user&.email %></td>
            <td>
              <div class="rp-action-group">
                <%= link_to school_admin_edit_student_path(student), class: "rp-icon-btn rp-icon-btn--edit", title: "편집" do %>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                <% end %>
                <%= button_to school_admin_reset_student_password_path(student),
                    method: :patch,
                    data: { turbo: false, confirm: "#{student.name}의 비밀번호를 초기화하시겠습니까?" },
                    class: "rp-icon-btn rp-icon-btn--warning",
                    title: "비밀번호 초기화" do %>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                <% end %>
                <%= button_to school_admin_destroy_student_path(student),
                    method: :delete,
                    data: { turbo: false, confirm: "#{student.name} 학생을 삭제하시겠습니까?\n관련 진단 데이터도 함께 삭제됩니다." },
                    class: "rp-icon-btn rp-icon-btn--danger",
                    title: "삭제" do %>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <% if @students.total_pages > 1 %>
      <div style="margin-top: 16px; text-align: center;">
        <%= paginate @students %>
      </div>
    <% end %>
  <% else %>
    <div style="text-align: center; padding: 40px; color: #94a3b8;">
      <p>등록된 학생이 없습니다.</p>
    </div>
  <% end %>
</section>

<style>
  .rp-action-group { display: flex; gap: 6px; align-items: center; }
  .rp-icon-btn {
    display: inline-flex; align-items: center; justify-content: center;
    width: 32px; height: 32px; border-radius: 8px; border: none;
    cursor: pointer; transition: all 0.2s ease; text-decoration: none;
  }
  .rp-icon-btn svg { pointer-events: none; }
  .rp-icon-btn--edit { background: #eff6ff; color: #3b82f6; }
  .rp-icon-btn--edit:hover { background: #dbeafe; box-shadow: 0 2px 4px rgba(59,130,246,0.2); }
  .rp-icon-btn--warning { background: #fef3c7; color: #d97706; }
  .rp-icon-btn--warning:hover { background: #fde68a; box-shadow: 0 2px 4px rgba(217,119,6,0.2); }
  .rp-icon-btn--danger { background: #fef2f2; color: #dc2626; }
  .rp-icon-btn--danger:hover { background: #fee2e2; box-shadow: 0 2px 4px rgba(220,38,38,0.2); }
  .rp-count-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
  .rp-count-badge--blue { background: #dbeafe; color: #1e40af; }
</style>
