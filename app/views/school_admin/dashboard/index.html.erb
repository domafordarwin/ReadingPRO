<% content_for :page_title do %>학교 관리자 대시보드<% end %>

<!-- Page Header -->
<div class="rp-page-header">
  <div class="rp-flex rp-items-center rp-justify-between">
    <div>
      <h1 class="rp-page-header__title"><%= @school_name %> 대시보드</h1>
      <p class="rp-page-header__subtitle">학교 전체 진단 현황과 운영 지표를 확인하세요.</p>
    </div>
    <div class="rp-flex rp-gap-2">
      <a href="/school_admin/reports" class="rp-btn rp-btn--secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
        </svg>
        보고서 내보내기
      </a>
    </div>
  </div>
</div>

<!-- Stats Grid -->
<div class="rp-grid rp-grid--4 rp-stagger rp-mb-6">
  <div class="rp-stat">
    <div class="rp-stat__label">전체 학생</div>
    <div class="rp-stat__value"><%= @total_students %>명</div>
    <div class="rp-stat__trend"><%= @total_classes %>개 학급</div>
  </div>
  <div class="rp-stat">
    <div class="rp-stat__label">진단 참여율</div>
    <div class="rp-stat__value" style="color: var(--rp-success);"><%= @participation_rate %>%</div>
    <div class="rp-stat__trend rp-stat__trend--up"><%= @total_attempts %>건</div>
  </div>
  <div class="rp-stat">
    <div class="rp-stat__label">완료 리포트</div>
    <div class="rp-stat__value"><%= @completed_reports %>건</div>
    <div class="rp-stat__trend">완료됨</div>
  </div>
  <div class="rp-stat">
    <div class="rp-stat__label">대기 피드백</div>
    <div class="rp-stat__value" style="color: var(--rp-warning);"><%= @pending_feedback %>건</div>
    <div class="rp-stat__trend">검토 필요</div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="rp-grid rp-grid--2 rp-mb-6">
  <!-- Grade Summary -->
  <div class="rp-card">
    <div class="rp-card__header">
      <div>
        <h3 class="rp-card__title">학년별 진단 결과</h3>
        <p class="rp-card__subtitle">학년별 평균 점수 비교</p>
      </div>
    </div>
    <div class="rp-card__body">
      <% if @grade_scores.any? && @grade_scores.any? { |g| g[:score] > 0 } %>
        <div class="rp-chart-placeholder" style="height: 180px;">
          <div style="display: flex; gap: 24px; align-items: flex-end; height: 100%;">
            <% @grade_scores.each do |grade_data| %>
              <div style="text-align: center; flex: 1;">
                <% height_percent = grade_data[:score].zero? ? 5 : (grade_data[:score] / 100.0 * 100) %>
                <div class="rp-chart-bar" style="height: <%= height_percent %>%; width: 100%;"></div>
                <div style="margin-top: 8px; font-size: var(--rp-font-size-xs); color: var(--rp-text-muted);"><%= grade_data[:grade] %>학년</div>
                <div style="font-weight: var(--rp-font-weight-semibold); color: var(--rp-text-title);"><%= grade_data[:score] %>점</div>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="rp-empty-state-sm">
          <p>진단 결과 데이터가 없습니다.</p>
          <p class="rp-text-muted" style="font-size: var(--rp-font-size-xs);">학생들의 진단이 완료되면 학년별 평균 점수가 표시됩니다.</p>
        </div>
      <% end %>
    </div>
    <div class="rp-card__footer">
      <a href="/school_admin/reports" class="rp-btn rp-btn--secondary rp-btn--sm">
        상세 분석 보기
      </a>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="rp-card">
    <div class="rp-card__header">
      <h3 class="rp-card__title">최근 활동</h3>
    </div>
    <div class="rp-card__body">
      <% recent_attempts = StudentAttempt.includes(:student).order(created_at: :desc).limit(5) %>
      <% if recent_attempts.any? %>
        <div class="rp-table-wrapper">
          <table class="rp-table">
            <tbody>
              <% recent_attempts.each do |attempt| %>
                <tr>
                  <td>
                    <strong><%= attempt.student&.name || '학생' %></strong>
                    <div class="rp-text-muted" style="font-size: var(--rp-font-size-xs);">
                      <%= attempt.status == 'completed' ? '진단 완료' : '진단 진행중' %>
                    </div>
                  </td>
                  <td class="rp-text-right">
                    <span class="rp-badge rp-badge--<%= attempt.status == 'completed' ? 'success' : 'warning' %>">
                      <%= time_ago_in_words(attempt.created_at) %> 전
                    </span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="rp-empty-state-sm">
          <p>최근 활동이 없습니다.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Class Status Table -->
<div class="rp-card">
  <div class="rp-card__header">
    <div>
      <h3 class="rp-card__title">학급별 진단 현황</h3>
      <p class="rp-card__subtitle">각 학급의 진단 참여 현황을 확인합니다.</p>
    </div>
    <a href="/school_admin/diagnostics" class="rp-btn rp-btn--primary rp-btn--sm">
      진단 배포
    </a>
  </div>
  <div class="rp-card__body">
    <% class_stats = Student.group(:grade, :class_name).count %>
    <% if class_stats.any? %>
      <div class="rp-table-wrapper">
        <table class="rp-table">
          <thead>
            <tr>
              <th>학급</th>
              <th>학생수</th>
              <th>참여율</th>
              <th>상태</th>
            </tr>
          </thead>
          <tbody>
            <% class_stats.each do |(grade, class_name), count| %>
              <% next if grade.nil? || class_name.nil? %>
              <%
                student_ids = Student.where(grade: grade, class_name: class_name).pluck(:id)
                attempts_count = StudentAttempt.where(student_id: student_ids).count
                participation = count.zero? ? 0 : ((attempts_count.to_f / count) * 100).round(0)
              %>
              <tr>
                <td><strong><%= grade %>학년 <%= class_name %></strong></td>
                <td><%= count %>명</td>
                <td><%= participation %>%</td>
                <td>
                  <% if participation >= 80 %>
                    <span class="rp-badge rp-badge--success">완료</span>
                  <% elsif participation > 0 %>
                    <span class="rp-badge rp-badge--warning">진행중</span>
                  <% else %>
                    <span class="rp-badge rp-badge--draft">대기</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="rp-empty-state-sm">
        <p>등록된 학급이 없습니다.</p>
        <p class="rp-text-muted" style="font-size: var(--rp-font-size-xs);">학생을 등록하면 학급별 현황이 표시됩니다.</p>
      </div>
    <% end %>
  </div>
</div>

<style>
  .rp-empty-state-sm {
    text-align: center;
    padding: 40px 20px;
  }

  .rp-empty-state-sm p {
    font-size: var(--rp-font-size-base);
    color: #94a3b8;
    margin: 0;
  }
</style>
