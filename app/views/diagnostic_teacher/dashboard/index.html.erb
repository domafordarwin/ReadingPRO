<% content_for :page_title do %>진단 담당 교사 대시보드<% end %>

<!-- Page Header -->
<div class="rp-page-header">
  <div class="rp-flex rp-items-center rp-justify-between">
    <div>
      <h1 class="rp-page-header__title">진단 담당 교사 대시보드</h1>
      <p class="rp-page-header__subtitle">진단 현황과 피드백 작업을 관리하세요.</p>
    </div>
    <div class="rp-flex rp-gap-2">
      <a href="/diagnostic_teacher/diagnostics" class="rp-btn rp-btn--primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        진단 배포하기
      </a>
      <a href="/diagnostic_teacher/reports" class="rp-btn rp-btn--secondary">
        보고서 생성
      </a>
    </div>
  </div>
</div>

<!-- Stats Grid -->
<div class="rp-grid rp-grid--4 rp-stagger rp-mb-6">
  <div class="rp-stat">
    <div class="rp-stat__label">전체 진단</div>
    <div class="rp-stat__value" style="color: var(--rp-primary);"><%= @total_diagnoses %>건</div>
    <div class="rp-stat__trend">학급 전체</div>
  </div>
  <div class="rp-stat">
    <div class="rp-stat__label">진단 진행중</div>
    <div class="rp-stat__value"><%= @pending_diagnoses %>건</div>
    <div class="rp-stat__trend">응시 중</div>
  </div>
  <div class="rp-stat">
    <div class="rp-stat__label">피드백 완료</div>
    <div class="rp-stat__value" style="color: var(--rp-success);"><%= @completed_feedback %>건</div>
    <div class="rp-stat__trend rp-stat__trend--up">작업 완료</div>
  </div>
  <div class="rp-stat">
    <div class="rp-stat__label">피드백 대기</div>
    <div class="rp-stat__value" style="color: var(--rp-warning);"><%= @pending_feedback %>건</div>
    <div class="rp-stat__trend">검토 필요</div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="rp-grid rp-grid--2 rp-mb-6">
  <!-- Pending Diagnosis -->
  <div class="rp-card">
    <div class="rp-card__header">
      <div>
        <h3 class="rp-card__title">진단 대기 목록</h3>
        <p class="rp-card__subtitle">학생별 진단 완료 대기 현황</p>
      </div>
      <span class="rp-badge rp-badge--warning"><%= @pending_diagnoses %>건</span>
    </div>
    <div class="rp-card__body">
      <div class="rp-table-wrapper">
        <table class="rp-table">
          <thead>
            <tr>
              <th>학생</th>
              <th>진단명</th>
              <th>시작일</th>
              <th>상태</th>
            </tr>
          </thead>
          <tbody>
            <% pending_statuses = @student_statuses.select { |s| s[:status] != '완료' }.first(5) %>
            <% if pending_statuses.any? %>
              <% pending_statuses.each do |status| %>
                <tr>
                  <td><strong><%= status[:student].name %></strong></td>
                  <td>진단 평가</td>
                  <td><%= status[:attempt].started_at&.strftime("%m/%d") || '-' %></td>
                  <td>
                    <% badge_class = status[:status] == '진행중' ? 'rp-badge--warning' : 'rp-badge--draft' %>
                    <span class="rp-badge <%= badge_class %>"><%= status[:status] %></span>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" style="text-align: center; color: #999; padding: 24px;">대기 중인 진단이 없습니다.</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
    <div class="rp-card__footer">
      <a href="/diagnostic_teacher/diagnostics" class="rp-btn rp-btn--secondary rp-btn--sm">
        전체 보기
      </a>
    </div>
  </div>

  <!-- Feedback Status -->
  <div class="rp-card">
    <div class="rp-card__header">
      <h3 class="rp-card__title">피드백 현황</h3>
      <span class="rp-badge rp-badge--<%= @pending_feedback > 0 ? 'danger' : 'success' %>"><%= @pending_feedback > 0 ? "#{@pending_feedback}건 대기" : '모두 완료' %></span>
    </div>
    <div class="rp-card__body">
      <% feedback_waiting = @student_statuses.select { |s| s[:status] == '피드백 대기' } %>
      <% if feedback_waiting.any? || @completed_feedback > 0 %>
        <div class="rp-table-wrapper">
          <table class="rp-table">
            <tbody>
              <% if feedback_waiting.any? %>
                <tr>
                  <td>
                    <strong>서술형 피드백</strong>
                    <div class="rp-text-muted" style="font-size: 12px;"><%= feedback_waiting.count %>건 대기</div>
                  </td>
                  <td class="rp-text-right">
                    <span class="rp-badge rp-badge--warning">대기</span>
                  </td>
                </tr>
              <% end %>
              <% if @completed_feedback > 0 %>
                <tr>
                  <td>
                    <strong>피드백 완료</strong>
                    <div class="rp-text-muted" style="font-size: 12px;"><%= @completed_feedback %>건 완료</div>
                  </td>
                  <td class="rp-text-right">
                    <span class="rp-badge rp-badge--success">완료</span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div style="text-align: center; color: #999; padding: 24px;">
          피드백 데이터가 없습니다.
        </div>
      <% end %>
    </div>
    <div class="rp-card__footer">
      <a href="/diagnostic_teacher/feedbacks" class="rp-btn rp-btn--primary rp-btn--sm">
        피드백 작성하기
      </a>
    </div>
  </div>
</div>

<!-- Student Status Table -->
<div class="rp-card">
  <div class="rp-card__header">
    <div>
      <h3 class="rp-card__title">학생별 응시 현황</h3>
      <p class="rp-card__subtitle">담당 학급의 진단 참여 현황을 확인합니다.</p>
    </div>
  </div>
  <div class="rp-card__body">
    <div class="rp-table-wrapper">
      <table class="rp-table">
        <thead>
          <tr>
            <th>학생 ID</th>
            <th>학년</th>
            <th>진단명</th>
            <th>시작일</th>
            <th>완료율</th>
            <th>상태</th>
            <th>액션</th>
          </tr>
        </thead>
        <tbody>
          <% if @student_statuses.any? %>
            <% @student_statuses.each do |status| %>
              <% student = status[:student] %>
              <% attempt = status[:attempt] %>
              <% completion_rate = status[:completion_rate] %>
              <% attempt_status = status[:status] %>
              <tr>
                <td><strong><%= student.name %></strong></td>
                <td><%= student.grade %>학년</td>
                <td>진단 평가</td>
                <td><%= attempt.started_at&.strftime("%m/%d") %></td>
                <td><%= completion_rate %>%</td>
                <td>
                  <% badge_class = case attempt_status
                    when '진행중'
                      'rp-badge--warning'
                    when '피드백 대기'
                      'rp-badge--review'
                    else
                      'rp-badge--success'
                    end %>
                  <span class="rp-badge <%= badge_class %>"><%= attempt_status %></span>
                </td>
                <td>
                  <a href="<%= diagnostic_teacher_show_student_report_path(student.id, attempt_id: attempt.id) %>" class="rp-btn rp-btn--ghost rp-btn--sm">상세</a>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="7" style="text-align: center; color: #999; padding: 24px;">진행된 진단이 없습니다.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
