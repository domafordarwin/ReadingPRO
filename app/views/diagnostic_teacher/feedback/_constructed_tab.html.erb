<div class="rp-tab-pane" data-tab="constructed">
  <% if @constructed_responses.any? %>
    <div class="rp-constructed-header">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
        서술형 문항 피드백
        <span style="font-size: 13px; font-weight: 400; color: #64748b; margin-left: 8px;">
          (<%= @constructed_responses.count %>개 문항)
        </span>
      </h2>
    </div>

    <div class="rp-constructed-feedback-container">
      <!-- 왼쪽: 문항 내용 및 채점 기준 -->
      <div class="rp-constructed-left-panel">
        <div class="rp-constructed-prompt-section">
          <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #0f172a;">문항 내용</h3>

          <% @constructed_responses.first&.item&.tap do |item| %>
            <div class="rp-prompt-display" style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #e2e8f0;">
              <div class="rp-prompt-text" style="font-size: 13px; line-height: 1.6; color: #1e293b; white-space: pre-wrap;">
                <%= item.prompt %>
              </div>
            </div>

            <% if item.stimulus.present? %>
              <div class="rp-stimulus-section" style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 3px solid #0ea5e9;">
                <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #0284c7;">지문</h4>
                <div class="rp-stimulus-text" style="font-size: 12px; line-height: 1.6; color: #1e293b; white-space: pre-wrap;">
                  <%= item.stimulus.content %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>

        <div class="rp-constructed-rubric-section">
          <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #0f172a;">채점 기준</h3>

          <% @constructed_responses.first&.item&.rubric&.rubric_criteria&.each do |criterion| %>
            <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #f8fafc;">
              <div style="font-weight: 600; color: #0f172a; font-size: 12px; margin-bottom: 8px;">
                <%= criterion.name %>
              </div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
                <% criterion.rubric_levels.sort_by(&:point).each do |level| %>
                  <div style="padding: 6px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-size: 11px;">
                    <div style="font-weight: 600; color: #2f5bff;">
                      <%= level.point %>점
                    </div>
                    <div style="color: #64748b; margin-top: 2px; line-height: 1.3;">
                      <%= truncate(level.description, length: 30) %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 오른쪽: 상하 이분할 (답안 표시 + 피드백) -->
      <div class="rp-constructed-right-panel">
        <!-- 상단: 답안 탭 및 답안 표시 -->
        <div class="rp-constructed-answers-section">
          <div class="rp-constructed-answer-tabs">
            <% @constructed_responses.each_with_index do |response, idx| %>
              <button class="rp-answer-tab-button <%= 'active' if idx == 0 %>" data-answer-id="<%= response.id %>">
                문항 <%= idx + 1 %>
              </button>
            <% end %>
          </div>

          <div class="rp-answer-display-area" style="padding: 16px;">
            <% @constructed_responses.first&.tap do |response| %>
              <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #0f172a;">학생 답변</h4>

              <div style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 12px;">
                <div style="font-size: 12px; line-height: 1.6; color: #1e293b; white-space: pre-wrap; min-height: 60px;">
                  <%= response.answer_text || "(답변 없음)" %>
                </div>
              </div>

              <h4 style="margin: 12px 0 8px 0; font-size: 13px; font-weight: 600; color: #0f172a;">채점 결과</h4>

              <div class="rp-rubric-scores-display" style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 3px solid #0ea5e9;">
                <% response.response_rubric_scores.each do |score| %>
                  <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 8px 0; border-bottom: 1px solid #e0f2fe;">
                    <div style="font-size: 12px; color: #1e293b; font-weight: 600;">
                      <%= score.rubric_criterion.name %>
                    </div>
                    <div style="font-size: 12px; font-weight: 700; color: #2f5bff;">
                      <%= score.level %> / <%= score.rubric_criterion.rubric_levels.maximum(:point) %>
                    </div>
                  </div>
                <% end %>

                <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 12px 0; margin-top: 8px; font-weight: 700; border-top: 2px solid #0ea5e9;">
                  <div style="font-size: 13px; color: #0f172a;">총점</div>
                  <div style="font-size: 14px; color: #2f5bff;">
                    <%= response.response_rubric_scores.sum(&:level) %> 점
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- 하단: 피드백 섹션 -->
        <div class="rp-constructed-feedback-section" style="display: grid; grid-template-rows: auto 1fr auto; gap: 12px; padding: 16px;">
          <h3 style="margin: 0; font-size: 13px; font-weight: 600; color: #0f172a;">피드백</h3>

          <div class="rp-feedback-display" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; min-height: 100px; overflow-y: auto;">
            <p style="color: #94a3b8; font-size: 12px; margin: 0;">
              피드백이 아직 생성되지 않았습니다. 버튼을 클릭하여 생성하세요.
            </p>
          </div>

          <div style="display: flex; gap: 8px;">
            <button class="rp-btn rp-btn--primary" style="flex: 1; font-size: 12px;">
              AI 피드백 생성
            </button>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="rp-empty-state">
      <p>이 학생의 서술형 문항 응답이 없습니다.</p>
    </div>
  <% end %>
</div>
