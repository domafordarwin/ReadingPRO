<div class="rp-tab-pane active" data-tab="mcq">
  <!-- 상단: 응답 현황 -->
  <div class="rp-overview-section">
    <h2 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
      객관식 응답 현황
      <span style="font-size: 13px; font-weight: 400; color: #64748b; margin-left: 8px;">
        <% if @responses.any? %>
          (<span id="correct-count">0</span>/<%= @responses.count %> 정답)
        <% else %>
          (0/0 정답)
        <% end %>
      </span>
    </h2>

    <% if @responses.any? %>
      <!-- 정답과 학생답 요약 테이블 -->
      <div style="margin-bottom: 16px; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed;">
          <tbody>
            <!-- 문항번호 행 -->
            <tr>
              <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: center; width: 60px;">문항</th>
              <% @responses.each_with_index do |response, index| %>
                <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: center;">
                  <%= index + 1 %>
                </th>
              <% end %>
            </tr>

            <!-- 정답 행 -->
            <tr>
              <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: left;">정답</th>
              <% @responses.each_with_index do |response, index| %>
                <% correct_choice = response&.item&.item_choices&.find(&:is_correct) %>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; background: #f0f9ff; color: #0284c7; font-weight: 600;">
                  <%= correct_choice&.choice_no || '—' %>
                </td>
              <% end %>
            </tr>

            <!-- 학생답 행 -->
            <tr>
              <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: left;">학생답</th>
              <% @responses.each_with_index do |response, index| %>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; background: #f5f5f5; color: #475569;">
                  <%= response.selected_choice&.choice_no || '—' %>
                </td>
              <% end %>
            </tr>

            <!-- 수정답 행 -->
            <tr>
              <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: left;">수정답</th>
              <% @responses.each_with_index do |response, index| %>
                <td style="padding: 4px; border: 1px solid #cbd5e1; text-align: center;">
                  <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                    <input type="number"
                           class="rp-edit-answer-input"
                           data-response-id="<%= response.id %>"
                           data-item-index="<%= index %>"
                           min="1"
                           max="5"
                           style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-family: monospace; box-sizing: border-box;">
                    <button class="rp-btn rp-btn--primary rp-btn--xs"
                            data-response-id="<%= response.id %>"
                            style="font-size: 11px; padding: 2px 6px; min-width: 40px;">저장</button>
                  </div>
                </td>
              <% end %>
            </tr>
          </tbody>
        </table>
      </div>
    <% else %>
      <div style="padding: 24px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-align: center; color: #64748b;">
        <p style="margin: 0; font-size: 14px;">객관식 응답 데이터가 없습니다.</p>
      </div>
    <% end %>
  </div>

    <% if @responses.any? %>
    <!-- 수평선 -->
    <div style="height: 1px; background: #e2e8f0; margin: 32px 0;"></div>

    <!-- 하단: 통합 피드백 섹션 (좌우 분할) -->
    <div style="margin-top: 32px;">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
        종합 분석 및 피드백
      </h2>

      <div class="rp-comprehensive-feedback-container" data-student-id="<%= @student.id %>">
        <!-- 왼쪽: 피드백 영역 -->
        <div class="rp-feedback-column">
          <div class="rp-feedback-section">
            <div class="rp-section-header">
              <h4><%= @responses.count %>개 문항 종합 피드백</h4>
              <button class="rp-btn rp-btn--primary" id="generate-comprehensive-feedback"<% unless @responses.any? %> disabled<% end %>>
                AI 종합 피드백 생성
              </button>
            </div>

            <!-- 피드백 표시 -->
            <div class="rp-feedback-display" id="comprehensive-feedback-display">
              <% if @comprehensive_feedback.present? %>
                <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                  <%= simple_format(@comprehensive_feedback) %>
                </div>
              <% else %>
                <p style="color: #94a3b8; font-size: 13px;">아직 생성된 피드백이 없습니다. 오른쪽의 버튼을 클릭하여 AI 종합 피드백을 생성하세요.</p>
              <% end %>
            </div>

            <!-- 피드백 액션 버튼 -->
            <div class="rp-feedback-actions" id="comprehensive-feedback-actions" style="display: none; margin-top: 12px; display: flex; gap: 8px;">
              <button class="rp-btn rp-btn--secondary rp-btn--sm" id="edit-comprehensive-feedback">수정</button>
              <button class="rp-btn rp-btn--success rp-btn--sm" id="save-feedback-display">저장</button>
            </div>

            <!-- 피드백 편집 -->
            <div class="rp-feedback-edit" style="display: none;">
              <textarea class="rp-feedback-textarea" id="comprehensive-feedback-textarea" rows="10" placeholder="종합 피드백을 입력하세요..."></textarea>
              <div class="rp-edit-actions">
                <button class="rp-btn rp-btn--primary rp-btn--sm" id="save-comprehensive-feedback">저장</button>
                <button class="rp-btn rp-btn--secondary rp-btn--sm" id="cancel-comprehensive-feedback">취소</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 오른쪽: 프롬프트 관리 영역 -->
        <div class="rp-prompt-column">
          <div class="rp-feedback-section rp-prompt-section">
            <h4>커스텀 프롬프트</h4>

            <div class="rp-prompt-controls">
              <div class="rp-form-group">
                <label for="comprehensive-category">카테고리</label>
                <select id="comprehensive-category" class="rp-prompt-category">
                  <option value="general">일반</option>
                  <option value="comprehension">이해력</option>
                  <option value="explanation">설명</option>
                  <option value="difficulty">난이도</option>
                  <option value="strategy">전략</option>
                </select>
              </div>

              <div class="rp-form-group">
                <label for="comprehensive-prompt">커스텀 프롬프트</label>
                <textarea id="comprehensive-prompt" class="rp-prompt-input" rows="6"
                          placeholder="예: 학생의 약점 분석과 개선 방안을 포함한 피드백을 만들어주세요"></textarea>
              </div>

              <div class="rp-form-group">
                <label class="rp-checkbox">
                  <input type="checkbox" id="comprehensive-save-template">
                  <span>템플릿으로 저장</span>
                </label>
              </div>

              <!-- 버튼 그룹 -->
              <div class="rp-button-group">
                <button class="rp-btn rp-btn--secondary" id="refine-comprehensive-feedback" style="flex: 1;">
                  프롬프트 최적화
                </button>
                <button class="rp-btn rp-btn--success" id="apply-custom-prompt" style="flex: 1;">
                  피드백 생성
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>
</div>
