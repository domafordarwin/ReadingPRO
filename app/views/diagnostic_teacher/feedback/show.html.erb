<% content_for :page_title, "í•™ìƒ í”¼ë“œë°±" %>

<div class="rp-page-header">
  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
    <%= link_to "â† ëŒì•„ê°€ê¸°", diagnostic_teacher_feedbacks_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
  </div>
  <h1 class="rp-page-header__title"><%= @student.name %>ì˜ ê°ê´€ì‹ í”¼ë“œë°±</h1>
  <p class="rp-page-header__subtitle">18ê°œ ë¬¸í•­ ì¢…í•© ë¶„ì„ (ì •ë‹µ/ì˜¤ë‹µ/ì ìˆ˜)</p>
</div>

<% if @responses.any? %>
  <!-- ===== ìƒë‹¨: ì „ì²´ ë¬¸í•­ í•œëˆˆì— ë³´ê¸° í…Œì´ë¸” ===== -->
  <div class="rp-overview-section">
    <h2 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
      ê°ê´€ì‹ ì‘ë‹µ í˜„í™©
      <span style="font-size: 13px; font-weight: 400; color: #64748b; margin-left: 8px;">
        (<span id="correct-count">0</span>/18 ì •ë‹µ)
      </span>
    </h2>

    <div class="rp-table-wrapper">
      <table class="rp-overview-table">
        <thead>
          <tr>
            <th>ë¬¸í•­</th>
            <th>ì •ë‹µ</th>
            <th>í•™ìƒë‹µ</th>
            <th>ì ìˆ˜</th>
          </tr>
        </thead>
        <tbody>
          <% @responses.each_with_index do |response, index| %>
            <tr class="rp-table-row" data-response-id="<%= response.id %>">
              <!-- ë¬¸í•­ë²ˆí˜¸ -->
              <td class="rp-table-cell rp-table-cell--question">
                <strong><%= index + 1 %></strong>
              </td>

              <!-- ì •ë‹µ -->
              <td class="rp-table-cell rp-table-cell--correct">
                <% correct_choice = response.item.item_choices.find { |c| c.choice_score&.is_key } %>
                <% if correct_choice %>
                  <span class="rp-choice-badge rp-choice-badge--correct">
                    <%= correct_choice.choice_letter %>
                  </span>
                  <span class="rp-choice-label"><%= correct_choice.choice_text.truncate(30) %></span>
                <% end %>
              </td>

              <!-- í•™ìƒë‹µ (í´ë¦­ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥) -->
              <td class="rp-table-cell rp-table-cell--student">
                <div class="rp-student-answer" data-response-id="<%= response.id %>" data-item-id="<%= response.item.id %>">
                  <% if response.selected_choice %>
                    <span class="rp-choice-badge rp-choice-badge--student">
                      <%= response.selected_choice.choice_letter %>
                    </span>
                    <span class="rp-choice-label rp-answer-clickable">
                      <%= response.selected_choice.choice_text.truncate(30) %>
                    </span>
                  <% else %>
                    <span class="rp-no-answer">ë¯¸ì‘ë‹µ</span>
                  <% end %>
                </div>

                <!-- ìˆ˜ì • ëª¨ë“œ (ìˆ¨ê¹€) -->
                <div class="rp-answer-edit-mode" style="display: none; width: 100%;">
                  <select class="rp-answer-select" style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                    <option value="">-- ì„ íƒ --</option>
                    <% response.item.item_choices.each do |choice| %>
                      <option value="<%= choice.id %>" <%= 'selected' if choice.id == response.selected_choice_id %>>
                        <%= choice.choice_letter %>. <%= choice.choice_text %>
                      </option>
                    <% end %>
                  </select>
                  <div style="display: flex; gap: 4px; margin-top: 6px;">
                    <button class="rp-btn rp-btn--primary rp-btn--xs" data-action="save-answer">ì €ì¥</button>
                    <button class="rp-btn rp-btn--secondary rp-btn--xs" data-action="cancel-answer">ì·¨ì†Œ</button>
                  </div>
                </div>
              </td>

              <!-- ì ìˆ˜ -->
              <td class="rp-table-cell rp-table-cell--score">
                <% if response.selected_choice %>
                  <% is_correct = response.selected_choice.choice_score&.is_key %>
                  <span class="rp-score-badge <%= is_correct ? 'rp-score-badge--correct' : 'rp-score-badge--incorrect' %>">
                    <%= is_correct ? 'âœ“ ì •ë‹µ' : 'âœ— ì˜¤ë‹µ' %>
                  </span>
                <% else %>
                  <span class="rp-score-badge rp-score-badge--unanswered">ë¯¸ì‘ë‹µ</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ìˆ˜í‰ì„  -->
  <div style="height: 1px; background: #e2e8f0; margin: 32px 0;"></div>

  <!-- ===== í•˜ë‹¨: ìƒì„¸ í”¼ë“œë°± ì„¹ì…˜ ===== -->
  <div style="margin-top: 32px;">
    <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
      ê°œë³„ í”¼ë“œë°± ë° ë¶„ì„
    </h2>

    <div class="rp-feedback-container" data-student-id="<%= @student.id %>">
      <% @responses.each_with_index do |response, index| %>
        <div class="rp-feedback-card" data-response-id="<%= response.id %>">
          <!-- ì¹´ë“œ í—¤ë” -->
          <div class="rp-feedback-card-header">
            <div class="rp-feedback-question-number">ë¬¸í•­ <%= index + 1 %></div>
            <% if response.selected_choice %>
              <span class="rp-badge <%= response.selected_choice.choice_score&.is_key ? 'rp-badge--success' : 'rp-badge--danger' %>">
                <%= response.selected_choice.choice_score&.is_key ? 'ì •ë‹µ' : 'ì˜¤ë‹µ' %>
              </span>
            <% else %>
              <span class="rp-badge rp-badge--secondary">ë¯¸ì‘ë‹µ</span>
            <% end %>
          </div>

          <!-- ë¬¸í•­ ë‚´ìš© -->
          <div class="rp-feedback-section">
            <h4>ë¬¸í•­</h4>
            <p><%= response.item.prompt %></p>
            <% if response.item.explanation.present? %>
              <details class="rp-expandable-details">
                <summary style="cursor: pointer; font-size: 12px; color: #64748b;">ë¬¸í•­ í•´ì„¤ ë³´ê¸°</summary>
                <p style="margin-top: 8px; padding: 8px; background: #f1f5f9; border-radius: 4px; font-size: 12px;">
                  <%= response.item.explanation %>
                </p>
              </details>
            <% end %>
          </div>

          <!-- í”¼ë“œë°± ì„¹ì…˜ -->
          <div class="rp-feedback-section" id="feedback-section-<%= response.id %>">
            <div class="rp-section-header">
              <h4>í”¼ë“œë°±</h4>
              <% ai_feedback = response.response_feedbacks.where(source: 'ai').last %>
              <% if ai_feedback.present? %>
                <button class="rp-btn-edit-small" data-action="edit-feedback">ìˆ˜ì •</button>
              <% else %>
                <button class="rp-btn rp-btn--primary rp-btn--xs" data-action="generate-feedback">
                  AI í”¼ë“œë°± ìƒì„±
                </button>
              <% end %>
            </div>

            <!-- í”¼ë“œë°± í‘œì‹œ -->
            <div class="rp-feedback-display">
              <% ai_feedback = response.response_feedbacks.where(source: 'ai').last %>
              <% teacher_feedback = response.response_feedbacks.where(source: 'teacher').last %>

              <% if ai_feedback.present? %>
                <div class="rp-feedback-item rp-feedback-item--ai">
                  <span class="rp-badge rp-badge--info">AI</span>
                  <p class="rp-feedback-text"><%= ai_feedback.feedback %></p>
                  <small class="rp-feedback-meta"><%= ai_feedback.created_at.strftime("%Y-%m-%d %H:%M") %></small>
                </div>
              <% end %>

              <% if teacher_feedback.present? %>
                <div class="rp-feedback-item rp-feedback-item--teacher">
                  <span class="rp-badge rp-badge--success">êµì‚¬</span>
                  <p class="rp-feedback-text"><%= teacher_feedback.feedback %></p>
                  <small class="rp-feedback-meta"><%= teacher_feedback.created_at.strftime("%Y-%m-%d %H:%M") %></small>
                </div>
              <% end %>

              <% if ai_feedback.blank? && teacher_feedback.blank? %>
                <p style="color: #94a3b8; font-size: 13px;">í”¼ë“œë°±ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
              <% end %>
            </div>

            <!-- í”¼ë“œë°± í¸ì§‘ -->
            <div class="rp-feedback-edit" style="display: none;">
              <textarea class="rp-feedback-textarea" rows="6" placeholder="í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..."><%= teacher_feedback&.feedback || ai_feedback&.feedback %></textarea>
              <div class="rp-edit-actions">
                <button class="rp-btn rp-btn--primary rp-btn--sm" data-action="save-feedback">ì €ì¥</button>
                <button class="rp-btn rp-btn--secondary rp-btn--sm" data-action="cancel-feedback">ì·¨ì†Œ</button>
              </div>
            </div>
          </div>

          <!-- í”„ë¡¬í”„íŠ¸ ì •êµí™” ì„¹ì…˜ -->
          <div class="rp-feedback-section rp-prompt-section">
            <h4>í”„ë¡¬í”„íŠ¸ë¡œ í”¼ë“œë°± ì •êµí™”</h4>

            <div class="rp-prompt-controls">
              <div class="rp-form-group">
                <label for="category-<%= response.id %>">ì¹´í…Œê³ ë¦¬</label>
                <select id="category-<%= response.id %>" class="rp-prompt-category">
                  <option value="general">ì¼ë°˜</option>
                  <option value="comprehension">ì´í•´ë ¥</option>
                  <option value="explanation">ì„¤ëª…</option>
                  <option value="difficulty">ë‚œì´ë„</option>
                  <option value="strategy">ì „ëµ</option>
                </select>
              </div>

              <div class="rp-form-group">
                <label for="prompt-<%= response.id %>">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</label>
                <textarea id="prompt-<%= response.id %>" class="rp-prompt-input" rows="3"
                          placeholder="ì˜ˆ: ë” ì¹œì ˆí•œ í†¤ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
              </div>

              <div class="rp-form-group">
                <label class="rp-checkbox">
                  <input type="checkbox" class="rp-save-template">
                  <span>í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</span>
                </label>
              </div>

              <button class="rp-btn rp-btn--primary" data-action="refine-feedback" data-response-id="<%= response.id %>">
                í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”
              </button>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

<% else %>
  <div class="rp-empty-state">
    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
    <p>ê°ê´€ì‹ ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  </div>
<% end %>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="rp-loading-overlay" style="display: none;">
  <div class="rp-spinner"></div>
  <p>ì²˜ë¦¬ ì¤‘...</p>
</div>

<style>
  /* ===== ìƒë‹¨ í…Œì´ë¸” ìŠ¤íƒ€ì¼ ===== */
  .rp-overview-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .rp-table-wrapper {
    overflow-x: auto;
  }

  .rp-overview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .rp-overview-table thead {
    background: #f8fafc;
    border-bottom: 2px solid #e2e8f0;
  }

  .rp-overview-table th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 12px;
  }

  .rp-table-row {
    border-bottom: 1px solid #e2e8f0;
    transition: background 0.15s;
  }

  .rp-table-row:hover {
    background: #f8fafc;
  }

  .rp-table-cell {
    padding: 14px 16px;
    color: #475569;
  }

  .rp-table-cell--question {
    font-weight: 600;
    color: #0f172a;
    width: 60px;
  }

  .rp-table-cell--correct,
  .rp-table-cell--student {
    min-width: 200px;
  }

  .rp-table-cell--score {
    text-align: center;
    width: 120px;
  }

  .rp-choice-badge {
    display: inline-block;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    font-weight: 600;
    font-size: 11px;
    margin-right: 6px;
  }

  .rp-choice-badge--correct {
    background: #dbeafe;
    color: #0284c7;
  }

  .rp-choice-badge--student {
    background: #2f5bff;
    color: white;
  }

  .rp-choice-label {
    font-size: 12px;
    color: #475569;
  }

  .rp-answer-clickable {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.15s;
  }

  .rp-answer-clickable:hover {
    background: #eff6ff;
    color: #2f5bff;
  }

  .rp-no-answer {
    color: #ef4444;
    font-style: italic;
  }

  .rp-answer-edit-mode {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .rp-answer-select {
    font-family: inherit;
  }

  .rp-score-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }

  .rp-score-badge--correct {
    background: #dcfce7;
    color: #166534;
  }

  .rp-score-badge--incorrect {
    background: #fee2e2;
    color: #991b1b;
  }

  .rp-score-badge--unanswered {
    background: #f3f4f6;
    color: #6b7280;
  }

  /* ===== í•˜ë‹¨ í”¼ë“œë°± ì„¹ì…˜ ìŠ¤íƒ€ì¼ ===== */
  .rp-feedback-container {
    display: grid;
    gap: 24px;
  }

  .rp-feedback-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .rp-feedback-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-feedback-question-number {
    font-size: 14px;
    font-weight: 600;
    color: #0f172a;
  }

  .rp-feedback-section {
    padding: 16px;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-feedback-section:last-child {
    border-bottom: none;
  }

  .rp-feedback-section h4 {
    margin: 0 0 8px;
    font-size: 13px;
    font-weight: 600;
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rp-feedback-section p {
    margin: 8px 0;
    font-size: 13px;
    line-height: 1.6;
    color: #475569;
  }

  .rp-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .rp-btn-edit-small {
    background: none;
    border: none;
    color: #2f5bff;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.15s;
  }

  .rp-btn-edit-small:hover {
    background: #eff6ff;
  }

  .rp-feedback-display {
    display: grid;
    gap: 12px;
  }

  .rp-feedback-item {
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid #cbd5e1;
  }

  .rp-feedback-item--ai {
    border-left-color: #0ea5e9;
    background: #f0f9ff;
  }

  .rp-feedback-item--teacher {
    border-left-color: #22c55e;
    background: #f0fdf4;
  }

  .rp-feedback-text {
    margin: 8px 0;
    font-size: 13px;
    line-height: 1.6;
    color: #475569;
  }

  .rp-feedback-meta {
    display: block;
    font-size: 11px;
    color: #94a3b8;
    margin-top: 8px;
  }

  .rp-feedback-edit {
    display: none;
  }

  .rp-feedback-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
  }

  .rp-feedback-textarea:focus {
    outline: none;
    border-color: #2f5bff;
    box-shadow: 0 0 0 3px rgba(47, 91, 255, 0.1);
  }

  .rp-edit-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .rp-prompt-section {
    background: #f8fafc;
  }

  .rp-prompt-controls {
    padding: 12px;
    background: white;
    border-radius: 8px;
  }

  .rp-form-group {
    margin-bottom: 12px;
  }

  .rp-form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 6px;
  }

  .rp-prompt-category,
  .rp-prompt-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 12px;
    font-family: inherit;
  }

  .rp-prompt-input {
    padding: 10px;
    font-size: 13px;
  }

  .rp-checkbox {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #475569;
    cursor: pointer;
    gap: 6px;
  }

  .rp-checkbox input {
    cursor: pointer;
  }

  .rp-expandable-details summary {
    cursor: pointer;
    user-select: none;
  }

  .rp-expandable-details summary:hover {
    text-decoration: underline;
  }

  .rp-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }

  .rp-badge--success {
    background: #dcfce7;
    color: #166534;
  }

  .rp-badge--danger {
    background: #fee2e2;
    color: #991b1b;
  }

  .rp-badge--secondary {
    background: #f3f4f6;
    color: #6b7280;
  }

  .rp-badge--info {
    background: #dbeafe;
    color: #0284c7;
  }

  .rp-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    z-index: 1000;
  }

  .rp-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .rp-loading-overlay p {
    color: white;
    font-size: 14px;
    margin: 0;
  }

  .rp-btn--xs {
    padding: 6px 12px;
    font-size: 12px;
  }

  .rp-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
  }
</style>

<script>
  class FeedbackPage {
    constructor() {
      this.init();
    }

    init() {
      this.bindTableClickEvents();
      this.bindFeedbackEvents();
      this.updateCorrectCount();
    }

    // í‘œì—ì„œ í•™ìƒë‹µ í´ë¦­ ì´ë²¤íŠ¸
    bindTableClickEvents() {
      document.querySelectorAll('.rp-answer-clickable').forEach(element => {
        element.addEventListener('click', (e) => {
          const row = e.target.closest('.rp-table-row');
          const answerDiv = row.querySelector('.rp-student-answer');
          const editDiv = row.querySelector('.rp-answer-edit-mode');

          answerDiv.style.display = 'none';
          editDiv.style.display = 'block';
          editDiv.querySelector('.rp-answer-select').focus();
        });
      });

      // ë‹µë³€ ì €ì¥
      document.querySelectorAll('[data-action="save-answer"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.saveAnswer(e.target));
      });

      // ë‹µë³€ ì·¨ì†Œ
      document.querySelectorAll('[data-action="cancel-answer"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('.rp-table-row');
          row.querySelector('.rp-student-answer').style.display = 'block';
          row.querySelector('.rp-answer-edit-mode').style.display = 'none';
        });
      });
    }

    async saveAnswer(button) {
      const row = button.closest('.rp-table-row');
      const responseId = row.dataset.responseId;
      const select = row.querySelector('.rp-answer-select');
      const selectedChoiceId = select.value;

      if (!selectedChoiceId) {
        alert('ì„ íƒì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_answer`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({ selected_choice_id: selectedChoiceId })
        });

        const data = await response.json();

        if (data.success) {
          // í‘œ ì—…ë°ì´íŠ¸
          const studentCell = row.querySelector('.rp-student-answer');
          studentCell.innerHTML = `
            <span class="rp-choice-badge rp-choice-badge--student">${data.choice_label}</span>
            <span class="rp-choice-label rp-answer-clickable">${data.choice_text.substring(0, 30)}</span>
          `;

          // ì ìˆ˜ ì—…ë°ì´íŠ¸
          const scoreCell = row.querySelector('.rp-table-cell--score');
          const badgeClass = data.is_correct ? 'rp-score-badge--correct' : 'rp-score-badge--incorrect';
          const badgeText = data.is_correct ? 'âœ“ ì •ë‹µ' : 'âœ— ì˜¤ë‹µ';
          scoreCell.innerHTML = `<span class="rp-score-badge ${badgeClass}">${badgeText}</span>`;

          // ì •ë‹µ ê°œìˆ˜ ì—…ë°ì´íŠ¸
          this.updateCorrectCount();

          // ëª¨ë“œ ì „í™˜
          row.querySelector('.rp-student-answer').style.display = 'block';
          row.querySelector('.rp-answer-edit-mode').style.display = 'none';

          this.showToast('ë‹µë³€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          this.bindTableClickEvents(); // í´ë¦­ ì´ë²¤íŠ¸ ì¬ë°”ì¸ë”©
        } else {
          alert(data.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        button.disabled = false;
        button.textContent = 'ì €ì¥';
      }
    }

    bindFeedbackEvents() {
      // AI í”¼ë“œë°± ìƒì„±
      document.querySelectorAll('[data-action="generate-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.generateFeedback(e.target));
      });

      // í”¼ë“œë°± ìˆ˜ì •
      document.querySelectorAll('[data-action="edit-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const section = e.target.closest('.rp-feedback-section');
          section.querySelector('.rp-feedback-display').style.display = 'none';
          section.querySelector('.rp-feedback-edit').style.display = 'block';
          section.querySelector('.rp-feedback-textarea').focus();
        });
      });

      // í”¼ë“œë°± ì €ì¥
      document.querySelectorAll('[data-action="save-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.saveFeedback(e.target));
      });

      // í”¼ë“œë°± ì·¨ì†Œ
      document.querySelectorAll('[data-action="cancel-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const section = e.target.closest('.rp-feedback-section');
          section.querySelector('.rp-feedback-display').style.display = 'block';
          section.querySelector('.rp-feedback-edit').style.display = 'none';
        });
      });

      // í”¼ë“œë°± ì •êµí™”
      document.querySelectorAll('[data-action="refine-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.refineFeedback(e.target));
      });
    }

    async generateFeedback(button) {
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;

      button.disabled = true;
      button.textContent = 'AI ìƒì„± ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        });

        const data = await response.json();

        if (data.success) {
          const section = card.querySelector('#feedback-section-' + responseId);
          const displayArea = section.querySelector('.rp-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.insertAdjacentHTML('afterbegin', `
            <div class="rp-feedback-item rp-feedback-item--ai">
              <span class="rp-badge rp-badge--info">AI</span>
              <p class="rp-feedback-text">${data.feedback}</p>
              <small class="rp-feedback-meta">${now}</small>
            </div>
          `);

          button.outerHTML = '<button class="rp-btn-edit-small" data-action="edit-feedback">ìˆ˜ì •</button>';
          this.bindFeedbackEvents();
          this.showToast('AI í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          alert(data.error || 'AI ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        button.disabled = false;
        button.textContent = 'AI í”¼ë“œë°± ìƒì„±';
      }
    }

    async saveFeedback(button) {
      const section = button.closest('.rp-feedback-section');
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;
      const textarea = section.querySelector('.rp-feedback-textarea');
      const feedbackText = textarea.value.trim();

      if (!feedbackText) {
        alert('í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_feedback`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({ feedback: feedbackText })
        });

        const data = await response.json();

        if (data.success) {
          const displayArea = section.querySelector('.rp-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.insertAdjacentHTML('afterbegin', `
            <div class="rp-feedback-item rp-feedback-item--teacher">
              <span class="rp-badge rp-badge--success">êµì‚¬</span>
              <p class="rp-feedback-text">${feedbackText}</p>
              <small class="rp-feedback-meta">${now}</small>
            </div>
          `);

          this.showToast('í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          section.querySelector('.rp-feedback-display').style.display = 'block';
          section.querySelector('.rp-feedback-edit').style.display = 'none';
        } else {
          alert(data.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        button.disabled = false;
        button.textContent = 'ì €ì¥';
      }
    }

    async refineFeedback(button) {
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;
      const section = button.closest('.rp-prompt-section');
      const category = section.querySelector('.rp-prompt-category').value;
      const promptText = section.querySelector('.rp-prompt-input').value.trim();
      const saveAsTemplate = section.querySelector('.rp-save-template').checked;

      if (!promptText) {
        alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì •êµí™” ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/refine`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({
            prompt: promptText,
            category: category,
            save_as_template: saveAsTemplate
          })
        });

        const data = await response.json();

        if (data.success) {
          const feedbackSection = card.querySelector('#feedback-section-' + responseId);
          const displayArea = feedbackSection.querySelector('.rp-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.insertAdjacentHTML('afterbegin', `
            <div class="rp-feedback-item rp-feedback-item--teacher">
              <span class="rp-badge rp-badge--success">êµì‚¬</span>
              <p class="rp-feedback-text">${data.feedback}</p>
              <small class="rp-feedback-meta">${now}</small>
            </div>
          `);

          section.querySelector('.rp-prompt-input').value = '';
          section.querySelector('.rp-save-template').checked = false;

          this.showToast('í”¼ë“œë°±ì´ ì •êµí™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          if (saveAsTemplate) this.showToast('í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        } else {
          alert(data.error || 'ì •êµí™” ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        button.disabled = false;
        button.textContent = 'í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”';
      }
    }

    updateCorrectCount() {
      const totalCorrect = document.querySelectorAll('.rp-score-badge--correct').length;
      document.getElementById('correct-count').textContent = totalCorrect;
    }

    showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        z-index: 999;
        opacity: 0;
        transform: translateY(100px);
        transition: all 0.3s;
      `;
      toast.textContent = message;
      toast.style.background = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#0ea5e9';
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      }, 10);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(100px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    getCSRFToken() {
      return document.querySelector('meta[name="csrf-token"]').content;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new FeedbackPage();
  });
</script>
