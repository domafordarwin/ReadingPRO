<% content_for :page_title, "학생 피드백" %>

<% if flash[:alert] %>
  <div style="background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 6px; margin-bottom: 16px; font-size: 13px;">
    ⚠️ <%= flash[:alert] %>
  </div>
<% end %>

<div class="rp-page-header rp-page-header--modern">
  <!-- 왼쪽: 페이지 제목 -->
  <div class="rp-page-header__left">
    <h1 class="rp-page-header__title"><%= @student&.name || "(학생 정보 없음)" %>의 피드백 생성하기</h1>
    <p class="rp-page-header__subtitle"><%= @responses&.count || 0 %>개 문항 종합 분석</p>
  </div>

  <!-- 오른쪽: 학생 탐색 네비게이션 -->
  <div class="rp-page-header__right">
    <div class="rp-student-nav rp-student-nav--inline">
      <%= link_to "← 목록", diagnostic_teacher_feedbacks_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% if @prev_student %>
        <%= link_to "< 이전", diagnostic_teacher_feedback_path(@prev_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">< 이전</button>
      <% end %>

      <input type="text" id="student-search" class="rp-student-search" placeholder="학생 검색..." />
      <select id="student-select" class="rp-student-select">
        <option value="">학생 선택</option>
        <% if @all_students.present? %>
          <% @all_students.each do |student| %>
            <option value="<%= student[:id] %>" <%= 'selected' if student[:id] == @student&.id %>>
              <%= student[:name] %>
            </option>
          <% end %>
        <% end %>
      </select>

      <% if @next_student %>
        <%= link_to "다음 >", diagnostic_teacher_feedback_path(@next_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">다음 ></button>
      <% end %>
    </div>
  </div>
</div>

<!-- ===== 3개 탭 네비게이션 ===== -->
<div class="rp-tabs-container">
  <div class="rp-tabs-nav">
    <button class="rp-tab-button active" data-tab="mcq">
      객관식 문항 피드백
      <span class="rp-tab-badge"><%= @responses&.count || 0 %></span>
    </button>
    <button class="rp-tab-button" data-tab="constructed">
      서술형 문항 피드백
      <span class="rp-tab-badge"><%= @constructed_responses&.count || 0 %></span>
    </button>
    <button class="rp-tab-button" data-tab="tendency">
      독자 성향 피드백
      <span class="rp-tab-badge">1</span>
    </button>
  </div>

  <!-- ===== 탭 컨테이너: 부분뷰 렌더링 ===== -->
  <% begin %>
    <%= render 'mcq_tab' %>
    <%= render 'constructed_tab' %>
    <%= render 'tendency_tab' %>
  <% rescue => e %>
    <div style="padding: 40px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; color: #dc2626;">
      <p style="margin: 0; font-size: 14px; font-weight: 600;">피드백 데이터 로드 중 오류가 발생했습니다</p>
      <p style="margin: 8px 0 0 0; font-size: 12px; color: #7f1d1d;"><%= e.message %></p>
    </div>
  <% end %>
</div>

<!-- ===== CSS 스타일 ===== -->
<style>
  /* 페이지 헤더 */
  .rp-page-header {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
  }

  .rp-page-header--modern {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 24px;
    padding: 20px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
  }

  .rp-page-header__left {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .rp-page-header__title {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
    color: #0f172a;
  }

  .rp-page-header__subtitle {
    margin: 0;
    font-size: 13px;
    color: #64748b;
  }

  .rp-page-header__right {
    display: flex;
    align-items: center;
  }

  .rp-student-nav--inline {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
  }

  .rp-student-search {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
    min-width: 150px;
  }

  .rp-student-select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
    min-width: 120px;
    background: white;
    cursor: pointer;
  }

  @media (max-width: 1200px) {
    .rp-page-header--modern {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .rp-page-header__right {
      width: 100%;
    }

    .rp-student-nav--inline {
      flex-wrap: wrap;
    }
  }

  /* 탭 네비게이션 */
  .rp-tabs-nav {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    padding: 0;
    gap: 0;
  }

  .rp-tab-button {
    padding: 16px 20px;
    border: none;
    background: transparent;
    color: #64748b;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .rp-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: white;
  }

  .rp-tab-button:hover {
    color: #0f172a;
    background: #f1f5f9;
  }

  .rp-tab-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #2f5bff;
    color: white;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
  }

  .rp-tab-pane {
    display: none;
    padding: 24px;
    animation: fadeIn 0.15s ease;
  }

  .rp-tab-pane.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* 탭 컨테이너 */
  .rp-tabs-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    margin-top: 24px;
    overflow: hidden;
  }

  /* 객관식 (MCQ) 피드백 레이아웃 */
  .rp-comprehensive-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
  }

  .rp-feedback-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rp-prompt-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rp-feedback-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
  }

  .rp-prompt-section {
    background: #f8fafc;
  }

  .rp-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 12px;
  }

  .rp-section-header h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #0f172a;
    flex: 1;
  }

  .rp-feedback-display {
    background: white;
    padding: 12px;
    border-radius: 8px;
    min-height: 200px;
    max-height: 600px;
    overflow-y: auto;
    margin-bottom: 16px;
    border: 1px solid #e2e8f0;
  }

  .rp-feedback-textarea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.6;
    resize: vertical;
  }

  .rp-prompt-input {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    resize: vertical;
  }

  .rp-prompt-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rp-form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .rp-form-group label {
    font-size: 12px;
    font-weight: 600;
    color: #0f172a;
  }

  .rp-form-group select,
  .rp-form-group textarea {
    padding: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
  }

  .rp-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 13px;
  }

  .rp-checkbox input {
    margin: 0;
    cursor: pointer;
  }

  .rp-button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .rp-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .rp-btn--primary {
    background: #2f5bff;
    color: white;
  }

  .rp-btn--primary:hover:not(:disabled) {
    background: #1e40af;
  }

  .rp-btn--primary:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
  }

  .rp-btn--secondary {
    background: #f0f0f0;
    color: #333;
  }

  .rp-btn--secondary:hover {
    background: #e0e0e0;
  }

  .rp-btn--success {
    background: #10b981;
    color: white;
  }

  .rp-btn--success:hover {
    background: #059669;
  }

  .rp-btn--sm {
    padding: 6px 10px;
    font-size: 11px;
  }

  .rp-btn--xs {
    padding: 4px 8px;
    font-size: 10px;
  }

  /* 서술형 레이아웃 */
  .rp-constructed-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-comprehensive-feedback-container,
    .rp-constructed-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-constructed-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-constructed-right-panel {
    display: grid;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    min-height: 800px;
  }

  .rp-constructed-answers-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
  }

  .rp-constructed-answer-tabs {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    overflow-x: auto;
    padding: 8px;
    gap: 4px;
  }

  .rp-answer-tab-button {
    padding: 8px 12px;
    border: none;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid #e2e8f0;
  }

  .rp-answer-tab-button.active {
    background: #2f5bff;
    color: white;
    border-color: #2f5bff;
  }

  /* 독자 성향 레이아웃 */
  .rp-tendency-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-tendency-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-tendency-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-tendency-right-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    min-height: 300px;
  }

  /* 중첩된 탭 */
  .rp-nested-tabs-nav {
    display: flex;
    border-bottom: 2px solid #e2e8f0;
    background: transparent;
    padding: 0 0 12px 0;
    margin-bottom: 16px;
    gap: 16px;
  }

  .rp-nested-tab-button {
    padding: 8px 12px;
    border: none;
    background: transparent;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    transition: all 0.15s ease;
  }

  .rp-nested-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: #f0f9ff;
  }

  .rp-nested-tab-button:hover {
    color: #0f172a;
  }

  .rp-nested-tab-pane {
    display: none;
  }

  .rp-nested-tab-pane.active {
    display: block;
    animation: fadeIn 0.15s ease;
  }

  /* 빈 상태 */
  .rp-empty-state {
    text-align: center;
    padding: 40px;
    color: #94a3b8;
  }
</style>

<!-- ===== JavaScript: 탭 스위칭 ===== -->
<script>
  class FeedbackPageTabs {
    constructor() {
      this.currentTab = 'mcq';
      this.currentNestedTab = { tendency: 'diagnosis' };
      this.currentConstructedResponse = null;
      this.init();
    }

    init() {
      this.bindMainTabButtons();
      this.bindNestedTabButtons();
      this.bindAnswerTabButtons();
    }

    bindMainTabButtons() {
      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;
          this.showTab(tabName);
        });
      });
    }

    bindNestedTabButtons() {
      document.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const parentPane = btn.closest('.rp-tab-pane');
          const parentTab = parentPane.dataset.tab;
          const nestedTabName = btn.dataset.nestedTab;
          this.showNestedTab(parentTab, nestedTabName);
        });
      });
    }

    bindAnswerTabButtons() {
      document.querySelectorAll('.rp-answer-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const responseId = btn.dataset.answerId;
          this.showAnswerTab(responseId);
        });
      });
    }

    showTab(tabName) {
      document.querySelectorAll('.rp-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = document.querySelector(`.rp-tab-pane[data-tab="${tabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = document.querySelector(`.rp-tab-button[data-tab="${tabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentTab = tabName;
    }

    showNestedTab(parentTab, nestedTabName) {
      const parentPane = document.querySelector(`.rp-tab-pane[data-tab="${parentTab}"]`);
      if (!parentPane) return;

      parentPane.querySelectorAll('.rp-nested-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      parentPane.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = parentPane.querySelector(`.rp-nested-tab-pane[data-nested-tab="${nestedTabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = parentPane.querySelector(`.rp-nested-tab-button[data-nested-tab="${nestedTabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentNestedTab[parentTab] = nestedTabName;
    }

    showAnswerTab(responseId) {
      const constructedTab = document.querySelector('.rp-tab-pane[data-tab="constructed"]');
      if (!constructedTab) return;

      // 모든 답변 콘텐츠 pane 숨기기
      constructedTab.querySelectorAll('.rp-answer-content-pane').forEach(pane => {
        pane.style.display = 'none';
        pane.classList.remove('active');
      });

      // 모든 탭 버튼 비활성화
      constructedTab.querySelectorAll('.rp-answer-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // 선택된 콘텐츠 표시
      const selectedPane = constructedTab.querySelector(`.rp-answer-content-pane[data-answer-id="${responseId}"]`);
      if (selectedPane) {
        selectedPane.style.display = 'block';
        selectedPane.classList.add('active');
      }

      // 선택된 탭 버튼 활성화
      const selectedBtn = constructedTab.querySelector(`.rp-answer-tab-button[data-answer-id="${responseId}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      // 피드백 섹션 업데이트
      this.updateConstructedFeedbackSection(responseId);
      this.currentConstructedResponse = responseId;
    }

    updateConstructedFeedbackSection(responseId) {
      const constructedTab = document.querySelector('.rp-tab-pane[data-tab="constructed"]');
      if (!constructedTab) return;

      // 피드백 생성 버튼 업데이트
      const feedbackBtn = constructedTab.querySelector('.rp-generate-constructed-feedback');
      if (feedbackBtn) {
        feedbackBtn.dataset.responseId = responseId;
      }

      // 해당 응답의 피드백 데이터 로드 (추후 구현 예정)
      // const feedbackDisplay = constructedTab.querySelector('#constructed-feedback-display');
      // if (feedbackDisplay) {
      //   // 새로운 응답의 피드백으로 업데이트
      // }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const tabs = new FeedbackPageTabs();
    window.__feedbackTabs = tabs;
  });
</script>

<!-- ===== JavaScript: 학생 검색 및 선택 기능 ===== -->
<script>
  class StudentNavigation {
    constructor() {
      this.searchInput = document.getElementById('student-search');
      this.selectDropdown = document.getElementById('student-select');
      this.allStudents = this.loadStudentList();
      this.filteredStudents = [...this.allStudents];

      if (this.searchInput && this.selectDropdown) {
        this.init();
      }
    }

    init() {
      // 학생 검색 입력 이벤트
      this.searchInput.addEventListener('input', (e) => {
        this.handleSearchInput(e.target.value);
      });

      // 학생 선택 드롭다운 이벤트
      this.selectDropdown.addEventListener('change', (e) => {
        this.handleStudentSelection(e.target.value);
      });
    }

    loadStudentList() {
      // 드롭다운의 모든 option 요소에서 학생 데이터 추출
      const students = [];
      this.selectDropdown.querySelectorAll('option').forEach(option => {
        if (option.value) { // "학생 선택" 옵션 제외
          students.push({
            id: option.value,
            name: option.textContent.trim()
          });
        }
      });
      return students;
    }

    handleSearchInput(searchText) {
      const query = searchText.toLowerCase().trim();

      if (query === '') {
        // 검색어 없으면 모든 학생 표시
        this.filteredStudents = [...this.allStudents];
        this.updateDropdown();
      } else {
        // 검색어로 필터링 (이름에 검색어 포함)
        this.filteredStudents = this.allStudents.filter(student =>
          student.name.toLowerCase().includes(query)
        );
        this.updateDropdown();

        // 검색 결과가 1개면 자동 선택
        if (this.filteredStudents.length === 1) {
          setTimeout(() => {
            this.selectDropdown.value = this.filteredStudents[0].id;
            this.handleStudentSelection(this.filteredStudents[0].id);
          }, 300);
        }
      }
    }

    updateDropdown() {
      // 드롭다운 옵션 업데이트
      const currentSelected = this.selectDropdown.value;
      this.selectDropdown.innerHTML = '<option value="">학생 선택</option>';

      this.filteredStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        this.selectDropdown.appendChild(option);
      });

      // 이전 선택값 복원 (필터 후에도 선택값 유지)
      if (currentSelected && this.filteredStudents.some(s => s.id === currentSelected)) {
        this.selectDropdown.value = currentSelected;
      }
    }

    handleStudentSelection(studentId) {
      if (!studentId) {
        return; // "학생 선택" 옵션 선택 시 아무것도 안 함
      }

      // 선택된 학생의 피드백 페이지로 이동
      const feedbackUrl = `/diagnostic_teacher/feedbacks/${studentId}`;
      window.location.href = feedbackUrl;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const studentNav = new StudentNavigation();
    window.__studentNav = studentNav;
  });
</script>

<% if @responses.any? %>
  <!-- 기존 JavaScript 코드: 피드백 생성 및 편집 기능 -->
  <script>
    class FeedbackPage {
      constructor() {
        this.currentComprehensiveFeedback = '<%= @comprehensive_feedback || "" %>'.trim();
        this.bindAll();
      }

      bindAll() {
        this.bindComprehensiveGeneration();
        this.bindComprehensiveFeedbackEdit();
        this.bindPromptRefinement();
        this.bindCorrectCount();
        this.bindConstructedFeedbackGeneration();
      }

      bindComprehensiveGeneration() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        if (btn) {
          btn.addEventListener('click', () => this.generateComprehensiveFeedback());
        }
      }

      bindComprehensiveFeedbackEdit() {
        const editBtn = document.getElementById('edit-comprehensive-feedback');
        const saveBtn = document.getElementById('save-comprehensive-feedback');
        const cancelBtn = document.getElementById('cancel-comprehensive-feedback');

        if (editBtn) {
          editBtn.addEventListener('click', () => this.toggleFeedbackEdit());
        }
        if (saveBtn) {
          saveBtn.addEventListener('click', () => this.saveComprehensiveFeedback());
        }
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => this.cancelFeedbackEdit());
        }
      }

      bindPromptRefinement() {
        const refineBtn = document.getElementById('refine-comprehensive-feedback');
        const applyBtn = document.getElementById('apply-custom-prompt');

        console.log('[bindPromptRefinement] Looking for buttons. Refine:', !!refineBtn, 'Apply:', !!applyBtn);

        if (refineBtn) {
          console.log('[bindPromptRefinement] Binding click event to refine-comprehensive-feedback');
          refineBtn.addEventListener('click', () => {
            console.log('[refineBtn click] Event fired!');
            this.refineCustomPrompt();
          });
        } else {
          console.warn('[bindPromptRefinement] refine-comprehensive-feedback button not found!');
        }

        if (applyBtn) {
          console.log('[bindPromptRefinement] Binding click event to apply-custom-prompt');
          applyBtn.addEventListener('click', () => this.applyCustomPromptToFeedback());
        } else {
          console.warn('[bindPromptRefinement] apply-custom-prompt button not found!');
        }
      }

      bindConstructedFeedbackGeneration() {
        document.querySelectorAll('.rp-generate-constructed-feedback').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const responseId = e.target.dataset.responseId;
            this.generateConstructedFeedback(responseId);
          });
        });
      }

      bindCorrectCount() {
        this.updateCorrectCount();
      }

      generateComprehensiveFeedback() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = 'AI 생성 중...';

        fetch(`/diagnostic_teacher/feedbacks/${studentId}/generate_comprehensive`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');
            const actionsArea = document.getElementById('comprehensive-feedback-actions');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            if (actionsArea) {
              actionsArea.style.display = 'flex';
            }

            this.showToast('✅ AI 종합 피드백이 생성되었습니다', 'success');
            btn.textContent = '피드백 재생성';
          }
        })
        .catch(err => {
          this.showToast('오류 발생', 'error');
          console.error(err);
        })
        .finally(() => {
          btn.disabled = false;
        });
      }

      generateConstructedFeedback(responseId) {
        const constructedTab = document.querySelector('.rp-tab-pane[data-tab="constructed"]');
        if (!constructedTab) {
          this.showToast('❌ 탭을 찾을 수 없습니다', 'error');
          return;
        }

        const btn = constructedTab.querySelector('.rp-generate-constructed-feedback');
        const feedbackDisplay = constructedTab.querySelector('.rp-feedback-display');

        if (!btn || !feedbackDisplay) {
          this.showToast('❌ UI 요소를 찾을 수 없습니다', 'error');
          return;
        }

        btn.disabled = true;
        btn.textContent = '생성 중...';

        fetch(`/diagnostic_teacher/feedbacks/${responseId}/generate_constructed`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          timeout: 30000
        })
        .then(r => {
          // HTTP 에러 상태 확인
          if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          }
          return r.json();
        })
        .then(data => {
          // JSON 응답 검증
          if (!data || typeof data !== 'object') {
            throw new Error('유효하지 않은 응답 형식');
          }

          if (data.success === true && data.feedback) {
            // 피드백 표시 업데이트
            feedbackDisplay.innerHTML = `
              <div style="font-size: 12px; line-height: 1.6; color: #1e293b; white-space: pre-wrap;">
                ${this.escapeHtml(data.feedback)}
              </div>
              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8;">
                ✓ AI 피드백 • ${new Date().toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}
              </div>
            `;

            this.showToast('✅ AI 피드백이 생성되었습니다', 'success');
            btn.textContent = 'AI 피드백 재생성';
          } else {
            const errorMsg = data.error || '피드백 생성 실패';
            this.showToast('❌ ' + errorMsg, 'error');
            btn.textContent = 'AI 피드백 생성';
            console.warn('[generateConstructedFeedback] Response error:', data);
          }
        })
        .catch(err => {
          console.error('[generateConstructedFeedback] Error:', err);

          // 에러 메시지 구성
          let errorMsg = '오류 발생';
          if (err.message.includes('HTTP 500')) {
            errorMsg = '서버 오류 발생. 관리자에게 문의하세요.';
          } else if (err.message.includes('HTTP 404')) {
            errorMsg = '페이지를 찾을 수 없습니다.';
          } else if (err.message.includes('HTTP')) {
            errorMsg = err.message;
          } else if (err.message.includes('JSON')) {
            errorMsg = '서버에서 유효한 응답을 받지 못했습니다.';
          } else if (err.message.includes('fetch')) {
            errorMsg = '네트워크 연결을 확인하세요.';
          }

          this.showToast('❌ ' + errorMsg, 'error');
          btn.textContent = 'AI 피드백 생성';
        })
        .finally(() => {
          btn.disabled = false;
        });
      }

      toggleFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          const isDisplaying = displayArea.style.display !== 'none';
          displayArea.style.display = isDisplaying ? 'none' : 'block';
          editArea.style.display = isDisplaying ? 'block' : 'none';

          if (isDisplaying) {
            document.getElementById('comprehensive-feedback-textarea').value = this.currentComprehensiveFeedback;
          }
        }
      }

      cancelFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          displayArea.style.display = 'block';
          editArea.style.display = 'none';
        }
      }

      async saveComprehensiveFeedback() {
        const feedbackText = document.getElementById('comprehensive-feedback-textarea').value.trim();
        if (!feedbackText) {
          alert('피드백을 입력하세요');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/save_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ feedback: feedbackText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = feedbackText;
            this.toggleFeedbackEdit();
            this.showToast('✅ 피드백이 저장되었습니다', 'success');
          }
        } catch (error) {
          this.showToast('저장 오류', 'error');
        }
      }

      refineCustomPrompt() {
        const btn = document.getElementById('refine-comprehensive-feedback');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();
        const categorySelect = document.querySelector('select[name="category"]') ||
                              document.querySelector('#comprehensive-category');
        const category = categorySelect ? categorySelect.value : 'general';

        console.log('[refineCustomPrompt] Button clicked. Prompt:', promptText.substring(0, 50) + '...', 'Category:', category);

        if (!promptText) {
          alert('프롬프트를 입력하세요');
          console.warn('[refineCustomPrompt] Prompt is empty');
          return;
        }

        btn.disabled = true;
        btn.textContent = '✨ 최적화 중...';

        console.log('[refineCustomPrompt] Starting API call to /diagnostic_teacher/feedbacks/optimize_prompt');

        fetch('/diagnostic_teacher/feedbacks/optimize_prompt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({
            prompt: promptText,
            category: category
          })
        })
        .then(r => {
          console.log('[refineCustomPrompt] Response status:', r.status);
          return r.json();
        })
        .then(data => {
          console.log('[refineCustomPrompt] Response data:', data);
          if (data.success && data.optimized_prompt) {
            // 최적화된 프롬프트로 textarea 업데이트
            document.getElementById('comprehensive-prompt').value = data.optimized_prompt;
            this.showToast('✨ 프롬프트가 최적화되었습니다! 아래 버튼으로 피드백을 생성하세요.', 'success');
          } else {
            const errorMsg = data.error || '프롬프트 최적화 실패';
            this.showToast('❌ ' + errorMsg, 'error');
            console.error('[refineCustomPrompt] API returned error:', data);
          }
        })
        .catch(err => {
          console.error('[refineCustomPrompt] Network/Parse Error:', err);
          this.showToast('❌ 프롬프트 최적화 중 오류가 발생했습니다: ' + err.message, 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btn.textContent = '프롬프트 최적화';
        });
      }

      async applyCustomPromptToFeedback() {
        const btn = document.getElementById('apply-custom-prompt');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();

        if (!promptText) {
          alert('프롬프트를 입력하세요');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = '피드백 생성 중...';

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/refine_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ prompt: promptText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            document.getElementById('comprehensive-prompt').value = '';
            this.showToast('✨ 커스텀 피드백이 생성되었습니다', 'success');
          }
        } catch (error) {
          this.showToast('생성 오류', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = '피드백 생성';
        }
      }

      updateCorrectCount() {
        // 정답 개수 계산 로직
      }

      getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').content;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 12px 16px;
          background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          border-radius: 8px;
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const page = new FeedbackPage();
      window.__feedbackPage = page;
    });
  </script>
<% end %>
