<% content_for :page_title, "학생 피드백" %>

<div class="rp-page-header">
  <!-- 학생 탐색 네비게이션 -->
  <div class="rp-student-nav">
    <div style="display: flex; align-items: center; gap: 8px;">
      <%= link_to "← 목록", diagnostic_teacher_feedbacks_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% if @prev_student %>
        <%= link_to "< 이전", diagnostic_teacher_feedback_path(@prev_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">< 이전</button>
      <% end %>
    </div>

    <div style="display: flex; align-items: center; gap: 12px;">
      <input type="text" id="student-search" class="rp-student-search" placeholder="학생 검색..." />
      <select id="student-select" class="rp-student-select">
        <option value="">학생 선택</option>
        <% @all_students.each do |student| %>
          <option value="<%= student[:id] %>" <%= 'selected' if student[:id] == @student.id %>>
            <%= student[:name] %>
          </option>
        <% end %>
      </select>
    </div>

    <div style="display: flex; align-items: center; gap: 8px;">
      <% if @next_student %>
        <%= link_to "다음 >", diagnostic_teacher_feedback_path(@next_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">다음 ></button>
      <% end %>
    </div>
  </div>

  <!-- 페이지 제목: 변경됨 -->
  <h1 class="rp-page-header__title"><%= @student.name %>의 피드백 생성하기</h1>
  <p class="rp-page-header__subtitle">18개 문항 종합 분석</p>
</div>

<!-- ===== 3개 탭 네비게이션 ===== -->
<div class="rp-tabs-container">
  <div class="rp-tabs-nav">
    <button class="rp-tab-button active" data-tab="mcq">
      객관식 문항 피드백
      <span class="rp-tab-badge"><%= @responses.count %></span>
    </button>
    <button class="rp-tab-button" data-tab="constructed">
      서술형 문항 피드백
      <span class="rp-tab-badge"><%= @constructed_responses.count %></span>
    </button>
    <button class="rp-tab-button" data-tab="tendency">
      독자 성향 피드백
      <span class="rp-tab-badge">1</span>
    </button>
  </div>

  <!-- ===== 탭 컨테이너: 부분뷰 렌더링 ===== -->
  <%= render 'mcq_tab' %>
  <%= render 'constructed_tab' %>
  <%= render 'tendency_tab' %>
</div>

<!-- ===== CSS 스타일 ===== -->
<style>
  /* 탭 네비게이션 */
  .rp-tabs-nav {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    padding: 0;
    gap: 0;
  }

  .rp-tab-button {
    padding: 16px 20px;
    border: none;
    background: transparent;
    color: #64748b;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .rp-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: white;
  }

  .rp-tab-button:hover {
    color: #0f172a;
    background: #f1f5f9;
  }

  .rp-tab-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #2f5bff;
    color: white;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
  }

  .rp-tab-pane {
    display: none;
    padding: 24px;
    animation: fadeIn 0.15s ease;
  }

  .rp-tab-pane.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* 탭 컨테이너 */
  .rp-tabs-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    margin-top: 24px;
    overflow: hidden;
  }

  /* 서술형 레이아웃 */
  .rp-constructed-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-constructed-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-constructed-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-constructed-right-panel {
    display: grid;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    min-height: 800px;
  }

  .rp-constructed-answers-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
  }

  .rp-constructed-answer-tabs {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    overflow-x: auto;
    padding: 8px;
    gap: 4px;
  }

  .rp-answer-tab-button {
    padding: 8px 12px;
    border: none;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid #e2e8f0;
  }

  .rp-answer-tab-button.active {
    background: #2f5bff;
    color: white;
    border-color: #2f5bff;
  }

  /* 독자 성향 레이아웃 */
  .rp-tendency-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-tendency-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-tendency-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-tendency-right-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    min-height: 300px;
  }

  /* 중첩된 탭 */
  .rp-nested-tabs-nav {
    display: flex;
    border-bottom: 2px solid #e2e8f0;
    background: transparent;
    padding: 0 0 12px 0;
    margin-bottom: 16px;
    gap: 16px;
  }

  .rp-nested-tab-button {
    padding: 8px 12px;
    border: none;
    background: transparent;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    transition: all 0.15s ease;
  }

  .rp-nested-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: #f0f9ff;
  }

  .rp-nested-tab-button:hover {
    color: #0f172a;
  }

  .rp-nested-tab-pane {
    display: none;
  }

  .rp-nested-tab-pane.active {
    display: block;
    animation: fadeIn 0.15s ease;
  }

  /* 빈 상태 */
  .rp-empty-state {
    text-align: center;
    padding: 40px;
    color: #94a3b8;
  }
</style>

<!-- ===== JavaScript: 탭 스위칭 ===== -->
<script>
  class FeedbackPageTabs {
    constructor() {
      this.currentTab = 'mcq';
      this.currentNestedTab = { tendency: 'diagnosis' };
      this.init();
    }

    init() {
      this.bindMainTabButtons();
      this.bindNestedTabButtons();
    }

    bindMainTabButtons() {
      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;
          this.showTab(tabName);
        });
      });
    }

    bindNestedTabButtons() {
      document.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const parentPane = btn.closest('.rp-tab-pane');
          const parentTab = parentPane.dataset.tab;
          const nestedTabName = btn.dataset.nestedTab;
          this.showNestedTab(parentTab, nestedTabName);
        });
      });
    }

    showTab(tabName) {
      document.querySelectorAll('.rp-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = document.querySelector(`.rp-tab-pane[data-tab="${tabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = document.querySelector(`.rp-tab-button[data-tab="${tabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentTab = tabName;
    }

    showNestedTab(parentTab, nestedTabName) {
      const parentPane = document.querySelector(`.rp-tab-pane[data-tab="${parentTab}"]`);
      if (!parentPane) return;

      parentPane.querySelectorAll('.rp-nested-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      parentPane.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = parentPane.querySelector(`.rp-nested-tab-pane[data-nested-tab="${nestedTabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = parentPane.querySelector(`.rp-nested-tab-button[data-nested-tab="${nestedTabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentNestedTab[parentTab] = nestedTabName;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const tabs = new FeedbackPageTabs();
    window.__feedbackTabs = tabs;
  });
</script>

<% if @responses.any? %>
  <!-- 기존 JavaScript 코드: 피드백 생성 및 편집 기능 -->
  <script>
    class FeedbackPage {
      constructor() {
        this.currentComprehensiveFeedback = '<%= @comprehensive_feedback || "" %>'.trim();
        this.bindAll();
      }

      bindAll() {
        this.bindComprehensiveGeneration();
        this.bindComprehensiveFeedbackEdit();
        this.bindPromptRefinement();
        this.bindCorrectCount();
      }

      bindComprehensiveGeneration() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        if (btn) {
          btn.addEventListener('click', () => this.generateComprehensiveFeedback());
        }
      }

      bindComprehensiveFeedbackEdit() {
        const editBtn = document.getElementById('edit-comprehensive-feedback');
        const saveBtn = document.getElementById('save-comprehensive-feedback');
        const cancelBtn = document.getElementById('cancel-comprehensive-feedback');

        if (editBtn) {
          editBtn.addEventListener('click', () => this.toggleFeedbackEdit());
        }
        if (saveBtn) {
          saveBtn.addEventListener('click', () => this.saveComprehensiveFeedback());
        }
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => this.cancelFeedbackEdit());
        }
      }

      bindPromptRefinement() {
        const refineBtn = document.getElementById('refine-comprehensive-feedback');
        const applyBtn = document.getElementById('apply-custom-prompt');

        if (refineBtn) {
          refineBtn.addEventListener('click', () => this.refineCustomPrompt());
        }
        if (applyBtn) {
          applyBtn.addEventListener('click', () => this.applyCustomPromptToFeedback());
        }
      }

      bindCorrectCount() {
        this.updateCorrectCount();
      }

      generateComprehensiveFeedback() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = 'AI 생성 중...';

        fetch(`/diagnostic_teacher/feedbacks/${studentId}/generate_comprehensive`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');
            const actionsArea = document.getElementById('comprehensive-feedback-actions');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            if (actionsArea) {
              actionsArea.style.display = 'flex';
            }

            this.showToast('✅ AI 종합 피드백이 생성되었습니다', 'success');
            btn.textContent = '피드백 재생성';
          }
        })
        .catch(err => {
          this.showToast('오류 발생', 'error');
          console.error(err);
        })
        .finally(() => {
          btn.disabled = false;
        });
      }

      toggleFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          const isDisplaying = displayArea.style.display !== 'none';
          displayArea.style.display = isDisplaying ? 'none' : 'block';
          editArea.style.display = isDisplaying ? 'block' : 'none';

          if (isDisplaying) {
            document.getElementById('comprehensive-feedback-textarea').value = this.currentComprehensiveFeedback;
          }
        }
      }

      cancelFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          displayArea.style.display = 'block';
          editArea.style.display = 'none';
        }
      }

      async saveComprehensiveFeedback() {
        const feedbackText = document.getElementById('comprehensive-feedback-textarea').value.trim();
        if (!feedbackText) {
          alert('피드백을 입력하세요');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/save_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ feedback: feedbackText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = feedbackText;
            this.toggleFeedbackEdit();
            this.showToast('✅ 피드백이 저장되었습니다', 'success');
          }
        } catch (error) {
          this.showToast('저장 오류', 'error');
        }
      }

      refineCustomPrompt() {
        const btn = document.getElementById('refine-comprehensive-feedback');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();

        if (!promptText) {
          alert('프롬프트를 입력하세요');
          return;
        }

        btn.disabled = true;
        btn.textContent = '최적화 중...';

        this.showToast('✨ 프롬프트가 준비되었습니다. 아래 버튼으로 피드백을 생성하세요.', 'success');
        btn.textContent = '프롬프트 최적화';
        btn.disabled = false;
      }

      async applyCustomPromptToFeedback() {
        const btn = document.getElementById('apply-custom-prompt');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();

        if (!promptText) {
          alert('프롬프트를 입력하세요');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = '피드백 생성 중...';

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/refine_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ prompt: promptText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            document.getElementById('comprehensive-prompt').value = '';
            this.showToast('✨ 커스텀 피드백이 생성되었습니다', 'success');
          }
        } catch (error) {
          this.showToast('생성 오류', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = '피드백 생성';
        }
      }

      updateCorrectCount() {
        // 정답 개수 계산 로직
      }

      getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').content;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 12px 16px;
          background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          border-radius: 8px;
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const page = new FeedbackPage();
      window.__feedbackPage = page;
    });
  </script>
<% end %>
