<% content_for :page_title, "학생 피드백" %>

<% if flash[:alert] %>
  <div style="background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 6px; margin-bottom: 16px; font-size: var(--rp-font-size-lg);">
    ⚠️ <%= flash[:alert] %>
  </div>
<% end %>

<div class="rp-page-header rp-page-header--modern">
  <!-- 왼쪽: 페이지 제목 + 배포 상태 -->
  <div class="rp-page-header__left">
    <div class="rp-page-header__title-row">
      <h1 class="rp-page-header__title"><%= @student&.name || "(학생 정보 없음)" %>의 피드백 생성하기</h1>
      <div class="publish-status-area" id="publish-status">
        <% if @latest_attempt&.respond_to?(:feedback_published_at) && @latest_attempt&.feedback_published_at.present? %>
          <span class="publish-badge publish-badge--published">배포됨 ✓ <%= @latest_attempt.feedback_published_at.strftime('%m/%d %H:%M') %></span>
          <button class="rp-btn rp-btn--secondary rp-btn--sm" id="unpublish-feedback-btn" data-student-id="<%= @student&.id %>">배포 취소</button>
        <% else %>
          <span class="publish-badge publish-badge--draft">미배포</span>
          <button class="rp-btn rp-btn--primary rp-btn--sm" id="publish-feedback-btn" data-student-id="<%= @student&.id %>">피드백 배포</button>
        <% end %>
      </div>
    </div>
    <p class="rp-page-header__subtitle"><%= @responses&.count || 0 %>개 문항 종합 분석</p>
  </div>

  <!-- 오른쪽: 학생 탐색 네비게이션 -->
  <div class="rp-page-header__right">
    <div class="rp-student-nav rp-student-nav--inline">
      <%= link_to "← 목록", diagnostic_teacher_feedbacks_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% if @prev_student %>
        <%= link_to "< 이전", diagnostic_teacher_feedback_path(@prev_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">< 이전</button>
      <% end %>

      <input type="text" id="student-search" class="rp-student-search" placeholder="학생 검색..." />
      <select id="student-select" class="rp-student-select">
        <option value="">학생 선택</option>
        <% if @all_students.present? %>
          <% @all_students.each do |student| %>
            <option value="<%= student[:id] %>" <%= 'selected' if student[:id] == @student&.id %>>
              <%= student[:name] %>
            </option>
          <% end %>
        <% end %>
      </select>

      <% if @next_student %>
        <%= link_to "다음 >", diagnostic_teacher_feedback_path(@next_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">다음 ></button>
      <% end %>
    </div>
  </div>
</div>

<!-- ===== 3개 탭 네비게이션 ===== -->
<div class="rp-tabs-container">
  <div class="rp-tabs-nav">
    <button class="rp-tab-button active" data-tab="mcq">
      객관식 문항 피드백
      <span class="rp-tab-badge"><%= @responses&.count || 0 %></span>
    </button>
    <button class="rp-tab-button" data-tab="constructed">
      서술형 문항 피드백
      <span class="rp-tab-badge"><%= @constructed_responses&.count || 0 %></span>
    </button>
    <button class="rp-tab-button" data-tab="tendency">
      독자 성향 피드백
      <span class="rp-tab-badge">1</span>
    </button>
  </div>

  <!-- ===== 탭 컨테이너: 부분뷰 렌더링 ===== -->
  <% begin %>
    <%= render 'mcq_tab' %>
    <%= render 'constructed_tab' %>
    <%= render 'tendency_tab' %>
  <% rescue => e %>
    <div style="padding: 40px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; color: #dc2626;">
      <p style="margin: 0; font-size: var(--rp-font-size-lg); font-weight: 600;">피드백 데이터 로드 중 오류가 발생했습니다</p>
      <p style="margin: 8px 0 0 0; font-size: var(--rp-font-size-md); color: #7f1d1d;"><%= e.message %></p>
    </div>
  <% end %>
</div>

<!-- ===== CSS 스타일 ===== -->
<style>
  /* 페이지 헤더 */
  .rp-page-header {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
  }

  .rp-page-header--modern {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 24px;
    padding: 20px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
  }

  .rp-page-header__left {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .rp-page-header__title-row {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .publish-status-area {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .publish-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: var(--rp-font-size-sm);
    font-weight: 600;
    white-space: nowrap;
  }

  .publish-badge--published {
    background: #dcfce7;
    color: #166534;
  }

  .publish-badge--draft {
    background: #fef3c7;
    color: #92400e;
  }

  .rp-page-header__title {
    margin: 0;
    font-size: var(--rp-font-size-xl);
    font-weight: 700;
    color: #0f172a;
  }

  .rp-page-header__subtitle {
    margin: 0;
    font-size: var(--rp-font-size-lg);
    color: #64748b;
  }

  .rp-page-header__right {
    display: flex;
    align-items: center;
  }

  .rp-student-nav--inline {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
  }

  .rp-student-search {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: var(--rp-font-size-lg);
    min-width: 150px;
  }

  .rp-student-select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: var(--rp-font-size-lg);
    min-width: 120px;
    background: white;
    cursor: pointer;
  }

  @media (max-width: 1200px) {
    .rp-page-header--modern {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .rp-page-header__right {
      width: 100%;
    }

    .rp-student-nav--inline {
      flex-wrap: wrap;
    }
  }

  /* 탭 네비게이션 */
  .rp-tabs-nav {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    padding: 0;
    gap: 0;
  }

  .rp-tab-button {
    padding: 16px 20px;
    border: none;
    background: transparent;
    color: #64748b;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: var(--rp-font-size-lg);
  }

  .rp-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: white;
  }

  .rp-tab-button:hover {
    color: #0f172a;
    background: #f1f5f9;
  }

  .rp-tab-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #2f5bff;
    color: white;
    border-radius: 12px;
    font-size: var(--rp-font-size-sm);
    font-weight: 700;
  }

  .rp-tab-pane {
    display: none;
    padding: 24px;
    animation: fadeIn 0.15s ease;
  }

  .rp-tab-pane.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* 탭 컨테이너 */
  .rp-tabs-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    margin-top: 24px;
    overflow: hidden;
  }

  /* 객관식 (MCQ) 피드백 레이아웃 */
  .rp-comprehensive-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
  }

  .rp-feedback-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rp-prompt-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rp-feedback-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
  }

  .rp-prompt-section {
    background: #f8fafc;
  }

  .rp-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 12px;
  }

  .rp-section-header h4 {
    margin: 0;
    font-size: var(--rp-font-size-lg);
    font-weight: 600;
    color: #0f172a;
    flex: 1;
  }

  .rp-feedback-display {
    background: white;
    padding: 12px;
    border-radius: 8px;
    min-height: 200px;
    max-height: 600px;
    overflow-y: auto;
    margin-bottom: 16px;
    border: 1px solid #e2e8f0;
  }

  .rp-feedback-textarea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: var(--rp-font-size-lg);
    line-height: 1.6;
    resize: vertical;
  }

  .rp-prompt-input {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: var(--rp-font-size-lg);
    line-height: 1.5;
    resize: vertical;
  }

  .rp-prompt-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rp-form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .rp-form-group label {
    font-size: var(--rp-font-size-md);
    font-weight: 600;
    color: #0f172a;
  }

  .rp-form-group select,
  .rp-form-group textarea {
    padding: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: var(--rp-font-size-lg);
  }

  .rp-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: var(--rp-font-size-lg);
  }

  .rp-checkbox input {
    margin: 0;
    cursor: pointer;
  }

  .rp-button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .rp-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: var(--rp-font-size-md);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .rp-btn--primary {
    background: #2f5bff;
    color: white;
  }

  .rp-btn--primary:hover:not(:disabled) {
    background: #1e40af;
  }

  .rp-btn--primary:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
  }

  .rp-btn--secondary {
    background: #f0f0f0;
    color: #333;
  }

  .rp-btn--secondary:hover {
    background: #e0e0e0;
  }

  .rp-btn--success {
    background: #10b981;
    color: white;
  }

  .rp-btn--success:hover {
    background: #059669;
  }

  .rp-btn--sm {
    padding: 6px 10px;
    font-size: var(--rp-font-size-sm);
  }

  .rp-btn--xs {
    padding: 4px 8px;
    font-size: var(--rp-font-size-sm);
  }

  /* 서술형 레이아웃 */
  .rp-constructed-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-comprehensive-feedback-container,
    .rp-constructed-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-constructed-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-constructed-right-panel {
    display: grid;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    min-height: 800px;
  }

  .rp-constructed-answers-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
  }

  .rp-constructed-answer-tabs {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    overflow-x: auto;
    padding: 8px;
    gap: 4px;
  }

  .rp-answer-tab-button {
    padding: 8px 12px;
    border: none;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: var(--rp-font-size-md);
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid #e2e8f0;
  }

  .rp-answer-tab-button.active {
    background: #2f5bff;
    color: white;
    border-color: #2f5bff;
  }

  /* 독자 성향 레이아웃 */
  .rp-tendency-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-tendency-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-tendency-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-tendency-right-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    min-height: 300px;
  }

  /* 중첩된 탭 */
  .rp-nested-tabs-nav {
    display: flex;
    border-bottom: 2px solid #e2e8f0;
    background: transparent;
    padding: 0 0 12px 0;
    margin-bottom: 16px;
    gap: 16px;
  }

  .rp-nested-tab-button {
    padding: 8px 12px;
    border: none;
    background: transparent;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: var(--rp-font-size-lg);
    font-weight: 600;
    color: #64748b;
    transition: all 0.15s ease;
  }

  .rp-nested-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: #f0f9ff;
  }

  .rp-nested-tab-button:hover {
    color: #0f172a;
  }

  .rp-nested-tab-pane {
    display: none;
  }

  .rp-nested-tab-pane.active {
    display: block;
    animation: fadeIn 0.15s ease;
  }

  /* 빈 상태 */
  .rp-empty-state {
    text-align: center;
    padding: 40px;
    color: #94a3b8;
  }
</style>

<!-- ===== JavaScript: 탭 스위칭 ===== -->
<script>
  class FeedbackPageTabs {
    constructor() {
      this.currentTab = 'mcq';
      this.currentNestedTab = { tendency: 'diagnosis' };
      this.currentConstructedResponse = null;
      this.init();
    }

    init() {
      this.bindMainTabButtons();
      this.bindNestedTabButtons();
      this.bindAnswerTabButtons();
    }

    bindMainTabButtons() {
      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;
          this.showTab(tabName);
        });
      });
    }

    bindNestedTabButtons() {
      document.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const parentPane = btn.closest('.rp-tab-pane');
          const parentTab = parentPane.dataset.tab;
          const nestedTabName = btn.dataset.nestedTab;
          this.showNestedTab(parentTab, nestedTabName);
        });
      });
    }

    bindAnswerTabButtons() {
      document.querySelectorAll('.rp-answer-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const responseId = btn.dataset.answerId;
          this.showAnswerTab(responseId);
        });
      });
    }

    showTab(tabName) {
      document.querySelectorAll('.rp-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = document.querySelector(`.rp-tab-pane[data-tab="${tabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = document.querySelector(`.rp-tab-button[data-tab="${tabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentTab = tabName;
    }

    showNestedTab(parentTab, nestedTabName) {
      const parentPane = document.querySelector(`.rp-tab-pane[data-tab="${parentTab}"]`);
      if (!parentPane) return;

      parentPane.querySelectorAll('.rp-nested-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      parentPane.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = parentPane.querySelector(`.rp-nested-tab-pane[data-nested-tab="${nestedTabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = parentPane.querySelector(`.rp-nested-tab-button[data-nested-tab="${nestedTabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentNestedTab[parentTab] = nestedTabName;
    }

    showAnswerTab(responseId) {
      const constructedTab = document.querySelector('.rp-tab-pane[data-tab="constructed"]');
      if (!constructedTab) return;

      // 모든 답변 콘텐츠 pane 숨기기
      constructedTab.querySelectorAll('.rp-answer-content-pane').forEach(pane => {
        pane.style.display = 'none';
        pane.classList.remove('active');
      });

      // 모든 탭 버튼 비활성화
      constructedTab.querySelectorAll('.rp-answer-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // 선택된 콘텐츠 표시
      const selectedPane = constructedTab.querySelector(`.rp-answer-content-pane[data-answer-id="${responseId}"]`);
      if (selectedPane) {
        selectedPane.style.display = 'block';
        selectedPane.classList.add('active');
      }

      // 선택된 탭 버튼 활성화
      const selectedBtn = constructedTab.querySelector(`.rp-answer-tab-button[data-answer-id="${responseId}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      // 피드백 섹션 업데이트
      this.updateConstructedFeedbackSection(responseId);
      this.currentConstructedResponse = responseId;
    }

    updateConstructedFeedbackSection(responseId) {
      const constructedTab = document.querySelector('.rp-tab-pane[data-tab="constructed"]');
      if (!constructedTab) return;

      // 피드백 생성 버튼 업데이트
      const feedbackBtn = constructedTab.querySelector('.rp-generate-constructed-feedback');
      if (feedbackBtn) {
        feedbackBtn.dataset.responseId = responseId;
      }

      // 해당 응답의 피드백 데이터 로드 (추후 구현 예정)
      // const feedbackDisplay = constructedTab.querySelector('#constructed-feedback-display');
      // if (feedbackDisplay) {
      //   // 새로운 응답의 피드백으로 업데이트
      // }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const tabs = new FeedbackPageTabs();
    window.__feedbackTabs = tabs;
  });
</script>

<!-- ===== JavaScript: 학생 검색 및 선택 기능 ===== -->
<script>
  class StudentNavigation {
    constructor() {
      this.searchInput = document.getElementById('student-search');
      this.selectDropdown = document.getElementById('student-select');
      this.allStudents = this.loadStudentList();
      this.filteredStudents = [...this.allStudents];

      if (this.searchInput && this.selectDropdown) {
        this.init();
      }
    }

    init() {
      // 학생 검색 입력 이벤트
      this.searchInput.addEventListener('input', (e) => {
        this.handleSearchInput(e.target.value);
      });

      // 학생 선택 드롭다운 이벤트
      this.selectDropdown.addEventListener('change', (e) => {
        this.handleStudentSelection(e.target.value);
      });
    }

    loadStudentList() {
      // 드롭다운의 모든 option 요소에서 학생 데이터 추출
      const students = [];
      this.selectDropdown.querySelectorAll('option').forEach(option => {
        if (option.value) { // "학생 선택" 옵션 제외
          students.push({
            id: option.value,
            name: option.textContent.trim()
          });
        }
      });
      return students;
    }

    handleSearchInput(searchText) {
      const query = searchText.toLowerCase().trim();

      if (query === '') {
        // 검색어 없으면 모든 학생 표시
        this.filteredStudents = [...this.allStudents];
        this.updateDropdown();
      } else {
        // 검색어로 필터링 (이름에 검색어 포함)
        this.filteredStudents = this.allStudents.filter(student =>
          student.name.toLowerCase().includes(query)
        );
        this.updateDropdown();

        // 검색 결과가 1개면 자동 선택
        if (this.filteredStudents.length === 1) {
          setTimeout(() => {
            this.selectDropdown.value = this.filteredStudents[0].id;
            this.handleStudentSelection(this.filteredStudents[0].id);
          }, 300);
        }
      }
    }

    updateDropdown() {
      // 드롭다운 옵션 업데이트
      const currentSelected = this.selectDropdown.value;
      this.selectDropdown.innerHTML = '<option value="">학생 선택</option>';

      this.filteredStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        this.selectDropdown.appendChild(option);
      });

      // 이전 선택값 복원 (필터 후에도 선택값 유지)
      if (currentSelected && this.filteredStudents.some(s => s.id === currentSelected)) {
        this.selectDropdown.value = currentSelected;
      }
    }

    handleStudentSelection(studentId) {
      if (!studentId) {
        return; // "학생 선택" 옵션 선택 시 아무것도 안 함
      }

      // 선택된 학생의 피드백 페이지로 이동
      const feedbackUrl = `/diagnostic_teacher/feedbacks/${studentId}`;
      window.location.href = feedbackUrl;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const studentNav = new StudentNavigation();
    window.__studentNav = studentNav;
  });
</script>

<% if @responses.any? || @constructed_responses.present? %>
  <!-- 데이터 저장 -->
  <div id="feedback-data" style="display:none;"
       data-comprehensive-feedback="<%= h(@comprehensive_feedback || '') %>"></div>

  <!-- 기존 JavaScript 코드: 피드백 생성 및 편집 기능 -->
  <script>
    class FeedbackPage {
      constructor() {
        const feedbackDataEl = document.getElementById('feedback-data');
        this.currentComprehensiveFeedback = feedbackDataEl ? (feedbackDataEl.getAttribute('data-comprehensive-feedback') || '').trim() : '';
        this.bindAll();
      }

      bindAll() {
        this.bindMcqItemFeedbackGeneration();
        this.bindMcqFeedbackEdit();
        this.bindComprehensiveGeneration();
        this.bindComprehensiveFeedbackEdit();
        this.bindPromptRefinement();
        this.bindCorrectCount();
        this.bindConstructedFeedbackGeneration();
        this.bindPromptEditors();
        this.bindPublishFeedback();
      }

      bindComprehensiveGeneration() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        if (btn) {
          btn.addEventListener('click', () => this.generateComprehensiveFeedback());
        }
      }

      bindComprehensiveFeedbackEdit() {
        const editBtn = document.getElementById('edit-comprehensive-feedback');
        const saveBtn = document.getElementById('save-comprehensive-feedback');
        const cancelBtn = document.getElementById('cancel-comprehensive-feedback');

        if (editBtn) {
          editBtn.addEventListener('click', () => this.toggleFeedbackEdit());
        }
        if (saveBtn) {
          saveBtn.addEventListener('click', () => this.saveComprehensiveFeedback());
        }
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => this.cancelFeedbackEdit());
        }
      }

      bindPromptRefinement() {
        const refineBtn = document.getElementById('refine-comprehensive-feedback');
        const applyBtn = document.getElementById('apply-custom-prompt');

        console.log('[bindPromptRefinement] Looking for buttons. Refine:', !!refineBtn, 'Apply:', !!applyBtn);

        if (refineBtn) {
          console.log('[bindPromptRefinement] Binding click event to refine-comprehensive-feedback');
          refineBtn.addEventListener('click', () => {
            console.log('[refineBtn click] Event fired!');
            this.refineCustomPrompt();
          });
        } else {
          console.warn('[bindPromptRefinement] refine-comprehensive-feedback button not found!');
        }

        if (applyBtn) {
          console.log('[bindPromptRefinement] Binding click event to apply-custom-prompt');
          applyBtn.addEventListener('click', () => this.applyCustomPromptToFeedback());
        } else {
          console.warn('[bindPromptRefinement] apply-custom-prompt button not found!');
        }
      }

      bindConstructedFeedbackGeneration() {
        // 일괄 생성 버튼
        const batchBtn = document.getElementById('generate-constructed-item-feedbacks');
        if (batchBtn) {
          batchBtn.addEventListener('click', () => this.generateConstructedItemFeedbacks());
        }

        // 개별 피드백 수정 버튼
        document.querySelectorAll('.cr-edit-feedback-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const responseId = btn.dataset.responseId;
            const feedbackText = btn.dataset.feedback;
            this.showConstructedFeedbackEdit(responseId, feedbackText);
          });
        });

        // 피드백 저장 버튼
        document.querySelectorAll('.cr-save-feedback-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const responseId = btn.dataset.responseId;
            this.saveConstructedFeedback(responseId);
          });
        });

        // 피드백 취소 버튼
        document.querySelectorAll('.cr-cancel-edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const responseId = btn.dataset.responseId;
            this.cancelConstructedFeedbackEdit(responseId);
          });
        });
      }

      bindMcqItemFeedbackGeneration() {
        const btn = document.getElementById('generate-mcq-item-feedbacks');
        if (btn) {
          btn.addEventListener('click', () => this.generateMcqItemFeedbacks());
        }
      }

      bindMcqFeedbackEdit() {
        document.querySelectorAll('.mcq-edit-feedback-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            this.showMcqFeedbackEdit(btn.dataset.responseId, btn.dataset.feedback);
          });
        });
        document.querySelectorAll('.mcq-save-feedback-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            this.saveMcqFeedback(btn.dataset.responseId);
          });
        });
        document.querySelectorAll('.mcq-cancel-edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            this.cancelMcqFeedbackEdit(btn.dataset.responseId);
          });
        });
      }

      showMcqFeedbackEdit(responseId, feedbackText) {
        const displayEl = document.getElementById(`feedback-display-${responseId}`);
        const editEl = document.getElementById(`mcq-feedback-edit-${responseId}`);
        const textareaEl = document.getElementById(`mcq-feedback-textarea-${responseId}`);
        if (displayEl && editEl && textareaEl) {
          displayEl.style.display = 'none';
          editEl.style.display = 'block';
          textareaEl.value = feedbackText;
          textareaEl.focus();
        }
      }

      cancelMcqFeedbackEdit(responseId) {
        const displayEl = document.getElementById(`feedback-display-${responseId}`);
        const editEl = document.getElementById(`mcq-feedback-edit-${responseId}`);
        if (displayEl && editEl) {
          displayEl.style.display = 'block';
          editEl.style.display = 'none';
        }
      }

      async saveMcqFeedback(responseId) {
        const textareaEl = document.getElementById(`mcq-feedback-textarea-${responseId}`);
        const feedbackText = textareaEl ? textareaEl.value.trim() : '';
        if (!feedbackText) {
          this.showToast('피드백 내용을 입력하세요', 'error');
          return;
        }

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_feedback`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ feedback: feedbackText })
          });

          const data = await response.json();
          if (data.success) {
            const displayEl = document.getElementById(`feedback-display-${responseId}`);
            if (displayEl) {
              displayEl.innerHTML = `
                <p class="mcq-feedback-text">${this.escapeHtml(feedbackText)}</p>
                <span class="mcq-feedback-meta">✓ teacher • ${new Date().toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
              `;
              displayEl.style.display = 'block';
            }

            const editEl = document.getElementById(`mcq-feedback-edit-${responseId}`);
            if (editEl) editEl.style.display = 'none';

            const actionsEl = document.getElementById(`mcq-feedback-actions-${responseId}`);
            if (actionsEl) {
              actionsEl.innerHTML = `<button class="rp-btn rp-btn--secondary rp-btn--xs mcq-edit-feedback-btn" data-response-id="${responseId}" data-feedback="${this.escapeAttr(feedbackText)}">수정</button>`;
              actionsEl.querySelector('.mcq-edit-feedback-btn').addEventListener('click', () => {
                this.showMcqFeedbackEdit(responseId, feedbackText);
              });
            }

            this.showToast('피드백이 저장되었습니다', 'success');
          } else {
            this.showToast(data.error || '저장 실패', 'error');
          }
        } catch (err) {
          console.error('[saveMcqFeedback] Error:', err);
          this.showToast('저장 중 오류가 발생했습니다', 'error');
        }
      }

      bindPublishFeedback() {
        const publishBtn = document.getElementById('publish-feedback-btn');
        if (publishBtn) {
          publishBtn.addEventListener('click', () => this.publishFeedback());
        }
        const unpublishBtn = document.getElementById('unpublish-feedback-btn');
        if (unpublishBtn) {
          unpublishBtn.addEventListener('click', () => this.unpublishFeedback());
        }
      }

      async publishFeedback() {
        const btn = document.getElementById('publish-feedback-btn');
        const studentId = btn.dataset.studentId;
        btn.disabled = true;
        btn.textContent = '배포 중...';

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/publish_feedback`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            }
          });
          const data = await response.json();
          if (data.success) {
            const statusArea = document.getElementById('publish-status');
            const now = new Date().toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            statusArea.innerHTML = `
              <span class="publish-badge publish-badge--published">배포됨 ✓ ${now}</span>
              <button class="rp-btn rp-btn--secondary rp-btn--sm" id="unpublish-feedback-btn" data-student-id="${studentId}">배포 취소</button>
            `;
            statusArea.querySelector('#unpublish-feedback-btn').addEventListener('click', () => this.unpublishFeedback());
            btn.remove();
            this.showToast('피드백이 학생에게 배포되었습니다', 'success');
          } else {
            this.showToast(data.error || '배포 실패', 'error');
            btn.disabled = false;
            btn.textContent = '피드백 배포';
          }
        } catch (err) {
          console.error('[publishFeedback] Error:', err);
          this.showToast('배포 중 오류가 발생했습니다', 'error');
          btn.disabled = false;
          btn.textContent = '피드백 배포';
        }
      }

      async unpublishFeedback() {
        const btn = document.getElementById('unpublish-feedback-btn');
        const studentId = btn.dataset.studentId;
        btn.disabled = true;

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/unpublish_feedback`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            }
          });
          const data = await response.json();
          if (data.success) {
            const statusArea = document.getElementById('publish-status');
            statusArea.innerHTML = `
              <span class="publish-badge publish-badge--draft">미배포</span>
              <button class="rp-btn rp-btn--primary rp-btn--sm" id="publish-feedback-btn" data-student-id="${studentId}">피드백 배포</button>
            `;
            statusArea.querySelector('#publish-feedback-btn').addEventListener('click', () => this.publishFeedback());
            this.showToast('배포가 취소되었습니다', 'success');
          } else {
            this.showToast(data.error || '취소 실패', 'error');
            btn.disabled = false;
          }
        } catch (err) {
          console.error('[unpublishFeedback] Error:', err);
          this.showToast('오류가 발생했습니다', 'error');
          btn.disabled = false;
        }
      }

      async generateMcqItemFeedbacks() {
        const btn = document.getElementById('generate-mcq-item-feedbacks');
        const studentId = btn.dataset.studentId;

        btn.disabled = true;
        btn.textContent = 'AI 피드백 생성 중...';

        // 오답 카드에 로딩 표시
        document.querySelectorAll('.mcq-card--incorrect').forEach(card => {
          const responseId = card.dataset.responseId;
          const feedbackEl = document.getElementById(`feedback-display-${responseId}`);
          if (feedbackEl && feedbackEl.querySelector('.mcq-feedback-placeholder')) {
            feedbackEl.innerHTML = '<div class="mcq-feedback-loading"><div class="mcq-feedback-loading__spinner"></div><span>AI 피드백 생성 중...</span></div>';
          }
        });

        try {
          // 프롬프트 에디터에서 커스텀 프롬프트 가져오기
          const mcqPromptEl = document.getElementById('mcq-prompt-textarea');
          const customPrompt = mcqPromptEl ? mcqPromptEl.value.trim() : '';

          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/generate_mcq_feedbacks`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ prompt: customPrompt || null })
          });

          const data = await response.json();

          if (data.success && data.feedbacks) {
            const feedbacks = data.feedbacks;
            let updatedCount = 0;

            Object.entries(feedbacks).forEach(([responseId, feedbackText]) => {
              const feedbackEl = document.getElementById(`feedback-display-${responseId}`);
              if (feedbackEl) {
                feedbackEl.innerHTML = `
                  <p class="mcq-feedback-text">${this.escapeHtml(feedbackText)}</p>
                  <span class="mcq-feedback-meta">✓ ai • ${new Date().toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                `;
                // 수정 버튼 추가/업데이트
                const actionsEl = document.getElementById(`mcq-feedback-actions-${responseId}`);
                if (actionsEl) {
                  actionsEl.innerHTML = `<button class="rp-btn rp-btn--secondary rp-btn--xs mcq-edit-feedback-btn" data-response-id="${responseId}" data-feedback="${this.escapeAttr(feedbackText)}">수정</button>`;
                  actionsEl.querySelector('.mcq-edit-feedback-btn').addEventListener('click', () => {
                    this.showMcqFeedbackEdit(responseId, feedbackText);
                  });
                }
                updatedCount++;
              }
            });

            const msg = data.message || `${updatedCount}개 문항에 피드백이 생성되었습니다`;
            this.showToast('✅ ' + msg, 'success');
            btn.textContent = '피드백 재생성';
          } else {
            const errorMsg = data.message || data.error || '피드백 생성 실패';
            this.showToast(errorMsg, data.feedbacks ? 'success' : 'error');
            btn.textContent = '오답 피드백 일괄 생성';
          }
        } catch (err) {
          console.error('[generateMcqItemFeedbacks] Error:', err);
          this.showToast('피드백 생성 중 오류가 발생했습니다', 'error');
          btn.textContent = '오답 피드백 일괄 생성';

          // 로딩 상태 원복
          document.querySelectorAll('.mcq-feedback-loading').forEach(el => {
            el.innerHTML = '<p class="mcq-feedback-placeholder">상단 버튼으로 피드백을 생성하세요</p>';
          });
        } finally {
          btn.disabled = false;
        }
      }

      bindCorrectCount() {
        this.updateCorrectCount();
      }

      generateComprehensiveFeedback() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = 'AI 생성 중...';

        fetch(`/diagnostic_teacher/feedbacks/${studentId}/generate_comprehensive`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');
            const actionsArea = document.getElementById('comprehensive-feedback-actions');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: var(--rp-font-size-lg);">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            if (actionsArea) {
              actionsArea.style.display = 'flex';
            }

            this.showToast('✅ AI 종합 피드백이 생성되었습니다', 'success');
            btn.textContent = '피드백 재생성';
          }
        })
        .catch(err => {
          this.showToast('오류 발생', 'error');
          console.error(err);
        })
        .finally(() => {
          btn.disabled = false;
        });
      }

      async generateConstructedItemFeedbacks() {
        const btn = document.getElementById('generate-constructed-item-feedbacks');
        if (!btn) return;

        const studentId = btn.dataset.studentId;
        btn.disabled = true;
        btn.textContent = 'AI 피드백 생성 중...';

        // 채점 완료 카드에 로딩 표시
        document.querySelectorAll('.cr-card').forEach(card => {
          const responseId = card.dataset.responseId;
          const feedbackEl = document.getElementById(`cr-feedback-display-${responseId}`);
          if (feedbackEl && feedbackEl.querySelector('.cr-feedback-placeholder:not(.cr-feedback-placeholder--warning)')) {
            feedbackEl.innerHTML = '<div class="cr-feedback-loading"><div class="cr-feedback-loading__spinner"></div><span>AI 피드백 생성 중...</span></div>';
          }
        });

        try {
          // 프롬프트 에디터에서 커스텀 프롬프트 가져오기
          const crPromptEl = document.getElementById('cr-prompt-textarea');
          const customPrompt = crPromptEl ? crPromptEl.value.trim() : '';

          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/generate_constructed_feedbacks`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ prompt: customPrompt || null })
          });

          const data = await response.json();

          if (data.success && data.feedbacks) {
            const feedbacks = data.feedbacks;
            let updatedCount = 0;

            Object.entries(feedbacks).forEach(([responseId, feedbackText]) => {
              const feedbackEl = document.getElementById(`cr-feedback-display-${responseId}`);
              if (feedbackEl) {
                feedbackEl.innerHTML = `
                  <div class="cr-feedback-content">${this.formatFeedbackHtml(feedbackText)}</div>
                  <span class="cr-feedback-meta">✓ AI • ${new Date().toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                `;
                updatedCount++;
              }

              // 수정 버튼 표시
              const actionsEl = document.getElementById(`cr-feedback-actions-${responseId}`);
              if (actionsEl) {
                actionsEl.innerHTML = `<button class="rp-btn rp-btn--secondary rp-btn--xs cr-edit-feedback-btn" data-response-id="${responseId}" data-feedback="${this.escapeAttr(feedbackText)}">수정</button>`;
                // 새 버튼에 이벤트 바인딩
                actionsEl.querySelector('.cr-edit-feedback-btn').addEventListener('click', (e) => {
                  this.showConstructedFeedbackEdit(responseId, feedbackText);
                });
              }
            });

            const msg = data.message || `${updatedCount}개 문항에 피드백이 생성되었습니다`;
            this.showToast(msg, 'success');
            btn.textContent = '피드백 재생성';
          } else {
            const msg = data.message || data.error || '피드백 생성 실패';
            this.showToast(msg, data.feedbacks ? 'success' : 'error');
            btn.textContent = '서술형 피드백 일괄 생성';
          }
        } catch (err) {
          console.error('[generateConstructedItemFeedbacks] Error:', err);
          this.showToast('피드백 생성 중 오류가 발생했습니다', 'error');
          btn.textContent = '서술형 피드백 일괄 생성';

          // 로딩 상태 원복
          document.querySelectorAll('.cr-feedback-loading').forEach(el => {
            el.innerHTML = '<p class="cr-feedback-placeholder">상단 버튼으로 피드백을 생성하세요</p>';
          });
        } finally {
          btn.disabled = false;
        }
      }

      showConstructedFeedbackEdit(responseId, feedbackText) {
        const displayEl = document.getElementById(`cr-feedback-display-${responseId}`);
        const editEl = document.getElementById(`cr-feedback-edit-${responseId}`);
        const textareaEl = document.getElementById(`cr-feedback-textarea-${responseId}`);

        if (displayEl && editEl && textareaEl) {
          displayEl.style.display = 'none';
          editEl.style.display = 'block';
          textareaEl.value = feedbackText;
          textareaEl.focus();
        }
      }

      cancelConstructedFeedbackEdit(responseId) {
        const displayEl = document.getElementById(`cr-feedback-display-${responseId}`);
        const editEl = document.getElementById(`cr-feedback-edit-${responseId}`);

        if (displayEl && editEl) {
          displayEl.style.display = 'block';
          editEl.style.display = 'none';
        }
      }

      async saveConstructedFeedback(responseId) {
        const textareaEl = document.getElementById(`cr-feedback-textarea-${responseId}`);
        const feedbackText = textareaEl ? textareaEl.value.trim() : '';

        if (!feedbackText) {
          this.showToast('피드백 내용을 입력하세요', 'error');
          return;
        }

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_feedback`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ feedback: feedbackText })
          });

          const data = await response.json();

          if (data.success) {
            // 피드백 표시 업데이트
            const displayEl = document.getElementById(`cr-feedback-display-${responseId}`);
            if (displayEl) {
              displayEl.innerHTML = `
                <div class="cr-feedback-content">${this.formatFeedbackHtml(feedbackText)}</div>
                <span class="cr-feedback-meta">✓ 교사 • ${new Date().toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
              `;
              displayEl.style.display = 'block';
            }

            // 편집 영역 닫기
            const editEl = document.getElementById(`cr-feedback-edit-${responseId}`);
            if (editEl) editEl.style.display = 'none';

            // 수정 버튼 데이터 업데이트
            const actionsEl = document.getElementById(`cr-feedback-actions-${responseId}`);
            if (actionsEl) {
              actionsEl.innerHTML = `<button class="rp-btn rp-btn--secondary rp-btn--xs cr-edit-feedback-btn" data-response-id="${responseId}" data-feedback="${this.escapeAttr(feedbackText)}">수정</button>`;
              actionsEl.querySelector('.cr-edit-feedback-btn').addEventListener('click', () => {
                this.showConstructedFeedbackEdit(responseId, feedbackText);
              });
            }

            this.showToast('피드백이 저장되었습니다', 'success');
          } else {
            this.showToast(data.error || '저장 실패', 'error');
          }
        } catch (err) {
          console.error('[saveConstructedFeedback] Error:', err);
          this.showToast('저장 중 오류가 발생했습니다', 'error');
        }
      }

      formatFeedbackHtml(text) {
        // 줄바꿈을 <p> 태그로 변환
        return text.split('\n').filter(line => line.trim()).map(line => `<p>${this.escapeHtml(line)}</p>`).join('');
      }

      escapeAttr(text) {
        return text.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      bindPromptEditors() {
        // MCQ 프롬프트 토글
        const mcqToggle = document.getElementById('mcq-prompt-toggle');
        if (mcqToggle) {
          mcqToggle.addEventListener('click', () => {
            const body = document.getElementById('mcq-prompt-body');
            const arrow = document.getElementById('mcq-prompt-arrow');
            if (body.style.display === 'none') {
              body.style.display = 'block';
              arrow.classList.add('open');
            } else {
              body.style.display = 'none';
              arrow.classList.remove('open');
            }
          });
        }

        // MCQ 기본값 복원
        const mcqReset = document.getElementById('mcq-prompt-reset');
        if (mcqReset) {
          mcqReset.addEventListener('click', () => {
            const textarea = document.getElementById('mcq-prompt-textarea');
            if (textarea) {
              textarea.value = <%= json_escape(FeedbackAiService::MCQ_DEFAULT_PROMPT.to_json) %>;
              this.showToast('기본 프롬프트로 복원되었습니다', 'success');
            }
          });
        }

        // 서술형 프롬프트 토글
        const crToggle = document.getElementById('cr-prompt-toggle');
        if (crToggle) {
          crToggle.addEventListener('click', () => {
            const body = document.getElementById('cr-prompt-body');
            const arrow = document.getElementById('cr-prompt-arrow');
            if (body.style.display === 'none') {
              body.style.display = 'block';
              arrow.classList.add('open');
            } else {
              body.style.display = 'none';
              arrow.classList.remove('open');
            }
          });
        }

        // 서술형 기본값 복원
        const crReset = document.getElementById('cr-prompt-reset');
        if (crReset) {
          crReset.addEventListener('click', () => {
            const textarea = document.getElementById('cr-prompt-textarea');
            if (textarea) {
              textarea.value = <%= json_escape(FeedbackAiService::CONSTRUCTED_DEFAULT_PROMPT.to_json) %>;
              this.showToast('기본 프롬프트로 복원되었습니다', 'success');
            }
          });
        }
      }

      toggleFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          const isDisplaying = displayArea.style.display !== 'none';
          displayArea.style.display = isDisplaying ? 'none' : 'block';
          editArea.style.display = isDisplaying ? 'block' : 'none';

          if (isDisplaying) {
            document.getElementById('comprehensive-feedback-textarea').value = this.currentComprehensiveFeedback;
          }
        }
      }

      cancelFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          displayArea.style.display = 'block';
          editArea.style.display = 'none';
        }
      }

      async saveComprehensiveFeedback() {
        const feedbackText = document.getElementById('comprehensive-feedback-textarea').value.trim();
        if (!feedbackText) {
          alert('피드백을 입력하세요');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/save_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ feedback: feedbackText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = feedbackText;
            this.toggleFeedbackEdit();
            this.showToast('✅ 피드백이 저장되었습니다', 'success');
          }
        } catch (error) {
          this.showToast('저장 오류', 'error');
        }
      }

      refineCustomPrompt() {
        const btn = document.getElementById('refine-comprehensive-feedback');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();
        const categorySelect = document.querySelector('select[name="category"]') ||
                              document.querySelector('#comprehensive-category');
        const category = categorySelect ? categorySelect.value : 'general';

        console.log('[refineCustomPrompt] Button clicked. Prompt:', promptText.substring(0, 50) + '...', 'Category:', category);

        if (!promptText) {
          alert('프롬프트를 입력하세요');
          console.warn('[refineCustomPrompt] Prompt is empty');
          return;
        }

        btn.disabled = true;
        btn.textContent = '✨ 최적화 중...';

        console.log('[refineCustomPrompt] Starting API call to /diagnostic_teacher/feedbacks/optimize_prompt');

        fetch('/diagnostic_teacher/feedbacks/optimize_prompt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({
            prompt: promptText,
            category: category
          })
        })
        .then(r => {
          console.log('[refineCustomPrompt] Response status:', r.status);
          return r.json();
        })
        .then(data => {
          console.log('[refineCustomPrompt] Response data:', data);
          if (data.success && data.optimized_prompt) {
            // 최적화된 프롬프트로 textarea 업데이트
            document.getElementById('comprehensive-prompt').value = data.optimized_prompt;
            this.showToast('✨ 프롬프트가 최적화되었습니다! 아래 버튼으로 피드백을 생성하세요.', 'success');
          } else {
            const errorMsg = data.error || '프롬프트 최적화 실패';
            this.showToast('❌ ' + errorMsg, 'error');
            console.error('[refineCustomPrompt] API returned error:', data);
          }
        })
        .catch(err => {
          console.error('[refineCustomPrompt] Network/Parse Error:', err);
          this.showToast('❌ 프롬프트 최적화 중 오류가 발생했습니다: ' + err.message, 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btn.textContent = '프롬프트 최적화';
        });
      }

      async applyCustomPromptToFeedback() {
        const btn = document.getElementById('apply-custom-prompt');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();

        if (!promptText) {
          alert('프롬프트를 입력하세요');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = '피드백 생성 중...';

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/refine_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ prompt: promptText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: var(--rp-font-size-lg);">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            document.getElementById('comprehensive-prompt').value = '';
            this.showToast('✨ 커스텀 피드백이 생성되었습니다', 'success');
          }
        } catch (error) {
          this.showToast('생성 오류', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = '피드백 생성';
        }
      }

      updateCorrectCount() {
        // 정답 개수 계산 로직
      }

      getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').content;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 12px 16px;
          background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          border-radius: 8px;
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const page = new FeedbackPage();
      window.__feedbackPage = page;
    });
  </script>
<% end %>
