<% content_for :page_title, "í•™ìƒ í”¼ë“œë°±" %>

<div class="rp-page-header">
  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
    <%= link_to "â† ëŒì•„ê°€ê¸°", diagnostic_teacher_feedbacks_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
  </div>
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
    <div>
      <h1 class="rp-page-header__title"><%= @student.name %>ì˜ í”¼ë“œë°±</h1>
      <p class="rp-page-header__subtitle">ê°ê´€ì‹ ë¬¸í•­ ì‘ë‹µì— ëŒ€í•œ AI í”¼ë“œë°± ë° êµì‚¬ ì˜ê²¬ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
    </div>
    <% # í”¼ë“œë°±ì´ ì—†ëŠ” ì‘ë‹µì´ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ %>
    <% if @responses.any? { |r| r.response_feedbacks.where(source: 'ai').empty? } %>
      <button class="rp-btn rp-btn--primary" data-action="bulk-generate" style="white-space: nowrap;">
        ì „ì²´ AI í”¼ë“œë°± ìƒì„±
      </button>
    <% end %>
  </div>
</div>

<% if @responses.any? %>
  <div class="rp-feedback-container" data-student-id="<%= @student.id %>">
    <% @responses.each_with_index do |response, index| %>
      <div class="rp-feedback-card" data-response-id="<%= response.id %>">
        <!-- ì¹´ë“œ í—¤ë”: ë¬¸í•­ ë²ˆí˜¸, ì •ë‹µ/ì˜¤ë‹µ ë°°ì§€ -->
        <div class="rp-feedback-card-header">
          <div class="rp-feedback-question-number">
            ë¬¸í•­ <%= index + 1 %>
          </div>
          <% if response.selected_choice %>
            <span class="rp-badge <%= response.selected_choice.choice_score&.is_key ? 'rp-badge--success' : 'rp-badge--danger' %>">
              <%= response.selected_choice.choice_score&.is_key ? 'ì •ë‹µ' : 'ì˜¤ë‹µ' %>
            </span>
          <% else %>
            <span class="rp-badge rp-badge--secondary">ë¯¸ì‘ë‹µ</span>
          <% end %>
        </div>

        <!-- ì„¹ì…˜ 1: ë¬¸í•­ í‘œì‹œ (ì½ê¸° ì „ìš©) -->
        <div class="rp-feedback-section">
          <h4>ë¬¸í•­</h4>
          <p><%= response.item.prompt %></p>
          <% if response.item.explanation.present? %>
            <details class="rp-expandable-details">
              <summary style="cursor: pointer; font-size: 12px; color: #64748b;">ë¬¸í•­ í•´ì„¤ ë³´ê¸°</summary>
              <p style="margin-top: 8px; padding: 8px; background: #f1f5f9; border-radius: 4px; font-size: 12px;">
                <%= response.item.explanation %>
              </p>
            </details>
          <% end %>
        </div>

        <!-- ì„¹ì…˜ 2: í•™ìƒì˜ ë‹µ (ìˆ˜ì • ê°€ëŠ¥) -->
        <div class="rp-feedback-section" id="answer-section-<%= response.id %>">
          <div class="rp-section-header">
            <h4>í•™ìƒì˜ ë‹µ</h4>
            <button class="rp-btn-edit-small" data-action="edit-answer">ìˆ˜ì •</button>
          </div>

          <!-- ì •ì  ë·° (ê¸°ë³¸) -->
          <div class="rp-answer-static">
            <% if response.selected_choice %>
              <span class="rp-choice-badge"><%= response.selected_choice.choice_letter %></span>
              <span class="rp-choice-text"><%= response.selected_choice.choice_text %></span>
              <% if response.selected_choice.explanation.present? %>
                <br><small style="color: #94a3b8; margin-top: 4px; display: block;"><%= response.selected_choice.explanation %></small>
              <% end %>
            <% else %>
              <span style="color: #ef4444;">ë‹µë³€ ì—†ìŒ</span>
            <% end %>
          </div>

          <!-- í¸ì§‘ ë·° (ìˆ¨ê¹€, JSë¡œ í† ê¸€) -->
          <div class="rp-answer-edit" style="display: none;">
            <select class="rp-choice-select">
              <option value="">-- ì„ íƒ --</option>
              <% response.item.item_choices.each do |choice| %>
                <option value="<%= choice.id %>" <%= 'selected' if choice.id == response.selected_choice_id %>>
                  <%= choice.choice_letter %>. <%= choice.choice_text %>
                </option>
              <% end %>
            </select>
            <div class="rp-edit-actions">
              <button class="rp-btn rp-btn--primary rp-btn--sm" data-action="save-answer">ì €ì¥</button>
              <button class="rp-btn rp-btn--secondary rp-btn--sm" data-action="cancel-answer">ì·¨ì†Œ</button>
            </div>
          </div>
        </div>

        <!-- ì •ë‹µ í‘œì‹œ (ì°¸ê³ ìš©) -->
        <div class="rp-feedback-section" style="background: #eff6ff; border-left: 3px solid #0ea5e9;">
          <div class="rp-section-header">
            <h4 style="color: #0284c7;">ì •ë‹µ</h4>
          </div>
          <% correct_choice = response.item.item_choices.find { |c| c.choice_score&.is_key } %>
          <% if correct_choice %>
            <span class="rp-choice-badge" style="background: #0284c7; color: white;"><%= correct_choice.choice_letter %></span>
            <span class="rp-choice-text"><%= correct_choice.choice_text %></span>
            <% if correct_choice.explanation.present? %>
              <br><small style="color: #0284c7; margin-top: 4px; display: block;"><%= correct_choice.explanation %></small>
            <% end %>
          <% end %>
        </div>

        <!-- ì„¹ì…˜ 3: AI í”¼ë“œë°± ë° êµì‚¬ ì˜ê²¬ (ìˆ˜ì • ê°€ëŠ¥) -->
        <div class="rp-feedback-section" id="feedback-section-<%= response.id %>">
          <div class="rp-section-header">
            <h4>í”¼ë“œë°±</h4>
            <% ai_feedback = response.response_feedbacks.where(source: 'ai').last %>
            <% if ai_feedback.present? %>
              <button class="rp-btn-edit-small" data-action="edit-feedback">ìˆ˜ì •</button>
            <% else %>
              <button class="rp-btn rp-btn--primary rp-btn--xs" data-action="generate-feedback">
                AI í”¼ë“œë°± ìƒì„±
              </button>
            <% end %>
          </div>

          <!-- í”¼ë“œë°± í‘œì‹œ ì˜ì—­ -->
          <div class="rp-feedback-display">
            <% ai_feedback = response.response_feedbacks.where(source: 'ai').last %>
            <% teacher_feedback = response.response_feedbacks.where(source: 'teacher').last %>

            <% if ai_feedback.present? %>
              <div class="rp-feedback-item rp-feedback-item--ai">
                <span class="rp-badge rp-badge--info">AI</span>
                <p class="rp-feedback-text"><%= ai_feedback.feedback %></p>
                <small class="rp-feedback-meta"><%= ai_feedback.created_at.strftime("%Y-%m-%d %H:%M") %></small>
              </div>
            <% end %>

            <% if teacher_feedback.present? %>
              <div class="rp-feedback-item rp-feedback-item--teacher">
                <span class="rp-badge rp-badge--success">êµì‚¬</span>
                <p class="rp-feedback-text"><%= teacher_feedback.feedback %></p>
                <small class="rp-feedback-meta"><%= teacher_feedback.created_at.strftime("%Y-%m-%d %H:%M") %></small>
              </div>
            <% end %>

            <% if ai_feedback.blank? && teacher_feedback.blank? %>
              <p style="color: #94a3b8; font-size: 13px;">í”¼ë“œë°±ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
            <% end %>
          </div>

          <!-- í”¼ë“œë°± í¸ì§‘ ì˜ì—­ (ìˆ¨ê¹€) -->
          <div class="rp-feedback-edit" style="display: none;">
            <textarea class="rp-feedback-textarea" rows="6" placeholder="í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..."><%= teacher_feedback&.feedback || ai_feedback&.feedback %></textarea>
            <div class="rp-edit-actions">
              <button class="rp-btn rp-btn--primary rp-btn--sm" data-action="save-feedback">ì €ì¥</button>
              <button class="rp-btn rp-btn--secondary rp-btn--sm" data-action="cancel-feedback">ì·¨ì†Œ</button>
            </div>
          </div>
        </div>

        <!-- ì„¹ì…˜ 4: í”„ë¡¬í”„íŠ¸ë¥¼ í†µí•œ í”¼ë“œë°± ì •êµí™” -->
        <div class="rp-feedback-section rp-prompt-section">
          <h4>í”„ë¡¬í”„íŠ¸ë¡œ í”¼ë“œë°± ì •êµí™”</h4>

          <div class="rp-prompt-controls">
            <div class="rp-form-group">
              <label for="category-<%= response.id %>">ì¹´í…Œê³ ë¦¬</label>
              <select id="category-<%= response.id %>" class="rp-prompt-category" data-response-id="<%= response.id %>">
                <option value="general">ì¼ë°˜</option>
                <option value="comprehension">ì´í•´ë ¥</option>
                <option value="explanation">ì„¤ëª…</option>
                <option value="difficulty">ë‚œì´ë„</option>
                <option value="strategy">ì „ëµ</option>
              </select>
            </div>

            <div class="rp-form-group">
              <label for="template-<%= response.id %>">í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° (ì„ íƒ)</label>
              <select id="template-<%= response.id %>" class="rp-prompt-template" data-response-id="<%= response.id %>">
                <option value="">ì§ì ‘ ì…ë ¥</option>
                <% @prompt_templates.group_by { |p| p[:category] }.each do |category, templates| %>
                  <optgroup label="<%= FeedbackPrompt.new(category: category).category_label %>">
                    <% templates.each do |template| %>
                      <option value="<%= template[:id] %>" data-text="<%= template[:prompt_text] %>">
                        <%= template[:prompt_text].truncate(50) %>
                      </option>
                    <% end %>
                  </optgroup>
                <% end %>
              </select>
            </div>

            <div class="rp-form-group">
              <label for="prompt-<%= response.id %>">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</label>
              <textarea id="prompt-<%= response.id %>" class="rp-prompt-input" rows="4"
                        placeholder="ì˜ˆ: ë” ì¹œì ˆí•œ í†¤ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”
ì´ˆë“±í•™êµ 5í•™ë…„ ìˆ˜ì¤€ìœ¼ë¡œ í’€ì–´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”
ë¹„ìœ ë¥¼ í†µí•´ ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
            </div>

            <div class="rp-form-group">
              <label class="rp-checkbox">
                <input type="checkbox" class="rp-save-template" data-response-id="<%= response.id %>">
                <span>í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</span>
              </label>
            </div>

            <button class="rp-btn rp-btn--primary" data-action="refine-feedback" data-response-id="<%= response.id %>">
              í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”
            </button>
          </div>

          <!-- í”„ë¡¬í”„íŠ¸ ì‚¬ìš© ì´ë ¥ -->
          <details class="rp-prompt-history">
            <summary>í”„ë¡¬í”„íŠ¸ ì‚¬ìš© ì´ë ¥ (<span class="history-count">0</span>)</summary>
            <div class="rp-history-list" data-response-id="<%= response.id %>">
              <!-- JSë¡œ AJAX ë¡œë“œ -->
            </div>
          </details>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="rp-empty-state">
    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
    <p>ê°ê´€ì‹ ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  </div>
<% end %>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="rp-loading-overlay" style="display: none;">
  <div class="rp-spinner"></div>
  <p>ì²˜ë¦¬ ì¤‘...</p>
</div>

<style>
  .rp-feedback-container {
    display: grid;
    gap: 24px;
    margin-bottom: 32px;
  }

  .rp-feedback-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .rp-feedback-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-feedback-question-number {
    font-size: 14px;
    font-weight: 600;
    color: #0f172a;
  }

  .rp-feedback-section {
    padding: 16px;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-feedback-section:last-child {
    border-bottom: none;
  }

  .rp-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .rp-feedback-section h4 {
    margin: 0;
    font-size: 13px;
    font-weight: 600;
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rp-feedback-section p {
    margin: 8px 0;
    font-size: 13px;
    line-height: 1.6;
    color: #475569;
  }

  .rp-btn-edit-small {
    background: none;
    border: none;
    color: #2f5bff;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.15s;
  }

  .rp-btn-edit-small:hover {
    background: #eff6ff;
  }

  .rp-choice-badge {
    display: inline-block;
    background: #2f5bff;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    text-align: center;
    line-height: 28px;
    font-weight: 600;
    font-size: 12px;
    margin-right: 8px;
  }

  .rp-choice-text {
    font-size: 13px;
    color: #475569;
  }

  .rp-answer-static,
  .rp-answer-edit {
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
  }

  .rp-choice-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 13px;
    margin-bottom: 12px;
  }

  .rp-edit-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .rp-feedback-display {
    display: grid;
    gap: 12px;
  }

  .rp-feedback-item {
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid #cbd5e1;
  }

  .rp-feedback-item--ai {
    border-left-color: #0ea5e9;
    background: #f0f9ff;
  }

  .rp-feedback-item--teacher {
    border-left-color: #22c55e;
    background: #f0fdf4;
  }

  .rp-feedback-text {
    margin: 8px 0;
    font-size: 13px;
    line-height: 1.6;
    color: #475569;
  }

  .rp-feedback-meta {
    display: block;
    font-size: 11px;
    color: #94a3b8;
    margin-top: 8px;
  }

  .rp-feedback-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
  }

  .rp-feedback-textarea:focus {
    outline: none;
    border-color: #2f5bff;
    box-shadow: 0 0 0 3px rgba(47, 91, 255, 0.1);
  }

  .rp-prompt-section {
    background: #f8fafc;
  }

  .rp-prompt-controls {
    padding: 12px;
    background: white;
    border-radius: 8px;
  }

  .rp-form-group {
    margin-bottom: 12px;
  }

  .rp-form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 6px;
  }

  .rp-prompt-category,
  .rp-prompt-template {
    width: 100%;
    padding: 8px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 12px;
  }

  .rp-prompt-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
  }

  .rp-checkbox {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #475569;
    cursor: pointer;
    gap: 6px;
  }

  .rp-checkbox input {
    cursor: pointer;
  }

  .rp-prompt-history {
    margin-top: 12px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    cursor: pointer;
  }

  .rp-prompt-history summary {
    font-weight: 600;
    color: #0f172a;
    font-size: 12px;
  }

  .rp-history-list {
    margin-top: 12px;
    display: grid;
    gap: 8px;
  }

  .rp-history-item {
    padding: 8px;
    background: #f8fafc;
    border-radius: 6px;
    border-left: 3px solid #cbd5e1;
  }

  .rp-history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 4px;
  }

  .rp-history-prompt {
    font-size: 12px;
    color: #475569;
    margin: 0;
  }

  .rp-history-date {
    font-size: 10px;
    color: #94a3b8;
  }

  .rp-empty-text {
    color: #94a3b8;
    font-size: 12px;
  }

  .rp-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    z-index: 1000;
  }

  .rp-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .rp-loading-overlay p {
    color: white;
    font-size: 14px;
    margin: 0;
  }

  .rp-toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 13px;
    color: white;
    opacity: 0;
    transform: translateY(100px);
    transition: all 0.3s;
    z-index: 999;
    max-width: 300px;
  }

  .rp-toast--show {
    opacity: 1;
    transform: translateY(0);
  }

  .rp-toast--success {
    background: #22c55e;
  }

  .rp-toast--error {
    background: #ef4444;
  }

  .rp-toast--info {
    background: #0ea5e9;
  }

  .rp-expandable-details {
    margin-top: 8px;
  }

  .rp-expandable-details summary {
    cursor: pointer;
    user-select: none;
  }

  .rp-expandable-details summary:hover {
    text-decoration: underline;
  }

  .rp-btn-edit-small {
    font-size: 12px;
  }

  .rp-btn--xs {
    padding: 6px 12px;
    font-size: 12px;
  }
</style>

<script>
  // Feedback Page Controller
  class FeedbackPage {
    constructor() {
      this.init();
    }

    init() {
      this.bindAnswerEditing();
      this.bindFeedbackEditing();
      this.bindFeedbackGeneration();
      this.bindPromptRefinement();
      this.bindTemplateLoading();
      this.bindBulkGeneration();
      this.loadAllPromptHistories();
    }

    // Answer Editing
    bindAnswerEditing() {
      document.querySelectorAll('[data-action="edit-answer"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.toggleAnswerEdit(e.target));
      });

      document.querySelectorAll('[data-action="save-answer"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.saveAnswer(e.target));
      });

      document.querySelectorAll('[data-action="cancel-answer"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.cancelAnswerEdit(e.target));
      });
    }

    toggleAnswerEdit(button) {
      const section = button.closest('.rp-feedback-section');
      const staticView = section.querySelector('.rp-answer-static');
      const editView = section.querySelector('.rp-answer-edit');

      if (staticView.style.display !== 'none') {
        staticView.style.display = 'none';
        editView.style.display = 'block';
        editView.querySelector('.rp-choice-select').focus();
      }
    }

    async saveAnswer(button) {
      const section = button.closest('.rp-feedback-section');
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;
      const select = section.querySelector('.rp-choice-select');
      const selectedChoiceId = select.value;

      if (!selectedChoiceId) {
        this.showToast('ì„ íƒì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_answer`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({ selected_choice_id: selectedChoiceId })
        });

        const data = await response.json();

        if (data.success) {
          // ì •ì  ë·° ì—…ë°ì´íŠ¸
          const staticView = section.querySelector('.rp-answer-static');
          staticView.innerHTML = `
            <span class="rp-choice-badge">${data.choice_label}</span>
            <span class="rp-choice-text">${data.choice_text}</span>
          `;

          // ì •ë‹µ/ì˜¤ë‹µ ë°°ì§€ ì—…ë°ì´íŠ¸
          const badge = card.querySelector('.rp-feedback-card-header .rp-badge');
          if (data.is_correct) {
            badge.className = 'rp-badge rp-badge--success';
            badge.textContent = 'ì •ë‹µ';
          } else {
            badge.className = 'rp-badge rp-badge--danger';
            badge.textContent = 'ì˜¤ë‹µ';
          }

          this.showToast('ë‹µë³€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

          // ì •ì  ë·°ë¡œ ëŒì•„ê°€ê¸°
          section.querySelector('.rp-answer-static').style.display = 'block';
          section.querySelector('.rp-answer-edit').style.display = 'none';
        } else {
          this.showToast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
        }
      } catch (error) {
        this.showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
      } finally {
        button.disabled = false;
        button.textContent = 'ì €ì¥';
      }
    }

    cancelAnswerEdit(button) {
      const section = button.closest('.rp-feedback-section');
      section.querySelector('.rp-answer-static').style.display = 'block';
      section.querySelector('.rp-answer-edit').style.display = 'none';
    }

    // Feedback Editing
    bindFeedbackEditing() {
      document.querySelectorAll('[data-action="edit-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.toggleFeedbackEdit(e.target));
      });

      document.querySelectorAll('[data-action="save-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.saveFeedback(e.target));
      });

      document.querySelectorAll('[data-action="cancel-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.cancelFeedbackEdit(e.target));
      });
    }

    toggleFeedbackEdit(button) {
      const section = button.closest('.rp-feedback-section');
      section.querySelector('.rp-feedback-display').style.display = 'none';
      section.querySelector('.rp-feedback-edit').style.display = 'block';
      section.querySelector('.rp-feedback-textarea').focus();
    }

    async saveFeedback(button) {
      const section = button.closest('.rp-feedback-section');
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;
      const textarea = section.querySelector('.rp-feedback-textarea');
      const feedbackText = textarea.value.trim();

      if (!feedbackText) {
        this.showToast('í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_feedback`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({ feedback: feedbackText })
        });

        const data = await response.json();

        if (data.success) {
          // í”¼ë“œë°± ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
          this.updateFeedbackDisplay(section, data.feedback, 'teacher');

          this.showToast('í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

          // ë””ìŠ¤í”Œë ˆì´ ë·°ë¡œ ëŒì•„ê°€ê¸°
          section.querySelector('.rp-feedback-display').style.display = 'block';
          section.querySelector('.rp-feedback-edit').style.display = 'none';
        } else {
          this.showToast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
        }
      } catch (error) {
        this.showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
      } finally {
        button.disabled = false;
        button.textContent = 'ì €ì¥';
      }
    }

    cancelFeedbackEdit(button) {
      const section = button.closest('.rp-feedback-section');
      section.querySelector('.rp-feedback-display').style.display = 'block';
      section.querySelector('.rp-feedback-edit').style.display = 'none';
    }

    // AI Feedback Generation
    bindFeedbackGeneration() {
      document.querySelectorAll('[data-action="generate-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.generateFeedback(e.target));
      });
    }

    async generateFeedback(button) {
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;

      button.disabled = true;
      button.textContent = 'AI ìƒì„± ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        });

        const data = await response.json();

        if (data.success) {
          const section = card.querySelector('#feedback-section-' + responseId);
          this.updateFeedbackDisplay(section, data.feedback, 'ai');

          // "ìƒì„±" ë²„íŠ¼ì„ "ìˆ˜ì •" ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
          button.outerHTML = '<button class="rp-btn-edit-small" data-action="edit-feedback">ìˆ˜ì •</button>';
          this.bindFeedbackEditing(); // ë‹¤ì‹œ ë°”ì¸ë”©

          this.showToast('AI í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          this.showToast(data.error || 'AI ìƒì„± ì‹¤íŒ¨', 'error');
        }
      } catch (error) {
        this.showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
      } finally {
        button.disabled = false;
        button.textContent = 'AI í”¼ë“œë°± ìƒì„±';
      }
    }

    // Prompt Refinement
    bindPromptRefinement() {
      document.querySelectorAll('[data-action="refine-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.refineFeedback(e.target));
      });
    }

    async refineFeedback(button) {
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;
      const section = button.closest('.rp-prompt-section');

      const category = section.querySelector('.rp-prompt-category').value;
      const promptText = section.querySelector('.rp-prompt-input').value.trim();
      const saveAsTemplate = section.querySelector('.rp-save-template').checked;

      if (!promptText) {
        this.showToast('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì •êµí™” ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/refine`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({
            prompt: promptText,
            category: category,
            save_as_template: saveAsTemplate
          })
        });

        const data = await response.json();

        if (data.success) {
          // í”¼ë“œë°± ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
          const feedbackSection = card.querySelector('#feedback-section-' + responseId);
          this.updateFeedbackDisplay(feedbackSection, data.feedback, 'teacher');

          // í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì´ˆê¸°í™”
          section.querySelector('.rp-prompt-input').value = '';
          section.querySelector('.rp-save-template').checked = false;

          // í”„ë¡¬í”„íŠ¸ ì´ë ¥ ë‹¤ì‹œ ë¡œë“œ
          this.loadPromptHistory(responseId);

          this.showToast('í”¼ë“œë°±ì´ ì •êµí™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

          if (saveAsTemplate) {
            this.showToast('í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
          }
        } else {
          this.showToast(data.error || 'ì •êµí™” ì‹¤íŒ¨', 'error');
        }
      } catch (error) {
        this.showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
      } finally {
        button.disabled = false;
        button.textContent = 'í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”';
      }
    }

    // Template Loading
    bindTemplateLoading() {
      document.querySelectorAll('.rp-prompt-template').forEach(select => {
        select.addEventListener('change', (e) => {
          const templateId = e.target.value;
          if (!templateId) return;

          const section = e.target.closest('.rp-prompt-section');
          const promptInput = section.querySelector('.rp-prompt-input');
          const option = e.target.options[e.target.selectedIndex];

          if (option.dataset.text) {
            promptInput.value = option.dataset.text;
            promptInput.focus();
          }
        });
      });
    }

    // Bulk Generation
    bindBulkGeneration() {
      const bulkBtn = document.querySelector('[data-action="bulk-generate"]');
      if (bulkBtn) {
        bulkBtn.addEventListener('click', () => this.bulkGenerateFeedback());
      }
    }

    async bulkGenerateFeedback() {
      const container = document.querySelector('.rp-feedback-container');
      const cards = container.querySelectorAll('.rp-feedback-card');
      const cardsWithoutFeedback = Array.from(cards).filter(card => {
        const generateBtn = card.querySelector('[data-action="generate-feedback"]');
        return generateBtn !== null;
      });

      if (cardsWithoutFeedback.length === 0) {
        this.showToast('ëª¨ë“  ì‘ë‹µì— í”¼ë“œë°±ì´ ìˆìŠµë‹ˆë‹¤', 'info');
        return;
      }

      const confirmed = confirm(
        `${cardsWithoutFeedback.length}ê°œì˜ ì‘ë‹µì— AI í”¼ë“œë°±ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì•½ ${cardsWithoutFeedback.length * 2}ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤)`
      );
      if (!confirmed) return;

      this.showLoadingOverlay(`0 / ${cardsWithoutFeedback.length} ì™„ë£Œ`);

      let successCount = 0;

      for (let i = 0; i < cardsWithoutFeedback.length; i++) {
        const card = cardsWithoutFeedback[i];
        const responseId = card.dataset.responseId;

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/generate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            }
          });

          const data = await response.json();

          if (data.success) {
            successCount++;
            const section = card.querySelector('#feedback-section-' + responseId);
            this.updateFeedbackDisplay(section, data.feedback, 'ai');

            // ë²„íŠ¼ êµì²´
            const generateBtn = card.querySelector('[data-action="generate-feedback"]');
            if (generateBtn) {
              generateBtn.outerHTML = '<button class="rp-btn-edit-small" data-action="edit-feedback">ìˆ˜ì •</button>';
            }
          }
        } catch (error) {
          console.error('Bulk generate error:', error);
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        this.updateLoadingOverlay(`${i + 1} / ${cardsWithoutFeedback.length} ì™„ë£Œ`);

        // API ë ˆì´íŠ¸ ì œí•œ ë°©ì§€ë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—°
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      this.hideLoadingOverlay();
      this.bindFeedbackEditing(); // ìƒˆë¡œìš´ ë²„íŠ¼ ë°”ì¸ë”©
      this.showToast(`${successCount}ê°œì˜ AI í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
    }

    // Prompt History
    loadAllPromptHistories() {
      const cards = document.querySelectorAll('.rp-feedback-card');
      cards.forEach(card => {
        const responseId = card.dataset.responseId;
        this.loadPromptHistory(responseId);
      });
    }

    async loadPromptHistory(responseId) {
      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/histories`);
        const data = await response.json();

        const card = document.querySelector(`.rp-feedback-card[data-response-id="${responseId}"]`);
        const historyList = card.querySelector(`.rp-history-list[data-response-id="${responseId}"]`);
        const historyCount = card.querySelector('.rp-prompt-history .history-count');

        if (data.histories && data.histories.length > 0) {
          historyList.innerHTML = data.histories.map(h => `
            <div class="rp-history-item">
              <div class="rp-history-header">
                <span class="rp-badge rp-badge--info" style="font-size: 10px;">${h.category_label}</span>
                <span class="rp-history-date">${h.created_at_display}</span>
              </div>
              <p class="rp-history-prompt">${h.prompt_text}</p>
            </div>
          `).join('');

          historyCount.textContent = data.histories.length;
        } else {
          historyList.innerHTML = '<p class="rp-empty-text">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</p>';
          historyCount.textContent = '0';
        }
      } catch (error) {
        console.error('History load failed:', error);
      }
    }

    // Helper Methods
    updateFeedbackDisplay(section, feedbackText, source) {
      const displayArea = section.querySelector('.rp-feedback-display');
      const badgeClass = source === 'ai' ? 'rp-badge--info' : 'rp-badge--success';
      const badgeLabel = source === 'ai' ? 'AI' : 'êµì‚¬';
      const now = new Date().toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      const feedbackHTML = `
        <div class="rp-feedback-item rp-feedback-item--${source}">
          <span class="rp-badge ${badgeClass}">${badgeLabel}</span>
          <p class="rp-feedback-text">${feedbackText}</p>
          <small class="rp-feedback-meta">${now}</small>
        </div>
      `;

      // ìƒˆë¡œìš´ í”¼ë“œë°±ì„ ë§¨ ìœ„ì— ì¶”ê°€
      displayArea.insertAdjacentHTML('afterbegin', feedbackHTML);
    }

    showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `rp-toast rp-toast--${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('rp-toast--show');
      }, 10);

      setTimeout(() => {
        toast.classList.remove('rp-toast--show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    showLoadingOverlay(message) {
      const overlay = document.querySelector('.rp-loading-overlay');
      overlay.querySelector('p').textContent = message;
      overlay.style.display = 'flex';
    }

    updateLoadingOverlay(message) {
      const overlay = document.querySelector('.rp-loading-overlay');
      overlay.querySelector('p').textContent = message;
    }

    hideLoadingOverlay() {
      const overlay = document.querySelector('.rp-loading-overlay');
      overlay.style.display = 'none';
    }

    getCSRFToken() {
      return document.querySelector('meta[name="csrf-token"]').content;
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', () => {
    if (document.querySelector('.rp-feedback-container')) {
      new FeedbackPage();
    }
  });
</script>
