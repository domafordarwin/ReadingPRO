<% content_for :page_title, "í•™ìƒ í”¼ë“œë°±" %>

<div class="rp-page-header">
  <!-- í•™ìƒ íƒìƒ‰ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="rp-student-nav">
    <div style="display: flex; align-items: center; gap: 8px;">
      <%= link_to "â† ëª©ë¡", diagnostic_teacher_feedbacks_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% if @prev_student %>
        <%= link_to "< ì´ì „", diagnostic_teacher_feedback_path(@prev_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">< ì´ì „</button>
      <% end %>
    </div>

    <div style="display: flex; align-items: center; gap: 12px;">
      <input type="text" id="student-search" class="rp-student-search" placeholder="í•™ìƒ ê²€ìƒ‰..." />
      <select id="student-select" class="rp-student-select">
        <option value="">í•™ìƒ ì„ íƒ</option>
        <% @all_students.each do |student| %>
          <option value="<%= student[:id] %>" <%= 'selected' if student[:id] == @student.id %>>
            <%= student[:name] %>
          </option>
        <% end %>
      </select>
    </div>

    <div style="display: flex; align-items: center; gap: 8px;">
      <% if @next_student %>
        <%= link_to "ë‹¤ìŒ >", diagnostic_teacher_feedback_path(@next_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">ë‹¤ìŒ ></button>
      <% end %>
    </div>
  </div>

  <!-- í˜ì´ì§€ ì œëª©: ë³€ê²½ë¨ -->
  <h1 class="rp-page-header__title"><%= @student.name %>ì˜ í”¼ë“œë°± ìƒì„±í•˜ê¸°</h1>
  <p class="rp-page-header__subtitle">18ê°œ ë¬¸í•­ ì¢…í•© ë¶„ì„</p>
</div>

<!-- ===== 3ê°œ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ===== -->
<div class="rp-tabs-container">
  <div class="rp-tabs-nav">
    <button class="rp-tab-button active" data-tab="mcq">
      ê°ê´€ì‹ ë¬¸í•­ í”¼ë“œë°±
      <span class="rp-tab-badge"><%= @responses.count %></span>
    </button>
    <button class="rp-tab-button" data-tab="constructed">
      ì„œìˆ í˜• ë¬¸í•­ í”¼ë“œë°±
      <span class="rp-tab-badge"><%= @constructed_responses.count %></span>
    </button>
    <button class="rp-tab-button" data-tab="tendency">
      ë…ì ì„±í–¥ í”¼ë“œë°±
      <span class="rp-tab-badge">1</span>
    </button>
  </div>

  <!-- ===== íƒ­ ì»¨í…Œì´ë„ˆ: ë¶€ë¶„ë·° ë Œë”ë§ ===== -->
  <%= render 'mcq_tab' %>
  <%= render 'constructed_tab' %>
  <%= render 'tendency_tab' %>
</div>


<!-- ===== CSS ìŠ¤íƒ€ì¼ ===== -->
    <% if @responses.any? %>
      <!-- ìƒë‹¨: ì‘ë‹µ í˜„í™© -->
      <div class="rp-overview-section">
        <h2 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
          ê°ê´€ì‹ ì‘ë‹µ í˜„í™©
          <span style="font-size: 13px; font-weight: 400; color: #64748b; margin-left: 8px;">
            (<span id="correct-count">0</span>/18 ì •ë‹µ)
          </span>
        </h2>

        <!-- ì •ë‹µê³¼ í•™ìƒë‹µ ìš”ì•½ í…Œì´ë¸” -->
        <div style="margin-bottom: 16px; overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed;">
            <tbody>
              <!-- ë¬¸í•­ë²ˆí˜¸ í–‰ -->
              <tr>
                <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: center; width: 60px;">ë¬¸í•­</th>
                <% @responses.each_with_index do |response, index| %>
                  <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: center;">
                    <%= index + 1 %>
                  </th>
                <% end %>
              </tr>

              <!-- ì •ë‹µ í–‰ -->
              <tr>
                <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: left;">ì •ë‹µ</th>
                <% @responses.each_with_index do |response, index| %>
                  <% correct_choice = response.item.item_choices.find { |c| c.choice_score&.is_key } %>
                  <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; background: #f0f9ff; color: #0284c7; font-weight: 600;">
                    <%= correct_choice&.choice_no %>
                  </td>
                <% end %>
              </tr>

              <!-- í•™ìƒë‹µ í–‰ -->
              <tr>
                <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: left;">í•™ìƒë‹µ</th>
                <% @responses.each_with_index do |response, index| %>
                  <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; background: #f5f5f5; color: #475569;">
                    <%= response.selected_choice&.choice_no || 'â€”' %>
                  </td>
                <% end %>
              </tr>

              <!-- ìˆ˜ì •ë‹µ í–‰ -->
              <tr>
                <th style="padding: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; text-align: left;">ìˆ˜ì •ë‹µ</th>
                <% @responses.each_with_index do |response, index| %>
                  <td style="padding: 4px; border: 1px solid #cbd5e1; text-align: center;">
                    <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                      <input type="number"
                             class="rp-edit-answer-input"
                             data-response-id="<%= response.id %>"
                             data-item-index="<%= index %>"
                             min="1"
                             max="5"
                             style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-family: monospace; box-sizing: border-box;">
                      <button class="rp-btn rp-btn--primary rp-btn--xs"
                              data-response-id="<%= response.id %>"
                              style="font-size: 11px; padding: 2px 6px; min-width: 40px;">ì €ì¥</button>
                    </div>
                  </td>
                <% end %>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ìˆ˜í‰ì„  -->
      <div style="height: 1px; background: #e2e8f0; margin: 32px 0;"></div>

      <!-- í•˜ë‹¨: í†µí•© í”¼ë“œë°± ì„¹ì…˜ (ì¢Œìš° ë¶„í• ) -->
      <div style="margin-top: 32px;">
        <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
          ì¢…í•© ë¶„ì„ ë° í”¼ë“œë°±
        </h2>

        <div class="rp-comprehensive-feedback-container" data-student-id="<%= @student.id %>">
          <!-- ì™¼ìª½: í”¼ë“œë°± ì˜ì—­ -->
          <div class="rp-feedback-column">
            <div class="rp-feedback-section">
              <div class="rp-section-header">
                <h4>18ê°œ ë¬¸í•­ ì¢…í•© í”¼ë“œë°±</h4>
                <button class="rp-btn rp-btn--primary" id="generate-comprehensive-feedback">
                  AI ì¢…í•© í”¼ë“œë°± ìƒì„±
                </button>
              </div>

              <!-- í”¼ë“œë°± í‘œì‹œ -->
              <div class="rp-feedback-display" id="comprehensive-feedback-display">
                <% if @comprehensive_feedback.present? %>
                  <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                    <%= simple_format(@comprehensive_feedback) %>
                  </div>
                <% else %>
                  <p style="color: #94a3b8; font-size: 13px;">ì•„ì§ ìƒì„±ëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ì¢…í•© í”¼ë“œë°±ì„ ìƒì„±í•˜ì„¸ìš”.</p>
                <% end %>
              </div>

              <!-- í”¼ë“œë°± ì•¡ì…˜ ë²„íŠ¼ -->
              <div class="rp-feedback-actions" id="comprehensive-feedback-actions" style="display: none; margin-top: 12px; display: flex; gap: 8px;">
                <button class="rp-btn rp-btn--secondary rp-btn--sm" id="edit-comprehensive-feedback">ìˆ˜ì •</button>
                <button class="rp-btn rp-btn--success rp-btn--sm" id="save-feedback-display">ì €ì¥</button>
              </div>

              <!-- í”¼ë“œë°± í¸ì§‘ -->
              <div class="rp-feedback-edit" style="display: none;">
                <textarea class="rp-feedback-textarea" id="comprehensive-feedback-textarea" rows="10" placeholder="ì¢…í•© í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <div class="rp-edit-actions">
                  <button class="rp-btn rp-btn--primary rp-btn--sm" id="save-comprehensive-feedback">ì €ì¥</button>
                  <button class="rp-btn rp-btn--secondary rp-btn--sm" id="cancel-comprehensive-feedback">ì·¨ì†Œ</button>
                </div>
              </div>
            </div>
          </div>

          <!-- ì˜¤ë¥¸ìª½: í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ì˜ì—­ -->
          <div class="rp-prompt-column">
            <div class="rp-feedback-section rp-prompt-section">
              <h4>ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</h4>

              <div class="rp-prompt-controls">
                <div class="rp-form-group">
                  <label for="comprehensive-category">ì¹´í…Œê³ ë¦¬</label>
                  <select id="comprehensive-category" class="rp-prompt-category">
                    <option value="general">ì¼ë°˜</option>
                    <option value="comprehension">ì´í•´ë ¥</option>
                    <option value="explanation">ì„¤ëª…</option>
                    <option value="difficulty">ë‚œì´ë„</option>
                    <option value="strategy">ì „ëµ</option>
                  </select>
                </div>

                <div class="rp-form-group">
                  <label for="comprehensive-prompt">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</label>
                  <textarea id="comprehensive-prompt" class="rp-prompt-input" rows="6"
                            placeholder="ì˜ˆ: í•™ìƒì˜ ì•½ì  ë¶„ì„ê³¼ ê°œì„  ë°©ì•ˆì„ í¬í•¨í•œ í”¼ë“œë°±ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"></textarea>
                </div>

                <div class="rp-form-group">
                  <label class="rp-checkbox">
                    <input type="checkbox" id="comprehensive-save-template">
                    <span>í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</span>
                  </label>
                </div>

                <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                <div class="rp-button-group">
                  <button class="rp-btn rp-btn--secondary" id="refine-comprehensive-feedback" style="flex: 1;">
                    í”„ë¡¬í”„íŠ¸ ìµœì í™”
                  </button>
                  <button class="rp-btn rp-btn--success" id="apply-custom-prompt" style="flex: 1;">
                    í”¼ë“œë°± ìƒì„±
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="rp-empty-state">
        <p>ì´ í•™ìƒì˜ ê°ê´€ì‹ ë¬¸í•­ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    <% end %>
  </div>

  <!-- ===== TAB 2: ì„œìˆ í˜• ë¬¸í•­ í”¼ë“œë°± ===== -->
  <div class="rp-tab-pane" data-tab="constructed">
    <% if @constructed_responses.any? %>
      <div class="rp-constructed-header">
        <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
          ì„œìˆ í˜• ë¬¸í•­ í”¼ë“œë°±
          <span style="font-size: 13px; font-weight: 400; color: #64748b; margin-left: 8px;">
            (<%= @constructed_responses.count %>ê°œ ë¬¸í•­)
          </span>
        </h2>
      </div>

      <div class="rp-constructed-feedback-container">
        <!-- ì™¼ìª½: ë¬¸í•­ ë‚´ìš© ë° ì±„ì  ê¸°ì¤€ -->
        <div class="rp-constructed-left-panel">
          <div class="rp-constructed-prompt-section">
            <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #0f172a;">ë¬¸í•­ ë‚´ìš©</h3>

            <% @constructed_responses.first&.item&.tap do |item| %>
              <div class="rp-prompt-display" style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #e2e8f0;">
                <div class="rp-prompt-text" style="font-size: 13px; line-height: 1.6; color: #1e293b; white-space: pre-wrap;">
                  <%= item.prompt %>
                </div>
              </div>

              <% if item.stimulus.present? %>
                <div class="rp-stimulus-section" style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 3px solid #0ea5e9;">
                  <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #0284c7;">ì§€ë¬¸</h4>
                  <div class="rp-stimulus-text" style="font-size: 12px; line-height: 1.6; color: #1e293b; white-space: pre-wrap;">
                    <%= item.stimulus.content %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>

          <div class="rp-constructed-rubric-section">
            <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #0f172a;">ì±„ì  ê¸°ì¤€</h3>

            <% @constructed_responses.first&.item&.rubric&.rubric_criteria&.each do |criterion| %>
              <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #f8fafc;">
                <div style="font-weight: 600; color: #0f172a; font-size: 12px; margin-bottom: 8px;">
                  <%= criterion.name %>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
                  <% criterion.rubric_levels.sort_by(&:point).each do |level| %>
                    <div style="padding: 6px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-size: 11px;">
                      <div style="font-weight: 600; color: #2f5bff;">
                        <%= level.point %>ì 
                      </div>
                      <div style="color: #64748b; margin-top: 2px; line-height: 1.3;">
                        <%= truncate(level.description, length: 30) %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ìƒí•˜ ì´ë¶„í•  (ë‹µì•ˆ í‘œì‹œ + í”¼ë“œë°±) -->
        <div class="rp-constructed-right-panel">
          <!-- ìƒë‹¨: ë‹µì•ˆ íƒ­ ë° ë‹µì•ˆ í‘œì‹œ -->
          <div class="rp-constructed-answers-section">
            <div class="rp-constructed-answer-tabs">
              <% @constructed_responses.each_with_index do |response, idx| %>
                <button class="rp-answer-tab-button <%= 'active' if idx == 0 %>" data-answer-id="<%= response.id %>">
                  ë¬¸í•­ <%= idx + 1 %>
                </button>
              <% end %>
            </div>

            <div class="rp-answer-display-area" style="padding: 16px;">
              <% @constructed_responses.first&.tap do |response| %>
                <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #0f172a;">í•™ìƒ ë‹µë³€</h4>

                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 12px;">
                  <div style="font-size: 12px; line-height: 1.6; color: #1e293b; white-space: pre-wrap; min-height: 60px;">
                    <%= response.answer_text || "(ë‹µë³€ ì—†ìŒ)" %>
                  </div>
                </div>

                <h4 style="margin: 12px 0 8px 0; font-size: 13px; font-weight: 600; color: #0f172a;">ì±„ì  ê²°ê³¼</h4>

                <div class="rp-rubric-scores-display" style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 3px solid #0ea5e9;">
                  <% response.response_rubric_scores.each do |score| %>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 8px 0; border-bottom: 1px solid #e0f2fe;">
                      <div style="font-size: 12px; color: #1e293b; font-weight: 600;">
                        <%= score.rubric_criterion.name %>
                      </div>
                      <div style="font-size: 12px; font-weight: 700; color: #2f5bff;">
                        <%= score.level %> / <%= score.rubric_criterion.rubric_levels.maximum(:point) %>
                      </div>
                    </div>
                  <% end %>

                  <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 12px 0; margin-top: 8px; font-weight: 700; border-top: 2px solid #0ea5e9;">
                    <div style="font-size: 13px; color: #0f172a;">ì´ì </div>
                    <div style="font-size: 14px; color: #2f5bff;">
                      <%= response.response_rubric_scores.sum(&:level) %> ì 
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- í•˜ë‹¨: í”¼ë“œë°± ì„¹ì…˜ -->
          <div class="rp-constructed-feedback-section" style="display: grid; grid-template-rows: auto 1fr auto; gap: 12px; padding: 16px;">
            <h3 style="margin: 0; font-size: 13px; font-weight: 600; color: #0f172a;">í”¼ë“œë°±</h3>

            <div class="rp-feedback-display" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; min-height: 100px; overflow-y: auto;">
              <p style="color: #94a3b8; font-size: 12px; margin: 0;">
                í”¼ë“œë°±ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒì„±í•˜ì„¸ìš”.
              </p>
            </div>

            <div style="display: flex; gap: 8px;">
              <button class="rp-btn rp-btn--primary" style="flex: 1; font-size: 12px;">
                AI í”¼ë“œë°± ìƒì„±
              </button>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="rp-empty-state">
        <p>ì´ í•™ìƒì˜ ì„œìˆ í˜• ë¬¸í•­ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    <% end %>
  </div>

  <!-- ===== TAB 3: ë…ì ì„±í–¥ í”¼ë“œë°± ===== -->
  <div class="rp-tab-pane" data-tab="tendency">
    <div class="rp-tendency-header">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
        ë…ì ì„±í–¥ ë¶„ì„
      </h2>
      <p style="margin: 0; font-size: 13px; color: #64748b;">í•™ìƒì˜ ë…ì„œ í–‰ë™ íŒ¨í„´ ë° íŠ¹ì„± ë¶„ì„</p>
    </div>

    <div class="rp-tendency-feedback-container">
      <!-- ì™¼ìª½: ì¤‘ì²©ëœ íƒ­ (ì„±í–¥ í•µì‹¬ ì§„ë‹¨ / êµìœ¡ì  ì œì–¸) -->
      <div class="rp-tendency-left-panel">
        <div class="rp-nested-tabs-nav">
          <button class="rp-nested-tab-button active" data-nested-tab="diagnosis">ì„±í–¥ í•µì‹¬ ì§„ë‹¨</button>
          <button class="rp-nested-tab-button" data-nested-tab="recommendations">êµìœ¡ì  ì œì–¸</button>
        </div>

        <div class="rp-nested-tabs-content">
          <!-- ì„±í–¥ í•µì‹¬ ì§„ë‹¨ -->
          <div class="rp-nested-tab-pane active" data-nested-tab="diagnosis">
            <% @diagnosis_items.each do |key, item| %>
              <div class="rp-diagnosis-item" data-item="<%= key %>" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #f8fafc; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.05)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                <div class="rp-diagnosis-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                  <span style="font-size: 18px;"><%= item[:icon] %></span>
                  <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #0f172a; flex: 1;">
                    <%= item[:title] %>
                  </h4>
                </div>
                <div class="rp-diagnosis-content" style="background: white; padding: 8px; border-radius: 4px;">
                  <p style="margin: 0; font-size: 12px; line-height: 1.5; color: #475569;">
                    <%= item[:content] %>
                  </p>
                </div>
              </div>
            <% end %>
          </div>

          <!-- êµìœ¡ì  ì œì–¸ -->
          <div class="rp-nested-tab-pane" data-nested-tab="recommendations">
            <% @recommendation_items.each do |key, item| %>
              <div class="rp-recommendation-item" data-item="<%= key %>" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #f8fafc; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.05)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                  <span style="font-size: 18px;"><%= item[:icon] %></span>
                  <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #0f172a; flex: 1;">
                    <%= item[:title] %>
                  </h4>
                </div>
                <div class="rp-recommendation-content" style="background: white; padding: 8px; border-radius: 4px;">
                  <p style="margin: 0; font-size: 12px; line-height: 1.5; color: #475569;">
                    <%= item[:content] %>
                  </p>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ì½˜í…ì¸  í‘œì‹œ ì˜ì—­ -->
      <div class="rp-tendency-right-panel">
        <div class="rp-content-display-area">
          <div class="rp-tendency-type-badge" style="display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%); border: 2px solid #0ea5e9; border-radius: 12px; margin-bottom: 16px;">
            <div class="rp-tendency-type-badge-icon" style="font-size: 48px; line-height: 1; margin-bottom: 12px;">
              <%= @reader_tendency&.reader_type_icon || "ğŸ“š" %>
            </div>
            <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #0284c7;">
              <%= @reader_tendency&.reader_type_name || "ì§„ë‹¨ ì¤‘" %>
            </h3>
            <p style="margin: 4px 0 0; font-size: 12px; color: #0ea5e9;">
              <%= @reader_tendency&.reader_type_code || "N/A" %>
            </p>
          </div>

          <div class="rp-tendency-type-characteristics" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #0f172a;">ìœ í˜•ë³„ íŠ¹ì„±</h4>
            <p style="margin: 0; font-size: 12px; line-height: 1.6; color: #475569;">
              <%= @reader_tendency&.characteristics || "ì„±í–¥ ë¶„ì„ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤." %>
            </p>
          </div>

          <div class="rp-tendency-display-content" style="padding: 16px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 200px; max-height: 400px; overflow-y: auto;">
            <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #0f172a;">ë…ì„œ ë™ê¸°</h4>
            <div class="rp-content-text" style="font-size: 12px; line-height: 1.7; color: #475569; white-space: pre-wrap;">
              <%= @reader_tendency&.reading_motivation || "ë°ì´í„° ë¶„ì„ ì¤‘..." %>
            </div>
          </div>

          <div class="rp-tendency-metadata" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8;">
            <small>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <%= @reader_tendency&.updated_at&.strftime("%Y-%m-%d %H:%M") || "ì§„í–‰ ì¤‘" %></small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CSS ìŠ¤íƒ€ì¼ ===== -->
<style>
  /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
  .rp-tabs-nav {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    padding: 0;
    gap: 0;
  }

  .rp-tab-button {
    padding: 16px 20px;
    border: none;
    background: transparent;
    color: #64748b;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .rp-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: white;
  }

  .rp-tab-button:hover {
    color: #0f172a;
    background: #f1f5f9;
  }

  .rp-tab-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #2f5bff;
    color: white;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
  }

  .rp-tab-pane {
    display: none;
    padding: 24px;
    animation: fadeIn 0.15s ease;
  }

  .rp-tab-pane.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* íƒ­ ì»¨í…Œì´ë„ˆ */
  .rp-tabs-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    margin-top: 24px;
    overflow: hidden;
  }

  /* ì„œìˆ í˜• ë ˆì´ì•„ì›ƒ */
  .rp-constructed-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-constructed-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-constructed-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-constructed-right-panel {
    display: grid;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    min-height: 800px;
  }

  .rp-constructed-answers-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
  }

  .rp-constructed-answer-tabs {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    overflow-x: auto;
    padding: 8px;
    gap: 4px;
  }

  .rp-answer-tab-button {
    padding: 8px 12px;
    border: none;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid #e2e8f0;
  }

  .rp-answer-tab-button.active {
    background: #2f5bff;
    color: white;
    border-color: #2f5bff;
  }

  /* ë…ì ì„±í–¥ ë ˆì´ì•„ì›ƒ */
  .rp-tendency-feedback-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .rp-tendency-feedback-container {
      grid-template-columns: 1fr;
    }
  }

  .rp-tendency-left-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
  }

  .rp-tendency-right-panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    min-height: 300px;
  }

  /* ì¤‘ì²©ëœ íƒ­ */
  .rp-nested-tabs-nav {
    display: flex;
    border-bottom: 2px solid #e2e8f0;
    background: transparent;
    padding: 0 0 12px 0;
    margin-bottom: 16px;
    gap: 16px;
  }

  .rp-nested-tab-button {
    padding: 8px 12px;
    border: none;
    background: transparent;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    transition: all 0.15s ease;
  }

  .rp-nested-tab-button.active {
    color: #0f172a;
    border-bottom-color: #2f5bff;
    background: #f0f9ff;
  }

  .rp-nested-tab-button:hover {
    color: #0f172a;
  }

  .rp-nested-tab-pane {
    display: none;
  }

  .rp-nested-tab-pane.active {
    display: block;
    animation: fadeIn 0.15s ease;
  }

  /* ë¹ˆ ìƒíƒœ */
  .rp-empty-state {
    text-align: center;
    padding: 40px;
    color: #94a3b8;
  }
</style>

<!-- ===== JavaScript: íƒ­ ìŠ¤ìœ„ì¹­ ===== -->
<script>
  class FeedbackPageTabs {
    constructor() {
      this.currentTab = 'mcq';
      this.currentNestedTab = { tendency: 'diagnosis' };
      this.init();
    }

    init() {
      this.bindMainTabButtons();
      this.bindNestedTabButtons();
    }

    bindMainTabButtons() {
      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;
          this.showTab(tabName);
        });
      });
    }

    bindNestedTabButtons() {
      document.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const parentPane = btn.closest('.rp-tab-pane');
          const parentTab = parentPane.dataset.tab;
          const nestedTabName = btn.dataset.nestedTab;
          this.showNestedTab(parentTab, nestedTabName);
        });
      });
    }

    showTab(tabName) {
      document.querySelectorAll('.rp-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      document.querySelectorAll('.rp-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = document.querySelector(`.rp-tab-pane[data-tab="${tabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = document.querySelector(`.rp-tab-button[data-tab="${tabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentTab = tabName;
    }

    showNestedTab(parentTab, nestedTabName) {
      const parentPane = document.querySelector(`.rp-tab-pane[data-tab="${parentTab}"]`);
      if (!parentPane) return;

      parentPane.querySelectorAll('.rp-nested-tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });

      parentPane.querySelectorAll('.rp-nested-tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      const selectedPane = parentPane.querySelector(`.rp-nested-tab-pane[data-nested-tab="${nestedTabName}"]`);
      if (selectedPane) {
        selectedPane.classList.add('active');
      }

      const selectedBtn = parentPane.querySelector(`.rp-nested-tab-button[data-nested-tab="${nestedTabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }

      this.currentNestedTab[parentTab] = nestedTabName;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const tabs = new FeedbackPageTabs();
    window.__feedbackTabs = tabs;
  });
</script>

<% if @responses.any? %>
  <!-- ê¸°ì¡´ JavaScript ì½”ë“œ: í”¼ë“œë°± ìƒì„± ë° í¸ì§‘ ê¸°ëŠ¥ -->
  <script>
    class FeedbackPage {
      constructor() {
        this.currentComprehensiveFeedback = '<%= @comprehensive_feedback || "" %>'.trim();
        this.bindAll();
      }

      bindAll() {
        // Existing feedback functions...
        this.bindComprehensiveGeneration();
        this.bindComprehensiveFeedbackEdit();
        this.bindPromptRefinement();
        this.bindCorrectCount();
      }

      bindComprehensiveGeneration() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        if (btn) {
          btn.addEventListener('click', () => this.generateComprehensiveFeedback());
        }
      }

      bindComprehensiveFeedbackEdit() {
        const editBtn = document.getElementById('edit-comprehensive-feedback');
        const saveBtn = document.getElementById('save-comprehensive-feedback');
        const cancelBtn = document.getElementById('cancel-comprehensive-feedback');

        if (editBtn) {
          editBtn.addEventListener('click', () => this.toggleFeedbackEdit());
        }
        if (saveBtn) {
          saveBtn.addEventListener('click', () => this.saveComprehensiveFeedback());
        }
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => this.cancelFeedbackEdit());
        }
      }

      bindPromptRefinement() {
        const refineBtn = document.getElementById('refine-comprehensive-feedback');
        const applyBtn = document.getElementById('apply-custom-prompt');

        if (refineBtn) {
          refineBtn.addEventListener('click', () => this.refineCustomPrompt());
        }
        if (applyBtn) {
          applyBtn.addEventListener('click', () => this.applyCustomPromptToFeedback());
        }
      }

      bindCorrectCount() {
        this.updateCorrectCount();
      }

      generateComprehensiveFeedback() {
        const btn = document.getElementById('generate-comprehensive-feedback');
        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = 'AI ìƒì„± ì¤‘...';

        fetch(`/diagnostic_teacher/feedbacks/${studentId}/generate_comprehensive`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');
            const actionsArea = document.getElementById('comprehensive-feedback-actions');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            if (actionsArea) {
              actionsArea.style.display = 'flex';
            }

            this.showToast('âœ… AI ì¢…í•© í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            btn.textContent = 'í”¼ë“œë°± ì¬ìƒì„±';
          }
        })
        .catch(err => {
          this.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
          console.error(err);
        })
        .finally(() => {
          btn.disabled = false;
        });
      }

      toggleFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          const isDisplaying = displayArea.style.display !== 'none';
          displayArea.style.display = isDisplaying ? 'none' : 'block';
          editArea.style.display = isDisplaying ? 'block' : 'none';

          if (isDisplaying) {
            document.getElementById('comprehensive-feedback-textarea').value = this.currentComprehensiveFeedback;
          }
        }
      }

      cancelFeedbackEdit() {
        const displayArea = document.getElementById('comprehensive-feedback-display');
        const editArea = document.querySelector('.rp-feedback-edit');

        if (displayArea && editArea) {
          displayArea.style.display = 'block';
          editArea.style.display = 'none';
        }
      }

      async saveComprehensiveFeedback() {
        const feedbackText = document.getElementById('comprehensive-feedback-textarea').value.trim();
        if (!feedbackText) {
          alert('í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/save_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ feedback: feedbackText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = feedbackText;
            this.toggleFeedbackEdit();
            this.showToast('âœ… í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          }
        } catch (error) {
          this.showToast('ì €ì¥ ì˜¤ë¥˜', 'error');
        }
      }

      refineCustomPrompt() {
        const btn = document.getElementById('refine-comprehensive-feedback');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();

        if (!promptText) {
          alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }

        btn.disabled = true;
        btn.textContent = 'ìµœì í™” ì¤‘...';

        this.showToast('âœ¨ í”„ë¡¬í”„íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ í”¼ë“œë°±ì„ ìƒì„±í•˜ì„¸ìš”.', 'success');
        btn.textContent = 'í”„ë¡¬í”„íŠ¸ ìµœì í™”';
        btn.disabled = false;
      }

      async applyCustomPromptToFeedback() {
        const btn = document.getElementById('apply-custom-prompt');
        const promptText = document.getElementById('comprehensive-prompt').value.trim();

        if (!promptText) {
          alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }

        const studentId = document.querySelector('.rp-comprehensive-feedback-container').dataset.studentId;

        btn.disabled = true;
        btn.textContent = 'í”¼ë“œë°± ìƒì„± ì¤‘...';

        try {
          const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/refine_comprehensive`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.getCSRFToken()
            },
            body: JSON.stringify({ prompt: promptText })
          });

          const data = await response.json();

          if (data.success) {
            this.currentComprehensiveFeedback = data.feedback;
            const displayArea = document.getElementById('comprehensive-feedback-display');

            displayArea.innerHTML = `
              <div style="white-space: pre-wrap; line-height: 1.6; color: #1e293b; font-size: 13px;">
                ${this.escapeHtml(data.feedback)}
              </div>
            `;

            document.getElementById('comprehensive-prompt').value = '';
            this.showToast('âœ¨ ì»¤ìŠ¤í…€ í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          }
        } catch (error) {
          this.showToast('ìƒì„± ì˜¤ë¥˜', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = 'í”¼ë“œë°± ìƒì„±';
        }
      }

      updateCorrectCount() {
        // ì •ë‹µ ê°œìˆ˜ ê³„ì‚° ë¡œì§
      }

      getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').content;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 12px 16px;
          background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          border-radius: 8px;
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const page = new FeedbackPage();
      window.__feedbackPage = page;
    });
  </script>
<% end %>
