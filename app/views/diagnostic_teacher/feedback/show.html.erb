<% content_for :page_title, "í•™ìƒ í”¼ë“œë°±" %>

<div class="rp-page-header">
  <!-- í•™ìƒ íƒìƒ‰ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="rp-student-nav">
    <div style="display: flex; align-items: center; gap: 8px;">
      <%= link_to "â† ëª©ë¡", diagnostic_teacher_feedbacks_path, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% if @prev_student %>
        <%= link_to "< ì´ì „", diagnostic_teacher_feedback_path(@prev_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">< ì´ì „</button>
      <% end %>
    </div>

    <div style="display: flex; align-items: center; gap: 12px;">
      <input type="text" id="student-search" class="rp-student-search" placeholder="í•™ìƒ ê²€ìƒ‰..." />
      <select id="student-select" class="rp-student-select">
        <option value="">í•™ìƒ ì„ íƒ</option>
        <% @all_students.each do |student| %>
          <option value="<%= student[:id] %>" <%= 'selected' if student[:id] == @student.id %>>
            <%= student[:name] %>
          </option>
        <% end %>
      </select>
    </div>

    <div style="display: flex; align-items: center; gap: 8px;">
      <% if @next_student %>
        <%= link_to "ë‹¤ìŒ >", diagnostic_teacher_feedback_path(@next_student[:id]), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <button class="rp-btn rp-btn--secondary rp-btn--sm" disabled style="opacity: 0.5;">ë‹¤ìŒ ></button>
      <% end %>
    </div>
  </div>

  <h1 class="rp-page-header__title"><%= @student.name %>ì˜ ê°ê´€ì‹ í”¼ë“œë°±</h1>
  <p class="rp-page-header__subtitle">18ê°œ ë¬¸í•­ ì¢…í•© ë¶„ì„</p>
</div>

<% if @responses.any? %>
  <!-- ===== ìƒë‹¨: ì‘ë‹µ í˜„í™© (ì‘ì¶•ëœ í˜•íƒœ) ===== -->
  <div class="rp-overview-section">
    <h2 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
      ê°ê´€ì‹ ì‘ë‹µ í˜„í™©
      <span style="font-size: 13px; font-weight: 400; color: #64748b; margin-left: 8px;">
        (<span id="correct-count">0</span>/18 ì •ë‹µ)
      </span>
    </h2>

    <!-- ì •ë‹µê³¼ í•™ìƒë‹µ ìš”ì•½ -->
    <% if @responses.any? %>
      <div style="margin-bottom: 16px; padding: 12px; background: #f1f5f9; border-radius: 6px;">
        <div style="font-size: 12px; color: #475569; margin-bottom: 8px;"><strong>ë¬¸í•­ë³„ ì •ë‹µ/í•™ìƒë‹µ:</strong></div>
        <% @responses.each_with_index do |response, index| %>
          <% correct_choice = response.item.item_choices.find { |c| c.choice_score&.is_key } %>
          <div style="display: inline-block; margin-right: 16px; margin-bottom: 8px; font-size: 11px;">
            <span style="font-weight: 600; color: #0f172a;">ë¬¸í•­ <%= index + 1 %>:</span>
            <span style="color: #0284c7;">ì •ë‹µ <%= correct_choice&.choice_letter %></span>
            <span style="color: #6b7280;">â†’ í•™ìƒ <%= response.selected_choice&.choice_letter || 'ë¯¸ì‘ë‹µ' %></span>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="rp-answer-grid">
      <% @responses.each_with_index do |response, index| %>
        <div class="rp-answer-cell" data-response-id="<%= response.id %>">
          <div class="rp-answer-cell-number"><%= index + 1 %></div>
          <div class="rp-answer-cell-status">
            <% if response.selected_choice %>
              <% is_correct = response.selected_choice.choice_score&.is_key %>
              <span class="rp-cell-badge <%= is_correct ? 'rp-cell-badge--correct' : 'rp-cell-badge--incorrect' %>">
                <%= is_correct ? 'âœ“' : 'âœ—' %>
              </span>
            <% else %>
              <span class="rp-cell-badge rp-cell-badge--unanswered">-</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ìˆ˜í‰ì„  -->
  <div style="height: 1px; background: #e2e8f0; margin: 32px 0;"></div>

  <!-- ===== ì¤‘ê°„: ë¬¸í•­ë³„ í”¼ë“œë°± ì„¹ì…˜ ===== -->
  <div style="margin-top: 32px; margin-bottom: 32px;">
    <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
      ë¬¸í•­ë³„ í”¼ë“œë°±
    </h2>

    <div class="rp-item-feedback-container">
      <% @responses.each_with_index do |response, index| %>
        <div class="rp-item-feedback-card" data-response-id="<%= response.id %>">
          <!-- í—¤ë”: ë¬¸í•­ ë²ˆí˜¸ì™€ ì •ë‹µ í˜„í™© -->
          <div class="rp-item-feedback-header">
            <div>
              <span class="rp-item-number">ë¬¸í•­ <%= index + 1 %></span>
              <% if response.selected_choice %>
                <% is_correct = response.selected_choice.choice_score&.is_key %>
                <span class="rp-item-status <%= is_correct ? 'rp-item-status--correct' : 'rp-item-status--incorrect' %>">
                  <%= is_correct ? 'âœ“ ì •ë‹µ' : 'âœ— ì˜¤ë‹µ' %>
                </span>
              <% else %>
                <span class="rp-item-status rp-item-status--unanswered">- ë¯¸ì‘ë‹µ</span>
              <% end %>
            </div>
          </div>

          <!-- ë¬¸í•­ ì •ë³´ -->
          <div class="rp-item-content">
            <div style="margin-bottom: 12px;">
              <div style="font-size: 12px; color: #64748b; margin-bottom: 6px;"><strong>ë¬¸í•­:</strong></div>
              <div style="font-size: 13px; color: #1e293b; line-height: 1.5;">
                <%= response.item.prompt %>
              </div>
            </div>

            <!-- ë‹µë³€ ë¹„êµ -->
            <div style="display: flex; gap: 16px; margin-top: 12px;">
              <div>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;"><strong>ì •ë‹µ:</strong></div>
                <% correct_choice = response.item.item_choices.find { |c| c.choice_score&.is_key } %>
                <div style="font-size: 13px; color: #0284c7;">
                  <%= correct_choice&.choice_letter %>. <%= correct_choice&.choice_text %>
                </div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;"><strong>í•™ìƒ ë‹µ:</strong></div>
                <% if response.selected_choice %>
                  <div style="font-size: 13px; color: #475569;">
                    <%= response.selected_choice.choice_letter %>. <%= response.selected_choice.choice_text %>
                  </div>
                <% else %>
                  <div style="font-size: 13px; color: #ef4444; font-style: italic;">ë¯¸ì‘ë‹µ</div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- í”¼ë“œë°± ì„¹ì…˜ -->
          <div class="rp-item-feedback-section">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #0f172a;">ê¸°ì¡´ í”¼ë“œë°±</h4>
              <% existing_feedback = response.response_feedbacks.where(source: 'teacher').last %>
              <% if !existing_feedback %>
                <button class="rp-btn rp-btn--primary rp-btn--sm" data-action="generate-item-feedback" data-response-id="<%= response.id %>">
                  AI í”¼ë“œë°± ìƒì„±
                </button>
              <% end %>
            </div>

            <!-- ê¸°ì¡´ í”¼ë“œë°± í‘œì‹œ -->
            <div class="rp-item-existing-feedback" id="existing-feedback-<%= response.id %>">
              <% if existing_feedback %>
                <div class="rp-feedback-item rp-feedback-item--teacher">
                  <span class="rp-badge rp-badge--success">êµì‚¬</span>
                  <p class="rp-feedback-text"><%= existing_feedback.feedback %></p>
                  <small class="rp-feedback-meta">
                    <%= existing_feedback.created_at.strftime("%Y-%m-%d %H:%M") %>
                  </small>
                </div>
              <% else %>
                <p style="color: #94a3b8; font-size: 13px;">ë“±ë¡ëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              <% end %>
            </div>

            <!-- AI í”¼ë“œë°± (ìƒì„± í›„ í‘œì‹œ) -->
            <div class="rp-item-ai-feedback" id="ai-feedback-<%= response.id %>" style="margin-top: 12px; display: none;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #0f172a;">AI í”¼ë“œë°±</h4>
              </div>
              <div id="ai-feedback-content-<%= response.id %>" class="rp-feedback-item rp-feedback-item--ai">
                <span class="rp-badge rp-badge--info">AI</span>
                <p class="rp-feedback-text" id="ai-feedback-text-<%= response.id %>"></p>
              </div>

              <!-- ë°˜ì˜ ë²„íŠ¼ -->
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="rp-btn rp-btn--primary rp-btn--sm" data-action="apply-ai-feedback" data-response-id="<%= response.id %>">
                  ë°˜ì˜
                </button>
                <button class="rp-btn rp-btn--secondary rp-btn--sm" data-action="dismiss-ai-feedback" data-response-id="<%= response.id %>">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>

            <!-- í”„ë¡¬í”„íŠ¸ ì •êµí™” (ì„ íƒì‚¬í•­) -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
              <button class="rp-btn rp-btn--secondary rp-btn--xs" data-action="toggle-prompt-section" data-response-id="<%= response.id %>" style="margin-bottom: 12px;">
                â–¼ í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”
              </button>

              <div class="rp-item-prompt-section" id="prompt-section-<%= response.id %>" style="display: none; background: #f8fafc; padding: 12px; border-radius: 8px;">
                <div style="margin-bottom: 12px;">
                  <label style="display: block; font-size: 12px; font-weight: 600; color: #0f172a; margin-bottom: 6px;">ì¹´í…Œê³ ë¦¬</label>
                  <select class="rp-prompt-category-item" data-response-id="<%= response.id %>" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px;">
                    <option value="general">ì¼ë°˜</option>
                    <option value="comprehension">ì´í•´ë ¥</option>
                    <option value="explanation">ì„¤ëª…</option>
                    <option value="difficulty">ë‚œì´ë„</option>
                    <option value="strategy">ì „ëµ</option>
                  </select>
                </div>

                <div style="margin-bottom: 12px;">
                  <label style="display: block; font-size: 12px; font-weight: 600; color: #0f172a; margin-bottom: 6px;">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</label>
                  <textarea class="rp-prompt-input-item" data-response-id="<%= response.id %>" rows="3"
                            placeholder="ì˜ˆ: ì´ ë¬¸í•­ì˜ í•¨ì • ìš”ì†Œë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”"
                            style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px; font-family: inherit;"></textarea>
                </div>

                <div style="display: flex; gap: 8px;">
                  <button class="rp-btn rp-btn--primary rp-btn--xs" data-action="refine-item-feedback" data-response-id="<%= response.id %>">
                    ì •êµí™”
                  </button>
                  <button class="rp-btn rp-btn--secondary rp-btn--xs" data-action="toggle-prompt-section" data-response-id="<%= response.id %>">
                    ë‹«ê¸°
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ìˆ˜í‰ì„  -->
  <div style="height: 1px; background: #e2e8f0; margin: 32px 0;"></div>

  <!-- ===== í•˜ë‹¨: í†µí•© í”¼ë“œë°± ì„¹ì…˜ ===== -->
  <div style="margin-top: 32px;">
    <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #0f172a;">
      ì¢…í•© ë¶„ì„ ë° í”¼ë“œë°±
    </h2>

    <div class="rp-comprehensive-feedback" data-student-id="<%= @student.id %>">
      <!-- í”¼ë“œë°± ì„¹ì…˜ -->
      <div class="rp-feedback-section">
        <div class="rp-section-header">
          <h4>18ê°œ ë¬¸í•­ ì¢…í•© í”¼ë“œë°±</h4>
          <button class="rp-btn rp-btn--primary" id="generate-comprehensive-feedback">
            AI ì¢…í•© í”¼ë“œë°± ìƒì„±
          </button>
        </div>

        <!-- í”¼ë“œë°± í‘œì‹œ -->
        <div class="rp-feedback-display" id="comprehensive-feedback-display">
          <p style="color: #94a3b8; font-size: 13px;">ì•„ì§ ìƒì„±ëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ì¢…í•© í”¼ë“œë°±ì„ ìƒì„±í•˜ì„¸ìš”.</p>
        </div>

        <!-- í”¼ë“œë°± í¸ì§‘ -->
        <div class="rp-feedback-edit" style="display: none;">
          <textarea class="rp-feedback-textarea" id="comprehensive-feedback-textarea" rows="8" placeholder="ì¢…í•© í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          <div class="rp-edit-actions">
            <button class="rp-btn rp-btn--primary rp-btn--sm" id="save-comprehensive-feedback">ì €ì¥</button>
            <button class="rp-btn rp-btn--secondary rp-btn--sm" id="cancel-comprehensive-feedback">ì·¨ì†Œ</button>
          </div>
        </div>
      </div>

      <!-- í”„ë¡¬í”„íŠ¸ ì •êµí™” ì„¹ì…˜ -->
      <div class="rp-feedback-section rp-prompt-section">
        <h4>í”„ë¡¬í”„íŠ¸ë¡œ í”¼ë“œë°± ì •êµí™”</h4>

        <div class="rp-prompt-controls">
          <div class="rp-form-group">
            <label for="comprehensive-category">ì¹´í…Œê³ ë¦¬</label>
            <select id="comprehensive-category" class="rp-prompt-category">
              <option value="general">ì¼ë°˜</option>
              <option value="comprehension">ì´í•´ë ¥</option>
              <option value="explanation">ì„¤ëª…</option>
              <option value="difficulty">ë‚œì´ë„</option>
              <option value="strategy">ì „ëµ</option>
            </select>
          </div>

          <div class="rp-form-group">
            <label for="comprehensive-prompt">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</label>
            <textarea id="comprehensive-prompt" class="rp-prompt-input" rows="4"
                      placeholder="ì˜ˆ: í•™ìƒì˜ ì•½ì  ë¶„ì„ê³¼ ê°œì„  ë°©ì•ˆì„ í¬í•¨í•œ í”¼ë“œë°±ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"></textarea>
          </div>

          <div class="rp-form-group">
            <label class="rp-checkbox">
              <input type="checkbox" id="comprehensive-save-template">
              <span>í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</span>
            </label>
          </div>

          <button class="rp-btn rp-btn--primary" id="refine-comprehensive-feedback">
            í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”
          </button>
        </div>
      </div>
    </div>
  </div>

<% else %>
  <div class="rp-empty-state">
    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
    <p>ê°ê´€ì‹ ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  </div>
<% end %>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="rp-loading-overlay" style="display: none;">
  <div class="rp-spinner"></div>
  <p>ì²˜ë¦¬ ì¤‘...</p>
</div>

<style>
  /* ===== í•™ìƒ íƒìƒ‰ ë„¤ë¹„ê²Œì´ì…˜ ===== */
  .rp-student-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 24px;
    padding: 12px 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .rp-student-search {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
    width: 150px;
    font-family: inherit;
  }

  .rp-student-search::placeholder {
    color: #94a3b8;
  }

  .rp-student-select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    background: white;
    cursor: pointer;
  }

  /* ===== ìƒë‹¨ í…Œì´ë¸” ìŠ¤íƒ€ì¼ ===== */
  .rp-overview-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }

  /* ì‘ì¶•ëœ ì‘ë‹µ í˜„í™© ê·¸ë¦¬ë“œ */
  .rp-answer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(48px, 1fr));
    gap: 8px;
    max-width: 100%;
  }

  .rp-answer-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: #f8fafc;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 60px;
  }

  .rp-answer-cell:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  .rp-answer-cell-number {
    font-size: 13px;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 6px;
  }

  .rp-answer-cell-status {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
  }

  .rp-cell-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 14px;
    font-weight: 700;
    color: white;
  }

  .rp-cell-badge--correct {
    background: #22c55e;
  }

  .rp-cell-badge--incorrect {
    background: #ef4444;
  }

  .rp-cell-badge--unanswered {
    background: #d1d5db;
    color: #6b7280;
    font-size: 16px;
  }

  .rp-choice-badge {
    display: inline-block;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    font-weight: 600;
    font-size: 11px;
    margin-right: 6px;
  }

  .rp-choice-badge--correct {
    background: #dbeafe;
    color: #0284c7;
  }

  .rp-choice-badge--student {
    background: #2f5bff;
    color: white;
  }

  .rp-choice-label {
    font-size: 12px;
    color: #475569;
  }

  .rp-answer-clickable {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.15s;
  }

  .rp-answer-clickable:hover {
    background: #eff6ff;
    color: #2f5bff;
  }

  .rp-no-answer {
    color: #ef4444;
    font-style: italic;
  }

  .rp-answer-edit-mode {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .rp-answer-select {
    font-family: inherit;
  }

  .rp-score-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }

  .rp-score-badge--correct {
    background: #dcfce7;
    color: #166534;
  }

  .rp-score-badge--incorrect {
    background: #fee2e2;
    color: #991b1b;
  }

  .rp-score-badge--unanswered {
    background: #f3f4f6;
    color: #6b7280;
  }

  /* ===== í•˜ë‹¨ í”¼ë“œë°± ì„¹ì…˜ ìŠ¤íƒ€ì¼ ===== */
  .rp-feedback-container {
    display: grid;
    gap: 24px;
  }

  .rp-feedback-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .rp-feedback-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-feedback-question-number {
    font-size: 14px;
    font-weight: 600;
    color: #0f172a;
  }

  .rp-feedback-section {
    padding: 16px;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-feedback-section:last-child {
    border-bottom: none;
  }

  .rp-feedback-section h4 {
    margin: 0 0 8px;
    font-size: 13px;
    font-weight: 600;
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rp-feedback-section p {
    margin: 8px 0;
    font-size: 13px;
    line-height: 1.6;
    color: #475569;
  }

  .rp-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .rp-btn-edit-small {
    background: none;
    border: none;
    color: #2f5bff;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.15s;
  }

  .rp-btn-edit-small:hover {
    background: #eff6ff;
  }

  .rp-feedback-display {
    display: grid;
    gap: 12px;
  }

  .rp-feedback-item {
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid #cbd5e1;
  }

  .rp-feedback-item--ai {
    border-left-color: #0ea5e9;
    background: #f0f9ff;
  }

  .rp-feedback-item--teacher {
    border-left-color: #22c55e;
    background: #f0fdf4;
  }

  .rp-feedback-text {
    margin: 8px 0;
    font-size: 13px;
    line-height: 1.6;
    color: #475569;
  }

  .rp-feedback-meta {
    display: block;
    font-size: 11px;
    color: #94a3b8;
    margin-top: 8px;
  }

  .rp-feedback-edit {
    display: none;
  }

  .rp-feedback-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
  }

  .rp-feedback-textarea:focus {
    outline: none;
    border-color: #2f5bff;
    box-shadow: 0 0 0 3px rgba(47, 91, 255, 0.1);
  }

  .rp-edit-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .rp-prompt-section {
    background: #f8fafc;
  }

  .rp-prompt-controls {
    padding: 12px;
    background: white;
    border-radius: 8px;
  }

  .rp-form-group {
    margin-bottom: 12px;
  }

  .rp-form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 6px;
  }

  .rp-prompt-category,
  .rp-prompt-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 12px;
    font-family: inherit;
  }

  .rp-prompt-input {
    padding: 10px;
    font-size: 13px;
  }

  .rp-checkbox {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #475569;
    cursor: pointer;
    gap: 6px;
  }

  .rp-checkbox input {
    cursor: pointer;
  }

  .rp-expandable-details summary {
    cursor: pointer;
    user-select: none;
  }

  .rp-expandable-details summary:hover {
    text-decoration: underline;
  }

  .rp-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }

  .rp-badge--success {
    background: #dcfce7;
    color: #166534;
  }

  .rp-badge--danger {
    background: #fee2e2;
    color: #991b1b;
  }

  .rp-badge--secondary {
    background: #f3f4f6;
    color: #6b7280;
  }

  .rp-badge--info {
    background: #dbeafe;
    color: #0284c7;
  }

  /* ===== ë¬¸í•­ë³„ í”¼ë“œë°± ìŠ¤íƒ€ì¼ ===== */
  .rp-item-feedback-container {
    display: grid;
    gap: 16px;
  }

  .rp-item-feedback-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .rp-item-feedback-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-item-number {
    font-weight: 600;
    color: #0f172a;
    font-size: 14px;
    margin-right: 12px;
  }

  .rp-item-status {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }

  .rp-item-status--correct {
    background: #dcfce7;
    color: #166534;
  }

  .rp-item-status--incorrect {
    background: #fee2e2;
    color: #991b1b;
  }

  .rp-item-status--unanswered {
    background: #f3f4f6;
    color: #6b7280;
  }

  .rp-item-content {
    padding: 16px;
    background: white;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-item-feedback-section {
    padding: 16px;
  }

  .rp-item-existing-feedback,
  .rp-item-ai-feedback {
    margin-top: 8px;
  }

  .rp-item-prompt-section {
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }

  .rp-btn--xs {
    padding: 6px 10px;
    font-size: 11px;
  }

  .rp-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    z-index: 1000;
  }

  .rp-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .rp-loading-overlay p {
    color: white;
    font-size: 14px;
    margin: 0;
  }

  .rp-btn--xs {
    padding: 6px 12px;
    font-size: 12px;
  }

  .rp-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
  }
</style>

<script>
  class FeedbackPage {
    constructor() {
      this.init();
    }

    init() {
      this.bindStudentNavigation();
      this.bindItemFeedbackEvents();
      this.bindComprehensiveFeedbackEvents();
      this.updateCorrectCount();
    }

    // í•™ìƒ íƒìƒ‰ ë„¤ë¹„ê²Œì´ì…˜ ë°”ì¸ë”©
    bindStudentNavigation() {
      const studentSelect = document.getElementById('student-select');
      const studentSearch = document.getElementById('student-search');

      if (studentSelect) {
        studentSelect.addEventListener('change', (e) => {
          if (e.target.value) {
            window.location.href = `/diagnostic_teacher/feedbacks/${e.target.value}`;
          }
        });
      }

      if (studentSearch) {
        studentSearch.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          const options = studentSelect.querySelectorAll('option');

          options.forEach(option => {
            if (option.value === '') return;
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(query) ? '' : 'none';
          });
        });
      }
    }

    // ë¬¸í•­ë³„ í”¼ë“œë°± ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindItemFeedbackEvents() {
      // AI í”¼ë“œë°± ìƒì„± ë²„íŠ¼
      document.querySelectorAll('[data-action="generate-item-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const responseId = e.target.dataset.responseId;
          this.generateItemFeedback(responseId);
        });
      });

      // ë°˜ì˜ ë²„íŠ¼
      document.querySelectorAll('[data-action="apply-ai-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const responseId = e.target.dataset.responseId;
          this.applyAIFeedback(responseId);
        });
      });

      // ì·¨ì†Œ ë²„íŠ¼
      document.querySelectorAll('[data-action="dismiss-ai-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const responseId = e.target.dataset.responseId;
          this.dismissAIFeedback(responseId);
        });
      });

      // í”„ë¡¬í”„íŠ¸ ì„¹ì…˜ í† ê¸€
      document.querySelectorAll('[data-action="toggle-prompt-section"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const responseId = e.target.dataset.responseId;
          const section = document.getElementById(`prompt-section-${responseId}`);
          const isHidden = section.style.display === 'none';
          section.style.display = isHidden ? 'block' : 'none';
          e.target.textContent = isHidden ? 'â–² í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”' : 'â–¼ í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”';
        });
      });

      // ì •êµí™” ë²„íŠ¼
      document.querySelectorAll('[data-action="refine-item-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const responseId = e.target.dataset.responseId;
          this.refineItemFeedback(responseId);
        });
      });
    }

    // AI í”¼ë“œë°± ìƒì„±
    async generateItemFeedback(responseId) {
      const btn = document.querySelector(`[data-action="generate-item-feedback"][data-response-id="${responseId}"]`);
      btn.disabled = true;
      btn.textContent = 'AI ìƒì„± ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        });

        const data = await response.json();

        if (data.success) {
          // AI í”¼ë“œë°± í‘œì‹œ
          const feedbackText = document.getElementById(`ai-feedback-text-${responseId}`);
          feedbackText.textContent = data.feedback;

          // AI í”¼ë“œë°± ì„¹ì…˜ í‘œì‹œ
          document.getElementById(`ai-feedback-${responseId}`).style.display = 'block';

          // ë²„íŠ¼ ìˆ¨ê¹€
          btn.style.display = 'none';

          this.showToast('AI í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          alert(data.error || 'AI í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        btn.disabled = false;
        btn.textContent = 'AI í”¼ë“œë°± ìƒì„±';
      }
    }

    // AI í”¼ë“œë°± ë°˜ì˜
    async applyAIFeedback(responseId) {
      const btn = document.querySelector(`[data-action="apply-ai-feedback"][data-response-id="${responseId}"]`);
      const feedbackText = document.getElementById(`ai-feedback-text-${responseId}`).textContent;

      btn.disabled = true;
      btn.textContent = 'ë°˜ì˜ ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_feedback`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({ feedback: feedbackText })
        });

        const data = await response.json();

        if (data.success) {
          // ê¸°ì¡´ í”¼ë“œë°± ì—…ë°ì´íŠ¸
          const existingContainer = document.getElementById(`existing-feedback-${responseId}`);
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          existingContainer.innerHTML = `
            <div class="rp-feedback-item rp-feedback-item--teacher">
              <span class="rp-badge rp-badge--success">êµì‚¬</span>
              <p class="rp-feedback-text">${feedbackText}</p>
              <small class="rp-feedback-meta">${now}</small>
            </div>
          `;

          // AI í”¼ë“œë°± ì„¹ì…˜ ìˆ¨ê¹€
          document.getElementById(`ai-feedback-${responseId}`).style.display = 'none';

          // ìƒì„± ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
          const generateBtn = document.querySelector(`[data-action="generate-item-feedback"][data-response-id="${responseId}"]`);
          if (generateBtn) {
            generateBtn.style.display = 'inline-block';
          }

          this.showToast('í”¼ë“œë°±ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          alert(data.error || 'ë°˜ì˜ ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ë°˜ì˜';
      }
    }

    // AI í”¼ë“œë°± ì·¨ì†Œ
    dismissAIFeedback(responseId) {
      document.getElementById(`ai-feedback-${responseId}`).style.display = 'none';

      // ìƒì„± ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
      const generateBtn = document.querySelector(`[data-action="generate-item-feedback"][data-response-id="${responseId}"]`);
      if (generateBtn) {
        generateBtn.style.display = 'inline-block';
      }
    }

    // í”„ë¡¬í”„íŠ¸ë¡œ ë¬¸í•­ í”¼ë“œë°± ì •êµí™”
    async refineItemFeedback(responseId) {
      const btn = document.querySelector(`[data-action="refine-item-feedback"][data-response-id="${responseId}"]`);
      const category = document.querySelector(`.rp-prompt-category-item[data-response-id="${responseId}"]`).value;
      const promptText = document.querySelector(`.rp-prompt-input-item[data-response-id="${responseId}"]`).value.trim();

      if (!promptText) {
        alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ì •êµí™” ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/refine`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({
            prompt: promptText,
            category: category,
            save_as_template: false
          })
        });

        const data = await response.json();

        if (data.success) {
          // AI í”¼ë“œë°± í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          document.getElementById(`ai-feedback-text-${responseId}`).textContent = data.feedback;

          // AI í”¼ë“œë°± ì„¹ì…˜ í‘œì‹œ
          document.getElementById(`ai-feedback-${responseId}`).style.display = 'block';

          // í”„ë¡¬í”„íŠ¸ ì„¹ì…˜ ìˆ¨ê¹€
          document.getElementById(`prompt-section-${responseId}`).style.display = 'none';

          // í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì´ˆê¸°í™”
          document.querySelector(`.rp-prompt-input-item[data-response-id="${responseId}"]`).value = '';

          this.showToast('í”¼ë“œë°±ì´ ì •êµí™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          alert(data.error || 'ì •êµí™” ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ì •êµí™”';
      }
    }

    // ì¢…í•© í”¼ë“œë°± ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindComprehensiveFeedbackEvents() {
      // AI ì¢…í•© í”¼ë“œë°± ìƒì„±
      const generateBtn = document.getElementById('generate-comprehensive-feedback');
      if (generateBtn) {
        generateBtn.addEventListener('click', () => this.generateComprehensiveFeedback());
      }

      // í¸ì§‘ ëª¨ë“œ í† ê¸€
      const feedbackDisplay = document.getElementById('comprehensive-feedback-display');
      if (feedbackDisplay) {
        feedbackDisplay.addEventListener('click', (e) => {
          if (e.target.closest('.rp-feedback-item')) {
            this.toggleFeedbackEdit();
          }
        });
      }

      // ì €ì¥/ì·¨ì†Œ ë²„íŠ¼
      const saveBtn = document.getElementById('save-comprehensive-feedback');
      const cancelBtn = document.getElementById('cancel-comprehensive-feedback');
      const refineBtn = document.getElementById('refine-comprehensive-feedback');

      if (saveBtn) saveBtn.addEventListener('click', () => this.saveComprehensiveFeedback());
      if (cancelBtn) cancelBtn.addEventListener('click', () => this.cancelFeedbackEdit());
      if (refineBtn) refineBtn.addEventListener('click', () => this.refineComprehensiveFeedback());
    }

    bindFeedbackEvents() {
      // ê¸°ì¡´ ê°œë³„ í”¼ë“œë°± ë°”ì¸ë”© (í•„ìš”ì‹œ ìœ ì§€)

      // í”¼ë“œë°± ìˆ˜ì •
      document.querySelectorAll('[data-action="edit-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const section = e.target.closest('.rp-feedback-section');
          section.querySelector('.rp-feedback-display').style.display = 'none';
          section.querySelector('.rp-feedback-edit').style.display = 'block';
          section.querySelector('.rp-feedback-textarea').focus();
        });
      });

      // í”¼ë“œë°± ì €ì¥
      document.querySelectorAll('[data-action="save-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.saveFeedback(e.target));
      });

      // í”¼ë“œë°± ì·¨ì†Œ
      document.querySelectorAll('[data-action="cancel-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const section = e.target.closest('.rp-feedback-section');
          section.querySelector('.rp-feedback-display').style.display = 'block';
          section.querySelector('.rp-feedback-edit').style.display = 'none';
        });
      });

      // í”¼ë“œë°± ì •êµí™”
      document.querySelectorAll('[data-action="refine-feedback"]').forEach(btn => {
        btn.addEventListener('click', (e) => this.refineFeedback(e.target));
      });
    }

    async generateFeedback(button) {
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;

      button.disabled = true;
      button.textContent = 'AI ìƒì„± ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        });

        const data = await response.json();

        if (data.success) {
          const section = card.querySelector('#feedback-section-' + responseId);
          const displayArea = section.querySelector('.rp-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.insertAdjacentHTML('afterbegin', `
            <div class="rp-feedback-item rp-feedback-item--ai">
              <span class="rp-badge rp-badge--info">AI</span>
              <p class="rp-feedback-text">${data.feedback}</p>
              <small class="rp-feedback-meta">${now}</small>
            </div>
          `);

          button.outerHTML = '<button class="rp-btn-edit-small" data-action="edit-feedback">ìˆ˜ì •</button>';
          this.bindFeedbackEvents();
          this.showToast('AI í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          alert(data.error || 'AI ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        button.disabled = false;
        button.textContent = 'AI í”¼ë“œë°± ìƒì„±';
      }
    }

    async saveFeedback(button) {
      const section = button.closest('.rp-feedback-section');
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;
      const textarea = section.querySelector('.rp-feedback-textarea');
      const feedbackText = textarea.value.trim();

      if (!feedbackText) {
        alert('í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/update_feedback`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({ feedback: feedbackText })
        });

        const data = await response.json();

        if (data.success) {
          const displayArea = section.querySelector('.rp-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.insertAdjacentHTML('afterbegin', `
            <div class="rp-feedback-item rp-feedback-item--teacher">
              <span class="rp-badge rp-badge--success">êµì‚¬</span>
              <p class="rp-feedback-text">${feedbackText}</p>
              <small class="rp-feedback-meta">${now}</small>
            </div>
          `);

          this.showToast('í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          section.querySelector('.rp-feedback-display').style.display = 'block';
          section.querySelector('.rp-feedback-edit').style.display = 'none';
        } else {
          alert(data.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        button.disabled = false;
        button.textContent = 'ì €ì¥';
      }
    }

    async refineFeedback(button) {
      const card = button.closest('.rp-feedback-card');
      const responseId = card.dataset.responseId;
      const section = button.closest('.rp-prompt-section');
      const category = section.querySelector('.rp-prompt-category').value;
      const promptText = section.querySelector('.rp-prompt-input').value.trim();
      const saveAsTemplate = section.querySelector('.rp-save-template').checked;

      if (!promptText) {
        alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      button.disabled = true;
      button.textContent = 'ì •êµí™” ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${responseId}/refine`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({
            prompt: promptText,
            category: category,
            save_as_template: saveAsTemplate
          })
        });

        const data = await response.json();

        if (data.success) {
          const feedbackSection = card.querySelector('#feedback-section-' + responseId);
          const displayArea = feedbackSection.querySelector('.rp-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.insertAdjacentHTML('afterbegin', `
            <div class="rp-feedback-item rp-feedback-item--teacher">
              <span class="rp-badge rp-badge--success">êµì‚¬</span>
              <p class="rp-feedback-text">${data.feedback}</p>
              <small class="rp-feedback-meta">${now}</small>
            </div>
          `);

          section.querySelector('.rp-prompt-input').value = '';
          section.querySelector('.rp-save-template').checked = false;

          this.showToast('í”¼ë“œë°±ì´ ì •êµí™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          if (saveAsTemplate) this.showToast('í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        } else {
          alert(data.error || 'ì •êµí™” ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        button.disabled = false;
        button.textContent = 'í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”';
      }
    }

    // ì¢…í•© í”¼ë“œë°± ìƒì„±
    async generateComprehensiveFeedback() {
      const btn = document.getElementById('generate-comprehensive-feedback');
      const studentId = document.querySelector('.rp-comprehensive-feedback').dataset.studentId;

      btn.disabled = true;
      btn.textContent = 'AI ìƒì„± ì¤‘...';

      try {
        const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/generate_comprehensive`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          }
        });

        const data = await response.json();

        if (data.success) {
          const displayArea = document.getElementById('comprehensive-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.innerHTML = `
            <div class="rp-feedback-item rp-feedback-item--ai">
              <span class="rp-badge rp-badge--info">AI ì¢…í•©</span>
              <p class="rp-feedback-text">${data.feedback}</p>
              <small class="rp-feedback-meta">${now}</small>
              <button class="rp-btn-edit-small" onclick="this.closest('.rp-comprehensive-feedback').__feedbackPage.toggleFeedbackEdit()">ìˆ˜ì •</button>
            </div>
          `;

          btn.textContent = 'ì¬ìƒì„±';
          this.showToast('AI ì¢…í•© í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          window.__feedbackPage = this; // ì „ì—­ ì°¸ì¡°
        } else {
          alert(data.error || 'AI ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        btn.disabled = false;
      }
    }

    toggleFeedbackEdit() {
      const displayArea = document.querySelector('.rp-comprehensive-feedback .rp-feedback-display');
      const editArea = document.querySelector('.rp-comprehensive-feedback .rp-feedback-edit');

      if (displayArea && editArea) {
        const isDisplaying = displayArea.style.display !== 'none';
        displayArea.style.display = isDisplaying ? 'none' : 'block';
        editArea.style.display = isDisplaying ? 'block' : 'none';

        if (isDisplaying) {
          const feedbackText = displayArea.querySelector('.rp-feedback-text')?.textContent || '';
          document.getElementById('comprehensive-feedback-textarea').value = feedbackText;
          document.getElementById('comprehensive-feedback-textarea').focus();
        }
      }
    }

    cancelFeedbackEdit() {
      const displayArea = document.querySelector('.rp-comprehensive-feedback .rp-feedback-display');
      const editArea = document.querySelector('.rp-comprehensive-feedback .rp-feedback-edit');

      if (displayArea && editArea) {
        displayArea.style.display = 'block';
        editArea.style.display = 'none';
      }
    }

    async saveComprehensiveFeedback() {
      const btn = document.getElementById('save-comprehensive-feedback');
      const textarea = document.getElementById('comprehensive-feedback-textarea');
      const feedbackText = textarea.value.trim();

      if (!feedbackText) {
        alert('í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const studentId = document.querySelector('.rp-comprehensive-feedback').dataset.studentId;
        const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/save_comprehensive`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({ feedback: feedbackText })
        });

        const data = await response.json();

        if (data.success) {
          const displayArea = document.getElementById('comprehensive-feedback-display');
          const editArea = document.querySelector('.rp-comprehensive-feedback .rp-feedback-edit');

          displayArea.innerHTML = `
            <div class="rp-feedback-item rp-feedback-item--teacher">
              <span class="rp-badge rp-badge--success">êµì‚¬</span>
              <p class="rp-feedback-text">${feedbackText}</p>
              <small class="rp-feedback-meta">ë°©ê¸ˆ ì €ì¥ë¨</small>
              <button class="rp-btn-edit-small" onclick="this.closest('.rp-comprehensive-feedback').__feedbackPage.toggleFeedbackEdit()">ìˆ˜ì •</button>
            </div>
          `;

          displayArea.style.display = 'block';
          editArea.style.display = 'none';
          this.showToast('í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          alert(data.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ì €ì¥';
      }
    }

    async refineComprehensiveFeedback() {
      const btn = document.getElementById('refine-comprehensive-feedback');
      const category = document.getElementById('comprehensive-category').value;
      const promptText = document.getElementById('comprehensive-prompt').value.trim();
      const saveAsTemplate = document.getElementById('comprehensive-save-template').checked;

      if (!promptText) {
        alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ì •êµí™” ì¤‘...';

      try {
        const studentId = document.querySelector('.rp-comprehensive-feedback').dataset.studentId;
        const response = await fetch(`/diagnostic_teacher/feedbacks/${studentId}/refine_comprehensive`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': this.getCSRFToken()
          },
          body: JSON.stringify({
            prompt: promptText,
            category: category,
            save_as_template: saveAsTemplate
          })
        });

        const data = await response.json();

        if (data.success) {
          const displayArea = document.getElementById('comprehensive-feedback-display');
          const now = new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          displayArea.innerHTML = `
            <div class="rp-feedback-item rp-feedback-item--teacher">
              <span class="rp-badge rp-badge--success">êµì‚¬</span>
              <p class="rp-feedback-text">${data.feedback}</p>
              <small class="rp-feedback-meta">${now}</small>
              <button class="rp-btn-edit-small" onclick="this.closest('.rp-comprehensive-feedback').__feedbackPage.toggleFeedbackEdit()">ìˆ˜ì •</button>
            </div>
          `;

          document.getElementById('comprehensive-prompt').value = '';
          document.getElementById('comprehensive-save-template').checked = false;

          this.showToast('í”¼ë“œë°±ì´ ì •êµí™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          if (saveAsTemplate) this.showToast('í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        } else {
          alert(data.error || 'ì •êµí™” ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      } finally {
        btn.disabled = false;
        btn.textContent = 'í”„ë¡¬í”„íŠ¸ë¡œ ì •êµí™”';
      }
    }

    updateCorrectCount() {
      const totalCorrect = document.querySelectorAll('.rp-score-badge--correct').length;
      document.getElementById('correct-count').textContent = totalCorrect;
    }

    showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        z-index: 999;
        opacity: 0;
        transform: translateY(100px);
        transition: all 0.3s;
      `;
      toast.textContent = message;
      toast.style.background = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#0ea5e9';
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      }, 10);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(100px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    getCSRFToken() {
      return document.querySelector('meta[name="csrf-token"]').content;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const feedbackPage = new FeedbackPage();
    window.__feedbackPage = feedbackPage;

    // ì¢…í•© í”¼ë“œë°± ì»¨í…Œì´ë„ˆì—ë„ ì°¸ì¡° ì¶”ê°€
    const comprehensiveContainer = document.querySelector('.rp-comprehensive-feedback');
    if (comprehensiveContainer) {
      comprehensiveContainer.__feedbackPage = feedbackPage;
    }
  });
</script>
