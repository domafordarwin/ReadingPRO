<% content_for :title do %><%= @student.name %>_발문역량보고서<% end %>

<% content_for :print_styles do %>
<style>
  /* ── Profile ── */
  .qrp-profile {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; border-radius: 10px; padding: 18px 20px; margin-bottom: 16px;
  }
  .qrp-profile__left { display: flex; align-items: center; gap: 14px; }
  .qrp-profile__avatar {
    width: 42px; height: 42px; background: rgba(255,255,255,0.2);
    border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 20px; font-weight: 700; flex-shrink: 0;
  }
  .qrp-profile__name { font-size: 18px; font-weight: 700; margin: 0 0 3px; }
  .qrp-profile__meta { font-size: 11px; opacity: 0.85; margin: 0; }

  /* ── Stats ── */
  .qrp-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 14px; }
  .qrp-stat {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; text-align: center;
  }
  .qrp-stat__label { font-size: 9px; color: #94a3b8; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
  .qrp-stat__value { font-size: 17px; font-weight: 700; color: #0f172a; }
  .qrp-stat__value--blue { color: #2563eb; }
  .qrp-stat__value--green { color: #16a34a; }
  .qrp-stat__value--purple { color: #7c3aed; }

  /* ── Stage scores ── */
  .qrp-stages { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
  .qrp-stage {
    background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;
  }
  .qrp-stage__num {
    width: 24px; height: 24px; border-radius: 6px; color: white;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; margin-bottom: 6px;
  }
  .qrp-stage__info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .qrp-stage__name { font-size: 12px; font-weight: 600; color: #334155; }
  .qrp-stage__score { font-size: 15px; font-weight: 700; }
  .qrp-stage__bar { height: 5px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
  .qrp-stage__bar-fill { height: 100%; border-radius: 3px; }

  /* ── Report content styles (from _report_content) ── */
  .qrc-section { margin-bottom: 16px; }

  .qrc-hero { padding: 16px; background: linear-gradient(135deg, #eff6ff, #f5f3ff); border-radius: 10px; border: 1px solid #c7d2fe; }
  .qrc-hero__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .qrc-hero__label { font-size: var(--rp-font-size-xs); font-weight: 600; color: var(--rp-primary); text-transform: uppercase; letter-spacing: 0.05em; }
  .qrc-hero__badges { display: flex; align-items: center; gap: 10px; }
  .qrc-hero__avg { font-size: var(--rp-font-size-xl); font-weight: 700; color: var(--rp-primary); }
  .qrc-hero__level { padding: 3px 10px; background: white; border: 2px solid var(--rp-primary); border-radius: 999px; font-size: var(--rp-font-size-xs); font-weight: 700; color: var(--rp-primary); }
  .qrc-hero__split { display: grid; grid-template-columns: 2fr 3fr; gap: 16px; align-items: start; }
  .qrc-hero__chart { text-align: center; min-width: 0; }
  .qrc-hero__chart-title { font-size: var(--rp-font-size-sm); font-weight: 600; color: #334155; margin: 0 0 6px; }
  .qrc-hero__legend { display: flex; justify-content: center; gap: 12px; margin-top: 6px; flex-wrap: wrap; }
  .qrc-hero__summary-title { font-size: var(--rp-font-size-base); font-weight: 600; color: #334155; margin: 0 0 8px; }
  .qrc-hero__summary-text { font-size: var(--rp-font-size-sm); line-height: 1.8; color: #475569; margin-bottom: 10px; }
  .qrc-hero__bars { margin-bottom: 10px; }
  .qrc-hero__bar-row { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .qrc-hero__bar-label { font-size: var(--rp-font-size-2xs); color: #64748b; width: 60px; flex-shrink: 0; text-align: right; }
  .qrc-hero__bar-track { flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
  .qrc-hero__bar-fill { height: 100%; border-radius: 3px; }
  .qrc-hero__bar-score { font-size: var(--rp-font-size-2xs); font-weight: 600; width: 24px; text-align: right; }
  .qrc-hero__highlights { display: flex; flex-direction: column; gap: 3px; }
  .qrc-hero__highlight { font-size: var(--rp-font-size-xs); padding: 4px 8px; border-radius: 4px; }
  .qrc-hero__highlight--top { background: #f0fdf4; color: #166534; }
  .qrc-hero__highlight--weak { background: #fffbeb; color: #92400e; }

  .qrc-group-title { font-size: var(--rp-font-size-md); font-weight: 700; margin: 0 0 10px; padding-bottom: 6px; border-bottom: 2px solid; }

  .qrc-cards-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .qrc-cards-grid--1 { grid-template-columns: 1fr; }
  .qrc-cards-grid--2 { grid-template-columns: repeat(2, 1fr); }

  .qrc-card { padding: 12px; border: 1px solid; border-radius: 8px; page-break-inside: avoid; }
  .qrc-card__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .qrc-card__name { font-size: var(--rp-font-size-sm); font-weight: 600; }
  .qrc-card__score { font-size: var(--rp-font-size-xl); font-weight: 700; }
  .qrc-card__bar { width: 100%; height: 5px; background: rgba(255,255,255,0.6); border-radius: 3px; margin-bottom: 8px; overflow: hidden; }
  .qrc-card__bar-fill { height: 100%; border-radius: 3px; }
  .qrc-card__feedback { font-size: var(--rp-font-size-xs); color: #475569; line-height: 1.7; margin-bottom: 6px; }
  .qrc-card__list { margin-top: 4px; }
  .qrc-card__item { font-size: var(--rp-font-size-2xs); display: flex; align-items: flex-start; gap: 3px; margin-bottom: 2px; }
  .qrc-card__item--good { color: #16a34a; }
  .qrc-card__item--improve { color: #f59e0b; }

  .qrc-opinion { padding: 16px; background: white; border: 1px solid #e2e8f0; border-radius: 10px; }
  .qrc-opinion__title { font-size: var(--rp-font-size-md); font-weight: 700; color: #0f172a; margin: 0 0 10px; }
  .qrc-opinion__body { font-size: var(--rp-font-size-base); line-height: 1.9; color: #334155; padding: 12px; background: #fafbff; border: 1px solid #e0e7ff; border-radius: 8px; border-left: 3px solid #6366f1; }

  .qrc-priority { padding: 12px; background: #fafbff; border: 1px solid #e2e8f0; border-radius: 8px; border-left: 3px solid; margin-bottom: 10px; page-break-inside: avoid; }
  .qrc-priority__header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .qrc-priority__num { width: 24px; height: 24px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: var(--rp-font-size-sm); font-weight: 700; flex-shrink: 0; }
  .qrc-priority__area { font-size: var(--rp-font-size-md); font-weight: 700; color: #0f172a; }
  .qrc-priority__levels { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
  .qrc-priority__level { padding: 8px; border-radius: 6px; font-size: var(--rp-font-size-xs); line-height: 1.6; color: #475569; }
  .qrc-priority__level--current { background: #fef2f2; }
  .qrc-priority__level--target { background: #f0fdf4; }
  .qrc-priority__level-label { font-size: var(--rp-font-size-2xs); font-weight: 600; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.05em; }
  .qrc-priority__level--current .qrc-priority__level-label { color: #dc2626; }
  .qrc-priority__level--target .qrc-priority__level-label { color: #16a34a; }
  .qrc-priority__block { margin-bottom: 6px; }
  .qrc-priority__block-title { font-size: var(--rp-font-size-xs); font-weight: 600; margin-bottom: 4px; }
  .qrc-priority__list { margin: 0; padding-left: 16px; font-size: var(--rp-font-size-xs); color: #475569; line-height: 1.7; }
  .qrc-priority__books { display: flex; flex-wrap: wrap; gap: 4px; }
  .qrc-priority__book { padding: 2px 8px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 999px; font-size: var(--rp-font-size-xs); color: #92400e; }

  .qrc-roadmap-title { font-size: var(--rp-font-size-base); font-weight: 600; color: #1e40af; margin: 14px 0 8px; }
  .qrc-roadmap { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px; }
  .qrc-roadmap__card { padding: 10px; border: 1px solid; border-radius: 8px; }
  .qrc-roadmap__label { font-size: var(--rp-font-size-xs); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
  .qrc-roadmap__text { font-size: var(--rp-font-size-xs); color: #475569; line-height: 1.7; }

  .qrc-strength { padding: 10px; background: linear-gradient(135deg, #ecfdf5, #f0fdf4); border: 1px solid #a7f3d0; border-radius: 8px; }
  .qrc-strength__title { font-size: var(--rp-font-size-base); font-weight: 600; color: #166534; margin-bottom: 6px; }
  .qrc-strength__text { font-size: var(--rp-font-size-xs); color: #064e3b; line-height: 1.8; }

  .qrc-stage-block { margin-bottom: 14px; }
  .qrc-stage-block__title { font-size: var(--rp-font-size-base); font-weight: 600; color: #334155; margin: 0 0 8px; padding-bottom: 4px; border-bottom: 1px solid #e2e8f0; }
  .qrc-question { padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 6px; page-break-inside: avoid; }
  .qrc-question__header { display: flex; align-items: flex-start; gap: 6px; margin-bottom: 4px; }
  .qrc-question__num { width: 18px; height: 18px; border-radius: 4px; background: #f1f5f9; color: #64748b; display: flex; align-items: center; justify-content: center; font-size: var(--rp-font-size-2xs); font-weight: 700; flex-shrink: 0; }
  .qrc-question__text { flex: 1; font-size: var(--rp-font-size-sm); font-weight: 500; color: #1e293b; line-height: 1.5; }
  .qrc-question__score { font-size: var(--rp-font-size-base); font-weight: 700; flex-shrink: 0; }
  .qrc-question__meta { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 4px; }
  .qrc-question__tag { font-size: var(--rp-font-size-2xs); padding: 1px 6px; background: #f1f5f9; border-radius: 3px; color: #64748b; }
  .qrc-question__feedback { font-size: var(--rp-font-size-xs); color: #64748b; line-height: 1.6; padding: 6px; background: #f8fafc; border-radius: 4px; }

  .qrc-meta { font-size: var(--rp-font-size-xs); color: #94a3b8; display: flex; gap: 12px; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid #e2e8f0; }

  /* Radar chart in print */
  .qrp-radar svg { max-width: 280px; width: 100%; height: auto; }
  .qrp-legend { display: flex; justify-content: center; gap: 12px; margin-top: 6px; }
  .qrp-legend__item { display: flex; align-items: center; gap: 4px; font-size: 9px; color: #475569; font-weight: 500; }
  .qrp-legend__dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
</style>
<% end %>

<%
  level = @module.level
  level_label = QuestioningLevelConfig::LEVEL_LABELS[level] rescue level
  total_questions = @questioning_session.student_questions.size
  duration_min = @questioning_session.time_spent_seconds.to_i > 0 ? (@questioning_session.time_spent_seconds / 60.0).round : nil
  stage_scores = @questioning_session.stage_scores || {}
  stage_names = { 1 => "책문열기", 2 => "이야기 나누기", 3 => "삶 적용" }
%>

<!-- 프로필 헤더 -->
<div class="qrp-profile">
  <div class="qrp-profile__left">
    <div class="qrp-profile__avatar"><%= @student.name&.first || "?" %></div>
    <div>
      <h1 class="qrp-profile__name"><%= @student.name %>의 발문 역량 종합 보고서</h1>
      <p class="qrp-profile__meta">
        <%= @module.title %> · <%= level_label %>
        · <%= @questioning_session.completed_at&.strftime("%Y-%m-%d") || Date.current.strftime("%Y-%m-%d") %>
      </p>
    </div>
  </div>
</div>

<!-- 세션 요약 통계 -->
<div class="qrp-stats">
  <div class="qrp-stat">
    <div class="qrp-stat__label">총점</div>
    <div class="qrp-stat__value"><%= @questioning_session.total_score ? @questioning_session.total_score.round(1) : "-" %></div>
  </div>
  <div class="qrp-stat">
    <div class="qrp-stat__label">발문 수</div>
    <div class="qrp-stat__value qrp-stat__value--blue"><%= total_questions %>개</div>
  </div>
  <div class="qrp-stat">
    <div class="qrp-stat__label">소요 시간</div>
    <div class="qrp-stat__value qrp-stat__value--green"><%= duration_min ? "#{duration_min}분" : "-" %></div>
  </div>
  <div class="qrp-stat">
    <div class="qrp-stat__label">성취 수준</div>
    <div class="qrp-stat__value qrp-stat__value--purple"><%= @report.literacy_level_label %></div>
  </div>
</div>

<!-- 단계별 점수 -->
<div class="qrp-stages">
  <% (1..3).each do |s| %>
    <%
      score = stage_scores[s.to_s]
      score_color = if score.nil? then "#94a3b8"
                    elsif score >= 80 then "#16a34a"
                    elsif score >= 60 then "#2563eb"
                    elsif score >= 40 then "#f59e0b"
                    else "#dc2626"
                    end
    %>
    <div class="qrp-stage">
      <div class="qrp-stage__num" style="background: <%= score_color %>;"><%= s %></div>
      <div class="qrp-stage__info">
        <div class="qrp-stage__name"><%= s %>단계: <%= stage_names[s] %></div>
        <div class="qrp-stage__score" style="color: <%= score_color %>;"><%= score ? "#{score.round(1)}점" : "-" %></div>
      </div>
      <% if score %>
        <div class="qrp-stage__bar">
          <div class="qrp-stage__bar-fill" style="width: <%= score %>%; background: <%= score_color %>;"></div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<!-- 발문 역량 보고서 본문 -->
<%
  # _report_content 파셜 대신 직접 렌더링 (JS 레이더 차트 → 서버사이드 SVG 대체)
  sections = @report.report_sections || {}

  radar_mapping = [
    { key: "reading_comprehension", label: "읽기 이해력", group: "이해 역량" },
    { key: "inferential_reasoning", label: "추론 능력", group: "이해 역량" },
    { key: "critical_thinking", label: "비판적 사고력", group: "이해 역량" },
    { key: "creative_thinking", label: "창의적 사고력", group: "사고 역량" },
    { key: "metacognition", label: "메타인지", group: "사고 역량" },
    { key: "vocabulary_usage", label: "어휘 활용", group: "사고 역량" },
    { key: "text_connection", label: "텍스트 연결", group: "소통·적용 역량" },
    { key: "communication", label: "의사소통", group: "소통·적용 역량" },
    { key: "personal_application", label: "삶 적용", group: "소통·적용 역량" }
  ]

  radar_data = radar_mapping.map do |item|
    sc = sections.dig(item[:key], "score") || 0
    { name: item[:label], group: item[:group], score: sc }
  end

  conditional_sections = [
    { key: "discussion_competency", label: "토론 역량" },
    { key: "argumentative_writing", label: "논증적 글쓰기" }
  ].select { |cs| sections.dig(cs[:key], "score").present? }

  avg_score = radar_data.any? ? (radar_data.sum { |d| d[:score] } / radar_data.size.to_f).round(1) : 0
  top_areas = radar_data.sort_by { |d| -d[:score] }.first(3)
  weak_areas = radar_data.sort_by { |d| d[:score] }.first(3)

  level_config = case level
    when "elementary_low"
      { summary_title: "선생님의 이야기", section_title: "어떤 점이 좋았을까?", recommendation_title: "이런 것도 해보자!" }
    when "elementary_high"
      { summary_title: "성장 분석", section_title: "역량별 상세 분석", recommendation_title: "성장을 위한 제안" }
    when "middle"
      { summary_title: "종합 평가", section_title: "역량별 분석", recommendation_title: "학습 권고사항" }
    when "high"
      { summary_title: "종합 분석", section_title: "역량별 심층 분석", recommendation_title: "심화 학습 방향" }
    else
      { summary_title: "종합 평가", section_title: "역량별 상세 분석", recommendation_title: "학습 권고사항" }
    end

  group_colors = {
    "이해 역량" => { bg: "#eff6ff", border: "#bfdbfe", title: "#1e40af", bar: "#3b82f6" },
    "사고 역량" => { bg: "#faf5ff", border: "#e9d5ff", title: "#6b21a8", bar: "#8b5cf6" },
    "소통·적용 역량" => { bg: "#f0fdf4", border: "#bbf7d0", title: "#166534", bar: "#16a34a" }
  }
%>

<!-- 1. 종합 발문 역량 수준 + 레이더 차트 -->
<div class="qrc-section qrc-hero">
  <div class="qrc-hero__header">
    <span class="qrc-hero__label">종합 발문 역량 수준</span>
    <div class="qrc-hero__badges">
      <span class="qrc-hero__avg"><%= avg_score %>점</span>
      <span class="qrc-hero__level"><%= @report.literacy_level_label %></span>
    </div>
  </div>
  <div class="qrc-hero__split">
    <div class="qrc-hero__chart">
      <h4 class="qrc-hero__chart-title">9개 역량 프로필</h4>
      <% if @radar_svg.present? %>
        <div class="qrp-radar"><%= raw @radar_svg %></div>
        <div class="qrp-legend">
          <div class="qrp-legend__item"><span class="qrp-legend__dot" style="background:#3b82f6;"></span>이해 역량</div>
          <div class="qrp-legend__item"><span class="qrp-legend__dot" style="background:#8b5cf6;"></span>사고 역량</div>
          <div class="qrp-legend__item"><span class="qrp-legend__dot" style="background:#16a34a;"></span>소통·적용 역량</div>
        </div>
      <% end %>
    </div>
    <div class="qrc-hero__summary">
      <h4 class="qrc-hero__summary-title"><%= level_config[:summary_title] %></h4>
      <% if @report.overall_summary.present? %>
        <div class="qrc-hero__summary-text"><%= simple_format(@report.overall_summary.truncate(600)) %></div>
      <% end %>
      <div class="qrc-hero__bars">
        <% radar_data.each do |rd| %>
          <% sc = rd[:score]; bar_color = sc >= 80 ? "#16a34a" : sc >= 60 ? "#2563eb" : sc >= 40 ? "#f59e0b" : "#dc2626" %>
          <div class="qrc-hero__bar-row">
            <span class="qrc-hero__bar-label"><%= rd[:name] %></span>
            <div class="qrc-hero__bar-track"><div class="qrc-hero__bar-fill" style="width:<%= sc %>%;background:<%= bar_color %>;"></div></div>
            <span class="qrc-hero__bar-score" style="color:<%= bar_color %>;"><%= sc.to_i %></span>
          </div>
        <% end %>
      </div>
      <div class="qrc-hero__highlights">
        <div class="qrc-hero__highlight qrc-hero__highlight--top"><strong>우수:</strong> <%= top_areas.map { |a| "#{a[:name]}(#{a[:score].to_i})" }.join(", ") %></div>
        <div class="qrc-hero__highlight qrc-hero__highlight--weak"><strong>보완:</strong> <%= weak_areas.map { |a| "#{a[:name]}(#{a[:score].to_i})" }.join(", ") %></div>
      </div>
    </div>
  </div>
</div>

<!-- 2. 역량별 상세 분석 -->
<% ["이해 역량", "사고 역량", "소통·적용 역량"].each do |group_name| %>
  <% group_items = radar_mapping.select { |r| r[:group] == group_name } %>
  <% gc = group_colors[group_name] %>
  <div class="qrc-section" style="page-break-inside: avoid;">
    <h3 class="qrc-group-title" style="color:<%= gc[:title] %>;border-bottom-color:<%= gc[:border] %>;"><%= group_name %></h3>
    <div class="qrc-cards-grid">
      <% group_items.each do |item| %>
        <% section = sections[item[:key]] || {}; sc = section["score"]; feedback = section["feedback"]; strengths = section["strengths"] || []; improvements = section["improvements"] || []
           score_color = sc.nil? ? "#94a3b8" : sc >= 80 ? "#16a34a" : sc >= 60 ? "#2563eb" : sc >= 40 ? "#f59e0b" : "#dc2626" %>
        <div class="qrc-card" style="background:<%= gc[:bg] %>;border-color:<%= gc[:border] %>;">
          <div class="qrc-card__header">
            <span class="qrc-card__name" style="color:<%= gc[:title] %>;"><%= item[:label] %></span>
            <span class="qrc-card__score" style="color:<%= score_color %>;"><%= sc.present? ? (sc.is_a?(Float) ? sc.round(1) : sc) : "N/A" %></span>
          </div>
          <% if sc.present? %><div class="qrc-card__bar"><div class="qrc-card__bar-fill" style="width:<%= sc %>%;background:<%= gc[:bar] %>;"></div></div><% end %>
          <% if feedback.present? %><div class="qrc-card__feedback"><%= simple_format(feedback) %></div><% end %>
          <% if strengths.any? %><div class="qrc-card__list"><% strengths.first(3).each do |s| %><div class="qrc-card__item qrc-card__item--good"><span>✓</span> <%= s %></div><% end %></div><% end %>
          <% if improvements.any? %><div class="qrc-card__list"><% improvements.first(3).each do |imp| %><div class="qrc-card__item qrc-card__item--improve"><span>△</span> <%= imp %></div><% end %></div><% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- 조건부 역량 -->
<% if conditional_sections.any? %>
  <div class="qrc-section" style="page-break-inside: avoid;">
    <h3 class="qrc-group-title" style="color:#475569;border-bottom-color:#e2e8f0;">추가 역량 평가</h3>
    <div class="qrc-cards-grid qrc-cards-grid--<%= conditional_sections.size %>">
      <% conditional_sections.each do |cs| %>
        <% section = sections[cs[:key]] || {}; sc = section["score"]; feedback = section["feedback"]; strengths = section["strengths"] || []; improvements = section["improvements"] || []
           score_color = sc.nil? ? "#94a3b8" : sc >= 80 ? "#16a34a" : sc >= 60 ? "#2563eb" : sc >= 40 ? "#f59e0b" : "#dc2626" %>
        <div class="qrc-card" style="background:#f8fafc;border-color:#e2e8f0;">
          <div class="qrc-card__header"><span class="qrc-card__name" style="color:#334155;"><%= cs[:label] %></span><span class="qrc-card__score" style="color:<%= score_color %>;"><%= sc %></span></div>
          <% if sc.present? %><div class="qrc-card__bar"><div class="qrc-card__bar-fill" style="width:<%= sc %>%;background:#6366f1;"></div></div><% end %>
          <% if feedback.present? %><div class="qrc-card__feedback"><%= simple_format(feedback) %></div><% end %>
          <% if strengths.any? %><div class="qrc-card__list"><% strengths.first(3).each do |s| %><div class="qrc-card__item qrc-card__item--good"><span>✓</span> <%= s %></div><% end %></div><% end %>
          <% if improvements.any? %><div class="qrc-card__list"><% improvements.first(3).each do |imp| %><div class="qrc-card__item qrc-card__item--improve"><span>△</span> <%= imp %></div><% end %></div><% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- 3. 종합 의견 -->
<% if @report.overall_summary.present? %>
  <div class="qrc-section qrc-opinion" style="page-break-inside: avoid;">
    <h3 class="qrc-opinion__title">종합 의견</h3>
    <div class="qrc-opinion__body"><%= simple_format(@report.overall_summary) %></div>
  </div>
<% end %>

<!-- 4. 학습 권고사항 -->
<%
  reco = @report.respond_to?(:learning_recommendations) ? (@report.learning_recommendations || {}) : {}
  has_reco = reco.is_a?(Hash) && (reco["priority_areas"].present? || reco["short_term"].present?)
%>
<% if has_reco %>
  <div class="qrc-section" style="page-break-inside: avoid;">
    <h3 class="qrc-group-title" style="color:#0f172a;border-bottom-color:#e2e8f0;"><%= level_config[:recommendation_title] %></h3>
    <% (reco["priority_areas"] || []).each_with_index do |pa, idx| %>
      <% ac = ["#3b82f6", "#8b5cf6", "#16a34a"][idx % 3] %>
      <div class="qrc-priority" style="border-left-color:<%= ac %>;">
        <div class="qrc-priority__header">
          <span class="qrc-priority__num" style="background:<%= ac %>;"><%= idx + 1 %></span>
          <span class="qrc-priority__area"><%= pa["area"] %></span>
        </div>
        <% if pa["current_level"].present? || pa["target"].present? %>
          <div class="qrc-priority__levels">
            <% if pa["current_level"].present? %><div class="qrc-priority__level qrc-priority__level--current"><div class="qrc-priority__level-label">현재 수준</div><div><%= pa["current_level"] %></div></div><% end %>
            <% if pa["target"].present? %><div class="qrc-priority__level qrc-priority__level--target"><div class="qrc-priority__level-label">목표 수준</div><div><%= pa["target"] %></div></div><% end %>
          </div>
        <% end %>
        <% if (acts = pa["activities"] || []).any? %><div class="qrc-priority__block"><div class="qrc-priority__block-title" style="color:#1e40af;">학교 활동</div><ul class="qrc-priority__list"><% acts.each do |a| %><li><%= a %></li><% end %></ul></div><% end %>
        <% if (home = pa["home_activities"] || []).any? %><div class="qrc-priority__block"><div class="qrc-priority__block-title" style="color:#7c3aed;">가정 활동</div><ul class="qrc-priority__list"><% home.each do |a| %><li><%= a %></li><% end %></ul></div><% end %>
        <% if (books = pa["recommended_books"] || []).any? %><div class="qrc-priority__block"><div class="qrc-priority__block-title" style="color:#92400e;">추천 도서</div><div class="qrc-priority__books"><% books.each do |b| %><span class="qrc-priority__book"><%= b %></span><% end %></div></div><% end %>
      </div>
    <% end %>
    <% if reco["short_term"].present? || reco["mid_term"].present? || reco["long_term"].present? %>
      <h4 class="qrc-roadmap-title">학습 목표 로드맵</h4>
      <div class="qrc-roadmap">
        <% [{ key: "short_term", label: "단기 (1-2주)", color: "#3b82f6", bg: "#eff6ff", border: "#bfdbfe" },
            { key: "mid_term", label: "중기 (1-2개월)", color: "#8b5cf6", bg: "#faf5ff", border: "#e9d5ff" },
            { key: "long_term", label: "장기 (한 학기)", color: "#16a34a", bg: "#f0fdf4", border: "#bbf7d0" }
        ].each do |goal| %>
          <% if reco[goal[:key]].present? %>
            <div class="qrc-roadmap__card" style="background:<%= goal[:bg] %>;border-color:<%= goal[:border] %>;">
              <div class="qrc-roadmap__label" style="color:<%= goal[:color] %>;"><%= goal[:label] %></div>
              <div class="qrc-roadmap__text"><%= simple_format(reco[goal[:key]]) %></div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
    <% if reco["strength_leverage"].present? %>
      <div class="qrc-strength"><div class="qrc-strength__title">강점 활용 전략</div><div class="qrc-strength__text"><%= simple_format(reco["strength_leverage"]) %></div></div>
    <% end %>
  </div>
<% end %>

<!-- 5. 학생 발문 활동 기록 -->
<div class="qrc-section" style="page-break-before: always;">
  <h3 class="qrc-group-title" style="color:#0f172a;border-bottom-color:#e2e8f0;">학생 발문 활동 기록</h3>
  <% (1..3).each do |stage| %>
    <% stage_qs = @questions_by_stage[stage] || []; next if stage_qs.empty? %>
    <div class="qrc-stage-block" style="page-break-inside: avoid;">
      <h4 class="qrc-stage-block__title"><%= stage %>단계: <%= stage_names[stage] %> (<%= stage_qs.size %>개 발문)</h4>
      <% stage_qs.each_with_index do |q, idx| %>
        <% sc = q.final_score || q.ai_score; type_label = q.question_type == "guided" ? "안내형" : "자유형"
           score_color = sc.nil? ? "#94a3b8" : sc >= 80 ? "#16a34a" : sc >= 60 ? "#2563eb" : sc >= 40 ? "#f59e0b" : "#dc2626" %>
        <div class="qrc-question">
          <div class="qrc-question__header">
            <span class="qrc-question__num"><%= idx + 1 %></span>
            <span class="qrc-question__text"><%= q.question_text %></span>
            <span class="qrc-question__score" style="color:<%= score_color %>;"><%= sc ? "#{sc.round(1)}점" : "-" %></span>
          </div>
          <div class="qrc-question__meta">
            <span class="qrc-question__tag"><%= type_label %></span>
            <span class="qrc-question__tag">스캐폴딩 <%= q.scaffolding_used %></span>
            <% if q.evaluation_indicator.present? %><span class="qrc-question__tag"><%= q.evaluation_indicator.name %></span><% end %>
          </div>
          <% if q.ai_evaluation.is_a?(Hash) && q.ai_evaluation["feedback"].present? %>
            <div class="qrc-question__feedback"><%= q.ai_evaluation["feedback"] %></div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<!-- 푸터 -->
<div class="qrc-meta">
  <span>Reading PRO 발문 역량 평가 시스템</span>
  <span><%= Date.current.strftime("%Y년 %m월 %d일") %> 생성</span>
</div>
