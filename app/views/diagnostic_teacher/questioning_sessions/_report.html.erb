<%#
  ë°œë¬¸ ì—­ëŸ‰ ì¢…í•© ë³´ê³ ì„œ íŒŒì…œ
  Local variables:
    - report (QuestioningReport)
    - level (String: "elementary_low", "elementary_high", "middle", "high")
  ë°ì´í„° ì†ŒìŠ¤: QuestioningReport.report_sections (ë°œë¬¸ í•™ìŠµ ë°ì´í„° ê¸°ë°˜ GPT-4o-mini í‰ê°€)
%>

<%
  level ||= "elementary_low"
  level_label = QuestioningLevelConfig::LEVEL_LABELS[level] || level

  # ìˆ˜ì¤€ë³„ UI ì„¤ì •
  level_config = case level
    when "elementary_low"
      { feedback_length: 300, summary_title: "ì„ ìƒë‹˜ì˜ ì´ì•¼ê¸°", badge_style: "background: #fef3c7; color: #92400e; border: 1px solid #fcd34d;",
        section_title: "ì–´ë–¤ ì ì´ ì¢‹ì•˜ì„ê¹Œ?", recommendation_title: "ì´ëŸ° ê²ƒë„ í•´ë³´ì!" }
    when "elementary_high"
      { feedback_length: 400, summary_title: "ì„±ì¥ ë¶„ì„", badge_style: "background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;",
        section_title: "ì—­ëŸ‰ë³„ ìƒì„¸ ë¶„ì„", recommendation_title: "ì„±ì¥ì„ ìœ„í•œ ì œì•ˆ" }
    when "middle"
      { feedback_length: 500, summary_title: "ì¢…í•© í‰ê°€", badge_style: "background: #ede9fe; color: #5b21b6; border: 1px solid #c4b5fd;",
        section_title: "ì—­ëŸ‰ë³„ ë¶„ì„", recommendation_title: "í•™ìŠµ ê¶Œê³ ì‚¬í•­" }
    when "high"
      { feedback_length: 600, summary_title: "ì¢…í•© ë¶„ì„", badge_style: "background: #fce7f3; color: #9d174d; border: 1px solid #f9a8d4;",
        section_title: "ì—­ëŸ‰ë³„ ì‹¬ì¸µ ë¶„ì„", recommendation_title: "ì‹¬í™” í•™ìŠµ ë°©í–¥" }
    else
      { feedback_length: 400, summary_title: "ì¢…í•© í‰ê°€", badge_style: "background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;",
        section_title: "ì—­ëŸ‰ë³„ ìƒì„¸ ë¶„ì„", recommendation_title: "í•™ìŠµ ê¶Œê³ ì‚¬í•­" }
    end

  sections = report.report_sections || {}

  # 9ê°œ í•„ìˆ˜ ì—­ëŸ‰ (ë°œë¬¸ í•™ìŠµì—ì„œ í•­ìƒ í‰ê°€ë˜ëŠ” ì˜ì—­)
  # discussion_competency, argumentative_writingì€ ì¡°ê±´ë¶€(í† ë¡ /ì—ì„¸ì´ ë°ì´í„° í•„ìš”)ì´ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬
  radar_mapping = [
    { key: "reading_comprehension", label: "ì½ê¸° ì´í•´ë ¥", group: "ì´í•´ ì—­ëŸ‰" },
    { key: "inferential_reasoning", label: "ì¶”ë¡  ëŠ¥ë ¥", group: "ì´í•´ ì—­ëŸ‰" },
    { key: "critical_thinking", label: "ë¹„íŒì  ì‚¬ê³ ë ¥", group: "ì´í•´ ì—­ëŸ‰" },
    { key: "creative_thinking", label: "ì°½ì˜ì  ì‚¬ê³ ë ¥", group: "ì‚¬ê³  ì—­ëŸ‰" },
    { key: "metacognition", label: "ë©”íƒ€ì¸ì§€", group: "ì‚¬ê³  ì—­ëŸ‰" },
    { key: "vocabulary_usage", label: "ì–´íœ˜ í™œìš©", group: "ì‚¬ê³  ì—­ëŸ‰" },
    { key: "text_connection", label: "í…ìŠ¤íŠ¸ ì—°ê²°", group: "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰" },
    { key: "communication", label: "ì˜ì‚¬ì†Œí†µ", group: "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰" },
    { key: "personal_application", label: "ì‚¶ ì ìš©", group: "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰" }
  ]

  radar_data = radar_mapping.map do |item|
    score = sections.dig(item[:key], "score") || 0
    { name: item[:label], group: item[:group], score: score }
  end

  # ì¡°ê±´ë¶€ ì—­ëŸ‰ (í† ë¡ /ì—ì„¸ì´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ)
  conditional_sections = [
    { key: "discussion_competency", label: "í† ë¡  ì—­ëŸ‰", icon: "discussion" },
    { key: "argumentative_writing", label: "ë…¼ì¦ì  ê¸€ì“°ê¸°", icon: "essay" }
  ].select { |cs| sections.dig(cs[:key], "score").present? }
%>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     1. ì¢…í•© ë°œë¬¸ ì—­ëŸ‰ ìˆ˜ì¤€ + ë ˆì´ë” ì°¨íŠ¸
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="padding: var(--rp-space-5); background: linear-gradient(135deg, #eff6ff, #f5f3ff); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5); border: 1px solid #c7d2fe;">
  <!-- Header -->
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--rp-space-4);">
    <div style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-semibold); color: var(--rp-primary); text-transform: uppercase; letter-spacing: 0.05em;">ì¢…í•© ë°œë¬¸ ì—­ëŸ‰ ìˆ˜ì¤€</div>
    <div style="display: flex; align-items: center; gap: var(--rp-space-3);">
      <div style="text-align: center;">
        <div style="font-size: var(--rp-font-size-sm); color: var(--rp-text-muted); margin-bottom: 2px; letter-spacing: 0.05em;">í•™ë…„</div>
        <div style="display: inline-flex; align-items: center; padding: var(--rp-space-1) var(--rp-space-3); border-radius: 999px; font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-semibold); <%= level_config[:badge_style] %>"><%= level_label %></div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: var(--rp-font-size-sm); color: var(--rp-text-muted); margin-bottom: 2px; letter-spacing: 0.05em;">ì„±ì·¨ ìˆ˜ì¤€</div>
        <div style="display: inline-flex; align-items: center; gap: var(--rp-space-2); padding: var(--rp-space-1) var(--rp-space-3); background: white; border-radius: 999px; border: 2px solid var(--rp-primary);">
          <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: var(--rp-primary);"><%= report.literacy_level_label %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Radar Chart + Summary Split -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--rp-space-5); align-items: start;">
    <!-- Left: Radar Chart -->
    <div style="text-align: center;">
      <h4 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: var(--rp-text-title); margin: 0 0 var(--rp-space-3) 0;">9ê°œ ì—­ëŸ‰ í”„ë¡œí•„</h4>
      <div style="display: flex; justify-content: center;">
        <svg id="qr-radar-svg" viewBox="0 0 460 420" style="max-width: 400px; width: 100%; height: auto;"></svg>
      </div>
      <div id="qr-radar-legend" style="display: flex; justify-content: center; gap: 16px; margin-top: var(--rp-space-2); flex-wrap: wrap;"></div>
    </div>

    <!-- Right: Overall Summary -->
    <div>
      <h4 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: var(--rp-text-title); margin: 0 0 var(--rp-space-3) 0;"><%= level_config[:summary_title] %></h4>
      <% if report.overall_summary.present? %>
        <div style="font-size: var(--rp-font-size-lg); line-height: 1.8; color: var(--rp-text-body);"><%= simple_format(report.overall_summary) %></div>
      <% end %>

      <!-- Score Summary Table -->
      <div style="margin-top: var(--rp-space-3);">
        <% radar_data.each do |rd| %>
          <%
            sc = rd[:score]
            bar_color = sc >= 80 ? "#16a34a" : sc >= 60 ? "#2563eb" : sc >= 40 ? "#f59e0b" : "#dc2626"
          %>
          <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: 6px;">
            <span style="font-size: var(--rp-font-size-sm); color: var(--rp-text-muted); width: 70px; flex-shrink: 0; text-align: right;"><%= rd[:name] %></span>
            <div style="flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
              <div style="width: <%= sc %>%; height: 100%; background: <%= bar_color %>; border-radius: 4px;"></div>
            </div>
            <span style="font-size: var(--rp-font-size-sm); font-weight: 600; color: <%= bar_color %>; width: 32px; text-align: right;"><%= sc.to_i %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2. 9ê°œ ì—­ëŸ‰ë³„ ìƒì„¸ ë¶„ì„ ì¹´ë“œ
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<%
  group_colors = {
    "ì´í•´ ì—­ëŸ‰" => { bg: "#eff6ff", border: "#bfdbfe", title: "#1e40af", bar: "#3b82f6" },
    "ì‚¬ê³  ì—­ëŸ‰" => { bg: "#faf5ff", border: "#e9d5ff", title: "#6b21a8", bar: "#8b5cf6" },
    "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰" => { bg: "#f0fdf4", border: "#bbf7d0", title: "#166534", bar: "#16a34a" }
  }
%>

<% ["ì´í•´ ì—­ëŸ‰", "ì‚¬ê³  ì—­ëŸ‰", "ì†Œí†µÂ·ì ìš© ì—­ëŸ‰"].each do |group_name| %>
  <% group_items = radar_mapping.select { |r| r[:group] == group_name } %>
  <% gc = group_colors[group_name] %>

  <div style="margin-bottom: var(--rp-space-5);">
    <h3 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: <%= gc[:title] %>; margin: 0 0 var(--rp-space-3) 0; padding-bottom: var(--rp-space-2); border-bottom: 2px solid <%= gc[:border] %>;">
      <%= group_name %>
    </h3>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--rp-space-4);">
      <% group_items.each do |item| %>
        <%
          section = sections[item[:key]] || {}
          score = section["score"]
          feedback = section["feedback"]
          strengths = section["strengths"] || []
          improvements = section["improvements"] || []

          score_color = if score.nil?
            "var(--rp-text-muted)"
          elsif score >= 80
            "#16a34a"
          elsif score >= 60
            "#2563eb"
          elsif score >= 40
            "#f59e0b"
          else
            "#dc2626"
          end
        %>
        <div style="padding: var(--rp-space-4); background: <%= gc[:bg] %>; border: 1px solid <%= gc[:border] %>; border-radius: var(--rp-radius-md);">
          <!-- Header -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--rp-space-2);">
            <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: <%= gc[:title] %>;"><%= item[:label] %></span>
            <% if score.present? %>
              <span style="font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-bold); color: <%= score_color %>;"><%= score.is_a?(Float) ? score.round(1) : score %></span>
            <% else %>
              <span style="font-size: var(--rp-font-size-md); color: var(--rp-text-muted);">N/A</span>
            <% end %>
          </div>

          <!-- Score Bar -->
          <% if score.present? %>
            <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.6); border-radius: 3px; margin-bottom: var(--rp-space-3); overflow: hidden;">
              <div style="width: <%= score %>%; height: 100%; background: <%= gc[:bar] %>; border-radius: 3px;"></div>
            </div>
          <% end %>

          <!-- Feedback -->
          <% if feedback.present? %>
            <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.6; margin-bottom: var(--rp-space-2);"><%= simple_format(feedback.truncate(level_config[:feedback_length])) %></div>
          <% end %>

          <!-- Strengths -->
          <% if strengths.any? %>
            <div style="margin-top: var(--rp-space-2);">
              <% strengths.first(3).each do |s| %>
                <div style="font-size: var(--rp-font-size-sm); color: #16a34a; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">âœ“</span> <%= s %>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Improvements -->
          <% if improvements.any? %>
            <div style="margin-top: var(--rp-space-1);">
              <% improvements.first(3).each do |imp| %>
                <div style="font-size: var(--rp-font-size-sm); color: #f59e0b; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">â–³</span> <%= imp %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2-1. ì¡°ê±´ë¶€ ì—­ëŸ‰ (í† ë¡ /ì—ì„¸ì´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<% if conditional_sections.any? %>
  <div style="margin-bottom: var(--rp-space-5);">
    <h3 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: #475569; margin: 0 0 var(--rp-space-3) 0; padding-bottom: var(--rp-space-2); border-bottom: 2px solid #e2e8f0;">
      ì¶”ê°€ ì—­ëŸ‰ í‰ê°€
    </h3>
    <div style="display: grid; grid-template-columns: repeat(<%= conditional_sections.size %>, 1fr); gap: var(--rp-space-4);">
      <% conditional_sections.each do |cs| %>
        <%
          section = sections[cs[:key]] || {}
          score = section["score"]
          feedback = section["feedback"]
          strengths = section["strengths"] || []
          improvements = section["improvements"] || []

          score_color = if score.nil?
            "var(--rp-text-muted)"
          elsif score >= 80
            "#16a34a"
          elsif score >= 60
            "#2563eb"
          elsif score >= 40
            "#f59e0b"
          else
            "#dc2626"
          end
        %>
        <div style="padding: var(--rp-space-4); background: #f8fafc; border: 1px solid #e2e8f0; border-radius: var(--rp-radius-md);">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--rp-space-2);">
            <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #334155;"><%= cs[:label] %></span>
            <span style="font-size: var(--rp-font-size-xl); font-weight: var(--rp-font-weight-bold); color: <%= score_color %>;"><%= score %></span>
          </div>

          <% if score.present? %>
            <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-bottom: var(--rp-space-3); overflow: hidden;">
              <div style="width: <%= score %>%; height: 100%; background: #6366f1; border-radius: 3px;"></div>
            </div>
          <% end %>

          <% if feedback.present? %>
            <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.6; margin-bottom: var(--rp-space-2);"><%= simple_format(feedback.truncate(level_config[:feedback_length])) %></div>
          <% end %>

          <% if strengths.any? %>
            <div style="margin-top: var(--rp-space-2);">
              <% strengths.first(3).each do |s| %>
                <div style="font-size: var(--rp-font-size-sm); color: #16a34a; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">âœ“</span> <%= s %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if improvements.any? %>
            <div style="margin-top: var(--rp-space-1);">
              <% improvements.first(3).each do |imp| %>
                <div style="font-size: var(--rp-font-size-sm); color: #f59e0b; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">â–³</span> <%= imp %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     3. ì¢…í•© ì˜ê²¬ (AI ìƒì„±)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<%
  avg_score = radar_data.any? ? (radar_data.sum { |d| d[:score] } / radar_data.size.to_f).round(1) : 0
  top_areas = radar_data.sort_by { |d| -d[:score] }.first(3)
  weak_areas = radar_data.sort_by { |d| d[:score] }.first(3)
%>

<div style="padding: var(--rp-space-5); background: var(--rp-surface); border: 1px solid var(--rp-border); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5);">
  <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-4);">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
    </svg>
    <h3 style="margin: 0; font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title);">ì¢…í•© ì˜ê²¬</h3>
  </div>

  <!-- ì—­ëŸ‰ ìš”ì•½ ë°” -->
  <div style="display: flex; align-items: center; gap: var(--rp-space-4); margin-bottom: var(--rp-space-4); padding: var(--rp-space-3); background: linear-gradient(135deg, #f0f4ff, #f5f3ff); border-radius: var(--rp-radius-md);">
    <div style="text-align: center; padding: 0 var(--rp-space-4); border-right: 1px solid #e0e7ff;">
      <div style="font-size: var(--rp-font-size-2xl); font-weight: 700; color: var(--rp-primary);"><%= avg_score %></div>
      <div style="font-size: var(--rp-font-size-sm); color: var(--rp-text-muted);">9ê°œ ì—­ëŸ‰ í‰ê· </div>
    </div>
    <div style="flex: 1;">
      <div style="font-size: var(--rp-font-size-lg); color: var(--rp-text-body); line-height: 1.6;">
        <strong>ìš°ìˆ˜ ì˜ì—­:</strong> <%= top_areas.map { |a| "#{a[:name]}(#{a[:score].to_i}ì )" }.join(", ") %><br>
        <strong>ë³´ì™„ ì˜ì—­:</strong> <%= weak_areas.map { |a| "#{a[:name]}(#{a[:score].to_i}ì )" }.join(", ") %>
      </div>
    </div>
  </div>

  <!-- AI ìƒì„± ì¢…í•© ì˜ê²¬ -->
  <% if report.overall_summary.present? && report.overall_summary.length > 50 %>
    <div style="font-size: var(--rp-font-size-lg); line-height: 1.9; color: var(--rp-text-body); padding: var(--rp-space-4); background: #fafbff; border: 1px solid #e0e7ff; border-radius: var(--rp-radius-md); border-left: 4px solid #6366f1;">
      <%= simple_format(report.overall_summary) %>
    </div>
  <% else %>
    <%# ì´ì „ ë³´ê³ ì„œ í˜¸í™˜: AI ì¢…í•© ì˜ê²¬ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ê°•ì /ë³´ì™„ í‘œì‹œ %>
    <%
      all_strengths = radar_mapping.flat_map { |item|
        (sections.dig(item[:key], "strengths") || []).map { |st| { area: item[:label], text: st } }
      }.uniq { |x| x[:text] }
      all_improvements = radar_mapping.flat_map { |item|
        (sections.dig(item[:key], "improvements") || []).map { |i| { area: item[:label], text: i } }
      }.uniq { |x| x[:text] }
    %>

    <% if report.overall_summary.present? %>
      <div style="font-size: var(--rp-font-size-lg); line-height: 1.8; color: var(--rp-text-body); margin-bottom: var(--rp-space-4);"><%= simple_format(report.overall_summary) %></div>
    <% end %>

    <% if all_strengths.any? %>
      <div style="margin-bottom: var(--rp-space-4);">
        <h4 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #16a34a; margin: 0 0 var(--rp-space-2) 0;">ì£¼ìš” ê°•ì </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
          <% all_strengths.first(6).each do |s| %>
            <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-body); display: flex; align-items: flex-start; gap: 6px; padding: 6px 10px; background: #f0fdf4; border-radius: var(--rp-radius-sm);">
              <span style="color: #16a34a; flex-shrink: 0; font-weight: 600;">âœ“</span>
              <span><strong style="color: #166534;"><%= s[:area] %></strong> &mdash; <%= s[:text] %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if all_improvements.any? %>
      <div>
        <h4 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #f59e0b; margin: 0 0 var(--rp-space-2) 0;">ë³´ì™„ì´ í•„ìš”í•œ ë¶€ë¶„</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
          <% all_improvements.first(6).each do |imp| %>
            <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-body); display: flex; align-items: flex-start; gap: 6px; padding: 6px 10px; background: #fffbeb; border-radius: var(--rp-radius-sm);">
              <span style="color: #f59e0b; flex-shrink: 0; font-weight: 600;">â–³</span>
              <span><strong style="color: #92400e;"><%= imp[:area] %></strong> &mdash; <%= imp[:text] %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     4. ì‹¬í™” í•™ìŠµ ë°©í–¥ (AI ìƒì„±)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<%
  reco = report.respond_to?(:learning_recommendations) ? (report.learning_recommendations || {}) : {}
  has_reco = reco.is_a?(Hash) && (reco["priority_areas"].present? || reco["short_term"].present?)
%>

<div style="padding: var(--rp-space-5); background: var(--rp-surface); border: 1px solid var(--rp-border); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5);">
  <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-4);">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
    <h3 style="margin: 0; font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title);"><%= level_config[:recommendation_title] %></h3>
  </div>

  <% if has_reco %>
    <%# === AI ìƒì„± ì‹¬í™” í•™ìŠµ ë°©í–¥ === %>

    <%# --- ìš°ì„  ë³´ì™„ ì˜ì—­ ì¹´ë“œ --- %>
    <% priority_areas = reco["priority_areas"] || [] %>
    <% if priority_areas.any? %>
      <div style="margin-bottom: var(--rp-space-5);">
        <h4 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #dc2626; margin: 0 0 var(--rp-space-3) 0;">
          ìš°ì„  ë³´ì™„ ì˜ì—­
        </h4>
        <div style="display: flex; flex-direction: column; gap: var(--rp-space-4);">
          <% area_colors = ["#3b82f6", "#8b5cf6", "#16a34a"] %>
          <% priority_areas.each_with_index do |pa, idx| %>
            <% ac = area_colors[idx % 3] %>
            <div style="padding: var(--rp-space-4); background: #fafbff; border: 1px solid #e2e8f0; border-radius: var(--rp-radius-md); border-left: 4px solid <%= ac %>;">
              <!-- ì˜ì—­ í—¤ë” -->
              <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-3);">
                <span style="width: 28px; height: 28px; border-radius: 50%; background: <%= ac %>; color: white; display: flex; align-items: center; justify-content: center; font-size: var(--rp-font-size-lg); font-weight: 700; flex-shrink: 0;"><%= idx + 1 %></span>
                <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title);"><%= pa["area"] %></span>
              </div>

              <!-- í˜„ì¬ ìˆ˜ì¤€ & ëª©í‘œ -->
              <% if pa["current_level"].present? || pa["target"].present? %>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--rp-space-3); margin-bottom: var(--rp-space-3);">
                  <% if pa["current_level"].present? %>
                    <div style="padding: var(--rp-space-3); background: #fef2f2; border-radius: var(--rp-radius-sm);">
                      <div style="font-size: var(--rp-font-size-sm); font-weight: 600; color: #dc2626; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em;">í˜„ì¬ ìˆ˜ì¤€</div>
                      <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.6;"><%= pa["current_level"] %></div>
                    </div>
                  <% end %>
                  <% if pa["target"].present? %>
                    <div style="padding: var(--rp-space-3); background: #f0fdf4; border-radius: var(--rp-radius-sm);">
                      <div style="font-size: var(--rp-font-size-sm); font-weight: 600; color: #16a34a; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em;">ëª©í‘œ ìˆ˜ì¤€</div>
                      <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.6;"><%= pa["target"] %></div>
                    </div>
                  <% end %>
                </div>
              <% end %>

              <!-- í•™êµ í™œë™ -->
              <% activities = pa["activities"] || [] %>
              <% if activities.any? %>
                <div style="margin-bottom: var(--rp-space-3);">
                  <div style="font-size: var(--rp-font-size-md); font-weight: 600; color: #1e40af; margin-bottom: 6px;">í•™êµì—ì„œ í•  ìˆ˜ ìˆëŠ” í™œë™</div>
                  <ul style="margin: 0; padding-left: 18px; font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.7;">
                    <% activities.each do |act| %>
                      <li><%= act %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <!-- ê°€ì • í™œë™ -->
              <% home_acts = pa["home_activities"] || [] %>
              <% if home_acts.any? %>
                <div style="margin-bottom: var(--rp-space-3);">
                  <div style="font-size: var(--rp-font-size-md); font-weight: 600; color: #7c3aed; margin-bottom: 6px;">ê°€ì •ì—ì„œ í•  ìˆ˜ ìˆëŠ” í™œë™</div>
                  <ul style="margin: 0; padding-left: 18px; font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.7;">
                    <% home_acts.each do |act| %>
                      <li><%= act %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <!-- ì¶”ì²œ ë„ì„œ -->
              <% books = pa["recommended_books"] || [] %>
              <% if books.any? %>
                <div>
                  <div style="font-size: var(--rp-font-size-md); font-weight: 600; color: #92400e; margin-bottom: 6px;">ì¶”ì²œ ë„ì„œ</div>
                  <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    <% books.each do |book| %>
                      <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 999px; font-size: var(--rp-font-size-md); color: #92400e;">
                        ğŸ“– <%= book %>
                      </span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# --- í•™ìŠµ ëª©í‘œ ë¡œë“œë§µ --- %>
    <% if reco["short_term"].present? || reco["mid_term"].present? || reco["long_term"].present? %>
      <div style="margin-bottom: var(--rp-space-5);">
        <h4 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #1e40af; margin: 0 0 var(--rp-space-3) 0;">
          í•™ìŠµ ëª©í‘œ ë¡œë“œë§µ
        </h4>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--rp-space-3);">
          <% [
            { key: "short_term", label: "ë‹¨ê¸° (1-2ì£¼)", color: "#3b82f6", bg: "#eff6ff", border: "#bfdbfe" },
            { key: "mid_term", label: "ì¤‘ê¸° (1-2ê°œì›”)", color: "#8b5cf6", bg: "#faf5ff", border: "#e9d5ff" },
            { key: "long_term", label: "ì¥ê¸° (í•œ í•™ê¸°)", color: "#16a34a", bg: "#f0fdf4", border: "#bbf7d0" }
          ].each do |goal| %>
            <% if reco[goal[:key]].present? %>
              <div style="padding: var(--rp-space-4); background: <%= goal[:bg] %>; border: 1px solid <%= goal[:border] %>; border-radius: var(--rp-radius-md);">
                <div style="font-size: var(--rp-font-size-md); font-weight: 700; color: <%= goal[:color] %>; margin-bottom: var(--rp-space-2); text-transform: uppercase; letter-spacing: 0.05em;"><%= goal[:label] %></div>
                <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.7;"><%= simple_format(reco[goal[:key]]) %></div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# --- ê°•ì  í™œìš© ì „ëµ --- %>
    <% if reco["strength_leverage"].present? %>
      <div style="padding: var(--rp-space-4); background: linear-gradient(135deg, #ecfdf5, #f0fdf4); border: 1px solid #a7f3d0; border-radius: var(--rp-radius-md);">
        <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-2);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
          </svg>
          <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: #166534;">ê°•ì  í™œìš© ì „ëµ</span>
        </div>
        <div style="font-size: var(--rp-font-size-md); color: #064e3b; line-height: 1.8;"><%= simple_format(reco["strength_leverage"]) %></div>
      </div>
    <% end %>

  <% else %>
    <%# === ì´ì „ ë³´ê³ ì„œ í˜¸í™˜: ê¸°ì¡´ ì•½ì  ì˜ì—­ ê¸°ë°˜ í‘œì‹œ === %>
    <div style="display: flex; flex-direction: column; gap: var(--rp-space-3);">
      <% weak_areas.each_with_index do |area, idx| %>
        <%
          mapping = radar_mapping.find { |m| m[:label] == area[:name] }
          section_data = mapping ? (sections[mapping[:key]] || {}) : {}
          improvements = section_data["improvements"] || []
          gc = group_colors[mapping&.dig(:group)] || group_colors["ì´í•´ ì—­ëŸ‰"]
        %>
        <div style="padding: var(--rp-space-4); background: <%= gc[:bg] %>; border: 1px solid <%= gc[:border] %>; border-radius: var(--rp-radius-md);">
          <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-2);">
            <span style="width: 24px; height: 24px; border-radius: 50%; background: <%= gc[:bar] %>; color: white; display: flex; align-items: center; justify-content: center; font-size: var(--rp-font-size-md); font-weight: 700; flex-shrink: 0;"><%= idx + 1 %></span>
            <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); color: <%= gc[:title] %>;"><%= area[:name] %></span>
            <span style="font-size: var(--rp-font-size-md); color: var(--rp-text-muted); margin-left: auto;"><%= area[:score].to_i %>ì  / 100</span>
          </div>
          <% if improvements.any? %>
            <ul style="margin: 0; padding-left: 20px; font-size: var(--rp-font-size-md); color: var(--rp-text-body); line-height: 1.7;">
              <% improvements.first(3).each do |imp| %>
                <li><%= imp %></li>
              <% end %>
            </ul>
          <% else %>
            <div style="font-size: var(--rp-font-size-md); color: var(--rp-text-muted);">í•´ë‹¹ ì˜ì—­ì˜ êµ¬ì²´ì ì¸ ê¶Œê³ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Report Metadata -->
<div style="font-size: var(--rp-font-size-md); color: var(--rp-text-muted); display: flex; gap: var(--rp-space-4); flex-wrap: wrap;">
  <% if report.generated_by.present? %>
    <span>ìƒì„±: <%= report.generated_by.name %></span>
  <% end %>
  <span>ìƒíƒœ: <%= report.published? ? 'ë°°í¬ë¨' : 'ì´ˆì•ˆ' %></span>
  <% if report.published_at.present? %>
    <span>ë°°í¬ì¼: <%= report.published_at.strftime('%Y-%m-%d %H:%M') %></span>
  <% end %>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë ˆì´ë” ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(function() {
  var radarData = <%= json_escape(radar_data.to_json) %>;

  function draw() {
    var svg = document.getElementById('qr-radar-svg');
    var legend = document.getElementById('qr-radar-legend');
    if (!svg || !radarData || radarData.length === 0) return;

    svg.innerHTML = '';

    var ns = 'http://www.w3.org/2000/svg';
    var cx = 230, cy = 195, radius = 150;
    var n = radarData.length;
    var levels = 5;
    var groupColors = {
      'ì´í•´ ì—­ëŸ‰': { fill: 'rgba(59,130,246,0.12)', stroke: '#3b82f6', dot: '#2563eb' },
      'ì‚¬ê³  ì—­ëŸ‰': { fill: 'rgba(139,92,246,0.12)', stroke: '#8b5cf6', dot: '#7c3aed' },
      'ì†Œí†µÂ·ì ìš© ì—­ëŸ‰': { fill: 'rgba(22,163,74,0.12)', stroke: '#16a34a', dot: '#15803d' }
    };

    function getPoint(index, value) {
      var angle = (Math.PI * 2 * index / n) - Math.PI / 2;
      var r = radius * (value / 100);
      return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
    }

    // Grid polygons
    for (var lvl = 1; lvl <= levels; lvl++) {
      var r = radius * lvl / levels;
      var pts = [];
      for (var i = 0; i < n; i++) {
        var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
        pts.push((cx + r * Math.cos(angle)) + ',' + (cy + r * Math.sin(angle)));
      }
      var polygon = document.createElementNS(ns, 'polygon');
      polygon.setAttribute('points', pts.join(' '));
      polygon.setAttribute('fill', lvl % 2 === 0 ? 'rgba(241,245,249,0.5)' : 'none');
      polygon.setAttribute('stroke', lvl === levels ? '#cbd5e1' : '#e2e8f0');
      polygon.setAttribute('stroke-width', lvl === levels ? '1.5' : '0.8');
      svg.appendChild(polygon);
      if (lvl % 2 === 0 || lvl === levels) {
        var pct = document.createElementNS(ns, 'text');
        pct.setAttribute('x', cx + 4); pct.setAttribute('y', cy - r + 12);
        pct.setAttribute('fill', '#94a3b8'); pct.setAttribute('font-size', '10');
        pct.textContent = (lvl * 20) + '';
        svg.appendChild(pct);
      }
    }

    // Axis lines & labels
    radarData.forEach(function(d, i) {
      var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
      var endX = cx + radius * Math.cos(angle);
      var endY = cy + radius * Math.sin(angle);
      var line = document.createElementNS(ns, 'line');
      line.setAttribute('x1', cx); line.setAttribute('y1', cy);
      line.setAttribute('x2', endX); line.setAttribute('y2', endY);
      line.setAttribute('stroke', '#e2e8f0'); line.setAttribute('stroke-width', '0.8');
      svg.appendChild(line);

      var labelR = radius + 28;
      var lx = cx + labelR * Math.cos(angle);
      var ly = cy + labelR * Math.sin(angle);
      var colors = groupColors[d.group] || { stroke: '#64748b' };

      var label = document.createElementNS(ns, 'text');
      label.setAttribute('x', lx); label.setAttribute('y', ly);
      label.setAttribute('text-anchor', 'middle'); label.setAttribute('dominant-baseline', 'middle');
      label.setAttribute('fill', colors.stroke); label.setAttribute('font-size', '11'); label.setAttribute('font-weight', '600');
      label.textContent = d.name;
      svg.appendChild(label);

      var scoreLabel = document.createElementNS(ns, 'text');
      scoreLabel.setAttribute('x', lx); scoreLabel.setAttribute('y', ly + 14);
      scoreLabel.setAttribute('text-anchor', 'middle'); scoreLabel.setAttribute('fill', '#94a3b8'); scoreLabel.setAttribute('font-size', '10');
      scoreLabel.textContent = d.score + 'ì ';
      svg.appendChild(scoreLabel);
    });

    // Data polygon
    var dataPoints = radarData.map(function(d, i) {
      var pt = getPoint(i, d.score);
      return pt.x + ',' + pt.y;
    });
    var dataPolygon = document.createElementNS(ns, 'polygon');
    dataPolygon.setAttribute('points', dataPoints.join(' '));
    dataPolygon.setAttribute('fill', 'rgba(99,102,241,0.12)');
    dataPolygon.setAttribute('stroke', '#6366f1');
    dataPolygon.setAttribute('stroke-width', '2.5');
    svg.appendChild(dataPolygon);

    // Data dots
    radarData.forEach(function(d, i) {
      var pt = getPoint(i, d.score);
      var colors = groupColors[d.group] || { dot: '#475569' };
      var dot = document.createElementNS(ns, 'circle');
      dot.setAttribute('cx', pt.x); dot.setAttribute('cy', pt.y); dot.setAttribute('r', '5');
      dot.setAttribute('fill', colors.dot); dot.setAttribute('stroke', 'white'); dot.setAttribute('stroke-width', '2');
      svg.appendChild(dot);
    });

    // Legend
    if (legend) {
      legend.innerHTML = '';
      ['ì´í•´ ì—­ëŸ‰', 'ì‚¬ê³  ì—­ëŸ‰', 'ì†Œí†µÂ·ì ìš© ì—­ëŸ‰'].forEach(function(group) {
        var colors = groupColors[group];
        var item = document.createElement('div');
        item.style.cssText = 'display:flex;align-items:center;gap:6px;font-size: var(--rp-font-size-md);color:#475569;font-weight:500;';
        item.innerHTML = '<span style="width:10px;height:10px;border-radius:50%;background:' + colors.stroke + ';flex-shrink:0;"></span><span>' + group + '</span>';
        legend.appendChild(item);
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', draw);
  } else {
    draw();
  }
  document.addEventListener('turbo:load', draw);
})();
</script>
