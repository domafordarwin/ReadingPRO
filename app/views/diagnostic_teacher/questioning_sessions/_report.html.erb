<%#
  발문 역량 종합 보고서 파셜
  Local variables:
    - report (QuestioningReport)
  데이터 소스: QuestioningReport.report_sections (발문 학습 데이터 기반 GPT-4o-mini 평가)
%>

<%
  sections = report.report_sections || {}

  # 9개 필수 역량 (발문 학습에서 항상 평가되는 영역)
  # discussion_competency, argumentative_writing은 조건부(토론/에세이 데이터 필요)이므로 별도 처리
  radar_mapping = [
    { key: "reading_comprehension", label: "읽기 이해력", group: "이해 역량" },
    { key: "inferential_reasoning", label: "추론 능력", group: "이해 역량" },
    { key: "critical_thinking", label: "비판적 사고력", group: "이해 역량" },
    { key: "creative_thinking", label: "창의적 사고력", group: "사고 역량" },
    { key: "metacognition", label: "메타인지", group: "사고 역량" },
    { key: "vocabulary_usage", label: "어휘 활용", group: "사고 역량" },
    { key: "text_connection", label: "텍스트 연결", group: "소통·적용 역량" },
    { key: "communication", label: "의사소통", group: "소통·적용 역량" },
    { key: "personal_application", label: "삶 적용", group: "소통·적용 역량" }
  ]

  radar_data = radar_mapping.map do |item|
    score = sections.dig(item[:key], "score") || 0
    { name: item[:label], group: item[:group], score: score }
  end

  # 조건부 역량 (토론/에세이 데이터가 있는 경우만)
  conditional_sections = [
    { key: "discussion_competency", label: "토론 역량", icon: "discussion" },
    { key: "argumentative_writing", label: "논증적 글쓰기", icon: "essay" }
  ].select { |cs| sections.dig(cs[:key], "score").present? }
%>

<!-- ════════════════════════════════════════════
     1. 종합 발문 역량 수준 + 레이더 차트
     ════════════════════════════════════════════ -->
<div style="padding: var(--rp-space-5); background: linear-gradient(135deg, #eff6ff, #f5f3ff); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5); border: 1px solid #c7d2fe;">
  <!-- Header -->
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--rp-space-4);">
    <div style="font-size: var(--rp-font-size-xs); font-weight: var(--rp-font-weight-semibold); color: var(--rp-primary); text-transform: uppercase; letter-spacing: 0.05em;">종합 발문 역량 수준</div>
    <div style="display: inline-flex; align-items: center; gap: var(--rp-space-2); padding: var(--rp-space-1) var(--rp-space-3); background: white; border-radius: 999px; border: 2px solid var(--rp-primary);">
      <span style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: var(--rp-primary);"><%= report.literacy_level_label %></span>
    </div>
  </div>

  <!-- Radar Chart + Summary Split -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--rp-space-5); align-items: start;">
    <!-- Left: Radar Chart -->
    <div style="text-align: center;">
      <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: var(--rp-text-title); margin: 0 0 var(--rp-space-3) 0;">9개 역량 프로필</h4>
      <div style="display: flex; justify-content: center;">
        <svg id="qr-radar-svg" viewBox="0 0 460 420" style="max-width: 400px; width: 100%; height: auto;"></svg>
      </div>
      <div id="qr-radar-legend" style="display: flex; justify-content: center; gap: 16px; margin-top: var(--rp-space-2); flex-wrap: wrap;"></div>
    </div>

    <!-- Right: Overall Summary -->
    <div>
      <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: var(--rp-text-title); margin: 0 0 var(--rp-space-3) 0;">종합 평가</h4>
      <% if report.overall_summary.present? %>
        <div style="font-size: var(--rp-font-size-sm); line-height: 1.8; color: var(--rp-text-body);"><%= simple_format(report.overall_summary) %></div>
      <% end %>

      <!-- Score Summary Table -->
      <div style="margin-top: var(--rp-space-3);">
        <% radar_data.each do |rd| %>
          <%
            sc = rd[:score]
            bar_color = sc >= 80 ? "#16a34a" : sc >= 60 ? "#2563eb" : sc >= 40 ? "#f59e0b" : "#dc2626"
          %>
          <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: 6px;">
            <span style="font-size: 11px; color: var(--rp-text-muted); width: 70px; flex-shrink: 0; text-align: right;"><%= rd[:name] %></span>
            <div style="flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
              <div style="width: <%= sc %>%; height: 100%; background: <%= bar_color %>; border-radius: 4px;"></div>
            </div>
            <span style="font-size: 11px; font-weight: 600; color: <%= bar_color %>; width: 32px; text-align: right;"><%= sc.to_i %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════
     2. 9개 역량별 상세 분석 카드
     ════════════════════════════════════════════ -->
<%
  group_colors = {
    "이해 역량" => { bg: "#eff6ff", border: "#bfdbfe", title: "#1e40af", bar: "#3b82f6" },
    "사고 역량" => { bg: "#faf5ff", border: "#e9d5ff", title: "#6b21a8", bar: "#8b5cf6" },
    "소통·적용 역량" => { bg: "#f0fdf4", border: "#bbf7d0", title: "#166534", bar: "#16a34a" }
  }
%>

<% ["이해 역량", "사고 역량", "소통·적용 역량"].each do |group_name| %>
  <% group_items = radar_mapping.select { |r| r[:group] == group_name } %>
  <% gc = group_colors[group_name] %>

  <div style="margin-bottom: var(--rp-space-5);">
    <h3 style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: <%= gc[:title] %>; margin: 0 0 var(--rp-space-3) 0; padding-bottom: var(--rp-space-2); border-bottom: 2px solid <%= gc[:border] %>;">
      <%= group_name %>
    </h3>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--rp-space-4);">
      <% group_items.each do |item| %>
        <%
          section = sections[item[:key]] || {}
          score = section["score"]
          feedback = section["feedback"]
          strengths = section["strengths"] || []
          improvements = section["improvements"] || []

          score_color = if score.nil?
            "var(--rp-text-muted)"
          elsif score >= 80
            "#16a34a"
          elsif score >= 60
            "#2563eb"
          elsif score >= 40
            "#f59e0b"
          else
            "#dc2626"
          end
        %>
        <div style="padding: var(--rp-space-4); background: <%= gc[:bg] %>; border: 1px solid <%= gc[:border] %>; border-radius: var(--rp-radius-md);">
          <!-- Header -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--rp-space-2);">
            <span style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: <%= gc[:title] %>;"><%= item[:label] %></span>
            <% if score.present? %>
              <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: <%= score_color %>;"><%= score.is_a?(Float) ? score.round(1) : score %></span>
            <% else %>
              <span style="font-size: var(--rp-font-size-xs); color: var(--rp-text-muted);">N/A</span>
            <% end %>
          </div>

          <!-- Score Bar -->
          <% if score.present? %>
            <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.6); border-radius: 3px; margin-bottom: var(--rp-space-3); overflow: hidden;">
              <div style="width: <%= score %>%; height: 100%; background: <%= gc[:bar] %>; border-radius: 3px;"></div>
            </div>
          <% end %>

          <!-- Feedback -->
          <% if feedback.present? %>
            <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); line-height: 1.6; margin-bottom: var(--rp-space-2);"><%= simple_format(feedback.truncate(200)) %></div>
          <% end %>

          <!-- Strengths -->
          <% if strengths.any? %>
            <div style="margin-top: var(--rp-space-2);">
              <% strengths.first(3).each do |s| %>
                <div style="font-size: 11px; color: #16a34a; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">&#10003;</span> <%= s %>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Improvements -->
          <% if improvements.any? %>
            <div style="margin-top: var(--rp-space-1);">
              <% improvements.first(3).each do |imp| %>
                <div style="font-size: 11px; color: #f59e0b; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">&#9651;</span> <%= imp %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- ════════════════════════════════════════════
     2-1. 조건부 역량 (토론/에세이 데이터가 있는 경우만)
     ════════════════════════════════════════════ -->
<% if conditional_sections.any? %>
  <div style="margin-bottom: var(--rp-space-5);">
    <h3 style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: #475569; margin: 0 0 var(--rp-space-3) 0; padding-bottom: var(--rp-space-2); border-bottom: 2px solid #e2e8f0;">
      추가 역량 평가
    </h3>
    <div style="display: grid; grid-template-columns: repeat(<%= conditional_sections.size %>, 1fr); gap: var(--rp-space-4);">
      <% conditional_sections.each do |cs| %>
        <%
          section = sections[cs[:key]] || {}
          score = section["score"]
          feedback = section["feedback"]
          strengths = section["strengths"] || []
          improvements = section["improvements"] || []

          score_color = if score.nil?
            "var(--rp-text-muted)"
          elsif score >= 80
            "#16a34a"
          elsif score >= 60
            "#2563eb"
          elsif score >= 40
            "#f59e0b"
          else
            "#dc2626"
          end
        %>
        <div style="padding: var(--rp-space-4); background: #f8fafc; border: 1px solid #e2e8f0; border-radius: var(--rp-radius-md);">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--rp-space-2);">
            <span style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #334155;"><%= cs[:label] %></span>
            <span style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-bold); color: <%= score_color %>;"><%= score %></span>
          </div>

          <% if score.present? %>
            <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-bottom: var(--rp-space-3); overflow: hidden;">
              <div style="width: <%= score %>%; height: 100%; background: #6366f1; border-radius: 3px;"></div>
            </div>
          <% end %>

          <% if feedback.present? %>
            <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-body); line-height: 1.6; margin-bottom: var(--rp-space-2);"><%= simple_format(feedback.truncate(200)) %></div>
          <% end %>

          <% if strengths.any? %>
            <div style="margin-top: var(--rp-space-2);">
              <% strengths.first(3).each do |s| %>
                <div style="font-size: 11px; color: #16a34a; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">&#10003;</span> <%= s %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if improvements.any? %>
            <div style="margin-top: var(--rp-space-1);">
              <% improvements.first(3).each do |imp| %>
                <div style="font-size: 11px; color: #f59e0b; display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px;">
                  <span style="flex-shrink: 0;">&#9651;</span> <%= imp %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- ════════════════════════════════════════════
     3. 종합 의견
     ════════════════════════════════════════════ -->
<%
  all_strengths = radar_mapping.flat_map { |item|
    (sections.dig(item[:key], "strengths") || []).map { |st| { area: item[:label], text: st } }
  }.uniq { |x| x[:text] }

  all_improvements = radar_mapping.flat_map { |item|
    (sections.dig(item[:key], "improvements") || []).map { |i| { area: item[:label], text: i } }
  }.uniq { |x| x[:text] }

  avg_score = radar_data.any? ? (radar_data.sum { |d| d[:score] } / radar_data.size.to_f).round(1) : 0
  top_areas = radar_data.sort_by { |d| -d[:score] }.first(3)
  weak_areas = radar_data.sort_by { |d| d[:score] }.first(3)
%>

<div style="padding: var(--rp-space-5); background: var(--rp-surface); border: 1px solid var(--rp-border); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5);">
  <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-4);">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
    </svg>
    <h3 style="margin: 0; font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title);">종합 의견</h3>
  </div>

  <!-- 평균 점수 -->
  <div style="display: flex; align-items: center; gap: var(--rp-space-4); margin-bottom: var(--rp-space-4); padding: var(--rp-space-3); background: linear-gradient(135deg, #f0f4ff, #f5f3ff); border-radius: var(--rp-radius-md);">
    <div style="text-align: center; padding: 0 var(--rp-space-4); border-right: 1px solid #e0e7ff;">
      <div style="font-size: 28px; font-weight: 700; color: var(--rp-primary);"><%= avg_score %></div>
      <div style="font-size: 11px; color: var(--rp-text-muted);">9개 역량 평균</div>
    </div>
    <div style="flex: 1;">
      <div style="font-size: var(--rp-font-size-sm); color: var(--rp-text-body); line-height: 1.6;">
        <strong>우수 영역:</strong> <%= top_areas.map { |a| "#{a[:name]}(#{a[:score].to_i}점)" }.join(", ") %><br>
        <strong>보완 영역:</strong> <%= weak_areas.map { |a| "#{a[:name]}(#{a[:score].to_i}점)" }.join(", ") %>
      </div>
    </div>
  </div>

  <!-- 주요 강점 -->
  <% if all_strengths.any? %>
    <div style="margin-bottom: var(--rp-space-4);">
      <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #16a34a; margin: 0 0 var(--rp-space-2) 0;">주요 강점</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
        <% all_strengths.first(6).each do |s| %>
          <div style="font-size: 12px; color: var(--rp-text-body); display: flex; align-items: flex-start; gap: 6px; padding: 6px 10px; background: #f0fdf4; border-radius: var(--rp-radius-sm);">
            <span style="color: #16a34a; flex-shrink: 0; font-weight: 600;">&#10003;</span>
            <span><strong style="color: #166534;"><%= s[:area] %></strong> &mdash; <%= s[:text] %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- 보완이 필요한 부분 -->
  <% if all_improvements.any? %>
    <div>
      <h4 style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: #f59e0b; margin: 0 0 var(--rp-space-2) 0;">보완이 필요한 부분</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
        <% all_improvements.first(6).each do |imp| %>
          <div style="font-size: 12px; color: var(--rp-text-body); display: flex; align-items: flex-start; gap: 6px; padding: 6px 10px; background: #fffbeb; border-radius: var(--rp-radius-sm);">
            <span style="color: #f59e0b; flex-shrink: 0; font-weight: 600;">&#9651;</span>
            <span><strong style="color: #92400e;"><%= imp[:area] %></strong> &mdash; <%= imp[:text] %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- ════════════════════════════════════════════
     4. 학습 권고사항
     ════════════════════════════════════════════ -->
<div style="padding: var(--rp-space-5); background: var(--rp-surface); border: 1px solid var(--rp-border); border-radius: var(--rp-radius-lg); margin-bottom: var(--rp-space-5);">
  <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-4);">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
    <h3 style="margin: 0; font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-bold); color: var(--rp-text-title);">학습 권고사항</h3>
  </div>

  <div style="display: flex; flex-direction: column; gap: var(--rp-space-3);">
    <% weak_areas.each_with_index do |area, idx| %>
      <%
        mapping = radar_mapping.find { |m| m[:label] == area[:name] }
        section_data = mapping ? (sections[mapping[:key]] || {}) : {}
        improvements = section_data["improvements"] || []
        gc = group_colors[mapping&.dig(:group)] || group_colors["이해 역량"]
      %>
      <div style="padding: var(--rp-space-4); background: <%= gc[:bg] %>; border: 1px solid <%= gc[:border] %>; border-radius: var(--rp-radius-md);">
        <div style="display: flex; align-items: center; gap: var(--rp-space-2); margin-bottom: var(--rp-space-2);">
          <span style="width: 24px; height: 24px; border-radius: 50%; background: <%= gc[:bar] %>; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0;"><%= idx + 1 %></span>
          <span style="font-size: var(--rp-font-size-sm); font-weight: var(--rp-font-weight-semibold); color: <%= gc[:title] %>;"><%= area[:name] %></span>
          <span style="font-size: var(--rp-font-size-xs); color: var(--rp-text-muted); margin-left: auto;"><%= area[:score].to_i %>점 / 100</span>
        </div>
        <% if improvements.any? %>
          <ul style="margin: 0; padding-left: 20px; font-size: var(--rp-font-size-xs); color: var(--rp-text-body); line-height: 1.7;">
            <% improvements.first(3).each do |imp| %>
              <li><%= imp %></li>
            <% end %>
          </ul>
        <% else %>
          <div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-muted);">해당 영역의 구체적인 권고사항이 없습니다.</div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Report Metadata -->
<div style="font-size: var(--rp-font-size-xs); color: var(--rp-text-muted); display: flex; gap: var(--rp-space-4); flex-wrap: wrap;">
  <% if report.generated_by.present? %>
    <span>생성: <%= report.generated_by.name %></span>
  <% end %>
  <span>상태: <%= report.published? ? '배포됨' : '초안' %></span>
  <% if report.published_at.present? %>
    <span>배포일: <%= report.published_at.strftime('%Y-%m-%d %H:%M') %></span>
  <% end %>
</div>

<!-- ════════════════════════════════════════════
     레이더 차트 스크립트
     ════════════════════════════════════════════ -->
<script>
(function() {
  var radarData = <%= raw radar_data.to_json %>;

  function draw() {
    var svg = document.getElementById('qr-radar-svg');
    var legend = document.getElementById('qr-radar-legend');
    if (!svg || !radarData || radarData.length === 0) return;

    svg.innerHTML = '';

    var ns = 'http://www.w3.org/2000/svg';
    var cx = 230, cy = 195, radius = 150;
    var n = radarData.length;
    var levels = 5;
    var groupColors = {
      '이해 역량': { fill: 'rgba(59,130,246,0.12)', stroke: '#3b82f6', dot: '#2563eb' },
      '사고 역량': { fill: 'rgba(139,92,246,0.12)', stroke: '#8b5cf6', dot: '#7c3aed' },
      '소통·적용 역량': { fill: 'rgba(22,163,74,0.12)', stroke: '#16a34a', dot: '#15803d' }
    };

    function getPoint(index, value) {
      var angle = (Math.PI * 2 * index / n) - Math.PI / 2;
      var r = radius * (value / 100);
      return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
    }

    // Grid polygons
    for (var lvl = 1; lvl <= levels; lvl++) {
      var r = radius * lvl / levels;
      var pts = [];
      for (var i = 0; i < n; i++) {
        var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
        pts.push((cx + r * Math.cos(angle)) + ',' + (cy + r * Math.sin(angle)));
      }
      var polygon = document.createElementNS(ns, 'polygon');
      polygon.setAttribute('points', pts.join(' '));
      polygon.setAttribute('fill', lvl % 2 === 0 ? 'rgba(241,245,249,0.5)' : 'none');
      polygon.setAttribute('stroke', lvl === levels ? '#cbd5e1' : '#e2e8f0');
      polygon.setAttribute('stroke-width', lvl === levels ? '1.5' : '0.8');
      svg.appendChild(polygon);
      if (lvl % 2 === 0 || lvl === levels) {
        var pct = document.createElementNS(ns, 'text');
        pct.setAttribute('x', cx + 4); pct.setAttribute('y', cy - r + 12);
        pct.setAttribute('fill', '#94a3b8'); pct.setAttribute('font-size', '10');
        pct.textContent = (lvl * 20) + '';
        svg.appendChild(pct);
      }
    }

    // Axis lines & labels
    radarData.forEach(function(d, i) {
      var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
      var endX = cx + radius * Math.cos(angle);
      var endY = cy + radius * Math.sin(angle);
      var line = document.createElementNS(ns, 'line');
      line.setAttribute('x1', cx); line.setAttribute('y1', cy);
      line.setAttribute('x2', endX); line.setAttribute('y2', endY);
      line.setAttribute('stroke', '#e2e8f0'); line.setAttribute('stroke-width', '0.8');
      svg.appendChild(line);

      var labelR = radius + 28;
      var lx = cx + labelR * Math.cos(angle);
      var ly = cy + labelR * Math.sin(angle);
      var colors = groupColors[d.group] || { stroke: '#64748b' };

      var label = document.createElementNS(ns, 'text');
      label.setAttribute('x', lx); label.setAttribute('y', ly);
      label.setAttribute('text-anchor', 'middle'); label.setAttribute('dominant-baseline', 'middle');
      label.setAttribute('fill', colors.stroke); label.setAttribute('font-size', '11'); label.setAttribute('font-weight', '600');
      label.textContent = d.name;
      svg.appendChild(label);

      var scoreLabel = document.createElementNS(ns, 'text');
      scoreLabel.setAttribute('x', lx); scoreLabel.setAttribute('y', ly + 14);
      scoreLabel.setAttribute('text-anchor', 'middle'); scoreLabel.setAttribute('fill', '#94a3b8'); scoreLabel.setAttribute('font-size', '10');
      scoreLabel.textContent = d.score + '점';
      svg.appendChild(scoreLabel);
    });

    // Data polygon
    var dataPoints = radarData.map(function(d, i) {
      var pt = getPoint(i, d.score);
      return pt.x + ',' + pt.y;
    });
    var dataPolygon = document.createElementNS(ns, 'polygon');
    dataPolygon.setAttribute('points', dataPoints.join(' '));
    dataPolygon.setAttribute('fill', 'rgba(99,102,241,0.12)');
    dataPolygon.setAttribute('stroke', '#6366f1');
    dataPolygon.setAttribute('stroke-width', '2.5');
    svg.appendChild(dataPolygon);

    // Data dots
    radarData.forEach(function(d, i) {
      var pt = getPoint(i, d.score);
      var colors = groupColors[d.group] || { dot: '#475569' };
      var dot = document.createElementNS(ns, 'circle');
      dot.setAttribute('cx', pt.x); dot.setAttribute('cy', pt.y); dot.setAttribute('r', '5');
      dot.setAttribute('fill', colors.dot); dot.setAttribute('stroke', 'white'); dot.setAttribute('stroke-width', '2');
      svg.appendChild(dot);
    });

    // Legend
    if (legend) {
      legend.innerHTML = '';
      ['이해 역량', '사고 역량', '소통·적용 역량'].forEach(function(group) {
        var colors = groupColors[group];
        var item = document.createElement('div');
        item.style.cssText = 'display:flex;align-items:center;gap:6px;font-size:12px;color:#475569;font-weight:500;';
        item.innerHTML = '<span style="width:10px;height:10px;border-radius:50%;background:' + colors.stroke + ';flex-shrink:0;"></span><span>' + group + '</span>';
        legend.appendChild(item);
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', draw);
  } else {
    draw();
  }
  document.addEventListener('turbo:load', draw);
})();
</script>
