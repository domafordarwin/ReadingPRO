<% content_for :page_title do %>종합 보고서 - <%= @student.name %><% end %>
<% content_for :head do %>
<% end %>

<div id="report-printable-area">
<!-- 헤더 -->
<div class="cr-show-header">
  <div class="cr-show-header__top">
    <%= link_to diagnostic_teacher_comprehensive_reports_path, class: "cr-show-nav-btn" do %>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
      목록으로
    <% end %>
    <div class="cr-show-header__actions">
      <%= link_to diagnostic_teacher_comprehensive_report_generate_path(@student.id, @attempt.id), class: "cr-show-action-btn cr-show-action-btn--ghost" do %>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        전체 재생성
      <% end %>
      <button id="publish-btn" onclick="togglePublish()"
              class="cr-show-action-btn <%= @report.report_status == 'published' ? 'cr-show-action-btn--danger' : 'cr-show-action-btn--success' %>">
        <% if @report.report_status == 'published' %>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          배포 취소
        <% else %>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          학생에게 배포
        <% end %>
      </button>
    </div>
  </div>

  <!-- 학생 프로필 -->
  <div class="cr-show-profile">
    <div class="cr-show-profile__left">
      <div class="cr-show-profile__avatar"><%= @student.name&.first || "?" %></div>
      <div>
        <div class="cr-show-profile__title-row">
          <h1 class="cr-show-profile__name"><%= @student.name %>의 종합 보고서</h1>
          <span id="status-badge" class="cr-show-badge <%= @report.report_status == 'published' ? 'cr-show-badge--green' : 'cr-show-badge--blue' %>">
            <%= @report.report_status == 'published' ? '배포됨' : '초안' %>
          </span>
        </div>
        <p class="cr-show-profile__meta">
          <%= @attempt.diagnostic_form&.name %> · <%= @attempt.submitted_at&.strftime("%Y-%m-%d") %>
          · 총점: <%= @report.total_score&.to_i %>/<%= @report.max_score&.to_i %> (<%= @report.score_percentage&.to_f&.round(1) %>%)
        </p>
      </div>
    </div>
  </div>
</div>

<!-- 성과 요약 카드 -->
<% summary_data = @report.section_data("overall_summary") %>
<% if summary_data.any? %>
<div class="cr-show-stats">
  <div class="cr-show-stat">
    <div class="cr-show-stat__icon cr-show-stat__icon--slate">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    </div>
    <div>
      <div class="cr-show-stat__label">총점</div>
      <div class="cr-show-stat__value"><%= summary_data["score_percentage"] || "-" %>%</div>
    </div>
  </div>
  <div class="cr-show-stat">
    <div class="cr-show-stat__icon cr-show-stat__icon--blue">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    </div>
    <div>
      <div class="cr-show-stat__label">객관식</div>
      <div class="cr-show-stat__value cr-show-stat__value--blue"><%= summary_data["mcq_correct"] || 0 %>/<%= summary_data["mcq_count"] || 0 %></div>
    </div>
  </div>
  <div class="cr-show-stat">
    <div class="cr-show-stat__icon cr-show-stat__icon--green">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    </div>
    <div>
      <div class="cr-show-stat__label">서술형</div>
      <div class="cr-show-stat__value cr-show-stat__value--green"><%= summary_data["constructed_earned"] || 0 %>/<%= summary_data["constructed_max"] || 0 %></div>
    </div>
  </div>
  <div class="cr-show-stat">
    <div class="cr-show-stat__icon cr-show-stat__icon--purple">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
    </div>
    <%
      level = summary_data["performance_level"] || @report.performance_level
      level_labels = { "advanced" => "우수", "proficient" => "양호", "developing" => "보통", "beginning" => "기초" }
      level_value_classes = { "advanced" => "cr-show-stat__value--green", "proficient" => "cr-show-stat__value--blue", "developing" => "cr-show-stat__value--yellow", "beginning" => "cr-show-stat__value--red" }
    %>
    <div>
      <div class="cr-show-stat__label">수행수준</div>
      <div class="cr-show-stat__value <%= level_value_classes[level] %>"><%= level_labels[level] || "-" %></div>
    </div>
  </div>
</div>
<% end %>

<!-- 7개 섹션 카드 -->
<%
  section_colors = { "overall_summary" => "#667eea", "area_analysis" => "#3b82f6", "mcq_analysis" => "#8b5cf6", "constructed_analysis" => "#16a34a", "reader_tendency" => "#d97706", "comprehensive_opinion" => "#dc2626", "learning_recommendations" => "#0891b2" }
  section_icons_svg = {
    "overall_summary" => '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>',
    "area_analysis" => '<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>',
    "mcq_analysis" => '<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>',
    "constructed_analysis" => '<path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>',
    "reader_tendency" => '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
    "comprehensive_opinion" => '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
    "learning_recommendations" => '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
  }
%>

<% AttemptReport::SECTION_KEYS.each_with_index do |key, idx| %>
  <% section = @report.section(key) %>
  <% color = section_colors[key] || "#64748b" %>
  <div class="cr-show-section" id="section-<%= key %>">
    <!-- 섹션 헤더 -->
    <div class="cr-show-section__header" onclick="toggleSection('<%= key %>')">
      <div class="cr-show-section__title-group">
        <span class="cr-show-section__number" style="background: <%= color %>;"><%= idx + 1 %></span>
        <svg class="cr-show-section__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="<%= color %>" stroke-width="2"><%= raw section_icons_svg[key] %></svg>
        <h3 class="cr-show-section__title"><%= AttemptReport::SECTION_TITLES[key] %></h3>
      </div>
      <div class="cr-show-section__header-right">
        <button onclick="event.stopPropagation(); regenerateSection('<%= key %>')"
                class="regen-btn-<%= key %> cr-show-regen-btn" title="AI 재생성">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          재생성
        </button>
        <svg class="chevron-<%= key %> cr-show-section__chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>
    </div>

    <!-- 영역별 분석 데이터 시각화 (이분할 레이아웃) -->
    <% if key == "area_analysis" && section.dig("data", "indicators").present? %>
      <div id="section-data-<%= key %>" class="cr-show-section__data">
        <% radar_data = section.dig("data", "radar_data") %>
        <%
          indicator_colors = {
            "이해력" => { bg: "#eff6ff", border: "#bfdbfe", text: "#1e40af", bar: "#3b82f6", icon_bg: "#dbeafe" },
            "심미적 감수성" => { bg: "#faf5ff", border: "#e9d5ff", text: "#6b21a8", bar: "#8b5cf6", icon_bg: "#f3e8ff" },
            "의사소통 능력" => { bg: "#f0fdf4", border: "#bbf7d0", text: "#166534", bar: "#16a34a", icon_bg: "#dcfce7" }
          }
          indicator_icons = {
            "이해력" => '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
            "심미적 감수성" => '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>',
            "의사소통 능력" => '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>'
          }
        %>
        <div class="cr-show-area-split">
          <!-- 왼쪽: 영역별 지수 카드 -->
          <div class="cr-show-area-left">
            <% section.dig("data", "indicators")&.each do |ind| %>
              <%
                colors = indicator_colors[ind["name"]] || { bg: "#f8fafc", border: "#e2e8f0", text: "#334155", bar: "#64748b", icon_bg: "#f1f5f9" }
                icon_svg = indicator_icons[ind["name"]] || '<circle cx="12" cy="12" r="10"/>'
                accuracy = ind["mcq_accuracy"].to_f
                level_text = accuracy >= 80 ? "우수" : (accuracy >= 60 ? "양호" : (accuracy >= 40 ? "보통" : "기초"))
                level_class = accuracy >= 80 ? "green" : (accuracy >= 60 ? "blue" : (accuracy >= 40 ? "yellow" : "red"))
              %>
              <div class="cr-show-area-card" style="border-left: 3px solid <%= colors[:bar] %>;">
                <div class="cr-show-area-card__top">
                  <div class="cr-show-area-card__icon" style="background: <%= colors[:icon_bg] %>;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="<%= colors[:bar] %>" stroke-width="2"><%= raw icon_svg %></svg>
                  </div>
                  <div class="cr-show-area-card__info">
                    <div class="cr-show-area-card__name" style="color: <%= colors[:text] %>;"><%= ind["name"] %></div>
                    <div class="cr-show-area-card__meta">문항 <%= ind["total_items"] %>개</div>
                  </div>
                  <div class="cr-show-area-card__score">
                    <span class="cr-show-area-card__pct" style="color: <%= colors[:bar] %>;"><%= accuracy.round(1) %>%</span>
                    <span class="cr-show-area-card__level cr-show-area-card__level--<%= level_class %>"><%= level_text %></span>
                  </div>
                </div>
                <div class="cr-show-area-card__bar">
                  <div class="cr-show-area-card__bar-fill" style="width: <%= accuracy %>%; background: <%= colors[:bar] %>;"></div>
                </div>
                <% sub_indicators = radar_data&.select { |r| r["group"] == ind["name"] } %>
                <% if sub_indicators.present? %>
                  <div class="cr-show-area-card__subs">
                    <% sub_indicators.each do |si| %>
                      <div class="cr-show-area-card__sub">
                        <span class="cr-show-area-card__sub-name"><%= si["name"] %></span>
                        <span class="cr-show-area-card__sub-score" style="color: <%= colors[:bar] %>;"><%= si["score"] %>%</span>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>

          <!-- 오른쪽: 레이더 차트 -->
          <% if radar_data.present? %>
            <div class="cr-show-area-right">
              <h4 class="cr-show-area-right__title">세부 지표별 달성률</h4>
              <div class="cr-radar-chart" id="radar-chart-teacher">
                <svg id="radar-svg-teacher" viewBox="0 0 460 420" width="100%"></svg>
              </div>
              <div class="cr-radar-legend" id="radar-legend-teacher"></div>
              <script>
                document.addEventListener('turbo:load', function() {
                  const radarData = <%= json_escape(radar_data.to_json) %>;
                  if (radarData.length > 0) drawRadarChart('radar-svg-teacher', 'radar-legend-teacher', radarData);
                });
              </script>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- 섹션 본문 -->
    <div id="section-body-<%= key %>" class="cr-show-section__body">
      <!-- 커스텀 프롬프트 패널 -->
      <div id="prompt-panel-<%= key %>" class="cr-show-prompt" style="display: none;">
        <label class="cr-show-prompt__label">AI 재생성 커스텀 프롬프트:</label>
        <textarea id="prompt-input-<%= key %>" rows="2" class="cr-show-prompt__input"
                  placeholder="예: 더 격려적인 톤으로 작성해주세요..."></textarea>
        <div class="cr-show-prompt__actions">
          <button onclick="regenerateSection('<%= key %>', true)" class="cr-show-btn cr-show-btn--primary cr-show-btn--sm">프롬프트로 재생성</button>
          <button onclick="document.getElementById('prompt-panel-<%= key %>').style.display='none'" class="cr-show-btn cr-show-btn--ghost cr-show-btn--sm">닫기</button>
        </div>
      </div>

      <!-- 텍스트 편집 -->
      <textarea id="content-<%= key %>" rows="8" class="cr-show-textarea"><%= section["content"].to_s %></textarea>

      <!-- 섹션 액션 -->
      <div class="cr-show-section__actions">
        <button onclick="document.getElementById('prompt-panel-<%= key %>').style.display = document.getElementById('prompt-panel-<%= key %>').style.display === 'none' ? 'block' : 'none'"
                class="cr-show-btn cr-show-btn--ghost cr-show-btn--sm">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          커스텀 프롬프트
        </button>
        <button onclick="saveSection('<%= key %>')" id="save-btn-<%= key %>" class="cr-show-btn cr-show-btn--primary cr-show-btn--sm">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          저장
        </button>
      </div>
    </div>
  </div>
<% end %>
</div><!-- end report-printable-area -->

<!-- PDF 저장 / HWPx / 인쇄 액션 바 -->
<div class="cr-show-actions-bar no-print">
  <%= link_to diagnostic_teacher_comprehensive_report_download_pdf_path(@student.id, @attempt.id),
        class: "cr-show-actions-bar__btn cr-show-actions-bar__btn--pdf",
        data: { turbo: false },
        id: "pdf-download-btn" do %>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    PDF 저장
  <% end %>
  <%= link_to diagnostic_teacher_comprehensive_report_download_hwpx_path(@student.id, @attempt.id),
        class: "cr-show-actions-bar__btn cr-show-actions-bar__btn--hwpx",
        data: { turbo: false },
        id: "hwpx-download-btn" do %>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
    HWPx 저장
  <% end %>
  <button onclick="window.print()" class="cr-show-actions-bar__btn cr-show-actions-bar__btn--print">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
    인쇄
  </button>
</div>

<!-- 토스트 -->
<div id="toast" class="cr-show-toast"></div>

<!-- 레이더 차트 공통 함수 -->
<script>
function drawRadarChart(svgId, legendId, data) {
  const svg = document.getElementById(svgId);
  const legend = document.getElementById(legendId);
  if (!svg || !data || data.length === 0) return;

  const ns = 'http://www.w3.org/2000/svg';
  const cx = 230, cy = 195, radius = 150;
  const n = data.length;
  const levels = 5;
  const groupColors = {
    '이해력': { fill: 'rgba(59,130,246,0.15)', stroke: '#3b82f6', dot: '#2563eb' },
    '심미적 감수성': { fill: 'rgba(139,92,246,0.15)', stroke: '#8b5cf6', dot: '#7c3aed' },
    '의사소통 능력': { fill: 'rgba(22,163,74,0.15)', stroke: '#16a34a', dot: '#15803d' }
  };
  const defaultColor = { fill: 'rgba(100,116,139,0.15)', stroke: '#64748b', dot: '#475569' };

  function getPoint(index, value) {
    const angle = (Math.PI * 2 * index / n) - Math.PI / 2;
    const r = radius * (value / 100);
    return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
  }

  for (let lvl = 1; lvl <= levels; lvl++) {
    const r = radius * lvl / levels;
    let pts = [];
    for (let i = 0; i < n; i++) {
      const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
      pts.push(`${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`);
    }
    const polygon = document.createElementNS(ns, 'polygon');
    polygon.setAttribute('points', pts.join(' '));
    polygon.setAttribute('fill', 'none');
    polygon.setAttribute('stroke', lvl === levels ? '#cbd5e1' : '#e2e8f0');
    polygon.setAttribute('stroke-width', lvl === levels ? '1.5' : '0.8');
    svg.appendChild(polygon);
    if (lvl % 2 === 0 || lvl === levels) {
      const pct = document.createElementNS(ns, 'text');
      pct.setAttribute('x', cx + 4); pct.setAttribute('y', cy - r + 12);
      pct.setAttribute('fill', '#94a3b8'); pct.setAttribute('font-size', '10');
      pct.textContent = (lvl * 20) + '%';
      svg.appendChild(pct);
    }
  }

  data.forEach((d, i) => {
    const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
    const endX = cx + radius * Math.cos(angle);
    const endY = cy + radius * Math.sin(angle);
    const line = document.createElementNS(ns, 'line');
    line.setAttribute('x1', cx); line.setAttribute('y1', cy);
    line.setAttribute('x2', endX); line.setAttribute('y2', endY);
    line.setAttribute('stroke', '#e2e8f0'); line.setAttribute('stroke-width', '0.8');
    svg.appendChild(line);

    const labelR = radius + 28;
    const lx = cx + labelR * Math.cos(angle);
    const ly = cy + labelR * Math.sin(angle);
    const colors = groupColors[d.group] || defaultColor;

    const label = document.createElementNS(ns, 'text');
    label.setAttribute('x', lx); label.setAttribute('y', ly);
    label.setAttribute('text-anchor', 'middle'); label.setAttribute('dominant-baseline', 'middle');
    label.setAttribute('fill', colors.stroke); label.setAttribute('font-size', '11'); label.setAttribute('font-weight', '600');
    label.textContent = d.name;
    svg.appendChild(label);

    const scoreLabel = document.createElementNS(ns, 'text');
    scoreLabel.setAttribute('x', lx); scoreLabel.setAttribute('y', ly + 14);
    scoreLabel.setAttribute('text-anchor', 'middle'); scoreLabel.setAttribute('fill', '#94a3b8'); scoreLabel.setAttribute('font-size', '10');
    scoreLabel.textContent = d.score + '%';
    svg.appendChild(scoreLabel);
  });

  let dataPoints = data.map((d, i) => { const pt = getPoint(i, d.score); return `${pt.x},${pt.y}`; });
  const dataPolygon = document.createElementNS(ns, 'polygon');
  dataPolygon.setAttribute('points', dataPoints.join(' '));
  dataPolygon.setAttribute('fill', 'rgba(99,102,241,0.12)');
  dataPolygon.setAttribute('stroke', '#6366f1'); dataPolygon.setAttribute('stroke-width', '2');
  svg.appendChild(dataPolygon);

  data.forEach((d, i) => {
    const pt = getPoint(i, d.score);
    const colors = groupColors[d.group] || defaultColor;
    const dot = document.createElementNS(ns, 'circle');
    dot.setAttribute('cx', pt.x); dot.setAttribute('cy', pt.y); dot.setAttribute('r', '5');
    dot.setAttribute('fill', colors.dot); dot.setAttribute('stroke', 'white'); dot.setAttribute('stroke-width', '2');
    svg.appendChild(dot);
  });

  if (legend) {
    legend.innerHTML = '';
    [...new Set(data.map(d => d.group))].forEach(group => {
      const colors = groupColors[group] || defaultColor;
      const item = document.createElement('div');
      item.className = 'cr-radar-legend__item';
      item.innerHTML = `<span class="cr-radar-legend__dot" style="background:${colors.stroke}"></span><span>${group}</span>`;
      legend.appendChild(item);
    });
  }
}
</script>

<!-- JavaScript -->
<script>
  const studentId = '<%= @student.id %>';
  const attemptId = '<%= @attempt.id %>';
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block'; toast.style.opacity = '1';
    toast.className = 'cr-show-toast ' + (type === 'success' ? 'cr-show-toast--success' : 'cr-show-toast--error');
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.style.display = 'none', 300); }, 3000);
  }

  function toggleSection(key) {
    const body = document.getElementById('section-body-' + key);
    const dataPanel = document.getElementById('section-data-' + key);
    const chevron = document.querySelector('.chevron-' + key);
    const isHidden = body.style.display === 'none';
    body.style.display = isHidden ? 'block' : 'none';
    if (dataPanel) dataPanel.style.display = isHidden ? 'block' : 'none';
    if (chevron) chevron.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
  }

  async function saveSection(key) {
    const content = document.getElementById('content-' + key).value;
    const btn = document.getElementById('save-btn-' + key);
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="cr-show-spinner"></span> 저장 중...'; btn.disabled = true;
    try {
      const response = await fetch(`/diagnostic_teacher/comprehensive_reports/${studentId}/${attemptId}/update_section`, {
        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ section_key: key, content: content })
      });
      const data = await response.json();
      showToast(data.success ? (data.message || '저장되었습니다.') : (data.error || '저장 실패'), data.success ? 'success' : 'error');
    } catch (e) { showToast('네트워크 오류', 'error'); }
    finally { btn.innerHTML = originalHTML; btn.disabled = false; }
  }

  async function regenerateSection(key, useCustomPrompt = false) {
    const btn = document.querySelector('.regen-btn-' + key);
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="cr-show-spinner"></span> 생성 중...'; btn.disabled = true;
    const body = { section_key: key };
    if (useCustomPrompt) {
      const promptInput = document.getElementById('prompt-input-' + key);
      if (promptInput && promptInput.value.trim()) body.custom_prompt = promptInput.value.trim();
    }
    try {
      const response = await fetch(`/diagnostic_teacher/comprehensive_reports/${studentId}/${attemptId}/regenerate_section`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify(body)
      });
      const data = await response.json();
      if (data.success && data.section) {
        document.getElementById('content-' + key).value = data.section.content || '';
        showToast('섹션이 재생성되었습니다.');
        const panel = document.getElementById('prompt-panel-' + key);
        if (panel) panel.style.display = 'none';
      } else { showToast(data.error || '재생성 실패', 'error'); }
    } catch (e) { showToast('네트워크 오류', 'error'); }
    finally { btn.innerHTML = originalHTML; btn.disabled = false; }
  }

  async function togglePublish() {
    const btn = document.getElementById('publish-btn');
    const badge = document.getElementById('status-badge');
    const isPublished = badge.textContent.trim() === '배포됨';
    const action = isPublished ? 'unpublish' : 'publish';
    if (isPublished && !confirm('배포를 취소하시겠습니까? 학생이 보고서를 볼 수 없게 됩니다.')) return;
    if (!isPublished && !confirm('보고서를 학생에게 배포하시겠습니까?')) return;
    btn.disabled = true; btn.textContent = '처리 중...';
    try {
      const response = await fetch(`/diagnostic_teacher/comprehensive_reports/${studentId}/${attemptId}/${action}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken }
      });
      const data = await response.json();
      if (data.success) {
        showToast(data.message);
        if (action === 'publish') {
          badge.textContent = '배포됨'; badge.className = 'cr-show-badge cr-show-badge--green';
          btn.className = 'cr-show-action-btn cr-show-action-btn--danger';
          btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> 배포 취소';
        } else {
          badge.textContent = '초안'; badge.className = 'cr-show-badge cr-show-badge--blue';
          btn.className = 'cr-show-action-btn cr-show-action-btn--success';
          btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> 학생에게 배포';
        }
      } else { showToast(data.error || '처리 실패', 'error'); }
    } catch (e) { showToast('네트워크 오류', 'error'); }
    finally { btn.disabled = false; }
  }
</script>

<style>
  /* ── 헤더 ── */
  .cr-show-header { margin-bottom: 24px; }
  .cr-show-header__top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
  .cr-show-header__actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

  .cr-show-nav-btn {
    display: inline-flex; align-items: center; gap: 4px; font-size: var(--rp-font-size-lg); font-weight: 500;
    color: #64748b; text-decoration: none; padding: 7px 14px; border-radius: 8px;
    border: 1px solid #e2e8f0; background: white; transition: all 0.15s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  }
  .cr-show-nav-btn:hover { background: #f8fafc; color: #334155; border-color: #cbd5e1; }

  .cr-show-action-btn {
    display: inline-flex; align-items: center; gap: 5px; padding: 7px 16px; border-radius: 8px;
    font-size: var(--rp-font-size-lg); font-weight: 500; cursor: pointer; border: 1px solid transparent;
    transition: all 0.15s; text-decoration: none; white-space: nowrap;
  }
  .cr-show-action-btn--ghost { background: white; color: #475569; border-color: #e2e8f0; }
  .cr-show-action-btn--ghost:hover { background: #f8fafc; border-color: #cbd5e1; }
  .cr-show-action-btn--success { background: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }
  .cr-show-action-btn--success:hover { background: #dcfce7; color: #15803d; }
  .cr-show-action-btn--danger { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
  .cr-show-action-btn--danger:hover { background: #fee2e2; color: #b91c1c; }

  /* 프로필 카드 */
  .cr-show-profile {
    display: flex; align-items: center; justify-content: space-between; gap: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; border-radius: 12px; padding: 20px 24px;
    box-shadow: 0 4px 12px rgba(102,126,234,0.25);
  }
  .cr-show-profile__left { display: flex; align-items: center; gap: 16px; }
  .cr-show-profile__avatar {
    width: 48px; height: 48px; background: rgba(255,255,255,0.2);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: var(--rp-font-size-xl); font-weight: 700; flex-shrink: 0;
  }
  .cr-show-profile__title-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
  .cr-show-profile__name { font-size: var(--rp-font-size-xl); font-weight: 700; margin: 0; }
  .cr-show-profile__meta { font-size: var(--rp-font-size-lg); opacity: 0.85; margin: 0; }

  .cr-show-badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: var(--rp-font-size-md); font-weight: 500; }
  .cr-show-badge--green { background: rgba(255,255,255,0.2); color: #bbf7d0; }
  .cr-show-badge--blue { background: rgba(255,255,255,0.2); color: #bfdbfe; }

  /* ── 통계 카드 ── */
  .cr-show-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0 24px; }
  .cr-show-stat {
    display: flex; align-items: center; gap: 12px; background: white; border: 1px solid #e2e8f0;
    border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    transition: box-shadow 0.2s, transform 0.2s;
  }
  .cr-show-stat:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
  .cr-show-stat__icon {
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .cr-show-stat__icon--slate { background: #f1f5f9; color: #475569; }
  .cr-show-stat__icon--blue { background: #eff6ff; color: #3b82f6; }
  .cr-show-stat__icon--green { background: #f0fdf4; color: #16a34a; }
  .cr-show-stat__icon--purple { background: #faf5ff; color: #8b5cf6; }
  .cr-show-stat__label { font-size: var(--rp-font-size-sm); color: #94a3b8; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
  .cr-show-stat__value { font-size: var(--rp-font-size-xl); font-weight: 700; color: #0f172a; }
  .cr-show-stat__value--blue { color: #2563eb; }
  .cr-show-stat__value--green { color: #16a34a; }
  .cr-show-stat__value--yellow { color: #d97706; }
  .cr-show-stat__value--red { color: #dc2626; }

  /* ── 섹션 카드 ── */
  .cr-show-section {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px;
    overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    transition: box-shadow 0.2s;
  }
  .cr-show-section:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .cr-show-section__header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px; cursor: pointer; transition: background 0.15s;
  }
  .cr-show-section__header:hover { background: #fafbfc; }
  .cr-show-section__title-group { display: flex; align-items: center; gap: 10px; }
  .cr-show-section__number {
    width: 26px; height: 26px; color: white; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: var(--rp-font-size-md); font-weight: 700; flex-shrink: 0;
  }
  .cr-show-section__icon { flex-shrink: 0; }
  .cr-show-section__title { font-size: var(--rp-font-size-xl); font-weight: 600; color: #0f172a; margin: 0; }
  .cr-show-section__header-right { display: flex; align-items: center; gap: 8px; }
  .cr-show-section__chevron { transition: transform 0.2s; flex-shrink: 0; }
  .cr-show-section__body { padding: 20px; border-top: 1px solid #f1f5f9; }
  .cr-show-section__actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }

  /* 재생성 버튼 */
  .cr-show-regen-btn {
    padding: 4px 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;
    font-size: var(--rp-font-size-md); color: #64748b; cursor: pointer; display: inline-flex; align-items: center;
    gap: 4px; transition: all 0.15s;
  }
  .cr-show-regen-btn:hover { background: #eff6ff; color: #3b82f6; border-color: #bfdbfe; }
  .cr-show-regen-btn:disabled { opacity: 0.6; cursor: not-allowed; }

  /* ── 데이터 영역 ── */
  .cr-show-section__data { padding: 20px; background: #f8fafc; border-top: 1px solid #f1f5f9; }

  /* 이분할 레이아웃 */
  .cr-show-area-split { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: stretch; }
  .cr-show-area-left { display: flex; flex-direction: column; gap: 12px; }
  .cr-show-area-right {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px;
    text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    display: flex; flex-direction: column; justify-content: center;
  }
  .cr-show-area-right__title { font-size: var(--rp-font-size-lg); font-weight: 600; color: #475569; margin: 0 0 12px 0; }

  /* 영역 카드 */
  .cr-show-area-card {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: box-shadow 0.2s, transform 0.2s;
  }
  .cr-show-area-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
  .cr-show-area-card__top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .cr-show-area-card__icon {
    width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .cr-show-area-card__info { flex: 1; min-width: 0; }
  .cr-show-area-card__name { font-size: var(--rp-font-size-lg); font-weight: 600; }
  .cr-show-area-card__meta { font-size: var(--rp-font-size-sm); color: #94a3b8; margin-top: 1px; }
  .cr-show-area-card__score { text-align: right; flex-shrink: 0; }
  .cr-show-area-card__pct { font-size: var(--rp-font-size-xl); font-weight: 700; display: block; line-height: 1.2; }
  .cr-show-area-card__level {
    display: inline-block; font-size: var(--rp-font-size-sm); font-weight: 600; padding: 2px 8px; border-radius: 10px; margin-top: 2px;
  }
  .cr-show-area-card__level--green { background: #dcfce7; color: #166534; }
  .cr-show-area-card__level--blue { background: #dbeafe; color: #1e40af; }
  .cr-show-area-card__level--yellow { background: #fef3c7; color: #92400e; }
  .cr-show-area-card__level--red { background: #fee2e2; color: #991b1b; }

  /* 프로그레스 바 */
  .cr-show-area-card__bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
  .cr-show-area-card__bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

  /* 세부 지표 */
  .cr-show-area-card__subs { display: flex; flex-direction: column; gap: 4px; }
  .cr-show-area-card__sub {
    display: flex; justify-content: space-between; align-items: center;
    padding: 4px 8px; background: #f8fafc; border-radius: 6px; font-size: var(--rp-font-size-md);
  }
  .cr-show-area-card__sub-name { color: #64748b; }
  .cr-show-area-card__sub-score { font-weight: 600; }

  /* ── 프롬프트 패널 ── */
  .cr-show-prompt { margin-bottom: 12px; padding: 14px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; }
  .cr-show-prompt__label { font-size: var(--rp-font-size-md); font-weight: 600; color: #475569; margin-bottom: 6px; display: block; }
  .cr-show-prompt__input {
    width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px;
    font-size: var(--rp-font-size-lg); resize: vertical; box-sizing: border-box; background: white;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .cr-show-prompt__input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
  .cr-show-prompt__actions { display: flex; gap: 6px; margin-top: 8px; }

  /* ── 텍스트 에디터 ── */
  .cr-show-textarea {
    width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px;
    font-size: var(--rp-font-size-lg); line-height: 1.7; color: #1e293b; resize: vertical; box-sizing: border-box;
    font-family: inherit; background: #fafbfc;
    transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
  }
  .cr-show-textarea:focus { outline: none; border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

  /* ── 버튼 ── */
  .cr-show-btn {
    display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px; border-radius: 8px;
    font-size: var(--rp-font-size-lg); font-weight: 500; cursor: pointer; border: 1px solid transparent;
    transition: all 0.15s; text-decoration: none; white-space: nowrap;
  }
  .cr-show-btn--sm { padding: 6px 12px; font-size: var(--rp-font-size-md); }
  .cr-show-btn--primary { background: #2563eb; color: white; border: none; }
  .cr-show-btn--primary:hover { background: #1d4ed8; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
  .cr-show-btn--ghost { background: white; color: #475569; border-color: #e2e8f0; }
  .cr-show-btn--ghost:hover { background: #f8fafc; border-color: #cbd5e1; }

  /* ── 토스트 ── */
  .cr-show-toast {
    display: none; position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
    border-radius: 10px; font-size: var(--rp-font-size-lg); font-weight: 500; z-index: 9999;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15); transition: opacity 0.3s;
  }
  .cr-show-toast--success { background: #16a34a; color: white; }
  .cr-show-toast--error { background: #dc2626; color: white; }

  /* ── 스피너 ── */
  .cr-show-spinner { display: inline-block; width: 13px; height: 13px; border: 2px solid rgba(100,116,139,0.3); border-radius: 50%; border-top-color: #64748b; animation: cr-show-spin 0.6s linear infinite; }
  @keyframes cr-show-spin { to { transform: rotate(360deg); } }

  /* ── 레이더 차트 ── */
  .cr-radar-wrapper { text-align: center; margin-bottom: 16px; }
  .cr-radar-wrapper__title { font-size: var(--rp-font-size-lg); font-weight: 600; color: #334155; margin: 0 0 12px 0; }
  .cr-radar-chart { display: flex; justify-content: center; }
  .cr-radar-chart svg { max-width: 460px; width: 100%; height: auto; }
  .cr-radar-legend { display: flex; justify-content: center; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
  .cr-radar-legend__item { display: flex; align-items: center; gap: 6px; font-size: var(--rp-font-size-md); color: #475569; font-weight: 500; }
  .cr-radar-legend__dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* ── PDF/Print 액션 바 ── */
  .cr-show-actions-bar {
    display: flex; justify-content: center; gap: 12px; padding: 24px 0; margin-top: 8px;
  }
  .cr-show-actions-bar__btn {
    display: inline-flex; align-items: center; gap: 8px; padding: 12px 28px;
    border-radius: 10px; font-size: var(--rp-font-size-lg); font-weight: 500; cursor: pointer;
    border: 1px solid transparent; transition: all 0.2s;
  }
  .cr-show-actions-bar__btn--pdf {
    background: #dc2626; color: white;
  }
  .cr-show-actions-bar__btn--pdf:hover {
    background: #b91c1c; box-shadow: 0 4px 12px rgba(220,38,38,0.3);
  }
  .cr-show-actions-bar__btn--pdf:disabled {
    background: #9ca3af; cursor: not-allowed; box-shadow: none;
  }
  .cr-show-actions-bar__btn--hwpx {
    background: #2563eb; color: white; text-decoration: none;
  }
  .cr-show-actions-bar__btn--hwpx:hover {
    background: #1d4ed8; color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3);
  }
  .cr-show-actions-bar__btn--print {
    background: white; color: #475569; border-color: #e2e8f0;
  }
  .cr-show-actions-bar__btn--print:hover {
    background: #f8fafc; border-color: #cbd5e1; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  /* ── 반응형 ── */
  @media (max-width: 900px) {
    .cr-show-area-split { grid-template-columns: 1fr; }
    .cr-show-area-right { order: -1; }
  }
  @media (max-width: 768px) {
    .cr-show-stats { grid-template-columns: repeat(2, 1fr); }
    .cr-show-header__top { flex-direction: column; align-items: flex-start; }
  }
  @media print {
    .cr-radar-chart svg { max-width: 350px; }
    .cr-show-regen-btn, .cr-show-section__actions, .cr-show-prompt, .cr-show-header__actions, .cr-show-header__top { display: none !important; }
    .cr-show-actions-bar, .cr-show-toast, .no-print { display: none !important; }
    .rp-header, .rp-sidebar { display: none !important; }
    .rp-layout, .rp-layout__body { display: block !important; }
    .rp-main { width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
    .rp-main__container { padding: 0 !important; max-width: 100% !important; }
    body { background: white !important; }
    .cr-show-section { break-inside: avoid; }
    .cr-show-textarea { border: none !important; background: transparent !important; padding: 0 !important; resize: none !important; }
  }
</style>
