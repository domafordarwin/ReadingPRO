<% content_for :page_title do %>보고서 생성<% end %>

<%
  status_label = case @attempt.status
                 when "completed", "submitted" then "완료"
                 when "in_progress" then "진행 중"
                 else @attempt.status
                 end
%>

<!-- 헤더 내비게이션 -->
<div class="cr-gen-nav">
  <%= link_to diagnostic_teacher_comprehensive_reports_path, class: "cr-gen-nav__back" do %>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
    목록으로
  <% end %>
  <% if @report&.comprehensive_report_generated? %>
    <%= link_to diagnostic_teacher_comprehensive_report_path(@student.id, @attempt.id), class: "cr-gen-nav__link" do %>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      기존 보고서 보기
    <% end %>
  <% end %>
</div>

<!-- 페이지 타이틀 -->
<div class="cr-gen-header">
  <h1 class="cr-gen-header__title">종합 결과 보고서 생성</h1>
  <p class="cr-gen-header__desc">AI가 학생의 진단 데이터를 종합 분석하여 보고서를 생성합니다</p>
</div>

<!-- 학생 프로필 카드 -->
<div class="cr-gen-profile">
  <div class="cr-gen-profile__avatar"><%= @student.name&.first || "?" %></div>
  <div class="cr-gen-profile__info">
    <div class="cr-gen-profile__name"><%= @student.name %></div>
    <div class="cr-gen-profile__meta">
      <span><%= @student.school&.name || "미지정" %></span>
      <span class="cr-gen-profile__sep">·</span>
      <span><%= @student.grade %>학년 <%= @student.class_name %>반</span>
    </div>
  </div>
</div>

<!-- 진단 정보 카드 -->
<div class="cr-gen-info-cards">
  <div class="cr-gen-info-card">
    <div class="cr-gen-info-card__icon cr-gen-info-card__icon--blue">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
    </div>
    <div class="cr-gen-info-card__label">진단지</div>
    <div class="cr-gen-info-card__value"><%= @attempt.diagnostic_form&.name || "미지정" %></div>
  </div>
  <div class="cr-gen-info-card">
    <div class="cr-gen-info-card__icon cr-gen-info-card__icon--slate">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    </div>
    <div class="cr-gen-info-card__label">진단일</div>
    <div class="cr-gen-info-card__value"><%= @attempt.submitted_at&.strftime("%Y-%m-%d") || "-" %></div>
  </div>
  <div class="cr-gen-info-card">
    <div class="cr-gen-info-card__icon cr-gen-info-card__icon--green">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    </div>
    <div class="cr-gen-info-card__label">상태</div>
    <div class="cr-gen-info-card__value cr-gen-info-card__value--green"><%= status_label %></div>
  </div>
  <div class="cr-gen-info-card">
    <div class="cr-gen-info-card__icon cr-gen-info-card__icon--slate">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    </div>
    <div class="cr-gen-info-card__label">소요시간</div>
    <div class="cr-gen-info-card__value"><%= @attempt.time_spent_seconds ? "#{(@attempt.time_spent_seconds / 60.0).round}분" : "-" %></div>
  </div>
</div>

<!-- 데이터 요약 -->
<div class="cr-gen-data">
  <div class="cr-gen-data__header">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
    <h3 class="cr-gen-data__title">보고서 생성에 사용할 데이터</h3>
  </div>
  <div class="cr-gen-data__grid">
    <div class="cr-gen-data__item cr-gen-data__item--blue">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      <div class="cr-gen-data__item-value"><%= @mcq_count %></div>
      <div class="cr-gen-data__item-label">객관식 문항</div>
    </div>
    <div class="cr-gen-data__item cr-gen-data__item--green">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      <div class="cr-gen-data__item-value"><%= @constructed_count %></div>
      <div class="cr-gen-data__item-label">서술형 문항</div>
    </div>
    <div class="cr-gen-data__item <%= @has_reader_tendency ? 'cr-gen-data__item--purple' : 'cr-gen-data__item--gray' %>">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      <div class="cr-gen-data__item-value">
        <% if @has_reader_tendency %>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
        <% else %>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        <% end %>
      </div>
      <div class="cr-gen-data__item-label">독자 성향</div>
    </div>
    <div class="cr-gen-data__item <%= @has_feedbacks ? 'cr-gen-data__item--purple' : 'cr-gen-data__item--gray' %>">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <div class="cr-gen-data__item-value">
        <% if @has_feedbacks %>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
        <% else %>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        <% end %>
      </div>
      <div class="cr-gen-data__item-label">AI 피드백</div>
    </div>
  </div>
</div>

<!-- 기존 보고서 경고 -->
<% if @report&.comprehensive_report_generated? %>
  <div class="cr-gen-alert">
    <div class="cr-gen-alert__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    </div>
    <div class="cr-gen-alert__content">
      <strong class="cr-gen-alert__title">기존 보고서가 있습니다</strong>
      <p class="cr-gen-alert__body">
        보고서를 재생성하면 기존 내용이 모두 덮어씌워집니다.
        <% if @report.report_status == "published" %>
          <strong>현재 배포 상태이므로 재생성 시 초안으로 변경됩니다.</strong>
        <% end %>
      </p>
    </div>
  </div>
<% end %>

<!-- 생성 중 폴링 UI -->
<% if @report&.job_status == "processing" %>
  <div class="cr-gen-action cr-gen-action--processing"
       data-controller="job-status"
       data-job-status-url-value="<%= diagnostic_teacher_comprehensive_report_job_status_path(@student.id, @attempt.id) %>"
       data-job-status-redirect-value="<%= diagnostic_teacher_comprehensive_report_path(@student.id, @attempt.id) %>"
       data-job-status-interval-value="3000">
    <div class="cr-gen-action__icon">
      <div class="cr-gen-spinner cr-gen-spinner--large"></div>
    </div>
    <p class="cr-gen-action__desc">
      <strong data-job-status-target="indicator">AI가 종합 보고서를 생성하고 있습니다...</strong><br>
      완료되면 자동으로 보고서 페이지로 이동합니다.
    </p>
    <div class="cr-gen-action__hint">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      약 30초~1분 소요
    </div>
  </div>
<% elsif @report&.job_status == "failed" %>
  <div class="cr-gen-alert" style="margin-bottom: 20px;">
    <div class="cr-gen-alert__icon" style="color: #dc2626;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    </div>
    <div class="cr-gen-alert__content">
      <strong class="cr-gen-alert__title" style="color: #991b1b;">보고서 생성 실패</strong>
      <p class="cr-gen-alert__body" style="color: #b91c1c;"><%= @report.job_error %></p>
    </div>
  </div>
<% end %>

<!-- 생성 액션 -->
<div class="cr-gen-action" <% if @report&.job_status == "processing" %>style="display:none"<% end %>>
  <div class="cr-gen-action__icon">
    <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="1.5">
      <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
    </svg>
  </div>
  <p class="cr-gen-action__desc">
    AI가 객관식/서술형 답안, 피드백 결과, 독자 성향 데이터를 종합 분석하여<br>
    <strong>7개 섹션</strong>으로 구성된 종합 보고서를 생성합니다.
  </p>
  <div class="cr-gen-action__hint">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    약 30초~1분 소요 (백그라운드에서 자동 처리)
  </div>
  <div class="cr-gen-action__buttons">
    <% if @report&.comprehensive_report_generated? %>
      <%= link_to diagnostic_teacher_comprehensive_report_path(@student.id, @attempt.id), class: "cr-gen-btn cr-gen-btn--secondary" do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        기존 보고서 보기
      <% end %>
    <% end %>
    <%= form_tag(diagnostic_teacher_comprehensive_report_create_path(@student.id, @attempt.id), method: :post, data: { turbo: false }, style: "display:inline") do %>
      <button type="submit" id="generate-btn" class="cr-gen-btn cr-gen-btn--primary"
              onclick="this.disabled=true; this.innerHTML='<span class=\'cr-gen-spinner\'></span> 요청 중...'; this.form.submit();">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        <%= @report&.comprehensive_report_generated? ? "보고서 재생성" : "종합 보고서 생성" %>
      </button>
    <% end %>
  </div>
</div>

<style>
  /* ── 내비게이션 ── */
  .cr-gen-nav { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
  .cr-gen-nav__back {
    display: inline-flex; align-items: center; gap: 4px; font-size: var(--rp-font-size-sm); font-weight: 500;
    color: #64748b; text-decoration: none; padding: 7px 14px; border-radius: 8px;
    border: 1px solid #e2e8f0; background: white; transition: all 0.15s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  }
  .cr-gen-nav__back:hover { background: #f8fafc; color: #334155; border-color: #cbd5e1; }
  .cr-gen-nav__link {
    display: inline-flex; align-items: center; gap: 4px; font-size: var(--rp-font-size-sm); font-weight: 500;
    color: #2563eb; text-decoration: none; padding: 7px 14px; border-radius: 8px;
    border: 1px solid #bfdbfe; background: #eff6ff; transition: all 0.15s;
  }
  .cr-gen-nav__link:hover { background: #dbeafe; color: #1d4ed8; }

  /* ── 헤더 ── */
  .cr-gen-header { margin-bottom: 24px; }
  .cr-gen-header__title { font-size: var(--rp-font-size-2xl); font-weight: 700; color: #0f172a; margin: 0 0 6px 0; }
  .cr-gen-header__desc { font-size: var(--rp-font-size-base); color: #64748b; margin: 0; }

  /* ── 프로필 카드 ── */
  .cr-gen-profile {
    display: flex; align-items: center; gap: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(102,126,234,0.25);
  }
  .cr-gen-profile__avatar {
    width: 48px; height: 48px; background: rgba(255,255,255,0.2);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: var(--rp-font-size-xl); font-weight: 700; flex-shrink: 0;
  }
  .cr-gen-profile__name { font-size: var(--rp-font-size-xl); font-weight: 700; margin-bottom: 4px; }
  .cr-gen-profile__meta { font-size: var(--rp-font-size-base); opacity: 0.85; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .cr-gen-profile__sep { opacity: 0.5; }

  /* ── 진단 정보 카드 ── */
  .cr-gen-info-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
  .cr-gen-info-card {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: box-shadow 0.2s, transform 0.2s;
  }
  .cr-gen-info-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
  .cr-gen-info-card__icon {
    width: 36px; height: 36px; border-radius: 8px; margin: 0 auto 10px;
    display: flex; align-items: center; justify-content: center;
  }
  .cr-gen-info-card__icon--blue { background: #eff6ff; color: #3b82f6; }
  .cr-gen-info-card__icon--green { background: #f0fdf4; color: #16a34a; }
  .cr-gen-info-card__icon--slate { background: #f1f5f9; color: #64748b; }
  .cr-gen-info-card__label { font-size: var(--rp-font-size-2xs); color: #94a3b8; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
  .cr-gen-info-card__value { font-size: var(--rp-font-size-md); font-weight: 600; color: #0f172a; }
  .cr-gen-info-card__value--green { color: #16a34a; }

  /* ── 데이터 요약 ── */
  .cr-gen-data {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px;
    margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .cr-gen-data__header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
  .cr-gen-data__title { font-size: var(--rp-font-size-md); font-weight: 600; color: #0f172a; margin: 0; }
  .cr-gen-data__grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }

  .cr-gen-data__item {
    border-radius: 12px; padding: 20px 12px; text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .cr-gen-data__item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
  .cr-gen-data__item svg { margin-bottom: 8px; }
  .cr-gen-data__item-value { font-size: var(--rp-font-size-3xl); font-weight: 700; margin-bottom: 6px; display: flex; justify-content: center; align-items: center; }
  .cr-gen-data__item-label { font-size: var(--rp-font-size-xs); font-weight: 600; }

  .cr-gen-data__item--blue { background: #eff6ff; color: #1d4ed8; }
  .cr-gen-data__item--blue .cr-gen-data__item-label { color: #3b82f6; }
  .cr-gen-data__item--green { background: #f0fdf4; color: #166534; }
  .cr-gen-data__item--green .cr-gen-data__item-label { color: #16a34a; }
  .cr-gen-data__item--purple { background: #faf5ff; color: #7c3aed; }
  .cr-gen-data__item--purple .cr-gen-data__item-label { color: #7c3aed; }
  .cr-gen-data__item--gray { background: #f8fafc; color: #94a3b8; }
  .cr-gen-data__item--gray .cr-gen-data__item-label { color: #94a3b8; }

  /* ── 경고 ── */
  .cr-gen-alert {
    display: flex; gap: 14px; align-items: flex-start; border-radius: 12px; padding: 16px 20px;
    margin-bottom: 20px; background: #fffbeb; border: 1px solid #fde68a;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .cr-gen-alert__icon { flex-shrink: 0; color: #d97706; margin-top: 2px; }
  .cr-gen-alert__title { font-size: var(--rp-font-size-base); font-weight: 600; color: #92400e; display: block; margin-bottom: 4px; }
  .cr-gen-alert__body { font-size: var(--rp-font-size-sm); color: #a16207; line-height: 1.6; margin: 0; }

  /* ── 생성 액션 ── */
  .cr-gen-action {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 40px 32px;
    text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .cr-gen-action__icon { margin-bottom: 16px; }
  .cr-gen-action__desc { font-size: var(--rp-font-size-base); color: #475569; margin: 0 0 10px 0; line-height: 1.7; }
  .cr-gen-action__hint {
    display: inline-flex; align-items: center; gap: 6px; font-size: var(--rp-font-size-xs); color: #94a3b8;
    margin-bottom: 24px;
  }
  .cr-gen-action__buttons { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }

  /* ── 버튼 ── */
  .cr-gen-btn {
    display: inline-flex; align-items: center; gap: 8px; padding: 12px 28px; border-radius: 10px;
    font-size: var(--rp-font-size-md); font-weight: 600; text-decoration: none; cursor: pointer;
    border: 1px solid transparent; transition: all 0.2s; white-space: nowrap;
  }
  .cr-gen-btn--primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
    box-shadow: 0 4px 12px rgba(102,126,234,0.3);
  }
  .cr-gen-btn--primary:hover { box-shadow: 0 6px 20px rgba(102,126,234,0.45); transform: translateY(-1px); }
  .cr-gen-btn--primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }
  .cr-gen-btn--secondary { background: white; color: #475569; border-color: #e2e8f0; }
  .cr-gen-btn--secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

  /* ── 스피너 ── */
  .cr-gen-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: cr-gen-spin 0.6s linear infinite; }
  .cr-gen-spinner--large { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top-color: #6366f1; }
  .cr-gen-action--processing { border-color: #c7d2fe; background: #eef2ff; }
  @keyframes cr-gen-spin { to { transform: rotate(360deg); } }

  /* ── 반응형 ── */
  @media (max-width: 640px) {
    .cr-gen-info-cards { grid-template-columns: repeat(2, 1fr); }
    .cr-gen-data__grid { grid-template-columns: repeat(2, 1fr); }
    .cr-gen-action__buttons { flex-direction: column; align-items: center; }
  }
</style>
