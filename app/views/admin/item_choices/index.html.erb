<header class="admin-header">
  <div>
    <h1 class="admin-title">보기/채점 정의</h1>
    <p class="admin-subtitle"><%= @item.code %> · <%= @item.prompt %></p>
  </div>
  <div class="admin-actions">
    <%= link_to "문항 상세", admin_item_path(@item), class: "admin-button" %>
    <%= link_to "목록", admin_items_path, class: "admin-button" %>
  </div>
</header>

<% if @missing_choice_scores %>
  <div class="admin-card">
    <span class="admin-badge warning">점수 미설정</span>
    <span class="admin-muted">일부 보기에 점수가 없습니다.</span>
  </div>
<% end %>

<section class="admin-card">
  <h2>보기 추가</h2>
  <%= form_with model: [:admin, @item, @new_choice], url: admin_item_item_choices_path(@item), local: true do |form| %>
    <% if @new_choice.errors.any? %>
      <div class="admin-muted">
        <% @new_choice.errors.full_messages.each do |message| %>
          <div><%= message %></div>
        <% end %>
      </div>
    <% end %>

    <div class="admin-form">
      <div>
        <%= form.label :choice_no, "보기 번호" %>
        <%= form.number_field :choice_no, class: "admin-input small" %>
      </div>
      <div>
        <%= form.label :content, "보기 내용" %>
        <%= form.text_field :content, class: "admin-input" %>
      </div>
      <div>
        <%= form.submit "추가", class: "admin-button primary" %>
      </div>
    </div>
  <% end %>
</section>

<section class="admin-card">
  <h2>보기 점수</h2>
  <table class="admin-table">
    <thead>
      <tr>
        <th>No</th>
        <th>내용</th>
        <th>점수(%)</th>
        <th>정답</th>
        <th>선택 이유</th>
        <th>저장</th>
      </tr>
    </thead>
    <tbody>
      <% @choices.each do |choice| %>
        <% choice_score = choice.choice_score || ChoiceScore.new %>
        <tr>
          <td><%= choice.choice_no %></td>
          <td><%= choice.content %></td>
          <td colspan="4">
            <%= form_with url: admin_item_item_choice_path(@item, choice), method: :patch, local: true, class: "admin-form" do |form| %>
              <%= form.fields_for :choice_score, choice_score do |score_fields| %>
                <div>
                  <%= score_fields.number_field :score_percent, min: 0, max: 100, step: 1, class: "admin-input small" %>
                </div>
                <div>
                  <%= score_fields.text_field :rationale, placeholder: "Rationale", class: "admin-input" %>
                </div>
                <div>
                  <%= score_fields.check_box :is_key %>
                  <%= score_fields.label :is_key, "정답" %>
                </div>
              <% end %>
              <div>
                <%= form.submit "저장", class: "admin-button" %>
              </div>
            <% end %>
            <% if choice.choice_score&.errors&.any? %>
              <div class="admin-muted">
                <% choice.choice_score.errors.full_messages.each do |message| %>
                  <div><%= message %></div>
                <% end %>
              </div>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</section>
