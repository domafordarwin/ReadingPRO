<% content_for :page_title, "사용자 관리" %>

<div class="rp-page-header">
  <div>
    <h1 class="rp-page-title">사용자 관리</h1>
    <p class="rp-page-subtitle">계정 상태와 접근 권한을 관리합니다.</p>
  </div>
  <button class="rp-btn rp-btn--primary" onclick="openCreateModal()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    새 사용자 추가
  </button>
</div>

<div class="rp-card">
  <div class="rp-card__header">
    <h2 class="rp-card__title">사용자 목록</h2>
    <p class="rp-card__description">총 <%= @users.count %>명의 사용자</p>
  </div>

  <!-- 검색 및 필터 -->
  <div class="rp-search-section">
    <%= form_with url: admin_users_path, method: :get, class: "rp-search-form" do %>
      <div class="rp-search-controls">
        <div class="rp-search-input-wrapper">
          <%= text_field_tag :search, params[:search],
              placeholder: "이름 또는 이메일로 검색...",
              class: "rp-search-input" %>
          <svg class="rp-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>

        <div class="rp-filter-group">
          <%= select_tag :role,
              options_for_select(
                [["모든 역할", ""]] + User.roles.keys.map { |r| [role_label(r), r] },
                params[:role]
              ),
              class: "rp-filter-select" %>

          <%= button_tag type: "submit", class: "rp-btn rp-btn--primary" do %>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            검색
          <% end %>

          <% if params[:search].present? || params[:role].present? %>
            <%= link_to "초기화", admin_users_path, class: "rp-btn rp-btn--secondary" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="rp-table-container">
    <table class="rp-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>이름</th>
          <th>이메일</th>
          <th>역할</th>
          <th>가입일</th>
          <th>작업</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <tr>
            <td><%= user.id %></td>
            <td><%= user.name || '-' %></td>
            <td><%= user.email || '-' %></td>
            <td>
              <span class="rp-badge rp-badge--<%= user.role %>">
                <%= role_label(user.role) %>
              </span>
            </td>
            <td><%= user.created_at.strftime('%Y-%m-%d') %></td>
            <td>
              <div class="rp-action-buttons">
                <!-- 역할 변경 버튼 -->
                <button
                  class="rp-btn rp-btn--sm rp-btn--secondary"
                  onclick="openRoleModal(<%= user.id %>, '<%= user.role %>')"
                  title="역할 변경">
                  역할 변경
                </button>

                <!-- 비밀번호 재설정 버튼 -->
                <%= button_to "비밀번호 재설정",
                    reset_password_admin_user_path(user),
                    method: :patch,
                    class: "rp-btn rp-btn--sm rp-btn--danger",
                    data: { confirm: "#{user.name || user.email}님의 비밀번호를 재설정하시겠습니까? 새로운 임시 비밀번호가 생성됩니다." },
                    title: "비밀번호 재설정" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- 역할 변경 모달 -->
<div id="roleModal" class="rp-modal" style="display: none;">
  <div class="rp-modal__overlay" onclick="closeRoleModal()"></div>
  <div class="rp-modal__content">
    <div class="rp-modal__header">
      <h3 class="rp-modal__title">역할 변경</h3>
      <button class="rp-modal__close" onclick="closeRoleModal()" aria-label="닫기">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="rp-modal__body">
      <%= form_with url: "#", method: :patch, id: "roleForm", class: "rp-form" do |f| %>
        <div class="rp-form-group">
          <label class="rp-form-label">새로운 역할 선택</label>
          <select name="role" class="rp-form-select" required>
            <option value="">역할을 선택하세요</option>
            <% User.roles.keys.each do |role| %>
              <option value="<%= role %>"><%= role_label(role) %></option>
            <% end %>
          </select>
        </div>

        <div class="rp-modal__actions">
          <button type="button" class="rp-btn rp-btn--secondary" onclick="closeRoleModal()">
            취소
          </button>
          <button type="submit" class="rp-btn rp-btn--primary">
            변경
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 사용자 생성 모달 -->
<div id="createModal" class="rp-modal" style="display: none;">
  <div class="rp-modal__overlay" onclick="closeCreateModal()"></div>
  <div class="rp-modal__content">
    <div class="rp-modal__header">
      <h3 class="rp-modal__title">새 사용자 추가</h3>
      <button class="rp-modal__close" onclick="closeCreateModal()" aria-label="닫기">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="rp-modal__body">
      <%= form_with url: admin_users_path, method: :post, id: "createForm", class: "rp-form", data: { turbo: false } do |f| %>
        <div class="rp-form-group">
          <label class="rp-form-label">이메일 <span class="rp-required">*</span></label>
          <%= email_field_tag :email, nil, class: "rp-form-input", required: true, placeholder: "user@example.com" %>
        </div>

        <div class="rp-form-group">
          <label class="rp-form-label">역할 <span class="rp-required">*</span></label>
          <select name="role" class="rp-form-select" required>
            <option value="">역할을 선택하세요</option>
            <% User.roles.keys.each do |role| %>
              <option value="<%= role %>"><%= role_label(role) %></option>
            <% end %>
          </select>
        </div>

        <div class="rp-form-group">
          <label class="rp-form-label">비밀번호 <span class="rp-required">*</span></label>
          <%= password_field_tag :password, nil, class: "rp-form-input", required: true, minlength: 6, placeholder: "6자 이상" %>
        </div>

        <div class="rp-form-group">
          <label class="rp-form-label">비밀번호 확인 <span class="rp-required">*</span></label>
          <%= password_field_tag :password_confirmation, nil, class: "rp-form-input", required: true, minlength: 6, placeholder: "비밀번호 재입력" %>
        </div>

        <div class="rp-modal__actions">
          <button type="button" class="rp-btn rp-btn--secondary" onclick="closeCreateModal()">
            취소
          </button>
          <button type="submit" class="rp-btn rp-btn--primary">
            생성
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function openRoleModal(userId, currentRole) {
    const modal = document.getElementById('roleModal');
    const form = document.getElementById('roleForm');
    const select = form.querySelector('select[name="role"]');

    // 폼 액션 URL 설정
    form.action = `/admin/users/${userId}/update_role`;

    // 현재 역할 선택
    select.value = currentRole;

    // 모달 표시
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function closeRoleModal() {
    const modal = document.getElementById('roleModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }

  function openCreateModal() {
    const modal = document.getElementById('createModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function closeCreateModal() {
    const modal = document.getElementById('createModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }

  // ESC 키로 모달 닫기
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeRoleModal();
      closeCreateModal();
    }
  });
</script>

<style>
  /* 검색 섹션 */
  .rp-search-section {
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f9fafb;
  }

  .rp-search-form {
    width: 100%;
  }

  .rp-search-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .rp-search-input-wrapper {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .rp-search-input {
    width: 100%;
    padding: 10px 12px 10px 40px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: var(--rp-font-size-base);
    transition: all 0.2s;
  }

  .rp-search-input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .rp-search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    pointer-events: none;
  }

  .rp-filter-group {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .rp-filter-select {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: var(--rp-font-size-base);
    background-color: white;
    cursor: pointer;
    min-width: 150px;
  }

  .rp-filter-select:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* 액션 버튼 */
  .rp-action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .rp-page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .rp-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: var(--rp-font-size-xs);
    font-weight: var(--rp-font-weight-medium);
  }

  .rp-badge--admin {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .rp-badge--teacher {
    background-color: #dbeafe;
    color: #1e40af;
  }

  .rp-badge--parent {
    background-color: #fef3c7;
    color: #92400e;
  }

  .rp-badge--student {
    background-color: #d1fae5;
    color: #065f46;
  }

  .rp-badge--researcher {
    background-color: #ede9fe;
    color: #5b21b6;
  }

  .rp-badge--diagnostic_teacher {
    background-color: #e0e7ff;
    color: #3730a3;
  }

  .rp-badge--school_admin {
    background-color: #fce7f3;
    color: #9d174d;
  }

  .rp-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
  }

  .rp-modal__overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .rp-modal__content {
    position: relative;
    background: white;
    max-width: 500px;
    margin: 100px auto;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    z-index: 1001;
  }

  .rp-modal__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
  }

  .rp-modal__title {
    margin: 0;
    font-size: var(--rp-font-size-lg);
    font-weight: var(--rp-font-weight-semibold);
  }

  .rp-modal__close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #6b7280;
  }

  .rp-modal__close:hover {
    color: #111827;
  }

  .rp-modal__body {
    padding: 24px;
  }

  .rp-form-group {
    margin-bottom: 20px;
  }

  .rp-form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: var(--rp-font-weight-medium);
    color: #374151;
  }

  .rp-form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: var(--rp-font-size-base);
  }

  .rp-modal__actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
  }

  .rp-form-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: var(--rp-font-size-base);
    transition: border-color 0.2s;
  }

  .rp-form-input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .rp-required {
    color: #dc2626;
  }
</style>
