<% content_for :portal_title do %>
  상담 신청
<% end %>
<% content_for :portal_subtitle do %>
  학습 상담 또는 진단 해석 상담을 신청할 수 있습니다.
<% end %>

<div class="rp-container">
  <!-- 새 상담 신청 폼 -->
  <div class="rp-card rp-mb-6">
    <h2 class="rp-card-title">새 상담 신청</h2>

    <%= form_with model: @new_request, local: true, url: parent_consultation_requests_path do |f| %>
      <div class="rp-form-group">
        <%= f.label :student_id, "자녀 선택" %>
        <%= f.select :student_id, options_for_select(@students.map { |s| [s.name, s.id] }), { prompt: "자녀를 선택하세요" }, class: "rp-input" %>
        <% if @new_request.errors[:student].any? %>
          <span class="rp-error"><%= @new_request.errors[:student].first %></span>
        <% end %>
      </div>

      <div class="rp-form-group">
        <%= f.label :category, "상담 유형" %>
        <%= f.select :category, options_for_select(ConsultationRequest::CATEGORY_LABELS.map { |k, v| [v, k] }, @new_request.category), {}, class: "rp-input" %>
        <% if @new_request.errors[:category].any? %>
          <span class="rp-error"><%= @new_request.errors[:category].first %></span>
        <% end %>
      </div>

      <div class="rp-form-group">
        <%= f.label :scheduled_at, "희망 일정" %>
        <%= f.datetime_local_field :scheduled_at, class: "rp-input" %>
        <small style="color: #94a3b8;">최소 현재 시간 이후를 선택해주세요</small>
        <% if @new_request.errors[:scheduled_at].any? %>
          <span class="rp-error"><%= @new_request.errors[:scheduled_at].first %></span>
        <% end %>
      </div>

      <div class="rp-form-group">
        <%= f.label :content, "요청 사항" %>
        <%= f.text_area :content, rows: 5, placeholder: "상담 시 궁금한 점을 적어주세요 (최소 10자)", class: "rp-input" %>
        <% if @new_request.errors[:content].any? %>
          <span class="rp-error"><%= @new_request.errors[:content].first %></span>
        <% end %>
      </div>

      <div class="rp-form-actions">
        <%= f.submit "상담 신청", class: "rp-btn rp-btn--primary" %>
        <%= link_to "취소", parent_consult_path, class: "rp-btn rp-btn--secondary" %>
      </div>
    <% end %>
  </div>

  <!-- 상담 신청 이력 -->
  <div class="rp-card">
    <h2 class="rp-card-title">상담 신청 이력</h2>

    <% if @consultation_requests.any? %>
      <div class="rp-table-wrapper">
        <table class="rp-table">
          <thead>
            <tr>
              <th style="width: 15%;">자녀</th>
              <th style="width: 20%;">상담 유형</th>
              <th style="width: 15%;">희망 일정</th>
              <th style="width: 15%;">상태</th>
              <th style="width: 15%;">신청일</th>
              <th style="width: 20%;">비고</th>
            </tr>
          </thead>
          <tbody>
            <% @consultation_requests.each do |request| %>
              <tr>
                <td><strong><%= request.student.name %></strong></td>
                <td><span class="rp-badge rp-badge--outline"><%= request.category_label %></span></td>
                <td><%= request.scheduled_at.strftime("%Y.%m.%d %H:%M") %></td>
                <td>
                  <% if request.pending? %>
                    <span class="rp-badge rp-badge--warning">대기 중</span>
                  <% elsif request.approved? %>
                    <span class="rp-badge rp-badge--success">승인됨</span>
                  <% elsif request.rejected? %>
                    <span class="rp-badge rp-badge--danger">거절됨</span>
                  <% elsif request.completed? %>
                    <span class="rp-badge rp-badge--gray">완료됨</span>
                  <% end %>
                </td>
                <td><%= request.created_at.strftime("%Y.%m.%d") %></td>
                <td>
                  <% if request.teacher_response.present? %>
                    <small style="color: #22c55e;">✓ 답변 있음</small>
                  <% else %>
                    <small style="color: #94a3b8;">-</small>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- 페이지네이션 -->
      <div style="margin-top: 24px; display: flex; justify-content: center; gap: 8px;">
        <% if @consultation_requests.respond_to?(:current_page) %>
          <% if @consultation_requests.current_page > 1 %>
            <%= link_to "◀ 이전", parent_consult_path(page: @consultation_requests.current_page - 1), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
          <% end %>

          <% (1..@consultation_requests.total_pages).each do |page| %>
            <% if page == @consultation_requests.current_page %>
              <span style="padding: 8px 12px; background: var(--rp-primary); color: white; border-radius: 6px;"><%= page %></span>
            <% else %>
              <%= link_to page, parent_consult_path(page: page), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
            <% end %>
          <% end %>

          <% if @consultation_requests.current_page < @consultation_requests.total_pages %>
            <%= link_to "다음 ▶", parent_consult_path(page: @consultation_requests.current_page + 1), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="rp-empty-state">
        <p style="font-size: var(--rp-font-size-lg); color: #666;">신청된 상담이 없습니다.</p>
        <p style="color: #94a3b8; margin-bottom: 16px;">위의 폼을 통해 상담을 신청해주세요.</p>
      </div>
    <% end %>
  </div>
</div>

<style>
  .rp-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 24px;
  }

  .rp-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 24px;
  }

  .rp-card-title {
    font-size: var(--rp-font-size-lg);
    font-weight: 600;
    color: #0f172a;
    margin: 0 0 24px 0;
  }

  .rp-form-group {
    margin-bottom: 20px;
  }

  .rp-form-group label {
    display: block;
    font-weight: 500;
    color: #0f172a;
    margin-bottom: 8px;
  }

  .rp-form-group small {
    display: block;
    margin-top: 4px;
  }

  .rp-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-family: inherit;
    font-size: var(--rp-font-size-base);
  }

  .rp-input:focus {
    outline: none;
    border-color: #2f5bff;
    box-shadow: 0 0 0 2px rgba(47, 91, 255, 0.1);
  }

  .rp-error {
    display: block;
    color: #dc2626;
    font-size: var(--rp-font-size-sm);
    margin-top: 4px;
  }

  .rp-form-actions {
    display: flex;
    gap: 8px;
    margin-top: 24px;
  }

  .rp-btn {
    padding: 10px 16px;
    border-radius: 6px;
    font-size: var(--rp-font-size-base);
    font-weight: 500;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
  }

  .rp-btn--primary {
    background: #2f5bff;
    color: white;
  }

  .rp-btn--primary:hover {
    background: #254ccb;
  }

  .rp-btn--secondary {
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #cbd5e1;
  }

  .rp-btn--secondary:hover {
    background: #e2e8f0;
  }

  .rp-btn--sm {
    padding: 6px 12px;
    font-size: var(--rp-font-size-sm);
  }

  .rp-mb-6 {
    margin-bottom: 24px;
  }

  .rp-table-wrapper {
    overflow-x: auto;
  }

  .rp-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--rp-font-size-base);
  }

  .rp-table th,
  .rp-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }

  .rp-table th {
    font-weight: 600;
    color: #94a3b8;
    background: #f8fafc;
  }

  .rp-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: var(--rp-font-size-xs);
    font-weight: 600;
  }

  .rp-badge--outline {
    background: transparent;
    border: 1px solid #cbd5e1;
    color: #475569;
  }

  .rp-badge--warning {
    background: #fef3c7;
    color: #b45309;
  }

  .rp-badge--success {
    background: #dcfce7;
    color: #15803d;
  }

  .rp-badge--danger {
    background: #fee2e2;
    color: #dc2626;
  }

  .rp-badge--gray {
    background: #f1f5f9;
    color: #64748b;
  }

  .rp-empty-state {
    text-align: center;
    padding: 48px 24px;
  }

  .rp-empty-state p {
    margin: 0 0 8px 0;
  }
</style>
