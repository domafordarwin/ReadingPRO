<% content_for :page_title do %>글 상세<% end %>

<!-- Forum Header -->
<div class="rp-card rp-mb-6">
  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
    <div style="flex: 1;">
      <h1 class="rp-page-header__title" style="margin: 0 0 8px 0;"><%= @forum.title %></h1>
      <div style="display: flex; gap: 12px; align-items: center; color: #666; font-size: var(--rp-font-size-sm);">
        <span><strong><%= @forum.created_by.email.split("@").first %></strong></span>
        <span>·</span>
        <span><%= @forum.created_at.strftime("%Y년 %m월 %d일 %H:%M") %></span>
        <span>·</span>
        <span>조회 <%= @forum.views_count %></span>
      </div>
    </div>
    <div style="display: flex; gap: 8px;">
      <span class="rp-badge rp-badge--primary"><%= @forum.category_label %></span>
      <% if @forum.closed? %>
        <span class="rp-badge rp-badge--danger">마감</span>
      <% elsif @forum.answered? %>
        <span class="rp-badge rp-badge--success">답변완료</span>
      <% else %>
        <span class="rp-badge rp-badge--warning">미답변</span>
      <% end %>
    </div>
  </div>

  <!-- Edit/Delete Buttons (Author Only) -->
  <% if @forum.created_by_id == current_user&.id && current_user&.parent? %>
    <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
      <%= link_to "수정", edit_parent_forum_path(@forum), class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% if @forum.closed? %>
        <%= button_to "다시 열기", reopen_parent_forum_path(@forum), method: :patch, class: "rp-btn rp-btn--secondary rp-btn--sm" %>
      <% else %>
        <%= button_to "마감", close_parent_forum_path(@forum), method: :patch, data: { turbo_confirm: "게시글을 마감하시겠습니까?" }, class: "rp-btn rp-btn--warning rp-btn--sm" %>
      <% end %>
      <%= button_to "삭제", parent_forum_path(@forum), method: :delete, data: { turbo_confirm: "정말 삭제하시겠습니까?" }, class: "rp-btn rp-btn--danger rp-btn--sm" %>
    </div>
  <% end %>
</div>

<!-- Forum Content -->
<div class="rp-card rp-mb-6">
  <div style="font-size: var(--rp-font-size-md); line-height: 1.8; color: #333; word-break: break-word;">
    <%= simple_format(@forum.content) %>
  </div>
</div>

<!-- Comments Section -->
<div class="rp-card">
  <h2 style="font-size: var(--rp-font-size-lg); font-weight: var(--rp-font-weight-semibold); margin: 0 0 24px 0; padding-bottom: 12px; border-bottom: 2px solid #2F5BFF;">
    댓글 (<%= @comments.count %>)
  </h2>

  <!-- Comments List -->
  <% if @comments.any? %>
    <div style="margin-bottom: 24px;">
      <% @comments.each do |comment| %>
        <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
            <div>
              <strong><%= comment.created_by.email.split("@").first %></strong>
              <% if comment.is_teacher_reply? %>
                <span class="rp-badge rp-badge--success" style="margin-left: 8px;">선생님 답변</span>
              <% end %>
              <br>
              <small style="color: #999;"><%= comment.created_at.strftime("%Y.%m.%d %H:%M") %></small>
            </div>
            <% if comment.created_by_id == current_user&.id %>
              <%= button_to "삭제", parent_forum_comment_path(forum_id: @forum.id, id: comment.id), method: :delete, data: { turbo_confirm: "정말 삭제하시겠습니까?" }, class: "rp-btn rp-btn--danger rp-btn--sm" %>
            <% end %>
          </div>
          <p style="margin: 8px 0; color: #333; line-height: 1.6;">
            <%= simple_format(comment.content) %>
          </p>
        </div>
      <% end %>
    </div>
  <% else %>
    <p style="color: #999; margin-bottom: 24px;">아직 댓글이 없습니다.</p>
  <% end %>

  <!-- New Comment Form (Not Closed) -->
  <% unless @forum.closed? %>
    <div style="padding-top: 24px; border-top: 1px solid #e0e0e0;">
      <h3 style="font-size: var(--rp-font-size-md); font-weight: var(--rp-font-weight-semibold); margin: 0 0 12px 0;">댓글 작성</h3>
      <form action="<%= "/parent/forums/#{@forum.id}/comments" %>" method="post" class="rp-form">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
        <div class="rp-form-group">
          <textarea name="parent_forum_comment[content]" placeholder="댓글을 입력해주세요..." rows="4" class="rp-textarea"></textarea>
        </div>
        <div style="display: flex; justify-content: flex-end;">
          <input type="submit" value="댓글 작성" class="rp-btn rp-btn--primary">
        </div>
      </form>
    </div>
  <% else %>
    <div style="padding-top: 24px; border-top: 1px solid #e0e0e0; text-align: center; color: #999;">
      마감된 게시글입니다. 댓글을 작성할 수 없습니다.
    </div>
  <% end %>
</div>

<!-- Back Button -->
<div style="margin-top: 24px;">
  <%= link_to "◀ 목록으로", parent_forums_path, class: "rp-btn rp-btn--secondary" %>
</div>
