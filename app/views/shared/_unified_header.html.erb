<%# Unified Header Component %>
<%# Required locals: page_title, current_role %>
<%# Updated: 2026-02-05 - Fixed notifications error %>
<% page_title ||= "대시보드" %>
<% current_role ||= "student" %>

<%
  # Role display names and icons
  role_config = {
    "student" => { name: "학생", icon: "user", color: "student" },
    "parent" => { name: "학부모", icon: "users", color: "parent" },
    "school_admin" => { name: "학교담당자", icon: "building", color: "school" },
    "teacher" => { name: "진단담당교사", icon: "clipboard-check", color: "teacher" },
    "developer" => { name: "문항개발위원", icon: "code", color: "developer" },
    "admin" => { name: "관리자", icon: "shield", color: "admin" }
  }
  role_info = role_config[current_role.to_s] || role_config["student"]
%>

<header class="rp-header">
  <div class="rp-header__left">
    <!-- Hamburger Menu (Mobile) -->
    <button class="rp-header__hamburger" id="sidebarToggle" aria-label="메뉴 열기">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>

    <!-- Logo -->
    <div class="rp-logo">
      <a href="/" class="rp-logo__main">
        <%= image_tag 'readingpro_logo.png', alt: 'ReadingPRO', style: 'height: 52px; width: auto;' %>
      </a>
    </div>
  </div>

  <div class="rp-header__center">
    <h1 class="rp-header__title"><%= page_title %></h1>
  </div>

  <div class="rp-header__right">
    <!-- TODO: Implement notifications feature (model not yet created) -->
    <button class="rp-notification-btn" aria-label="알림" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span class="rp-notification-btn__badge"></span>
      </button>

    <!-- Role Chip with Dropdown -->
    <div class="rp-dropdown">
      <button class="rp-role-chip rp-role-chip--<%= role_info[:color] %>">
        <%= render "shared/icons/#{role_info[:icon]}", size: 16 rescue nil %>
        <span><%= role_info[:name] %></span>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
      <div class="rp-dropdown__content">
        <a href="/profile" class="rp-dropdown__item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          내 정보
        </a>
      </div>
    </div>

    <!-- User Name Button -->
    <button class="rp-user-name-btn">
      <% if current_user&.student %>
        <%= current_user.student.name %>
      <% elsif current_user&.parent %>
        <%= current_user.parent.name || current_user.email || '사용자' %>
      <% else %>
        <%= current_user&.email || '사용자' %>
      <% end %>
    </button>

    <!-- Logout Button -->
    <%= button_to "로그아웃", logout_path, method: :delete,
        data: { turbo: false },
        form: { data: { turbo: false } },
        class: "rp-btn rp-btn--secondary rp-btn--sm" %>
  </div>
</header>

<script>
  document.getElementById('sidebarToggle')?.addEventListener('click', function() {
    document.querySelector('.rp-sidebar')?.classList.toggle('rp-sidebar--open');
  });
</script>
