# frozen_string_literal: true

# =============================================================================
# QuestioningLevelConfig
# 수준별 발문 학습 모듈 설정: AI 평가 프롬프트, 스캐폴딩 UI, 평가 기준
# =============================================================================
module QuestioningLevelConfig
  LEVELS = %w[elementary_low elementary_high middle high].freeze

  LEVEL_LABELS = {
    "elementary_low"  => "초등 저학년 (1-2학년)",
    "elementary_high" => "초등 고학년 (3-6학년)",
    "middle"          => "중학생",
    "high"            => "고등학생"
  }.freeze

  # ---------------------------------------------------------------------------
  # 수준별 AI 평가 시스템 프롬프트
  # ---------------------------------------------------------------------------
  LEVEL_SYSTEM_PROMPTS = {
    "elementary_low" => <<~PROMPT,
      당신은 초등 저학년(1-2학년) 학생의 독서 발문을 평가하는 전문가입니다.

      ## 평가 기준 (초저 수준)
      - **관련성(relevance)**: 읽기 지문의 내용과 연결되어 있는가? 간단한 연결도 인정.
      - **사고 깊이(depth)**: 감정이나 행동을 표현했는가? "어떤 마음", "왜 그랬을까" 수준이면 충분.
      - **창의성(creativity)**: 자기만의 생각이나 경험을 덧붙였는가?
      - **언어 표현(language_quality)**: 한 문장이라도 완성된 형태로 표현했는가?

      ## 초저 수준 특성
      - 한 번에 한 가지만 묻는 짧은 발문이 적절합니다.
      - "무엇/어떻게 느꼈니" 형태의 감정 중심 발문을 높이 평가하세요.
      - 감정어(기쁘다/무섭다/미안하다/고맙다)와 행동(도와주기/기다리기/나누기) 연결을 칭찬하세요.
      - O/X, 그림 선택, 빈칸 채우기 등 스캐폴딩을 활용한 답변도 긍정적으로 평가하세요.
      - 피드백은 매우 쉬운 한국어로, 칭찬 위주로 작성하세요 (1-2문장).

      ## 피드백 톤
      - 반말 사용 ("잘했어!", "멋진 생각이야!")
      - 구체적으로 칭찬 ("○○ 마음을 잘 표현했어!", "경험을 잘 연결했어!")
      - 개선점은 부드럽게 ("다음엔 '왜'도 한번 생각해 보자!")
    PROMPT

    "elementary_high" => <<~PROMPT,
      당신은 초등 고학년(3-6학년) 학생의 독서 발문을 평가하는 전문가입니다.

      ## 평가 기준 (초고 수준)
      - **관련성(relevance)**: 텍스트의 특정 장면이나 인물과 연결되는가?
      - **사고 깊이(depth)**: 장면 근거를 제시하며 추론하는가? 원인-결과를 연결하는가?
      - **창의성(creativity)**: 개인 경험과 개념을 연결하는가? 다른 관점을 시도하는가?
      - **언어 표현(language_quality)**: 완성된 문장으로 이유를 설명하는가?

      ## 초고 수준 특성
      - 1단계에서 개인 경험 + 개념 정의(예: 공감, 초능력, 관점)까지 끌어올리기를 기대합니다.
      - 2단계에서 장면 근거를 요구하되, '정답 맞히기'가 아닌 "어느 대목에서?"로 자연스럽게 묻는 발문을 높이 평가하세요.
      - 3단계에서 찬반 토론 + 실천 다짐으로 마무리하는 발문을 높이 평가하세요.
      - 연속 발문(큰 질문을 1-1, 1-2로 쪼개는 것)을 시도하면 보너스 점수를 주세요.

      ## 피드백 톤
      - 존댓말 사용 ("잘 했어요!", "좋은 생각이에요!")
      - 장면 근거를 찾은 경우 칭찬 ("텍스트에서 근거를 잘 찾았어요!")
      - 개선점은 구체적 제안 ("'왜냐하면'을 사용해서 이유를 덧붙이면 더 좋겠어요!")
    PROMPT

    "middle" => <<~PROMPT,
      당신은 중학생의 독서 발문을 평가하는 전문가입니다.

      ## 평가 기준 (중등 수준)
      - **관련성(relevance)**: 텍스트의 핵심 논지와 연결되는가? 개념과 텍스트를 함께 다루는가?
      - **사고 깊이(depth)**: 개념(편향/무력감/변명 논리 등)을 텍스트와 연결해 설명하는가? 원인-결과-영향을 분석하는가?
      - **창의성(creativity)**: 관점 전환(다른 인물/시대/문화)을 시도하는가? 조건부 추론("만약 ~라면")을 사용하는가?
      - **언어 표현(language_quality)**: 논리적 구조('왜냐하면', '그러므로')로 서술하는가? 근거를 인용하는가?

      ## 중등 수준 특성
      - 2단계에서 개념을 텍스트와 연결해 '설명'하게 하는 발문을 높이 평가하세요.
      - 3단계에서 정책/제도/집단 책임까지 확장해, 개인 실천과 사회 구조를 함께 다루는 발문이 우수합니다.
      - "내 생각"에 "근거(텍스트/사례/경험)"를 반드시 붙이는 발문을 높이 평가하세요.
      - KWL 차트, 사실/의견/궁금한 점 구분을 활용한 발문에 보너스를 주세요.

      ## 피드백 톤
      - 존댓말 사용 ("분석력이 돋보입니다", "깊이 있는 질문이네요")
      - 텍스트 근거 사용을 강조 ("텍스트 근거와 함께 주장하면 더 설득력이 있겠습니다")
      - 사고 확장을 제안 ("이 질문을 사회 제도 차원으로 확장해보면 어떨까요?")
    PROMPT

    "high" => <<~PROMPT
      당신은 고등학생의 독서 발문을 평가하는 전문가입니다.

      ## 평가 기준 (고등 수준)
      - **관련성(relevance)**: 텍스트의 전제/세계관/이데올로기까지 다루는가? 배제된 목소리를 발견하는가?
      - **사고 깊이(depth)**: 가설 설정 → 근거 수집 → 논증의 학술적 사고를 보이는가? 논지의 한계/반례를 찾는가?
      - **창의성(creativity)**: 학제 간 연결(경제학/심리학/사회학 등)을 시도하는가? 대안 비교(효율/정의/공정/정서)를 제시하는가?
      - **언어 표현(language_quality)**: 학술적 서술 구조(주장-근거-반론-재반론)를 사용하는가? 정교한 개념어를 활용하는가?

      ## 고등 수준 특성
      - 1단계에서 '개념 정의'를 넘어 개념의 함의(윤리/정당화/한계)까지 묻는 발문이 우수합니다.
      - 2단계에서 책의 주장(논지)을 요약 → 근거 → 반례/한계로 확장하는 발문을 높이 평가하세요.
      - 3단계는 하이라이트: 찬반이 갈리는 쟁점 또는 대안 비교(효율/정의/공정/정서)를 설계하는 발문이 최고점입니다.
      - 메타인지 성찰("내 발문의 사고 유형/강점/한계는?")을 시도하면 보너스를 주세요.

      ## 피드백 톤
      - 학술적 존댓말 ("비판적 분석이 돋보입니다", "다층적 해석을 시도한 점이 인상적입니다")
      - 사고의 깊이를 인정 ("텍스트의 전제를 의문시하는 것은 비판적 읽기의 핵심입니다")
      - 확장 제안 ("이 주제를 다른 학문 분야의 렌즈로도 분석해보시면 더 풍부해질 것입니다")
    PROMPT
  }.freeze

  # ---------------------------------------------------------------------------
  # 수준별 스캐폴딩 설명
  # ---------------------------------------------------------------------------
  SCAFFOLDING_DESCRIPTIONS = {
    "elementary_low" => {
      3 => { label: "최대 도움", description: "O/X 선택, 그림 고르기, 이모지 선택 등 시각적 도구로 쉽게 시작해요." },
      2 => { label: "많은 도움", description: "빈칸 채우기, 선택지에서 고르기 등으로 생각을 표현해 보세요." },
      1 => { label: "약간 도움", description: "힌트를 참고하여 짧은 문장으로 발문을 만들어 보세요." },
      0 => { label: "스스로 해보기", description: "도움 없이 자기만의 발문을 자유롭게 만들어 보세요!" }
    },
    "elementary_high" => {
      3 => { label: "구조 안내", description: "'누가/무엇을/왜' 구조를 참고하여 발문을 만들어 보세요." },
      2 => { label: "힌트 제공", description: "핵심 단어 힌트를 참고하여 발문을 작성해 보세요." },
      1 => { label: "최소 도움", description: "예시만 참고하고, 자기만의 표현으로 발문을 만들어 보세요." },
      0 => { label: "자기주도", description: "도움 없이 완전한 발문을 자유롭게 작성해 보세요!" }
    },
    "middle" => {
      3 => { label: "분석 틀 제공", description: "KWL 차트, 사실/의견 분류 등 사고 도구를 활용하세요." },
      2 => { label: "관점 안내", description: "다른 인물/시대의 관점에서 생각해 보세요." },
      1 => { label: "방향 제시", description: "큰 주제만 참고하고, 구체적 질문은 스스로 구성하세요." },
      0 => { label: "자기주도", description: "독자적으로 분석하고 근거를 들어 발문을 작성하세요." }
    },
    "high" => {
      3 => { label: "학제적 틀", description: "여러 학문 분야의 개념을 활용하여 분석하세요." },
      2 => { label: "논증 구조", description: "주장-근거-반론의 구조로 발문을 구성하세요." },
      1 => { label: "넓은 주제", description: "큰 주제만 참고하고, 세부 논점은 스스로 설정하세요." },
      0 => { label: "완전 자기주도", description: "메타인지적 성찰까지 포함하여 독자적으로 발문하세요." }
    }
  }.freeze

  # ---------------------------------------------------------------------------
  # 수준별 단계 설명 (MD 파일 기반 강화)
  # ---------------------------------------------------------------------------
  LEVEL_STAGE_DESCRIPTIONS = {
    "elementary_low" => {
      1 => { title: "책문 열기", subtitle: "경험 나누기",
             description: "동물/가족/자연 등 친숙한 주제로 '어떤 기분이 드나요?' 같은 쉬운 질문부터 시작해요." },
      2 => { title: "이야기 나누기", subtitle: "이야기 속으로",
             description: "책 속 인물은 누구인지, 어떤 일이 일어났는지, 인물의 기분은 어떤지 이야기해요." },
      3 => { title: "삶과 연결", subtitle: "나라면 어떻게?",
             description: "나도 그렇게 할 수 있을까? 가장 좋았던 장면은? 나의 실천 다짐을 이야기해요." }
    },
    "elementary_high" => {
      1 => { title: "책문 열기", subtitle: "배경지식 깨우기",
             description: "개인 경험과 개념(공감/관점/초능력 등)을 연결하고, 제목에서 이야기를 짐작해 봅시다." },
      2 => { title: "이야기 나누기", subtitle: "장면 깊이 탐구",
             description: "'어느 대목에서?' 텍스트 근거를 찾고, 인물의 감정 변화와 원인-결과를 분석해요." },
      3 => { title: "삶과 연결", subtitle: "찬반 토론과 실천",
             description: "찬성/반대 이유를 2가지씩 말하고, 나만의 공감 결심을 만들어 봅시다." }
    },
    "middle" => {
      1 => { title: "책문 열기", subtitle: "사전 지식 구조화",
             description: "KWL 차트로 알고 있는 것/알고 싶은 것을 정리하고, 선입견의 출처를 돌아봅시다." },
      2 => { title: "이야기 나누기", subtitle: "개념과 논리 분석",
             description: "편향/무력감/변명 논리 같은 개념을 텍스트와 연결하고, 관점을 전환하여 분석합니다." },
      3 => { title: "삶과 연결", subtitle: "정책과 실천 제안",
             description: "개인 실천과 사회 구조(정책/제도/집단 책임)를 함께 다루고, 현실적 캠페인을 설계합니다." }
    },
    "high" => {
      1 => { title: "책문 열기", subtitle: "메타인지적 성찰",
             description: "선입견의 배경(매체/교육/경험)을 분석하고, 사회적 통념의 한계와 간과된 시각을 탐색합니다." },
      2 => { title: "이야기 나누기", subtitle: "논지와 이데올로기 비판",
             description: "텍스트의 세계관/전제를 분석하고, 가설을 세워 논증하며, 학제 간 재해석을 시도합니다." },
      3 => { title: "삶과 연결", subtitle: "쟁점 토론과 정책 제안",
             description: "효율 vs 정의, 대안 비교, 윤리적 함의를 분석하고, 메타인지 성찰로 마무리합니다." }
    }
  }.freeze

  # ---------------------------------------------------------------------------
  # 수준별 연속 발문(쪼개기) 예시
  # ---------------------------------------------------------------------------
  SEQUENTIAL_QUESTION_EXAMPLES = {
    "elementary_low" => nil, # L1은 연속 발문 미적용
    "elementary_high" => {
      big_question: "공감이 왜 중요할까?",
      sub_questions: [
        "1-1) 책에서 공감이 필요한 장면은 어디였나요?",
        "1-2) 그 장면에서 누가 어떤 마음이었나요?",
        "1-3) 그때 '공감'이 실제로 도움이 되었나요? 왜 그렇게 생각하나요?"
      ]
    },
    "middle" => {
      big_question: "기후 문제는 왜 해결이 어려울까?",
      sub_questions: [
        "1-1) 책에서 제시한 '변명'은 무엇이었나요?",
        "1-2) 그 변명이 개인 행동을 어떻게 바꾸나요?",
        "1-3) 변명을 줄이기 위해 개인/학교/정부는 각각 무엇을 해야 하나요?"
      ]
    },
    "high" => {
      big_question: "이타적 선택에서 '냉정함'은 왜 필요한가?",
      sub_questions: [
        "1-1) 책이 말하는 '냉정함'은 무엇을 의미하나요?",
        "1-2) 책 속 사례에서 '감정적 선의'가 만든 부작용은 무엇이었나요?",
        "1-3) 그렇다면 우리는 '냉정함'을 어떤 기준/절차로 구현할 수 있을까요?"
      ]
    }
  }.freeze

  # ---------------------------------------------------------------------------
  # 수준별 발문 작성 팁 (학생 UI에 표시)
  # ---------------------------------------------------------------------------
  LEVEL_WRITING_TIPS = {
    "elementary_low" => [
      "한 번에 한 가지만 물어보세요.",
      "'어떤 마음이 들었니?'처럼 느낌을 물어보면 좋아요.",
      "'나라면 어떻게 했을까?'도 좋은 발문이에요."
    ],
    "elementary_high" => [
      "'어느 대목에서 그렇게 느꼈어?'처럼 장면 근거를 찾아보세요.",
      "큰 질문을 작은 질문으로 쪼개어 보세요 (연속 발문).",
      "찬성/반대 이유를 2가지씩 생각해 보세요."
    ],
    "middle" => [
      "'내 생각'에 반드시 '근거(텍스트/사례/경험)'를 붙이세요.",
      "개념(편향/무력감 등)을 텍스트와 연결해 설명해 보세요.",
      "개인 실천과 사회 제도를 함께 다뤄 보세요."
    ],
    "high" => [
      "텍스트의 전제/세계관을 의문시해 보세요.",
      "가설을 세우고, 근거를 찾아 논증해 보세요.",
      "여러 학문 분야의 렌즈로 재해석해 보세요.",
      "나의 사고 과정 자체를 성찰해 보세요 (메타인지)."
    ]
  }.freeze

  # ---------------------------------------------------------------------------
  # Public API
  # ---------------------------------------------------------------------------
  def self.system_prompt_for(level)
    LEVEL_SYSTEM_PROMPTS[level] || LEVEL_SYSTEM_PROMPTS["elementary_low"]
  end

  def self.stage_description_for(level, stage)
    LEVEL_STAGE_DESCRIPTIONS.dig(level, stage) || {}
  end

  def self.scaffolding_for(level, scaffolding_level)
    SCAFFOLDING_DESCRIPTIONS.dig(level, scaffolding_level) || {}
  end

  def self.writing_tips_for(level)
    LEVEL_WRITING_TIPS[level] || []
  end

  def self.sequential_example_for(level)
    SEQUENTIAL_QUESTION_EXAMPLES[level]
  end
end
